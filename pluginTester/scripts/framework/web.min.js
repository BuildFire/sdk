"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},imageLibCurrentApp=null;function ImageLibAPI(e){this.context={},angular.copy(e,this.context),this.context.datastoreWriteKey&&(this.context.writeKey=this.context.datastoreWriteKey),this.init()}$app.directive("scrolly",function(){return{restrict:"A",link:function(e,t,i){var o=t[0];console.log("loading directive"),t.bind("scroll",function(){o.scrollTop+o.offsetHeight+10>=o.scrollHeight&&e.$apply(i.scrolly)})}}}),ImageLibAPI.prototype={init:function(e){imageLibCurrentApp=this},showDialog:function(e,t){this&&this.context&&(imageLibCurrentApp.context=this.context),imageLibCurrentApp.options=e;var i="pages/imageLib/imageLib.html";void 0!==imageLibCurrentApp&&imageLibCurrentApp.imageLibTemplate&&(i=imageLibCurrentApp.imageLibTemplate);var o={templateUrl:i,controller:"imageLibCtrl",size:"lg",position:"modal-pos"};window.openDialog(o,function(e){t&&t(null,e)})}},ImageLibAPI.tools={resizeImage:function(e,t){if(!e)return null;if("gif"==e.split(".").pop().toLowerCase())return e;var i=t.disablePixelRation?1:window.devicePixelRatio;if(t){if("object"!=(void 0===t?"undefined":_typeof(t)))throw"options not an object"}else t={width:window.innerWidth};"full"==t.width&&(t.width=window.innerWidth),"full"==t.height&&(t.height=window.innerHeight);var o="https://apmyztgbko.cloudimg.io/s/";return t.width&&!t.height?o+"width/"+Math.floor(t.width*i)+"/"+e:!t.width&&t.height?o+"height/"+Math.floor(t.height*i)+"/"+e:t.width&&t.height?o+"resizenp/"+Math.floor(t.width*i)+"x"+Math.floor(t.height*i)+"/"+e:e},cropImage:function(e,t){if(!e)return null;var i=t.disablePixelRation?1:window.devicePixelRatio;if("object"!=(void 0===t?"undefined":_typeof(t)))throw"options not an object";if(t.width||t.height||(t={width:"full",height:"full"}),"full"==t.width&&(t.width=window.innerWidth),"full"==t.height&&(t.height=window.innerHeight),!t.width||!t.height)return console.warn("cropImage doenst have width or height please fix. returning original url"),e;return"https://apmyztgbko.cloudimg.io/s/crop/"+Math.floor(t.width*i)+"x"+Math.floor(t.height*i)+"/"+e},checkTransparent:function(e,a){var n=document.createElement("img");n.crossOrigin="Anonymous",n.onload=function(){s.width=n.width,s.height=n.height;var e=s.getContext("2d");e.drawImage(n,0,0);for(var t=e.getImageData(0,0,s.width,s.height).data,i=!1,o=0;o<t.length;o+=4)if(t[o+3]<255){i=!0;break}a(null,i)},n.src=e;var s=document.createElement("canvas")}},$app.controller("imageLibRemoveCtrl",["$scope","$http","$dialog","$data",function(e,t,i,o){e.close=function(){i.close(null)},e.confirm=function(){i.close(o)}}]),$app.controller("imageLibCtrl",["$scope","Upload","$http","$dialog","$interval","$timeout","angularGridInstance",function(c,a,g,n,l,t,e){c.helpLink="1717"===window.whitelabelContext.whitelabelId?"https://learn.buildfire.com/en/articles/499625-using-the-media-library":"https://learn.appdocumentation.com/en/articles/805514-using-the-media-library",c.readyToShowFiles=!1,c.tools=ImageLibAPI.tools,c.invalidFileType=c.showProgressMessage=c.showSuccessMessage=c.showErrorMessage=c.invalidFileSize=!1,c.hideMessage=function(){c.invalidFileType=c.showProgressMessage=c.showSuccessMessage=c.showErrorMessage=!1},c.showMessage=function(e){c.hideMessage(),c[e]=!0,"showSuccessMessage"===e&&t(function(){c.hideMessage(),c.$digest()},1e4)};var i=null;c.files=[],c.selectedFiles={},c.stockImages=[],c.selectedStockImages={},c.loadingFiles=!0,c.hoveredImageName="",c.selectedIcons={},c.iconsShown=!1,c.filesShown=!1,c.stockShown=!1,c.iconsActive=!1,c.filesActive=!1,c.stockActive=!1,c.activeType=function(e){c.iconsActive=!1,c.filesActive=!1,c.stockActive=!1,c.clearSelection(),void 0!==e&&(c[e]=!0)},c.activeFiles=function(){c.selectedFiles={},c.activeType("filesActive")},c.activeIcons=function(){c.selectedIcons={},c.activeType("iconsActive")},c.activeStockImages=function(){c.selectedStockImages={},c.activeType("stockImagesActive")},c.isImageSelected=!1,c.clearSelection=function(){if(c.isImageSelected=!1,c.selectedFiles={},c.files)for(var e=0;e<c.files.length;e++)c.files[e].selected=!1;if(c.selectedIcons={},c.icons)for(e=0;e<c.icons.length;e++)c.icons[e].selected=!1;if(c.selectedStockImages={},c.stockImages)for(e=0;e<c.stockImages.length;e++)c.stockImages[e].selected=!1},c.close=function(){n.close({selectedFiles:[],selectedIcons:[],selectedStockImages:[]})},c.insertSelection=function(){var e=[];if(c.selectedFiles)for(var t in c.selectedFiles)t&&c.selectedFiles[t]&&e.push(c.selectedFiles[t]);var i=[];if(c.selectedIcons)for(var o in c.selectedIcons)o&&c.selectedIcons[o]&&i.push(c.selectedIcons[o]);if(c.selectedStockImages){for(var a in c.selectedStockImages)a&&c.selectedStockImages[a]&&e.push(c.selectedStockImages[a]);c.appendStockImageToSavedList(c.selectedStockImages),f(c.selectedStockImages)}n.close({selectedFiles:e,selectedIcons:i})},c.appendStockImageToSavedList=function(e){if(!(50<=c.cachedStockImages.length)){var t=!1;for(var i in e){var o=s(i);r(o)||(o.selected=!1,c.cachedStockImages.push(o),t=!0)}t&&c.saveStockImages(c.cachedStockImages)}};var s=function(e){for(var t in c.stockImages)if(c.stockImages[t].key==e)return c.stockImages[t]},r=function(e){for(var t in c.cachedStockImages)if(c.cachedStockImages[t].key==e.key)return!0;return!1};c.saveStockImages=function(e){i.save({tag:"",obj:e},function(e,t){})},c.showRecentUsedLabel=!1,c.getStockImages=function(){c.stockImages=[],i.get({tag:""},function(e,t){if(e)console.error(e);else if(t&&t.data){if(c.cachedStockImages=[],t.data.length&&0!=t.data.length){for(var i in t.data)t.data[i].isCached=!0,c.atLeastOneSearchMade=!0,c.cachedStockImages.push(t.data[i]);c.showRecentUsedLabel=!0}else c.stockImageSearch();c.stockImages=c.cachedStockImages}})},c.selectFile=function(e){"mediaLibraryManagement"!=c.mode&&(imageLibCurrentApp.options&&!1===imageLibCurrentApp.options.multiSelection&&c.clearSelection(),e&&(c.isImageSelected=!0,e.selected=!e.selected,e.selected?c.selectedFiles[e.key]=e.url:delete c.selectedFiles[e.key]))},c.changeFilesView=function(e){"small"!==(c.filesView=e)||c.startWith||c.getFiles()},c.selectIcon=function(e){imageLibCurrentApp.options&&!1===imageLibCurrentApp.options.multiSelection&&c.clearSelection(),e&&(c.isImageSelected=!0,e.selected=!e.selected,e.selected?c.selectedIcons[e.key]=e.class:delete c.selectedIcons[e.class])},c.selectStockImage=function(e){imageLibCurrentApp.options&&!1===imageLibCurrentApp.options.multiSelection&&c.clearSelection(),e&&(c.isImageSelected=!0,e.selected=!e.selected,e.selected?c.selectedStockImages[e.key]=e.url:delete c.selectedStockImages[e.key])},c.$watch("uploadFiles",function(){!c.uploadFiles||c.uploadFiles.length<=0||(c.uploadFiles&&1===c.uploadFiles.length?c.renameFilePopup():c.uploadFiles&&c.upload(c.uploadFiles))}),c.renameFilePopup=function(){var e=c.uploadFiles[0],t={templateUrl:"imageLibRenameAndReplaceFile.html",controller:"imageLibRenameAndReplaceFileCtrl",data:{validateFile:c.validateFile,file:e},size:"sm"};window.openDialog(t,function(e){!e||"rename"!==e.action&&"keepName"!==e.action?e&&"replace"===e.action&&c.replaceFileApi(e.existingFile,e.newFile):c.upload([e.file])})},c.replaceFileApi=function(n,e){if(n||e){if(p([e])){var t=window.siteConfig.endPoints.datastoreHost+"/app/"+imageLibCurrentApp.context.appId+"/image/replace";a.upload({url:t,fields:{},data:{existingFileKey:n.key},file:e,headers:{writeKey:imageLibCurrentApp.context.writeKey}}).progress(function(e){c.progressMessage=!0;var t=parseInt(100*e.loaded/e.total);console.log("progress: "+t+"% "+e.config.file.name),c.showMessage("showProgressMessage")}).success(function(e,t,i,o){n.url=n.url+"?cacheBuster="+Math.random();var a=c.files.findIndex(function(e){return e.key==n.key});d(n,function(e){e&&(c.files[a]=e),c.refreshFiles()}),c.addCacheBusterImage(n),c.showMessage("showSuccessMessage")}).error(function(e){c.showMessage("showErrorMessage")})}}else c.invalidFileType=!0},c.searchFiles=function(){var e={startIndex:0};c.startWith&&(e.startWith=c.startWith),c.readyToShowFiles=!1,c.loadingFiles=!0,c.getFiles(e,function(){})},c.validateFile=function(e,i){if(e){var t=window.siteConfig.endPoints.datastoreHost+"/app/"+imageLibCurrentApp.context.appId+"/validateImage";g.get(t,{params:{filename:e}}).success(function(e,t){i(e)}).error(function(e,t){i(e),console.error(e)})}},c.removeFilePopup=function(e){var t={templateUrl:"imageLibRemove.html",controller:"imageLibRemoveCtrl",data:e,size:"sm"};window.openDialog(t,c.removeFile)},c.removeStockImagePopup=function(e){var t={templateUrl:"imageLibRemove.html",controller:"imageLibRemoveCtrl",data:e,size:"sm"};window.openDialog(t,c.removeStockImage)},c.removeStockImage=function(e){void 0!==e&&null!=e&&c.cachedStockImages[e]&&c.cachedStockImages[e].key&&(c.cachedStockImages.splice(e,1),c.saveStockImages(c.cachedStockImages))},c.removeFile=function(a){if(void 0!==a&&null!=a)if(c.files[a]&&c.files[a].key){var e=window.siteConfig.endPoints.datastoreHost+"/app/"+imageLibCurrentApp.context.appId+"/image/delete";g.post(e,{key:c.files[a].key},{headers:{writekey:imageLibCurrentApp.context.writeKey}}).success(function(e,t,i,o){c.files.splice(a,1),c.refreshFiles()}).error(function(e,t,i,o){console.error(e)})}else console.log("invalid key to remove")},c.refreshFiles=function(){c.$$phase||c.$digest(),t(function(){e.gallery.refresh(),c.readyToShowFiles=!0,c.loadingFiles=!1},1e3)};var d=function(t,i){if(t)if(c.files.find(function(e){return e.url==t.url}))i&&i();else{var e=new Image;e.onload=function(e){t.actualHeight=this.height,t.actualWidth=this.width,i&&i(t)},e.onerror=function(){i&&i()};var o=t.url,a=c.checkCacheBusterImage(t);a&&(o+="?cacheBuster="+a.getTime());var n=t.key.split(".").pop();"gif"===n.toLowerCase()||"svg"===n.toLowerCase()?t.clientUrl=e.src=t.url:t.clientUrl=e.src=c.tools.resizeImage(o,{width:200,cacheBusting:!0})}else i&&i()};c.onImageHover=function(e){c.hoveredImageName=e.key.split("/").pop()},c.onImageHoverLeave=function(){c.hoveredImageName=""},c.isEditImageOptionShown=function(e){var t=e.clientUrl.split(".").pop();return"gif"!==t.toLowerCase()&&"svg"!==t.toLowerCase()},c.addCacheBusterImage=function(e){var t=window.localStorage.getItem("cacheBusterImages");t?(t=JSON.parse(t))[e.key]=new Date:(t={})[e.key]=new Date,window.localStorage.setItem("cacheBusterImages",JSON.stringify(t))},c.checkCacheBusterImage=function(e){var t=window.localStorage.getItem("cacheBusterImages");if(!t)return null;var i=(t=JSON.parse(t))[e.key];if(!i)return null;var o=new Date,a=new Date(i);return 8<Math.abs(o.getTime()-a.getTime())/36e5?(delete t[e.key],window.localStorage.setItem("cacheBusterImages",JSON.stringify(t)),null):a},c.editFile=function(r){var t={templateUrl:"imageLibReplace.html",controller:"imageLibReplaceCtrl",data:r,size:"sm"},e=c.files[r].url,i=c.checkCacheBusterImage(c.files[r]);i&&(e+="?cacheBuster="+i.getTime()),imageEditor.launchEditor("imgLibFile"+r,e,function(e,l){window.openDialog(t,function(e){var t,i,o,a,n,s;"replace"==e?(o=l,a=r,n=c.files[a],s=window.siteConfig.endPoints.datastoreHost+"/app/"+imageLibCurrentApp.context.appId+"/image/base64",c.showMessage("showProgressMessage"),g.post(s,{base64Data:o,existingImageKey:n.key},{headers:{writeKey:imageLibCurrentApp.context.writeKey}}).success(function(e){var t=angular.copy(n);t.url=n.url+"?cacheBuster="+Math.random(),d(t,function(e){e&&(c.files[a]=e),c.refreshFiles()}),c.showMessage("showSuccessMessage"),c.addCacheBusterImage(n)}).error(function(e){console.log(e),c.showMessage("showErrorMessage")})):"dontReplace"==e&&(t=l,i=window.siteConfig.endPoints.datastoreHost+"/app/"+imageLibCurrentApp.context.appId+"/image/base64",c.showMessage("showProgressMessage"),g.post(i,{base64Data:t},{headers:{writeKey:imageLibCurrentApp.context.writeKey}}).success(function(e){d({key:e.key,url:e.url,selected:!1},function(e){e&&c.files.splice(0,0,e),c.refreshFiles(),document.getElementById("media-library-upload-imgs").scrollTop=0}),c.showMessage("showSuccessMessage")}).error(function(e){console.log(e),c.showMessage("showErrorMessage")}),c.$$phase||c.$digest())})},function(e){console.log(e)})};var p=function(e){var t=!0;c.invalidFileSize=!1;for(var i=0;i<e.length;i++)if(10485760<e[i].size){t=!1,c.invalidFileSize=!0;break}return t};c.upload=function(e){var t=null;if(imageLibCurrentApp&&(t=window.siteConfig.endPoints.datastoreHost+"/app/"+imageLibCurrentApp.context.appId+"/image"),e&&e.length<1&&(c.invalidFileType=!0),e&&0<e.length){if(!p(e))return;c.hideMessage();for(var i=0;i<e.length;i++){var o=e[i];a.upload({url:t,fields:{},data:{filename:1<e.length?null:o.name},file:o,headers:{writeKey:imageLibCurrentApp.context.writeKey}}).progress(function(e){c.progressMessage=!0;var t=parseInt(100*e.loaded/e.total);console.log("progress: "+t+"% "+e.config.file.name),c.showMessage("showProgressMessage")}).success(function(e,t,i,o){console.log("file "+o.file.name+"uploaded. Response: "+e),d({key:e.key,url:e.url,selected:!1},function(e){e&&c.files.splice(0,0,e),c.refreshFiles(),document.getElementById("media-library-upload-imgs").scrollTop=0}),c.showMessage("showSuccessMessage")}).error(function(e){c.showMessage("showErrorMessage")})}}},c.onScroll=function(){c.notscrolly&&c.notEmptyData&&(c.notscrolly=!1,c.getFiles())};var u=[],m=[],o=!0;c.getFiles=function(e,n){if(c.notEmptyData=!0,imageLibCurrentApp){if(2<u.length)return void(c.loadingFiles=!0);var t=window.siteConfig.endPoints.datastoreHost+"/app/"+imageLibCurrentApp.context.appId+"/image";e||(e={}),void 0===e.startIndex?c.files&&c.files.length&&(e.startKey=c.files[c.files.length-1].key):c.files=[],c.startWith&&(e.startWith=c.startWith),o&&(c.loadingFiles=!0),o=!1,g.get(t,{params:e}).success(function(t){var o=20;function a(){if(u&&!(u.length<1))for(var e=0,t=0;e<o&&u&&!(u.length<1);){e++;var i=u.splice(0,1);i&&i[0]&&d(i[0],function(e){t++,e&&m.push(e),(o<=t||u.length<1)&&setTimeout(function(){for(var t=0;t<m.length;t++)c.files.find(function(e){return e.url==m[t].url})||c.files.push(m[t]);m=[],c.refreshFiles(),setTimeout(function(){a()},100)},10)})}}0<t.length&&0<c.files.length&&(c.files.find(function(e){return e.key===t[t.length-1].key})&&(console.log("match"),c.notEmptyData=!1));for(var e=0;e<t.length;e++){var i=t[e];i.selected=!1,u.push(i)}0<u.length&&(c.loadingFiles=!0,a()),(!t||t.length<=0)&&(c.notEmptyData=!1,c.loadingFiles=!1,c.readyToShowFiles=!0),c.notscrolly=!0,n&&n(null,t)}).error(function(e,t,i,o){console.error(e),n&&n(e,null)})}else n&&n({msg:"Invalid folder"},null)},void 0!==imageLibCurrentApp&&(imageLibCurrentApp.options||(imageLibCurrentApp.options={}),c.iconsShown=!(!1===imageLibCurrentApp.options.showIcons),c.filesShown=!(!1===imageLibCurrentApp.options.showFiles),c.stockShown=!(!1===imageLibCurrentApp.options.showStockImages),c.mode=imageLibCurrentApp.options.mode,c.stockShown&&(window.appContext&&window.appContext.currentApp&&window.appContext.currentApp.appId&&window.appContext.currentApp.keys&&window.appContext.currentApp.keys.datastoreKey?i=new DatastoreAPI({appId:window.appContext.currentApp.appId,pluginId:"stockImages",instanceId:"stockImages",liveMode:0,writeKey:window.appContext.currentApp.keys.datastoreKey}):(imageLibCurrentApp.options.showStockImages=!1,c.stockShown=!1,console.error("stockImages error: missing appId or datastoreKey")))),"mediaLibraryManagement"===c.mode?c.filesView="large":c.filesView="small",c.stockShown&&(c.activeTab=2,c.activeStockImages(),c.getStockImages()),c.iconsShown&&(c.activeTab=0,g.get(siteConfig.endPoints.appHost+"/styles/bootstrapIcons.css").success(function(e){var t=angular.element(document.querySelector("#iconsFrame"))[0],n=t.contentDocument;if(!n&&t&&t.contentWindow&&t.contentWindow.document&&(n=t.contentWindow.document),n){var i,o="<style id='iconStyle' type='text/css'>"+e+"</style>";n.head.innerHTML=o;var s=0,a=function(){s++;try{for(var e=n.styleSheets[n.styleSheets.length-1],t=e.rules||e.cssRules,i=[],o=0;o<t.length;o++)if(void 0!==t[o].selectorText&&0==t[o].selectorText.indexOf(".glyphicon-")){var a=t[o].selectorText.replace(".glyphicon-","");a=(a=(a=(a=a.replace("::before","")).replace(":before","")).replace(":after","")).replace("::after",""),i.indexOf(a)<0&&i.push({key:"glyphicon glyphicon-"+a,class:"glyphicon glyphicon-"+a,selected:!1})}c.icons=i}catch(e){if(10==s&&(c.stopInterval(),console.error("stop trying")),e&&"InvalidAccessError"==e.name)return void console.warn("icons css document not parsed yet");console.error(e)}c.stopInterval()};c.stopInterval=function(){angular.isDefined(i)&&(l.cancel(i),i=void 0)},i=l(a,50),a()}else console.warn("innerDoc was not found")}),c.activeIcons()),c.filesShown&&(c.activeTab=1,c.activeFiles(),c.getFiles({startIndex:0},function(){})),c.currentStockImagePage=1,c.totalStockImagesPages=1,c.showNoResultLabel=!1,c.atLeastOneSearchMade=!1,c.stockImageSearch=function(){c.selectedStockImages={},c.stockImages=[],c.currentStockImagePage=1,c.retrieveStockImage()},c.retrieveStockImage=function(){if(c.stockImagesKeyword){var e=c.stockImagesKeyword?escape(c.stockImagesKeyword):"";c.loadingStockImage=!0,c.atLeastOneSearchMade=!0,g.post(siteConfig.endPoints.appHost+"/api/stockImages/search",{query:e,page:c.currentStockImagePage}).success(function(e){c.showRecentUsedLabel=!1,c.totalStockImagesPages=e.totalPages;var t=(new Date).getTime();c.showNoResultLabel=0==e.images.length;for(var i=0;i<e.images.length;i++){var o={key:t+"_"+i,url:e.images[i].urls.regular,imageId:e.images[i].imageId,photographerName:e.images[i].photographerName,selected:!1};c.stockImages.push(o)}c.loadingStockImage=!1}).error(function(e){console.error(e),c.loadingStockImage=!1})}},c.loadMoreStockImages=function(){c.stockActive&&!c.loadingStockImage&&c.totalStockImagesPages!=c.currentStockImagePage&&(c.currentStockImagePage++,c.retrieveStockImage())};var f=function(e){var t=[];for(var i in e){var o=s(i);o.imageId&&t.push(o.imageId)}0<t.length&&g.post(siteConfig.endPoints.appHost+"/api/stockImages/view",{ids:t}).success(function(e){}).error(function(e){})}}]),$app.controller("imageLibReplaceCtrl",["$scope","$http","$dialog","$data",function(e,t,i,o){e.close=function(){i.close(null)},e.confirm=function(e){i.close(e)}}]),$app.controller("imageLibRenameAndReplaceFileCtrl",["$scope","$http","$dialog","$data",function(t,e,i,o){t.dialogOptions={},t.dialogOptions.title="Rename Image",t.dialogOptions.action="renameOption",t.file=i.options.data.file,t.validateFile=i.options.data.validateFile,t.newFilename="",t.showErrorMessage=!1,t.errorMessage="",t.renameLoading=!1,t.keepNameLoading=!1,t.close=function(){i.close(null)},t.doAction=function(e){switch(t.errorMessage="",e){case"rename":"rename"!==t.dialogOptions.action?(t.dialogOptions.title="Rename Image",t.dialogOptions.action="rename"):t.rename();break;case"replace":t.replace();break;case"keepName":t.keepName()}},t.rename=function(){if(t.newFilename&&t.newFilename.replace(/\s/g,"")){if(t.file||t.newFilename){-1!==t.newFilename.lastIndexOf(".")&&(t.newFilename=t.newFilename.substring(0,t.newFilename.lastIndexOf(".")));var e="."+t.file.name.split(".").pop();Object.defineProperty(t.file,"name",{writable:!0,value:t.newFilename+e}),t.renameLoading=!0,t.validateFile(t.file.name,function(e){t.renameLoading=!1,e&&e.isInvalidFilename?t.errorMessage="Wrong, A file name can't contains any of the following characters:  < > : \" / \\ | ? *":e&&!e.isFileExist?i.close({action:"rename",file:t.file}):(t.dialogOptions.action="replaceOption",t.dialogOptions.title="Name already in use",t.existingFile=e.file)})}}else t.showErrorMessage=!0},t.replace=function(){(t.existingFile||t.file)&&i.close({action:"replace",newFile:t.file,existingFile:t.existingFile})},t.keepName=function(){t.clear(),t.keepNameLoading=!0,t.validateFile(t.file.name,function(e){t.keepNameLoading=!1,e&&!e.isFileExist?i.close({action:"keepName",file:t.file}):(t.dialogOptions.action="replaceOption",t.existingFile=e.file)})},t.clear=function(){t.showErrorMessage=!1}}]);
"use strict";function ColorLibAPI(o){this.context={},angular.copy(o,this.context),this.init()}ColorLibAPI.prototype={init:function(){},showDialog:function(t,e){var r=this;t||(t={});var o="";window.siteConfig&&window.siteConfig.endPoints&&window.siteConfig.endPoints.appHost&&(o=window.siteConfig.endPoints.appHost);var i={templateUrl:o+"/pages/colorLib/colorLib.html",controller:"colorLibCtrl",size:"sm",backdrop:t.backdrop,position:t.position,data:{options:t,onChange:function(o,t){r._onChange&&r._onChange(t)}}};window.openDialog(i,function(o){e&&e(null,o||t.data)})},onChange:function(o){this._onChange=o}},$app.controller("colorLibCtrl",["$scope","$dialog","$data","$window",function(r,o,i,t){r.tools=ImageLibAPI.tools,r.appHost=window.siteConfig.endPoints.appHost,i.options||(i.options={}),r.gradientTypes={"to bottom":"Bottom","to right":"Right","to top left":"Top Left","to top right":"Top Right","to top":"Top","to left":"Left","to bottom left":"Bottom Left","to bottom right":"Bottom Right"},!i.options.data||angular.equals(i.options.data,{})?r.items={gradient:{colors:[{color:"",percentage:0,opacity:100},{color:"",percentage:100,opacity:100}],gradientType:"to bottom"},solid:{color:"",opacity:100}}:(r.items={},angular.copy(i.options.data,r.items),r.items.gradient||(r.items.gradient={colors:[{color:"",percentage:0,opacity:100},{color:"",percentage:100,opacity:100}],gradientType:"to bottom"}),r.items.solid||(r.items.solid={color:"",opacity:100})),r.colorTypes={};var e=r.items.colorType;function c(o,t){o||(o="#ffffff"),void 0===t&&(t=100);var e,r,i=o.substring(0,7);return r=t,e=(e=i).replace("#",""),"rgba("+parseInt(e.substring(0,2),16)+","+parseInt(e.substring(2,4),16)+","+parseInt(e.substring(4,6),16)+","+r/100+")"}i.options.hideGradient?e="gradient"===e?null:"solid":(r.colorTypes.gradient="Gradient",e||(e="gradient")),i.options.hideSolid?e="solid"===e?null:"gradient":r.colorTypes.solid="Solid",r.items.colorType=e,angular.element(t).bind("mousedown",function(){r.config={},r.$apply()}),r.$watch("items.gradient",function(o,t){if(o){o.colors&&o.colors[0]&&o.colors[0].color&&-1<o.colors[0].color.indexOf("#")&&(o.colors[0].colorHex=o.colors[0].color),o.colors&&o.colors[0]&&(void 0===o.colors[0].percentage&&(r.items.gradient.colors[0].percentage=o.colors[0].percentage=0),void 0===o.colors[0].opacity&&(r.items.gradient.colors[0].opacity=o.colors[0].opacity=100)),r.items.gradient.colors[0].color=c(o.colors[0].colorHex,o.colors[0].opacity),o.colors&&o.colors[1]&&o.colors[1].color&&-1<o.colors[1].color.indexOf("#")&&(o.colors[1].colorHex=o.colors[1].color),o.colors&&o.colors[1]&&(void 0===o.colors[1].percentage&&(r.items.gradient.colors[1].percentage=o.colors[1].percentage=100),void 0===o.colors[1].opacity&&(r.items.gradient.colors[1].opacity=o.colors[1].opacity=100)),r.items.gradient.colors[1].color=c(o.colors[1].colorHex,o.colors[1].opacity);var e="background: linear-gradient({gradientType}, {colorOne} {colorOnePercentage}%, {colorTwo} {colorTwoPercentage}%)";e=(e=(e=(e=(e=e.replace("{gradientType}",o.gradientType)).replace("{colorOne}",o.colors[0]?o.colors[0].color:"")).replace("{colorOnePercentage}",o.colors[0]?o.colors[0].percentage:0)).replace("{colorTwo}",o.colors[1]?o.colors[1].color:"")).replace("{colorTwoPercentage}",o.colors[1]?o.colors[1].percentage:100),r.items.gradient.backgroundCSS=e,i.onChange&&i.onChange(null,r.items)}},!0),r.$watch("items.solid",function(o,t){o&&(o.color&&-1<o.color.indexOf("#")&&(o.colorHex=o.color),r.items.solid.color=c(o.colorHex,o.opacity),r.items.solid.backgroundCSS="background: "+r.items.solid.color,r.items.solid.colorCSS="color: "+r.items.solid.color,i.onChange&&i.onChange(null,r.items))},!0),r.$watch("items.colorType",function(o,t){o&&i.onChange&&i.onChange(null,r.items)},!0),r.save=function(){o.close(r.items)},r.closeDialog=function(){o.close(null)}}]);
"use strict";var PopupLibAPI={confirm:function(t,e){t||(t={}),!1!==t.allowHtml&&(t.allowHtml=!0),t.message?(t.confirmButton||(t.confirmButton={text:"Confirm",type:"primary",key:"confirm"}),t.confirmButton.text||(t.confirmButton.text="Confirm"),t.confirmButton.key||(t.confirmButton.key="confirm"),t.confirmButton.type||(t.confirmButton.type="primary"),t.cancelButton||(t.cancelButton={text:"Cancel",type:"default",key:"cancel"}),t.cancelButton.text||(t.cancelButton.text="Cancel"),t.cancelButton.key||(t.cancelButton.key="cancel"),t.cancelButton.type||(t.cancelButton.type="default"),PopupLibAPI.showDialog({title:t.title||"Are you sure?",message:t.message,buttons:[t.confirmButton,t.cancelButton],size:t.size},e)):e("invalid parameter, missing message",null)},alert:function(t,e){t||(t={}),!1!==t.allowHtml&&(t.allowHtml=!0),t.message?(t.okButton||(t.okButton={text:"OK",type:"primary",key:"ok"}),t.okButton.text||(t.okButton.text="OK"),t.okButton.key||(t.okButton.key="ok"),t.okButton.type||(t.okButton.type="primary"),PopupLibAPI.showDialog({title:t.title||"Alert",message:t.message,buttons:[t.okButton],size:t.size},e)):e("invalid parameter, messing message",null)},showDialog:function(t,e){if(t||(t={}),!1!==t.allowHtml&&(t.allowHtml=!0),t.title){if(t.buttons&&0<t.buttons.length)for(var o=0;o<t.buttons.length;o++){if(!t.buttons[o].text)return void e("invalid parameter, missing text button");if(!t.buttons[o].key)return void e("invalid parameter, missing key button");t.buttons[o].type||(t.buttons[o].type="default")}else t.buttons=[];var n="";window.siteConfig&&window.siteConfig.endPoints&&window.siteConfig.endPoints.appHost&&(n=window.siteConfig.endPoints.appHost);var i={templateUrl:n+"/pages/popupLib/popupLib.html",controller:"popupLibCtrl",size:t.size||"sm",data:t};window.openDialog(i,function(t){e&&e(null,t)})}else e("invalid parameter, messing title",null)}};$app.controller("popupLibCtrl",["$scope","$dialog","$data","$sce",function(t,o,e,n){t.allowHtml=e.allowHtml,t.popupData=e,t.popupData.message=n.trustAsHtml(e.message),t.message=e.message,t.title=e.title,t.buttons=e.buttons,t.size=e.size,t.subtitle=e.subtitle,t.hideCloseIcon=e.hideCloseIcon,t.closeDialog=function(){o.close(null)},t.selectedButton=function(t){var e={};t&&(e.selectedButton=angular.copy(t)),o.close(e)}}]);
"use strict";$app.factory("commonPluginService",["$http","promoService","$location",function(l,o,r){var u={redirect:function(n,e){r.path(n).search("token",e).search("showHeader",!1).search("pluginTypeId",null).search("folderName",null)},redirectToActivePlugins:function(n){u.redirect("/activePlugins",n)},addPlugin:function(n){u.redirect("/addPlugin",n)},getPluginJson:function(n,e,t){var i=window.siteConfig.endPoints.pluginHost+"/"+n+"/plugin.json?v="+(e||"");l.get(i).success(function(n){t(null,n)}).error(function(n){t(n)})},getMatchingInstances:function(e,n){return n.filter(function(n){return e==n.token})},filteredPluginInstances:function(n,t){o.getPluginInstances(n,function(n,e){n?t(n):(e=e.map(function(n){return n.data}).map(function(n){return{instanceId:n.instanceId,pluginTypeId:n.pluginTypeId,token:n.token,title:n.title}}),t(null,e))})},redirectToInstance:function(n){var e=n.token,t=n.pluginInstanceId,i=n.pluginTitle,l=n.folderName,a="/pluginControl/{1}/{2}/{3}/{4}/false";a=a.replace("{1}",e).replace("{2}",t).replace("{3}",i).replace("{4}",l),r.path(a)},instanceExists:function(i,l){var a={isInUse:!1};u.getPluginJson(i.folderName,i.lastUpdatedOn,function(n,e){n?l(n):e.singleton?o.getPluginInstances(i,function(n,e){if(n)l(n);else{var t=e.filter(function(n){return n.data.pluginTypeId==i.pluginTypeId});0<t.length&&(a.isInUse=!0,a.matches=t),l(null,a)}}):l(null,a)})}};return u.clone=function(a,o,r){if(o&&o.data){a||(a={});var n={domain:window.siteConfig.endPoints.datastoreHost,appId:appContext.currentApp.appId,folderName:o.data._buildfire.pluginType.result[0].folderName,pluginTypeId:o.data._buildfire.pluginType.result[0].pluginTypeId};u.instanceExists(n,function(n,e){if(n)console.error(n);else if(e.isInUse){var t=e.matches[0].data,i={token:t.token,pluginInstanceId:t.instanceId,pluginTitle:t.title,folderName:t._buildfire.pluginType.result[0].folderName};!1===a.allowSingletonRedirection?window.PopupLibAPI.alert({title:"Singleton Feature",message:"Singleton feature already exist!"},function(n,e){}):(toast("Singleton. Redirecting to instance.","warning"),u.redirectToInstance(i))}else{var l;l={templateUrl:"/pages/plugins/clonePlugin/clonePluginDialog.html",controller:"clonePluginDialogCtrl",size:"sm",data:{plugin:angular.fromJson(angular.toJson(o)),includePluginData:a.includePluginData}},window.openDialog(l,function(n){n&&r(n)})}})}},u.navigateToPlugin=function(n){var e={token:n.data._buildfire.pluginType.result[0].token,pluginInstanceId:n.data.instanceId||n.data.refId,pluginTitle:n.data.title,folderName:n.data._buildfire.pluginType.result[0].folderName};u.redirectToInstance(e)},u}]);
"use strict";$app.controller("openDialogCtrl",["$uibModal",function(n){function l(o,e){this.modalInstance=null,this.options=o,this.callback=e}l.prototype.open=function(o){var e=this,t=o||this.options;this.modalInstance=n.open({animation:!0,windowClass:t.position||"",templateUrl:t.templateUrl,controller:t.controller,size:t.size,backdrop:void 0===t.backdrop||t.backdrop,keyboard:void 0===t.keyboard||t.keyboard,resolve:{$data:function(){return t.data},$dialog:function(){return e}}}),this.modalInstance.result.then(function(o){e.callback&&e.callback(o)},function(){t.useCallbackWhenNoAction&&e.callback&&e.callback()})},l.prototype.close=function(o){this.modalInstance.close(o)},window.openDialog=function(o,e){if(!o)throw"options have not been provided to openDialog";o.controller||console.warn("window.openDialog :: You have to pass the controller value to the openDialog function");var t=window._appRoot||"";o.controller=o.controller||"modalCtrl",o.templateUrl=o.templateUrl||t+"pages/templates/modal.html";var n=new l(o,e);return n.open(),n}}]).directive("googleLangOptions",function(){return{restrict:"A",link:function(o,e,t){window.googleTranslateLoadedCallback=function(){console.log("loaded google translate widget ..............");var o=document.querySelector("iframe.goog-te-menu-frame"),e=(o.contentDocument||o.contentWindow.document).querySelector("body"),t=document.createElement("link");t.rel="stylesheet",t.href="/styles/googleTranslate.css",e.appendChild(t)}}}});
"use strict";$app.controller("pluginInstanceDialog",["$scope","$data","$dialog",function(t,e,n){t.showPluginInstances=!0,t.showAddPlugin=!1,t.hideAddPlugin=!1,t.skipPluginInstances=!1,t.hideAddToSideMenuCheckbox=!1,t.selectedPluginsInstances=[],e&&e.options&&(e.options.skipPluginInstances&&(t.showPluginInstances=!1,t.showAddPlugin=!0,t.skipPluginInstances=!0),e.options.hideAddPlugin&&(t.hideAddPlugin=e.options.hideAddPlugin),e.options.hideAddToSideMenuCheckbox&&(t.hideAddToSideMenuCheckbox=e.options.hideAddToSideMenuCheckbox)),t.cancel=function(){n.close(null)},t.close=function(e){n.close(e)},t.goToPluginInstances=function(){var e=(0<arguments.length&&void 0!==arguments[0]?arguments[0]:{}).selectedPluginInstance,n=void 0===e?null:e;t.showAddPlugin=!1,t.showPluginInstances=!0,n&&t.selectedPluginsInstances.push(n)},t.goToAddPluginDialog=function(){t.showPluginInstances=!1,t.showAddPlugin=!0},t.refreshPluginInstances=function(){t.$broadcast("searchPluginInstances",{})}}]),$app.controller("pluginInstanceSearchCtrl",["$scope","$rootScope","$analytics","commonPluginService","addPluginService",function(r,e,n,t,g){r.contextOptions={allowAddFeatureBtn:!0,showCloneBtn:!0};var i={controller:"pluginInstanceDialog",appId:window.appContext.currentApp.appId,liveMode:window.appContext.currentApp.liveMode,pluginId:"pluginInstances",instanceId:1,writeKey:appContext.currentApp.keys.datastoreKey};r.tools=ImageLibAPI.tools,appContext.currentApp.config&&(r.marketplaceButton=appContext.currentApp.config.marketplaceButton),r.data={},r.tools=ImageLibAPI.tools;var I=new DatastoreAPI(appContext.currentApp.appId,"pluginInstances",1,0,appContext.currentApp.keys.datastoreKey);new PluginInstanceAPI(i);r.getPluginInstances=function(e,t,i,o){var n=e.searchName,a=e.instanceIds;r.loading=!0;var l=function(e){var n={obj:{filter:e,page:i-1,pageSize:t,withDynamicData:!0,recordCount:!0},tag:""};I.search(n,function(e,n){if(e)o&&o(e,null);else{for(var t=n.result?n.result:[],i=t.filter(function(n){return!r.pluginInstances.find(function(e){return e.data.instanceId===n.data.instanceId})}),a=0;a<i.length;a++)i[a]&&i[a].data&&i[a].data.instanceId&&null!=r.instances[i[a].data.instanceId]&&(i[a].selected=!0);r.totalItems=n.totalRecord,r.pluginInstances=r.pluginInstances.concat(i),0===t.length&&(r.notEmptyData=!1),r.notscrolly=!0,r.loading=!1,o&&o(null,t)}})},s={"$json.title":{$regex:null!=n?n:"",$options:"-i"}};a&&0<a.length&&(s["$json.instanceId"]={$in:a});var d={$or:[s]};if(!n)return l(d);var p,c,u=[];(p=n,c={pluginTypeName:p,appId:appContext.currentApp.appId,whitelabelId:window.whitelabelContext.whitelabelId,reload:!g.miniSearchLoaded,fuzzy:.2,fields:["pluginTypeName"]},new Promise(function(t,i){g.searchAppPluginTypes(c,function(e,n){if(e)return i(e);t(n)})})).then(function(e){e.plugins.forEach(function(e){u.push({"$json.pluginTypeId":e.pluginTypeId})}),u&&0<u.length&&d.$or.push({$or:u}),l(d)})},r.save=function(){var e=[];for(var n in r.instances)r.instances.hasOwnProperty(n)&&e.push(r.instances[n]);r.close(e)};var a=void 0;function o(){if(r.$parent&&r.$parent.selectedPluginsInstances&&0<r.$parent.selectedPluginsInstances.length){var t=r.$parent.selectedPluginsInstances.map(function(e){return e.instanceId});r.getPluginInstances({instanceIds:t},r.pageSize,1,function(e,n){n&&0<n.length&&r.pluginInstances.forEach(function(e,n){-1<t.indexOf(e.data.instanceId)&&(e.selected=!0,r.onSelectPlugin(e,!0),r.pluginInstances.splice(n,1),r.pluginInstances.unshift(e))})})}}r.search=function(){r.loading=!0,r.pluginInstances=[],clearTimeout(a),a=setTimeout(function(){r.notEmptyData=!0,r.notscrolly=!1,r.pageIndex=1,r.setPage()},500)},r.clone=function(e){t.clone({allowSingletonRedirection:!1},e,function(e){r.search()})},r.onSelectPlugin=function(e,n){var t=e.pluginInstance?e.pluginInstance:e;void 0===t.selected||n?t.selected=!0:t.selected=!t.selected;var i=t.data.instanceId,a=t.data.iconUrl,o=t.data._buildfire.pluginType.result[0].token,l=t.data._buildfire.pluginType.result[0].folderName,s=t.data._buildfire.pluginType.result[0].name,d=t.data.title,p=t.data.iconClassName;if(t.selected){var c={instanceId:i,iconUrl:a,title:d,pluginTypeId:o,pluginTypeName:s,folderName:l,iconClassName:p};r.instances[c.instanceId]=c}else delete r.instances[i]},r.setPage=function(e){r.getPluginInstances({searchName:r.level.pluginTitle},r.pageSize,r.pageIndex,e)},r.onScroll=function(){r.notscrolly&&r.notEmptyData&&(r.notscrolly=!1,r.pageIndex++,r.setPage())},r.init=function(){r.instances={},r.level={},r.pageIndex=1,r.pageSize=40,r.maxSize=20,r.loading=!1,r.notEmptyData=!0,r.notscrolly=!1,r.level.pluginTitle="",r.pluginInstances=[],r.setPage(function(){o()})},r.init(),e.$on("plugin-instance-created",function(e,n){r.setPage(function(){o()})})}]),$app.controller("addPluginInstanceCtrl",["$scope","$rootScope","$http","$analytics","commonPluginService",function(s,n,d,p,c){s.pluginHost=window.siteConfig.endPoints.pluginHost,s.tools=ImageLibAPI.tools;var u=new DatastoreAPI(appContext.currentApp.appId,"pluginInstances",1,0,appContext.currentApp.keys.datastoreKey),i=new DatastoreAPI(appContext.currentApp.appId,"sideMenu",1,0,appContext.currentApp.keys.datastoreKey),e=function(e,n,t){var i=window.siteConfig.endPoints.appHost+"/api/appPluginTypes/search",a=localStorage.getItem("user");a?(a=JSON.parse(a),d.get(i,{headers:{auth:a.auth,userToken:a.userToken},params:{appId:window.appContext.currentApp.appId,pluginTypeName:e,pageSize:n,pageIndex:t}}).success(function(e){s.plugins=e.data,s.totalItems=e.total})):(s.plugins=[],s.totalItems=0)};s.openAddPageDialog=function(l){if(l){var a=function(n){"addPage"==n.operation&&null!=n.title&&d.get("/api/appPluginTypes/validateToAdd",{params:{appId:window.appContext.currentApp.appId,token:l.token}}).success(function(e){e&&e.isActive?t(n):toast("Invalid to add, the plugin is inactive","danger")})},t=function(e){if("addPage"==e.operation&&null!=e.title){var n=e.title,i=e.addToSideMenu,a=(window.appContext.currentApp.appId,l.token,e.title,l.folderName,l.token+"-"+Date.now()),o={tag:"",obj:{pluginTypeId:l.pluginTypeId,token:l.token,title:n,instanceId:a,refId:a,iconUrl:window.siteConfig.endPoints.pluginHost+"/"+l.folderName+"/resources/icon.png",_buildfire:{pluginType:{dataType:"pluginType",data:l.token}}}};u.insert(o,function(e,n){if(e)console.log(e);else{p.eventTrack("cp/pluginInstanceAdded",{pluginTypeId:l.pluginTypeId,pluginTypeName:l.pluginTypeName,marketItemId:l.marketItemId});var t={instanceId:a,iconUrl:window.siteConfig.endPoints.pluginHost+"/"+l.folderName+"/resources/icon.png",title:o.obj.title,pluginTypeId:l.token,pluginTypeName:l.pluginTypeName,folderName:l.folderName,iconClassName:null};i&&(s.hideAddToSideMenuCheckbox||s.addToSideMenu(t)),s.close([t])}})}},o={templateUrl:"addPage.html",controller:"addPageDialogCtrl",size:"sm",data:{options:{hideAddToSideMenuCheckbox:s.hideAddToSideMenuCheckbox}}},e={domain:window.siteConfig.endPoints.datastoreHost,appId:appContext.currentApp.appId,folderName:l.folderName,pluginTypeId:l.pluginTypeId,lastUpdatedOn:l.lastUpdatedOn};c.instanceExists(e,function(e,n){if(e)console.error(e);else if(n.isInUse){var t=n.matches[0].data,i={token:t.token,pluginInstanceId:t.instanceId,pluginTitle:t.title,folderName:t._buildfire.pluginType.result[0].folderName};s.close(),toast("Singleton. Redirecting to instance.","warning"),c.redirectToInstance(i)}else window.openDialog(o,a)})}},s.setPage=function(){e(s.pluginTypeName,s.pageSize,s.pageIndex)},s.addToSideMenu=function(e){s.sideMenu.result.push({id:e.instanceId,data:e}),s.sideMenu.data.push(e.instanceId),t(s.sideMenu)};var t=function(e){if(null!=e){var n={_buildfire:{sideMenu:e}},t=n._buildfire.sideMenu.result;n._buildfire.sideMenu.result&&delete n._buildfire.sideMenu.result,i.save({tag:"",obj:n},function(e,n){e||!n?alert(JSON.stringify(e)):(emulatorSync.triggerSideMenuOnUpdate(n),console.log("data saved"))}),e.result=t}};s.init=function(){s.totalItems=100,s.pageIndex=1,s.pageSize=10,s.maxSize=5,e(s.pluginTypeName,s.pageSize,s.pageIndex),s.sideMenu={dataType:"pluginInstance",data:[]},i.get({withDynamicData:!0},function(e,n){if(n){if(n.data&&n.data._buildfire&&n.data._buildfire.sideMenu){var t=n.data._buildfire.sideMenu;t.content&&t.content.loadAllPlugins||(t.result=(i=t.result,a=t.data,i.sort(function(e,n){var t=a.indexOf(e.data.instanceId),i=a.indexOf(n.data.instanceId);return i<t?1:t<i?-1:0}),i)),s.sideMenu=t}s.id=n.id,s.$$phase||s.$digest()}var i,a})},s.onCreateNewPlugin=function(e){if(e&&e.obj&&e.obj.instanceId)s.$parent&&s.$parent.goToPluginInstances&&(s.$parent.goToPluginInstances({selectedPluginInstance:{title:e.obj.title,instanceId:e.obj.instanceId}}),n.$broadcast("plugin-instance-created",{}));else{window.openDialog({templateUrl:"addPage.html",controller:"addPageDialogCtrl",size:"sm"}),s.$$phase||s.$digest()}},s.onCreateSingletonPlugin=function(){window.PopupLibAPI.alert({title:"Singleton Feature",message:"Singleton feature already exist!"},function(e,n){})},s.init()}]),$app.controller("addPageDialogCtrl",["$scope","$dialog",function(e,n){e.addPage=function(){n.close({operation:"addPage",title:e.title})},e.closeDialog=function(){n.close({operation:"close",title:""})}}]);
"use strict";function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}"undefined"==typeof ActionItemsAPI&&(window.ActionItemsAPI=function(e){this.templateUrl="pages/share/actionBuilder.html",this.controller="actionItemsCtrl",this.context=e,this.init()}),ActionItemsAPI.prototype.init=function(){},ActionItemsAPI.prototype.showDialog=function(e,t){var n={templateUrl:this.templateUrl,controller:this.controller,size:"lg",data:e};window.openDialog(n,function(e){t&&t(null,e)})},$app.controller("actionItemsCtrl",["$scope","$data","$dialog",function(g,e,t){g.appConfig=window.appContext.currentApp.config,g.$dialog=t,g.showTitle=!1,g.tools=ImageLibAPI.tools,g.selectedItemAction=null,g.showCommunicationServices=!1,g.showSocialMedia=!1,g.appHost="",window.siteConfig&&window.siteConfig.endPoints&&window.siteConfig.endPoints.appHost&&"sdk"==window.siteConfig.scope&&(g.appHost=window.siteConfig.endPoints.appHost),g.originalActionItem={},g.init=function(){g.errors={},g.actionItem={},g.options={},g.actionItemAlreadyHasIcon=!1,e&&e.options&&(g.options=e.options,g.options.showTitle?(g.displayTitle="Display Title",g.showTitle=g.options.showTitle):g.displayTitle="Action Button Text",e.options.actionTextLabel&&(g.displayTitle=e.options.actionTextLabel),void 0!==e.options.allowNoAction?g.options.allowNoAction=e.options.allowNoAction:g.options.allowNoAction=!0,void 0!==e.options.removePurchase?g.options.removePurchase=e.options.removePurchase:g.options.removePurchase=!1),"enabled"!=g.appConfig.inAppPurchases&&(g.options.removePurchase=!0),g.actionItemsList=[{title:"App Sections",icon:g.appHost+"/images/ai_app_content.svg",type:"parent",show:!0,enabled:!0,children:[{title:"App Content",actionName:"linkToApp",show:!0,enabled:!0,image:g.appHost+"/images/ai_app_content.svg",description:"This action will link the user to App Content."},{title:"App Settings",actionName:"navigateToAppSettings",show:!0,enabled:!0,image:g.appHost+"/images/ai_settings.svg",description:"This action will link the user  to the  App Settings screen."},{title:"Bookmarks",actionName:"navigateToBookmarks",show:!0,enabled:!0,image:g.appHost+"/images/ai_bookmarks.svg",description:"This action will link the user to the Bookmarks screen."},{title:"Notifications",actionName:"navigateToNotifications",show:!0,enabled:!0,image:g.appHost+"/images/ai_notifications.svg",description:"This action will link the user to the Notifications screen."},{title:"Notes",actionName:"navigateToNotes",show:!0,enabled:!0,image:g.appHost+"/images/ai_notes.svg",description:"This action will link the user to the Notes screen."},{title:"Search",actionName:"navigateToSearch",show:!0,enabled:"enterprise"==g.appConfig.type,image:g.appHost+"/images/ai_search.svg",description:"This action will link the user to the Search screen."},{title:"Login",actionName:"navigateToLogin",show:!0,enabled:!0,image:g.appHost+"/images/ai_login.svg",description:"This action will link the user to the Login screen."}]},{title:"Contact",icon:g.appHost+"/images/ai_communication.svg",type:"parent",show:!0,enabled:!0,children:[{title:"Send an Email",actionName:"sendEmail",show:!0,enabled:!0,image:g.appHost+"/images/ai_email.svg",description:"This action will link the user to send an Email."},{title:"Send SMS Text Message",actionName:"sendSms",show:!0,enabled:!0,image:g.appHost+"/images/ai_sms.svg",description:"This action will link the user to send an SMS text message."},{title:"Call Phone Number",actionName:"callNumber",show:!0,enabled:!0,image:g.appHost+"/images/ai_phone.svg",description:"This action will link the user to call a phone number."}]},{title:"Map",actionName:"navigateToAddress",icon:g.appHost+"/images/ai_map.svg",image:g.appHost+"/images/ai_map.svg",type:"item",show:!0,enabled:!0,description:"This action will link the user to a location in a map."},{title:"Purchase",actionName:"purchase",icon:g.appHost+"/images/ai_purchase.svg",image:g.appHost+"/images/ai_purchase.svg",type:"item",show:!g.options.removePurchase,enabled:!0,description:"This action will link the user to in app purchases."},{title:"Social Media",icon:g.appHost+"/images/ai_social_media.svg",type:"parent",show:!0,enabled:!0,children:[{title:"Facebook Page",actionName:"linkToSocialFacebook",show:!0,enabled:!0,image:g.appHost+"/images/ai_facebook.png",description:"This action will link the user to a Facebook page."},{title:"Twitter Page",actionName:"linkToSocialTwitter",show:!0,enabled:!0,image:g.appHost+"/images/ai_twitter.png",description:"This action will link the user to a Twitter page."},{title:"Instagram Page",actionName:"linkToSocialInstagram",show:!0,enabled:!0,image:g.appHost+"/images/ai_instagram.png",description:"This action will link the user to a Instagram page."},{title:"LinkedIn Page",actionName:"linkToSocialLinkedIn",show:!0,enabled:!0,image:g.appHost+"/images/ai_linkedin.png",description:"This action will link the user to a LinkedIn page."}]},{title:"Web Content",actionName:"linkToWeb",icon:g.appHost+"/images/ai_web_content.svg",image:g.appHost+"/images/ai_web_content.svg",type:"item",show:!0,enabled:!0,description:"This action will link the user to web content."},{title:"No Action",actionName:"noAction",icon:g.appHost+"/images/ai_no_action.svg",image:g.appHost+"/images/ai_no_action.svg",type:"item",show:!0,enabled:g.options.allowNoAction,hasDivider:!0,description:"This action will link the user to no action."}],e&&e.actionItem&&e.actionItem.action?(g.actionItem=e.actionItem,Object.assign(g.originalActionItem,e.actionItem),(e.actionItem.iconUrl||e.actionItem.iconClassName)&&(g.actionItemAlreadyHasIcon=!0),n(g.actionItem.action)):n("linkToApp")};var n=function(e){var t=null,n=!0,i=!1,o=void 0;try{for(var a,l=g.actionItemsList[Symbol.iterator]();!(n=(a=l.next()).done);n=!0){var s=a.value;if("parent"!==s.type&&s.actionName===e)return t=s,void g.changeAction(t);if("parent"===s.type&&s.children){var r=!0,c=!1,p=void 0;try{for(var d,u=s.children[Symbol.iterator]();!(r=(d=u.next()).done);r=!0){var m=d.value;if(m.actionName===e)return t=m,s.isToggled=!0,void g.changeAction(t)}}catch(e){c=!0,p=e}finally{try{!r&&u.return&&u.return()}finally{if(c)throw p}}}}}catch(e){i=!0,o=e}finally{try{!n&&l.return&&l.return()}finally{if(i)throw o}}};g.onChangeAction=function(e,t){var n=!0,i=!1,o=void 0;try{for(var a,l=g.actionItemsList[Symbol.iterator]();!(n=(a=l.next()).done);n=!0){var s=a.value;t?"parent"===s.type&&s.children&&s.title!==t.title&&(s.isToggled=!1):"parent"===s.type&&s.children&&s.title!==e.title&&(s.isToggled=!1)}}catch(e){i=!0,o=e}finally{try{!n&&l.return&&l.return()}finally{if(i)throw o}}if("parent"!==e.type){if(g.originalActionItem&&0<Object.keys(g.originalActionItem).length&&e.actionName===g.originalActionItem.action)Object.assign(g.actionItem,g.originalActionItem);else{var r=g.actionItem.title,c=g.actionItem.iconUrl,p=g.actionItem.iconClassName;g.actionItem={},g.actionItem.title=r,g.actionItem.iconUrl=c,g.actionItem.iconClassName=p}"purchase"===e.actionName?g.actionItem.title="Buy Now!":g.originalActionItem&&0<Object.keys(g.originalActionItem).length&&g.originalActionItem.title&&(g.actionItem.title=g.originalActionItem.title),document.querySelector(".action-builder-scrollable").scrollTop=0,g.changeAction(e)}else e.isToggled=!e.isToggled},g.changeAction=function(e){switch(g.currentActionItem=e,g.actionItem.action=e.actionName,g.errors={},g.showLinkToAppContent=!1,g.showLinkToWeb=!1,g.showLinkToSocialMedia=!1,g.showSendEmail=!1,g.showSendSms=!1,g.showNavigateToAddress=!1,g.showNoAction=!1,g.showCallNumber=!1,g.showPurchase=!1,g.showSearchInApp=!1,e.actionName){case"purchase":g.showPurchase=!0;break;case"linkToApp":g.showLinkToAppContent=!0;break;case"linkToWeb":g.showLinkToWeb=!0;break;case"sendEmail":g.showSendEmail=!0;break;case"callNumber":g.showCallNumber=!0;break;case"sendSms":g.showSendSms=!0;break;case"navigateToAddress":g.showNavigateToAddress=!0;break;case"navigateToSearch":g.showSearchInApp=!0;break;case"linkToSocialFacebook":case"linkToSocialInstagram":case"linkToSocialTwitter":case"linkToSocialLinkedIn":g.showLinkToSocialMedia=!0;break;case"noAction":case"navigateToLogin":case"navigateToAppSettings":case"navigateToNotifications":case"navigateToBookmarks":case"navigateToNotes":g.showNoAction=!0}},g.openImageLib=function(){g.options&&!g.options.imgLibOptions&&(g.options.imgLibOptions={showIcons:!1}),window.imageLibCurrentApp.showDialog({showIcons:g.options.imgLibOptions.showIcons||!1,showFiles:!0,multiSelection:!1},function(e,t){t&&t.selectedIcons&&0<t.selectedIcons.length&&(g.actionItem.iconClassName=t.selectedIcons[0],g.actionItem.iconUrl=null),t&&t.selectedFiles&&0<t.selectedFiles.length&&(g.actionItem.iconUrl=t.selectedFiles[0],g.actionItem.iconClassName=null)})},g.clearIconUrl=function(){g.actionItem.iconUrl=null,g.actionItem.iconClassName=null,g.actionItemAlreadyHasIcon=!1},g.validUrl=function(e){return!!new RegExp("^(http:/|https:/|http://|https://)[a-z0-9]").test(e)},g.resizeImage=function(e){return e?ImageLibAPI.tools.resizeImage(e,{width:92,height:88}):""},g.close=function(){g.$dialog.close(null)},g.init()}]),$app.controller("pluginSelectorCtrl",["$scope","$dialog",function(i,e){i.$dialog=e,i.tools=ImageLibAPI.tools,i.cancel=function(){i.$dialog.close(null)},i.save=function(){i.$dialog.close(i.selectedPluginInstance)};var t={controller:"pluginInstanceDialog",appId:window.appContext.currentApp.appId,liveMode:window.appContext.currentApp.liveMode,pluginId:"pluginInstances",instanceId:1,writeKey:appContext.currentApp.keys.datastoreKey};i.selectPluginInstance=function(e){var t=e.pluginInstance;e.clearQueryString;i.selectedPluginInstance=t};var o=new PluginInstanceAPI(t);i.getPluginInstances=function(e,t,n){o.search({title:e,pageSize:t,pageIndex:n-1},function(e,t){e?i.pluginInstances=[]:(i.pluginInstances=t.result,i.totalItems=t.totalRecord)})},i.init=function(){i.totalItems=100,i.pageIndex=1,i.pageSize=10,i.maxSize=5,i.pluginTitle=null,i.getPluginInstances(i.pluginTitle,i.pageSize,i.pageIndex)},i.init()}]),$app.controller("linkToWebCtrl",["$scope",function(t){void 0===t.actionItem.openIn&&(t.actionItem.openIn="_blank"),t.checkUrlFormat=function(){null!=t.actionItem.url&&""!=t.actionItem.url&&t.actionItem.url.indexOf("://")<0&&(t.actionItem.url="http://"+t.actionItem.url)},t.cancel=function(){t.$dialog.close(null)},t.save=function(){t.validate()&&t.$dialog.close(t.actionItem)},t.validate=function(){var e=!0;return t.errors.title="",t.errors.urlError="",t.errors.openInError="",!t.options||t.options.hideActionText||null!=t.actionItem.title&&""!=t.actionItem.title||(e=!1,t.errors.title="Required"),null!=t.actionItem.url&&""!=t.actionItem.url||(e=!1,t.errors.urlError="Required"),null!=t.actionItem.openIn&&""!=t.actionItem.openIn||(e=!1,t.errors.openInError="Required"),e}}]),$app.controller("sendSmsCtrl",["$scope",function(t){t.cancel=function(){t.$dialog.close(null)},t.save=function(){t.validate()&&t.$dialog.close(t.actionItem)},t.validate=function(){var e=!0;return t.errors.title="",t.errors.phoneNumberError="",!t.options||t.options.hideActionText||null!=t.actionItem.title&&""!=t.actionItem.title||(e=!1,t.errors.title="Required"),null!=t.actionItem.phoneNumber&&""!=t.actionItem.phoneNumber||(e=!1,t.errors.phoneNumberError="Required"),e}}]),$app.controller("sendEmailCtrl",["$scope",function(t){t.cancel=function(){t.$dialog.close(null)},t.save=function(){t.validate()&&t.$dialog.close(t.actionItem)},t.isValidEmail=function(e){return/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z\-0-9]{2,}))$/.test(e)},t.validate=function(){var e=!0;return t.errors.title="",t.errors.email="",t.errors.subject="",t.errors.body="",!t.options||t.options.hideActionText||null!=t.actionItem.title&&""!=t.actionItem.title||(e=!1,t.errors.title="Required"),null==t.actionItem.email||""==t.actionItem.email?(e=!1,t.errors.email="Required"):t.isValidEmail(t.actionItem.email)||(e=!1,t.errors.email="Invalid Email"),null!=t.actionItem.subject&&""!=t.actionItem.subject||(e=!1,t.errors.subject="Required"),null!=t.actionItem.body&&""!=t.actionItem.body||(e=!1,t.errors.body="Required"),e}}]),$app.controller("linkToSocialMediaCtrl",["$scope",function(t){t.cancel=function(){t.$dialog.close(null)},t.save=function(){t.validate()&&t.$dialog.close(t.actionItem)},t.validate=function(){var e=!0;return t.errors.title="",t.errors.urlError="",!t.options||t.options.hideActionText||null!=t.actionItem.title&&""!=t.actionItem.title||(e=!1,t.errors.title="Required"),null==t.actionItem.url||""==t.actionItem.url?(e=!1,t.errors.urlError="Required"):t.validUrl(t.actionItem.url)||(e=!1,t.errors.urlError="Invalid URL format. Example: http://www.google.com"),e}}]),$app.controller("linkToAppContentCtrl",["$scope","addPluginService",function(r,c){r.contextOptions={title:"Select Feature"};var p=new DatastoreAPI(appContext.currentApp.appId,"pluginInstances",1,appContext.currentApp.liveMode,appContext.currentApp.keys.datastoreKey);r.getPluginInstances=function(e,n,i){function t(e){var t={obj:{filter:e,page:i-1,pageSize:n,withDynamicData:!0,recordCount:!0},tag:""};p.search(t,function(e,t){if(e)console.error(e);else{var n=t.result?t.result:[];r.totalItems=t.totalRecord,r.pluginInstances=r.pluginInstances.concat(n),0===n.length&&(r.notEmptyData=!1),r.notscrolly=!0,r.loading=!1}})}r.loading=!0;var o={$or:[{"$json.title":{$regex:null!=e?e:"",$options:"-i"}}]};if(!e)return t(o);var a,l,s=[];(a=e,l={pluginTypeName:a,appId:appContext.currentApp.appId,whitelabelId:window.whitelabelContext.whitelabelId,reload:!c.miniSearchLoaded,fuzzy:.2,fields:["pluginTypeName"]},new Promise(function(n,i){c.searchAppPluginTypes(l,function(e,t){if(e)return i(e);n(t)})})).then(function(e){e.plugins.forEach(function(e){s.push({"$json.pluginTypeId":e.pluginTypeId})}),s&&0<s.length&&o.$or.push({$or:s}),t(o)})},r.getSelectedPluginInformation=function(){var e={};e.obj={filter:{"$json.instanceId":r.actionItem.instanceId},pageSize:1},p.search(e,function(e,t){t&&t.length&&r.onSelectPlugin({pluginInstance:t[0],clearQueryString:!1})})},r.init=function(){r.level={},r.level.pluginTitle="",r.pluginInstances=[],r.deepLinkPlugin={},r.totalItems=100,r.pageIndex=1,r.pageSize=40,r.maxSize=5,r.action="Add",r.loading=!1,r.notEmptyData=!0,r.notscrolly=!1,r.actionItem.instanceId&&(r.getSelectedPluginInformation(),r.action="Edit"),r.setPage()},r.setPage=function(){r.getPluginInstances(r.level.pluginTitle,r.pageSize,r.pageIndex)};var i=function(){r.deeplinks={data:[],selectedDeeplink:null,actionItemDeeplink:null,active:!1,isCustomQueryString:!1,customQueryString:"",queryString:"",options:{instanceId:null,deeplinkName:null,pageIndex:0,pageSize:5}},r.deeplinksDataEmpty=!1};i(),r.onSelectPlugin=function(e){var t=e.pluginInstance,n=e.clearQueryString;void 0!==r.options.showIcon&&0==r.options.showIcon&&r.options.hideActionText&&(r.hideDeeplinkLine=!0),r.errors.selectPlugin="",r.actionItem.instanceId=t.data.instanceId,r.selectedPluginInstance=t,"Add"===r.action&&(r.actionItem.title=t.data.title,r.actionItemAlreadyHasIcon||(r.actionItem.iconUrl=t.data.iconUrl,r.actionItem.iconClassName=t.data.iconClassName)),n?(r.actionItem.queryString="",i()):r.actionItem&&r.actionItem.queryString&&0<r.actionItem.queryString.length&&(r.deeplinks.customQueryString=r.actionItem.queryString,r.deeplinks.active=!0,r.actionItem.deeplinkId||(r.deeplinks.isCustomQueryString=!0)),r.deeplinks.options.instanceId=t.data.instanceId,!n&&r.actionItem&&r.actionItem.deeplinkId&&r.getDeeplinkById(r.actionItem.deeplinkId),o()};var n=new DeeplinksAPI(window.appContext.currentApp.appId),e=void 0;r.searchDeeplinks=function(){r.deeplinksLoading=!0,r.deeplinksDataEmpty=!1,r.deeplinks.data=[],r.deeplinks.options.pageIndex=0,clearTimeout(e),e=setTimeout(function(){r.loadPluginDeeplinks()},500)},r.onDeeplinkChange=function(e){r.deeplinks.customQueryString="dld="+encodeURIComponent(JSON.stringify(e.data.deeplinkData)),r.deeplinks.queryString="dld="+encodeURIComponent(JSON.stringify(e.data.deeplinkData)),(r.deeplinks.selectedDeeplink=e).data.name&&(r.actionItem.title=e.data.name),e.data.imageUrl&&(r.actionItem.iconUrl=e.data.imageUrl)},r.getDeeplinkById=function(e){var t=r.deeplinks.options.instanceId;n.getDeeplinkById({instanceId:t,deeplinkId:e},function(e,t){if(e)return console.error(e);t&&t[0]&&r.onDeeplinkChange(t[0])})},r.onIsCustomQueryStingChange=function(){r.deeplinks.isCustomQueryString&&(r.deeplinks.selectedDeeplink=null,r.actionItem.deeplinkId=null),r.errors.noQueryString=null};var t=void 0,o=function(){r.deeplinksLoading=!0,clearTimeout(t),t=setTimeout(function(){r.loadPluginDeeplinks()},500)};r.loadPluginDeeplinks=function(){r.deeplinks&&r.deeplinks.options&&r.deeplinks.options.instanceId?(r.deeplinksLoading=!0,n.searchDeeplinks(r.deeplinks.options,function(e,t){var n;if(e)return r.deeplinksLoading=!1,console.error(e);t.length<5&&(r.deeplinksDataEmpty=!0);var i=t.filter(function(e){return e.data&&e.data.deeplinkData});r.deeplinks.options.pageIndex++,(n=r.deeplinks.data).push.apply(n,_toConsumableArray(i)),r.deeplinksLoading=!1})):r.deeplinksLoading=!1},r.cancel=function(){r.$dialog.close(null)},r.save=function(){r.deeplinks.active?r.deeplinks.isCustomQueryString?(r.actionItem.queryString=r.deeplinks.customQueryString,r.actionItem.deeplinkId=null):r.deeplinks.selectedDeeplink&&r.deeplinks.selectedDeeplink.data&&r.deeplinks.selectedDeeplink.data._buildfire&&r.deeplinks.selectedDeeplink.data._buildfire.index&&r.deeplinks.selectedDeeplink.data._buildfire.index.array1[0]&&r.deeplinks.selectedDeeplink.data._buildfire.index.array1[0].string1?(r.actionItem.deeplinkId=r.deeplinks.selectedDeeplink.data._buildfire.index.array1[0].string1,r.actionItem.queryString=r.deeplinks.queryString):r.actionItem.queryString=null:(r.actionItem.queryString=null,r.actionItem.deeplinkId=null),r.validate()&&r.$dialog.close(r.actionItem)},r.onScroll=function(){r.notscrolly&&r.notEmptyData&&(r.notscrolly=!1,r.pageIndex++,r.setPage())};var a=void 0;r.search=function(){r.loading=!0,r.pluginInstances=[],clearTimeout(a),a=setTimeout(function(){r.notEmptyData=!0,r.notscrolly=!1,r.pageIndex=1,r.setPage()},500)},r.validate=function(){var e=!0;return r.errors.title="",r.errors.selectPlugin="",!r.options||r.options.hideActionText||null!=r.actionItem.title&&""!=r.actionItem.title||(e=!1,r.errors.title="Required"),null!=r.actionItem.instanceId&&""!=r.actionItem.instanceId||(e=!1,r.errors.selectPlugin="Please select a feature"),r.deeplinks.active&&(r.actionItem.queryString||(e=!1,r.errors.noQueryString="Required")),e},r.init()}]),$app.controller("navigateToAddress",["$scope",function(a){a.marker=null,a.$watch("addressDetails",function(){a.marker&&(a.marker.setMap(null),a.actionItem.lat=null,a.actionItem.lng=null),a.addressDetails&&(a.actionItem.lat=a.addressDetails.geometry.location.lat(),a.actionItem.lng=a.addressDetails.geometry.location.lng(),n())}),a.$on("mapInitialized",function(e,t){a.map=t,a.actionItem.lat&&a.actionItem.lng&&n()}),a.cancel=function(){a.$dialog.close(null)},a.save=function(){a.validate()&&a.$dialog.close(a.actionItem)},a.validate=function(){var e=!0;return a.errors.title="",a.errors.address="",!a.options||a.options.hideActionText||null!=a.actionItem.title&&""!=a.actionItem.title||(e=!1,a.errors.title="Required"),null!=a.actionItem.lat&&null!=a.actionItem.lng||(e=!1,a.errors.address="Required"),e};var n=function(){var e=new google.maps.LatLng(a.actionItem.lat,a.actionItem.lng);a.marker=new google.maps.Marker({position:e,map:a.map,draggable:!0,animation:google.maps.Animation.DROP}),a.map.setCenter(a.marker.getPosition()),a.map.setZoom(12),google.maps.event.addListener(a.marker,"dragend",function(e){var t,n,i,o;a.actionItem.lat=e.latLng.lat(),a.actionItem.lng=e.latLng.lng(),t=a.actionItem.lat,n=a.actionItem.lng,i=function(e){a.actionItem.address=e||"",a.$apply()},o=new google.maps.LatLng(t,n),(new google.maps.Geocoder).geocode({latLng:o},function(e,t){if(t==google.maps.GeocoderStatus.OK){var n=e[0].formatted_address;i(n)}else i(null)})})}}]),$app.controller("noActionCtrl",["$scope",function(t){t.cancel=function(){t.$dialog.close(null)},t.save=function(){t.validate()&&t.$dialog.close(t.actionItem)},t.validate=function(){var e=!0;return!t.options||t.options.hideActionText||null!=t.actionItem.title&&""!=t.actionItem.title||(e=!1,t.errors.title="Required"),e}}]),$app.controller("callNumberCtrl",["$scope",function(t){t.cancel=function(){t.$dialog.close(null)},t.save=function(){t.validate()&&t.$dialog.close(t.actionItem)},t.validate=function(){var e=!0;return t.errors.title="",t.errors.phoneNumberError="",!t.options||t.options.hideActionText||null!=t.actionItem.title&&""!=t.actionItem.title||(e=!1,t.errors.title="Required"),null!=t.actionItem.phoneNumber&&""!=t.actionItem.phoneNumber||(e=!1,t.errors.phoneNumberError="Required"),e}}]),$app.controller("searchInAppCtrl",["$scope",function(e){e.cancel=function(){e.$dialog.close(null)},e.save=function(){e.validate()&&e.$dialog.close(e.actionItem)},e.validate=function(){return!(e.errors.searchAppValueError="")}}]);
"use strict";$app.controller("pluginAnalyticsCtrl",["$scope","$http","$routeParams","$timeout","upgradePlanService",function(n,s,e,t,a){var r=null;r=n.invokeReportsFromPopup?n.pluginId:e.pluginId;var o=null;o=n.invokeReportsFromPopup?n.instanceId:e.instanceId;var p=null;p=n.invokeReportsFromPopup?n.activeEvent:e.activeEvent;var i=new AnalyticsAPI(appContext.currentApp.appId,r,o,0);void 0===appContext.currentApp.config.advancedPluginAnalytics?"enterprise"==appContext.currentApp.config.type?n.analyticsAccess="enabled":n.analyticsAccess="promo":"disabled"==appContext.currentApp.config.advancedPluginAnalytics?n.analyticsAccess="promo":n.analyticsAccess=appContext.currentApp.config.advancedPluginAnalytics,n.daysRange=[{name:"30",value:"30"},{name:"60",value:"60"},{name:"90",value:"90"}];var l=0,d=function(){n.events=[{title:"Opened",key:"app/openedPlugin",description:"",type:"build_in"}],n.selectedEvent=n.events[0],n.selectedDaysRange=n.daysRange[0],l=0},u=function(){n.reports={dailyReport:{options:{responsive:!0},total:0,labels:[],series:["Daily Views"],data:[[]]},topUsersReport:{options:{responsive:!0,scales:{xAxes:[{display:!1,maxBarThickness:70}],yAxes:[{ticks:{beginAtZero:!0}}]}},total:0,labels:[],series:["Top Users"],data:[[]]},topUsersGrid:{data:[]},userDetails:{data:[],skip:0}}};d(),u();n.getUserManagmentUrl=function(e){return"#/appUserManagement/?email="+encodeURIComponent(e)+"&activeTab=activity"},n.userDetailsReport=function(e,t){if(!n.selectedEvent)return n.reports.userDetails.busy=!1,n.reports.userDetails.isComplete=!0,void(n.reports.userDetails.data=[]);if(!n.reports.userDetails.busy){n.reports.userDetails.busy=!0;var a="/api/app/analytics/"+window.appContext.currentApp.appId+"/eventSearch";s.post(a,{fromDate:e||n.fromDate,toDate:t||n.toDate,eventName:n.selectedEvent.key,context:{pluginId:r,instanceId:o},options:{skip:n.reports.userDetails.skip,limit:15}}).success(function(e){if(n.reports.userDetails.busy=!1,n.reports.userDetails.isComplete=!0,e&&e.length)for(var t=0;t<e.length;t++){var a=e[t].metadata.user.firstName||e[t].metadata.user.lastName?(e[t].metadata.user.firstName||"")+" "+(e[t].metadata.user.lastName||""):e[t].metadata.user.username;n.reports.userDetails.data.push({createdOn:e[t].createdOn,user:e[t].metadata.user,displayName:a,platform:e[t].metadata.platform})}}).error(function(e){n.reports.userDetails.busy=!1,n.reports.userDetails.isComplete=!0,console.error(e),window.toast("error getting analytics","danger")}),n.reports.userDetails.skip+=15}};var c=function(){"promo"==n.analyticsAccess&&"app/openedPlugin"!=n.selectedEvent.key||"promo"==n.analyticsAccess&&"app/openedPlugin"==n.selectedEvent.key&&30<n.selectedDaysRange.value||(n.fromDate=new Date,n.fromDate.setDate(n.fromDate.getDate()-n.selectedDaysRange.value),n.toDate=new Date,function(e,t){if(!n.selectedEvent)return n.reports.dailyReport.isComplete=!0,n.reports.dailyReport.data=[[]],n.reports.dailyReport.labels=[],n.reports.dailyReport.total=0;var a="/api/app/analytics/"+window.appContext.currentApp.appId+"/dailyEvent/groupCount";s.post(a,{fromDate:e,toDate:t,eventName:n.selectedEvent.key,context:{pluginId:r,instanceId:o}}).success(function(e){if(n.reports.dailyReport.isComplete=!0,n.reports.dailyReport.data=[[]],n.reports.dailyReport.labels=[],n.reports.dailyReport.total=0,e.hasAggregation&&(n.reports.dailyReport.options.legend={display:!0,position:"bottom"},n.reports.dailyReport.data=[[],[],[],[],[]],n.reports.dailyReport.series.push("Avg"),n.reports.dailyReport.series.push("Sum"),n.reports.dailyReport.series.push("Min"),n.reports.dailyReport.series.push("Max")),e&&e.days&&0<e.days.length)for(var t=0;t<e.days.length;t++)if(n.reports.dailyReport.labels.push(e.days[t].dayName),n.reports.dailyReport.data[0].push(e.days[t].count),e.hasAggregation){var a=0;e.days[t].aggregation&&e.days[t].aggregation.sum&&e.days[t].count&&(a=Math.round(e.days[t].aggregation.sum/e.days[t].count*100)/100),n.reports.dailyReport.data[1].push(a||0),n.reports.dailyReport.data[2].push(e.days[t].aggregation&&e.days[t].aggregation.sum||0),n.reports.dailyReport.data[3].push(e.days[t].aggregation&&e.days[t].aggregation.min||0),n.reports.dailyReport.data[4].push(e.days[t].aggregation&&e.days[t].aggregation.max||0)}n.reports.dailyReport.total=e.total}).error(function(e){n.reports.dailyReport.isComplete=!0,window.toast("error getting analytics","danger")})}(n.fromDate,n.toDate),function(e,t){if(!n.selectedEvent)return n.reports.topUsersReport.isComplete=!0,n.reports.topUsersGrid.isComplete=!0,n.reports.topUsersReport.data=[[]],n.reports.topUsersReport.labels=[],n.reports.topUsersGrid.data=[];var a="/api/app/analytics/"+window.appContext.currentApp.appId+"/userEvent/count";s.post(a,{fromDate:e,toDate:t,eventName:n.selectedEvent.key,context:{pluginId:r,instanceId:o}}).success(function(e){if(n.reports.topUsersReport.isComplete=!0,n.reports.topUsersGrid.isComplete=!0,n.reports.topUsersReport.data=[[]],n.reports.topUsersReport.labels=[],n.reports.topUsersGrid.data=[],e&&e.length)for(var t=0;t<e.length;t++){var a=e[t].user.firstName||e[t].user.lastName?(e[t].user.firstName||"")+" "+(e[t].user.lastName||""):e[t].user.username;t<=9&&(n.reports.topUsersReport.total+=e[t].total||0,n.reports.topUsersReport.labels.push(a),n.reports.topUsersReport.data[0].push(e[t].total)),n.reports.topUsersGrid.data.push({total:e[t].total,user:e[t].user,displayName:a})}}).error(function(e){n.reports.topUsersReport.isComplete=!0,window.toast("error getting analytics","danger")})}(n.fromDate,n.toDate),n.userDetailsReport(n.fromDate,n.toDate))};n.loadPluginEvents=function(o){t(function(){if("enabled"==n.analyticsAccess||"promo"==n.analyticsAccess){n.customEventsLoading=!0;var e={skip:l,limit:50,sort:{_titleLowerCase:1}};n.customEventSearch&&(e.filter={"$json.title":{$regex:n.customEventSearch,$options:"i"}}),i.getPluginEvents(e,function(e,t){if(n.customEventsLoading=!1,t&&0<t.length){l+=50;for(var a=0;a<t.length;a++)if(t[a].data&&t[a].data.title&&t[a].data.key){for(var s=!1,r=0;r<n.events.length;r++)if(n.events[r].key==t[a].data.key){s=!0;break}s||(t[a].data.type="custom",n.events.push(t[a].data)),p==t[a].data.key&&(n.selectedEvent=t[a].data)}}o&&o()})}else o&&o()},10)};var g=void 0;n.searchCustomEvents=function(){t.cancel(g),g=t(function(){l=0,n.events=[{title:"Opened",key:"app/openedPlugin",description:"",type:"build_in"}],n.loadPluginEvents()},500)},n.changeEvent=function(e){n.customEventSearch="",n.selectedEvent=e,u(),c()},n.changeDaysRange=function(e){n.selectedDaysRange=e,u(),c()},n.upgradePlan=a.upgrade,n.start=function(){n.analyticsStarted||(n.analyticsStarted=!0,d(),u(),p?n.loadPluginEvents(function(){c()}):(n.loadPluginEvents(),c()))},n.$on("pluginAnalyticsTabOpened",function(e,t){n.start()}),(n.invokeReportsFromPopup||"analytics"==e.activeTab)&&n.start(),n.invokeReportsFromPopup||cpNotification.analyticsPluginDailyOpen({pluginId:r,instanceId:o})}]);
"use strict";$app.controller("pluginAnalyticsPopupCtrl",["$scope","$http","$data","$dialog",function(n,i,o,t){n.invokeReportsFromPopup=!0,n.pluginId=o.pluginId,n.instanceId=o.instanceId,n.activeEvent=o.activeEvent,n.appHost="",window.siteConfig&&window.siteConfig.endPoints&&window.siteConfig.endPoints.appHost&&"sdk"==window.siteConfig.scope&&(n.appHost=window.siteConfig.endPoints.appHost),n.close=function(){t.close()}}]);
"use strict";"undefined"!=typeof AnalyticsAPI&&(AnalyticsAPI.prototype.registerPluginEvent=function(i,s){if(i){i.data||(i.data={}),i.options||(i.options={});var n=i.data;if(n.key)if(n.title){n._titleLowerCase=n.title.toLowerCase();var t=this.instanceId+"_pluginEvents",o=new DatastoreAPI(this.appId,this.pluginId,t,this.liveMode);o.searchAndUpdate({tag:"events",obj:{$set:n},search:{key:n.key}},function(t,e){null==t&&e&&0==e.nModified?o.insert({tag:"events",obj:n,checkDuplicate:!1},function(t,e){var n=new CustomEvent("pluginAnalyticsRegisterEvent",{detail:{data:i.data,options:i.options}});document.dispatchEvent(n),s&&s(t,e)}):s&&s(t,e)})}else s&&s("Missing event title",null);else s&&s("Missing event key",null)}else s&&s("invalid params",null)},AnalyticsAPI.prototype.unregisterPluginEvent=function(t,i){if(t&&t.key){var e=this.instanceId+"_pluginEvents",s=new DatastoreAPI(this.appId,this.pluginId,e,this.liveMode);s.search({tag:"events",obj:{filter:{"$json.key":t.key}}},function(t,e){if(!t&&e&&0<e.length)for(var n=0;n<e.length;n++)s.delete({tag:"events",id:e[n].id},function(t,e){i&&i(t,e)});else i&&i(t,e)})}else i&&i("Missing event key",null)},AnalyticsAPI.prototype.showReports=function(t,e){var n="";window.siteConfig&&window.siteConfig.endPoints&&window.siteConfig.endPoints.appHost&&"sdk"==window.siteConfig.scope&&(n=window.siteConfig.endPoints.appHost),window.openDialog({templateUrl:n+"/pages/plugins/pluginControl/analytics/pluginAnalyticsPopup.html",controller:"pluginAnalyticsPopupCtrl",size:"lg",data:{pluginId:this.pluginId,instanceId:this.instanceId,activeEvent:t.eventKey}},function(t){}),e(null,!0)});
"use strict";function UsersLibAPI(e){this.context={},angular.copy(e,this.context),this.init()}UsersLibAPI.prototype={init:function(){},showSearchDialog:function(e,i){var s="";window.siteConfig&&window.siteConfig.endPoints&&window.siteConfig.endPoints.appHost&&"sdk"==window.siteConfig.scope&&(s=window.siteConfig.endPoints.appHost);var n={templateUrl:s+"/pages/common/userSearch.html",controller:"userSearchDialogCtrl",size:"lg",data:{appId:this.context.appId,source:"sdk"}};window.openDialog(n,function(e){if(e){if(e){if(e.users&&0<e.users.length)for(var s=0;s<e.users.length;s++)e.users[s]={userId:e.users[s]._id,firstName:e.users[s].firstName||null,lastName:e.users[s].lastName||null,displayName:e.users[s].displayName||null,username:e.users[s].username||null,isActive:e.users[s].isActive,userProfile:e.users[s].userProfile||null,imageUrl:e.users[s].imageUrl||null};delete e.criteria,delete e.criteriaTanslation,delete e.selectAll}i&&i(null,e)}else i&&i(null,null)})},showTagsSearchDialog:function(e,s){var i="";window.siteConfig&&window.siteConfig.endPoints&&window.siteConfig.endPoints.appHost&&"sdk"==window.siteConfig.scope&&(i=window.siteConfig.endPoints.appHost);var n={templateUrl:i+"/pages/common/tagSearch.html",controller:"tagSearchDialogCtrl",size:"lg",data:{appId:this.context.appId,source:"sdk"}};window.openDialog(n,function(e){s&&s(null,e)})}};
"use strict";$app.controller("userSearchDialogCtrl",["$scope","$dialog",function(e,s){s.options&&s.options.data&&s.options.data.source&&(e.source=s.options.data.source),e.isPopupUserSearch=!0,e.close=function(){s.close(null)},e.returnSearchResult=function(e){s.close(e)}}]),$app.controller("userSearchCtrl",["$scope","$rootScope",function(o,e){o.activeAll=!0,o.activeRange=!1,o.errors={},o.tagsHave=!0,o.tagsAll=!0,o.activeType=function(e){o.activeAll=!1,o.activeRange=!1,void 0!==e&&(o[e]=!0)},o.export=function(){o.exporting=!0;var e=t();delete e.skip,delete e.limit;var s="";window.siteConfig&&window.siteConfig.endPoints&&window.siteConfig.endPoints.appHost&&"sdk"==window.siteConfig.scope&&(s=window.siteConfig.endPoints.appHost),$http.post(s+"/api/userTagging/userExport/"+window.appContext.currentApp.appId+"/",e).success(function(e){o.exporting=!1;var s=document.createElement("a");s.setAttribute("href","data:text/csv;charset=utf-8,"+encodeURIComponent(e)),s.setAttribute("download","users.csv"),s.click()}).error(function(e){o.exporting=!1,console.error(e),window.toast("Search Error","danger")})},e.$on("searchUsers",function(e,s){o.searchUsers()}),o.selectTagHave=function(e){o.tagsHave=e};var t=function(){var e={filter:{},skip:(o.pageIndex-1)*o.pageSize,limit:o.pageSize},s=[];if(o.searchName){var r=[];o.searchName.split(",").forEach(function(e){var s,t;e=e.trim(),t=!1,(0===(s=e).indexOf("facebook")||0===s.indexOf("twitter")||/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z\-0-9]{2,}))$/.test(s))&&(t=!0),t?r.push({email:e.toLowerCase()}):e&&r.push({displayName:{$regex:e,$options:"-i"}},{email:{$regex:e,$options:"-i"}})}),s.push({$or:r})}if(-1!=o.currentUserStatusFilter&&(e.isActive=1==o.currentUserStatusFilter),o.showAdvancedSearch){o.searchFromDate&&(e.signupDateFrom=o.searchFromDate),o.searchToDate&&(e.signupDateTo=o.searchToDate);var t=[];if(o.searchTags&&o.searchTags.length){for(var a=0;a<o.searchTags.length;a++)t.push(o.searchTags[a].tagName);if(o.tagsHave)if(o.tagsAll)for(a=0;a<t.length;a++)s.push({tags:{$elemMatch:{tagName:t[a]}}});else s.push({tags:{$elemMatch:{tagName:{$in:t}}}});else if(o.tagsAll)for(a=0;a<t.length;a++)s.push({tags:{$not:{$elemMatch:{tagName:t[a]}}}});else{var n=[];for(a=0;a<t.length;a++)n.push({tags:{$not:{$elemMatch:{tagName:t[a]}}}});s.push({$or:n})}}}return o.sortBy&&(e.sort=o.sortBy),o.isReversed&&(e.isReversed=o.isReversed),0<s.length&&(e.filter.$and=s),e};o.getUsers=function(){o.searching=!0;var a=t(),e="";window.siteConfig&&window.siteConfig.endPoints&&window.siteConfig.endPoints.appHost&&"sdk"==window.siteConfig.scope&&(e=window.siteConfig.endPoints.appHost),$http.post(e+"/api/userTagging/userSearch/"+window.appContext.currentApp.appId+"/",a).success(function(e){o.totalItems=e.usersCount,o.searching=!1;for(var s=0;s<e.users.length;s++){var t=e.users[s];if(o.users.push(t),o.selectedUsers&&o.selectedUsers.length)for(var r=0;r<o.selectedUsers.length;r++)o.selectedUsers[r]._id==t._id&&(t.selected=!0)}delete a.isReversed,delete a.limit,delete a.skip,delete a.sort,0<e.users.length&&(o.busy=!1),o.currentSearchCriteria=a,o.loading=!1,o.sortLoading=!1}).error(function(e){o.searching=!1,o.busy=!1,console.error(e),window.toast("Search Error","danger")}).finally(function(){})},o.changeSorting=function(e){o.sortBy===e?o.isReversed=!o.isReversed:(o.sortBy=e,o.isReversed=!1),o.sortLoading=!0,o.users=[],o.busy=!1,o.pageIndex=0,o.setPage()},o.getUserStatus=function(e){var s=e.externalApps[window.appContext.currentApp.appId].isActive;return s||void 0===s?"Active":"Banned"},o.setUserStatus=function(e,s){var t=e.externalApps[window.appContext.currentApp.appId].isActive;void 0===t&&s||t===s||(e.externalApps[window.appContext.currentApp.appId].isActive=s,o.updateUserStatus(e))},o.updateUserStatus=function(e){var s={isActive:e.externalApps[window.userContext.currentApp.appId].isActive};$http.post("/api/userTagging/updateUserStatus/"+window.userContext.currentApp.appId+"/"+e._id,s).success(function(e){window.toast("Saved","success")}).error(function(e){window.toast("save error","danger")})},o.setStatusFilter=function(e){"-1"==(o.currentUserStatusFilter=e)?o.currentUserStatusFilterText="All":"0"==e?o.currentUserStatusFilterText="Banned":"1"==e&&(o.currentUserStatusFilterText="Active")},o.showHideAdvancedSearch=function(){o.showAdvancedSearch=!o.showAdvancedSearch},o.setPage=function(){o.busy||(o.busy=!0,o.pageIndex+=1,o.getUsers())},o.managUser=function(e){window.location.hash="appUserManagement?email="+encodeURIComponent(e.email)},o.resetPassword=function(e){var s={templateUrl:"userManagementResetPassword.html",controller:"userManagementResetPasswordCtrl",size:"md",data:{user:e}};window.openDialog(s,function(){})};o.uploadFile=function(){},o.init=function(){o.appConfig=window.appContext.currentApp.config,o.showDuplicateWarning=!1,o.totalItems=100,o.pageIndex=0,o.pageSize=10,o.maxSize=10,o.username=null,o.sortColumn="",o.currentUserStatusFilter="-1",o.currentUserStatusFilterText="All",o.searchText="",o.showAdvancedSearch=!0,o.currentUserStatusFilter="-1",o.currentUserStatusFilterText="All",o.sortBy="createdOn",o.isReversed=!1,o.selectedUsers=null,o.busy=!1,o.users=[],o.loading=!0,o.sortLoading=!1,o.scopeLoading=!1,o.isNonFederatedApp=!1,o.setPage(),o.scopeLoading=!0,$http.get("api/app/"+appContext.currentApp.appId+"/users/scope").success(function(e){o.scopeLoading=!1,o.isNonFederatedApp=!(!e||!e.scope)}).error(function(e){o.scopeLoading=!1,console.error(e)})},o.init();o.returnSearchResult=function(){var e={criteria:JSON.stringify(o.currentSearchCriteria),criteriaTanslation:function(){var e="";if(o.searchName&&(e="name or email in ("+o.searchName,e+=")"),-1!=o.currentUserStatusFilter&&(0<e.length&&(e+=" and "),1==o.currentUserStatusFilter&&(e+="Active"),0==o.currentUserStatusFilter&&(e+="Banned")),o.showAdvancedSearch){o.searchFromDate&&(0<e.length&&(e+=" and "),e+="Signup date <  "+o.searchFromDate.toLocaleString()),o.searchToDate&&(0<e.length&&(e+=" and "),e+="Signup date <  "+o.searchToDate.toLocaleString());var s=[];if(o.searchTags&&o.searchTags.length){0<e.length&&(e+=" and ");for(var t=0;t<o.searchTags.length;t++)s.push(o.searchTags[t].tagName);o.tagsHave?o.tagsAll?e+="has these tags ("+s.toString(",")+")":e+="has some of these tags ("+s.toString(",")+")":o.tagsAll?e+="does not have these tags ("+s.toString(",")+")":e+="does not have some of these tags ("+s.toString()+")"}}return e}()};if(e.users=o.selectedUsers,e.selectAll=!0,e.userIds=null,o.selectedUsers){e.selectAll=!1,e.userIds=[];for(var s=0;s<e.users.length;s++)e.userIds.push(e.users[s]._id)}o.$parent.returnSearchResult(e)},o.loadTags=function(s){var e="";return window.siteConfig&&window.siteConfig.endPoints&&window.siteConfig.endPoints.appHost&&"sdk"==window.siteConfig.scope&&(e=window.siteConfig.endPoints.appHost),$http.get(e+"/api/userTagging/getTags/"+window.appContext.currentApp.appId+"/",null).then(function(e){return e.data.filter(function(e){return-1!=e.tagName.toLowerCase().indexOf(s.toLowerCase())})})},o.changeUserSelection=function(e){if(o.selectedUsers||(o.selectedUsers=[]),e.selected)o.selectedUsers.push(e);else for(var s=0;o.selectedUsers&&s<o.selectedUsers.length;s++)o.selectedUsers[s]._id==e._id&&(o.selectedUsers.splice(s,1),o.selectedUsers.length||(o.selectedUsers=null))},o.searchUsers=function(){o.loading=!0,o.users=[],o.busy=!1,o.pageIndex=0,o.setPage()}}]),$app.controller("userManagementResetPasswordCtrl",["$scope","$dialog","$http","$data",function(s,e,t,r){s.passwordPattern=validator.passwordPattern,s.user=r.user,s.errorMessage="",s.newPassword="",s.confirmPassword="",s.loading=!1,s.closeDialog=function(){e.close()},s.resetPassword=function(){s.errorMessage="",s.newPassword&&s.confirmPassword&&validator.validatePassword(s.newPassword)&&s.newPassword===s.confirmPassword&&(s.loading=!0,t.post("api/app/"+appContext.currentApp.appId+"/user/"+s.user._id+"/resetPassword",{password:s.newPassword,email:s.user.email}).success(function(e){window.toast("Reset password successfully"),s.loading=!1,s.closeDialog()}).error(function(e){s.errorMessage=e.message,s.loading=!1}))}}]);
"use strict";$app.controller("tagSearchDialogCtrl",["$scope","$dialog",function(e,t){t.options&&t.options.data&&t.options.data.source&&(e.source=t.options.data.source),e.close=function(){t.close(null)},e.returnSearchResult=function(e){t.close(e)}}]),$app.controller("tagSearchCtrl",["$scope","$http","$rootScope",function(a,t,e){a.tags=[],a.currentPageTags=[],a.loading=!0,a.getTags=function(){a.loading=!0;var e="";window.siteConfig&&window.siteConfig.endPoints&&window.siteConfig.endPoints.appHost&&"sdk"==window.siteConfig.scope&&(e=window.siteConfig.endPoints.appHost),t.get(e+"/api/userTagging/getTags/"+window.appContext.currentApp.appId+"/",{}).success(function(e){a.currentPageTags=(a.totalItems=e?(a.tags=e,a.tags.length):(a.tags=[],0),a.getDataPage(a.tags))}).finally(function(){a.loading=!1})},a.getDataPage=function(e){var t=[];if(a.searchText)for(var s in e)-1<e[s].tagName.toLowerCase().indexOf(a.searchText.toLowerCase())&&t.push(e[s]);else t=e;return t},a.setSort=function(e,t){a.sortCriteria=e,a.reverse=t,a.sort()},a.sort=function(){switch(a.sortCriteria){case"Newest First":a.sortBy="createdOn",a.reverse=!0;break;case"Oldest First":a.sortBy="createdOn",a.reverse=!1;break;case"Tag Name A-Z":a.sortBy="tagName",a.reverse=!1;break;case"Tag Name Z-A":a.sortBy="tagName",a.reverse=!0}},a.changeTagSelection=function(e){if(a.selectedTags||(a.selectedTags=[]),e.selected)a.selectedTags.push({id:e._id,tagName:e.tagName});else for(var t=0;a.selectedTags&&t<a.selectedTags.length;t++)a.selectedTags[t]&&a.selectedTags[t].id==e._id&&(a.selectedTags.splice(t,1),a.selectedTags.length||(a.selectedTags=null))},a.returnSearchResult=function(){a.$parent.returnSearchResult(a.selectedTags)},a.setPage=function(){a.currentPageTags=a.getDataPage(a.tags)},a.init=function(){a.sortColumn="",a.currentUserStatusFilter="-1",a.currentUserStatusFilterText="All",a.searchText="",a.sortCriteria="Newest First",a.sortBy="createdOn",a.reverse=!0,a.getTags()},a.init()}]);
"use strict";$app.factory("addPluginService",["$rootScope","$http","$q","$analytics","pluginManager","promoService","marketplaceServices","$searchEngineService",function(p,l,n,c,a,t,r,g){var f={};f.miniSearchLoaded=!1,f.currencyToInt=function(e,n){return parseInt((100*e).toFixed())},f.sortResults=function(e,i){return e.sort(function(e,n){var t=i.indexOf(e.data.instanceId),a=i.indexOf(n.data.instanceId);return a<t?1:t<a?-1:0}),e},f.getMarketplaceSettings=function(e){e(null,{showDevInfo:whitelabelContext.showDevInfo})},f.isPluginFree=function(e){return r.isPluginFree(e)},f.markPurchased=function(e){return r.markPurchased(e)},f.addLicense=function(e,n){var t={clientReferenceId:e.clientReferenceId,pluginId:e.pluginId,appId:e.appId,userId:e.userId,email:e.email};l.post("/api/stripe/charge",t).then(function(){a.removeRevokedPlugin(e.pluginId),n(null)},function(e){n(e)})},f.isPluginLicenseActive=function(e,n){l.get("/api/appPluginTypes/validateToAdd",{params:{appId:e.appId,token:e.pluginToken}}).success(function(e){e&&e.isActive?n(null,!0):n(null,!1)})},f.trackPluginAdded=function(e){c.eventTrack("cp/pluginInstanceAdded",{pluginTypeId:e.pluginTypeId,pluginTypeName:e.pluginTypeName,marketItemId:e.marketItemId})};var e=new DatastoreAPI(appContext.currentApp.appId,"sideMenu",1,0,appContext.currentApp.keys.datastoreKey);return f.addToSideMenu=function(a,i){var r,l,s=new DatastoreAPI(appContext.currentApp.appId,"sideMenu",1,0,appContext.currentApp.keys.datastoreKey);r=function(e,t){if(e)i&&i(e);else if(t&&t.result){t.result.push({id:a.instanceId,data:a}),t.data||(t.data=[]),t.data.push(a.instanceId);var n={_buildfire:{sideMenu:t}};n._buildfire.sideMenu.result&&delete n._buildfire.sideMenu.result,s.save({tag:"",obj:n},function(e,n){e||!n?(console.error(e),i&&i(e)):(i&&i(null,t),window.dispatchEvent(new CustomEvent("SideMenuUpdated",{detail:n})),emulatorSync.triggerSideMenuOnUpdate(n))})}},l={dataType:"pluginInstance",data:[],content:{securedFeaturesOption:"enable"},result:[]},e.get({withDynamicData:!0},function(e,n){if(n&&n.data){var t=n.data._buildfire&&n.data._buildfire.sideMenu;t&&t.content?t.content.loadAllPlugins||(t.result=(a=t.result,i=t.data,a.sort(function(e,n){var t=i.indexOf(e.data.instanceId),a=i.indexOf(n.data.instanceId);return a<t?1:t<a?-1:0}),a)):t=l,l=t}var a,i;r(null,l)})},f.addPluginToDataStore=function(u,o,d){u||(u={}),u.pluginHost=window.siteConfig.endPoints.pluginHost.replace("http:","https:");var e=u.pluginHost+"/"+o.folderName+"/plugin.json?v="+(o.lastUpdatedOn?o.lastUpdatedOn:"");n.all([l.get(e),l.get("/api/appPluginTypes/validateToAdd",{params:{appId:u.appId,token:o.token}})]).then(function(e){var n,t,a,i,r,l,s=!1;e&&e[0].data&&(n=e[0].data)&&n.requireLogin&&(s=!0),e&&e[1].data&&(t=e[1].data),t&&t.isActive?(a=s,i=new DatastoreAPI(u.appId,"pluginInstances",1,0,appContext.currentApp.keys.datastoreKey),r=o.token+"-"+Date.now(),l={tag:"",obj:{pluginTypeId:o.pluginTypeId,token:o.token,title:u.title,instanceId:r,refId:r,iconUrl:u.pluginHost+"/"+o.folderName+"/resources/icon.png",_buildfire:{pluginType:{dataType:"pluginType",data:o.token}}}},a&&(l.obj.requiresLogin=!0,l.obj._forceRequireLoginInEmulator=!0),i.insert(l,function(e){if(e)d(e),console.log(e);else{c.eventTrack("cp/pluginInstanceAdded",{pluginTypeId:o.pluginTypeId,pluginTypeName:o.pluginTypeName,marketItemId:o.marketItemId}),p.$broadcast("pluginInserted",o.token);var n={instanceId:r,iconUrl:u.pluginHost+"/"+o.folderName+"/resources/icon.png",title:l.obj.title,pluginTypeId:o.token,pluginTypeName:o.pluginTypeName,folderName:o.folderName,iconClassName:null};g.savePluginTitle({instanceId:r,pluginId:o.token,title:l.obj.title},function(e,n){e&&console.error("addPluginCtrl","add plugin title to searchEngineAPI",e)}),u.addToSideMenu?f.addToSideMenu(n,function(){d(null,{pluginInstance:l,folderName:o.folderName})}):d(null,{pluginInstance:l,folderName:o.folderName})}})):d("plugin_inactive")})},f.getMarketPlacePlugins=function(e,n,t){return l.get("/api/marketplace/search",{params:{appId:n,search:e,whitelabelId:t}})},f.formatPluginLicenses=function(e){if(e)for(var n=0;n<e.length;n++)e[n]&&e[n].license&&(e[n].license=e[n].license.replace(/.(?=.{4})/g,"x"))},f.logToCrm=function(e,n,t){var a=e.length?e.length:"0";crm&&1==t&&n&&(crm.set({lastPluginSearchOn:Date.now(),lastPluginSearchFor:n,lastPluginSearchFound:a}),0==a&&(crm.set({lastPluginSearchMissOn:Date.now(),lastPluginSearchMissFor:n}),crm.inc({pluginSearchMissCount:1})),crm.log("Searched for plugin: "+n+": "+a+" plugins found"))},f.checkAndSaveMissedKeywords=function(e,n){var t={totalScore:0,highestScore:0,searchResult:[],averageScore:0,threshold:10,totalResult:n&&n.length?n.length:0,exactMatch:!1,missedKeyword:!1,query:e};if(n&&0<n.length){for(var a=0;a<n.length;a++){for(var i=0;i<n[a].terms.length;i++)n[a].terms[i]==e.toLowerCase()&&(t.exactMatch=!0);if(0==a&&(t.highestScore=n[a].score),t.totalScore+=n[a].score,t.searchResult.push({name:n[a].pluginTypeName,pluginTypeId:n[a].pluginTypeId,terms:n[a].terms,isBuildFirePlugin:!!n[a].author&&"buildfire"===n[a].author.toLowerCase()}),3<=t.searchResult.length)break}t.averageScore=t.totalScore/n.length,t.highestScore-t.averageScore>t.threshold&&(t.missedKeyword=!0)}else t.missedKeyword=!0;r&&r._trackAction&&r._trackAction("cp/marketplace/search",null,null,{result:t})},f.searchAppPluginTypes=function(t,a){var l=t.pluginTypeName,e=t.appId,n=t.whitelabelId;function i(r){f.getMarketPlacePlugins("",e,n).then(function(e){var n=e.data[0];f.formatPluginLicenses(n),f.logToCrm(n,l,1);var t,a,i={plugins:n};t=i.plugins,a=new Set(["and","or","to","in","a","the","you","is","are"]),f.miniSearch=new MiniSearch({fields:["pluginTypeName","keywords","description"],storeFields:["pluginTypeId","description","author","awsAPIPublicKey","createdOn","folderName","lastUpdatedOn","license","marketplacepluginTypeId","pluginTypeId","pluginTypeName","price","publishableKey","stripePlan","supportEmail","supportLink","useCount","keywords","token"],boost:{pluginTypeName:3,keywords:2},idField:"pluginTypeId",prefix:!0,processTerm:function(e,n){return a.has(e)?null:e.toLowerCase()},searchOptions:{fuzzy:.3}}),f.miniSearch.addAll(t),f.miniSearchLoaded=!0,r(null,i)})}function r(){var e={prefix:!0};t.fuzzy&&(e.fuzzy=t.fuzzy),t.fields&&(e.fields=t.fields);var n=f.miniSearch.search(l,e);f.checkAndSaveMissedKeywords(l,n),a(null,{plugins:n})}l&&f.miniSearchLoaded?t.reload?i(function(){r()}):r():i(l?function(){r()}:a)},f.instanceExists=function(a,i){var e=window.siteConfig.endPoints.pluginHost+"/"+a.folderName+"/plugin.json?v="+(a.lastUpdatedOn?a.lastUpdatedOn:""),r={isInUse:!1};l.get(e).success(function(e){e.singleton?t.getPluginInstances(a,function(e,n){if(e)i(e);else{var t=n.filter(function(e){return e.data.pluginTypeId==a.pluginTypeId});0<t.length&&(r.isInUse=!0,r.matches=t),i(null,r)}}):i(null,r)}).error(function(e){i(e)})},f.getPlanType=function(e){var n=null;if(e.stripePlan)try{n=JSON.parse(e.stripePlan)}catch(e){}switch(n.type){case"subscriptions":return"subscriptions";case"onetime":case e.price&&0<e.price:return"onetime";default:return"free"}},f}]);
"use strict";$app.service("pluginManager",["$http","$rootScope",function(e,n){var o={revokedPlugins:null,checkIfPluginIsRevoked:function(r,i){var e=function(){var e=!1;if(o.revokedPlugins)for(var n=0;n<o.revokedPlugins.length;n++)if(o.revokedPlugins[n].token==r){e=!0;break}i&&i(e)};o.revokedPlugins?e():u(e)},removeRevokedPlugin:function(e){if(o.revokedPlugins)for(var n=0;n<o.revokedPlugins.length;n++)if(o.revokedPlugins[n].pluginTypeId==e){o.revokedPlugins.splice(n,1);break}}},u=function n(r){e.get("/api/appPluginTypes/revoked",{params:{appId:window.appContext.currentApp.appId}}).success(function(e){o.revokedPlugins=e,r&&r(),setTimeout(n,3e5)}).error(function(e){r&&r()})};return o}]);
"use strict";$app.factory("promoService",["$http",function(r){var e={},n=window.siteConfig.menuShortcutsPlugins;return e.getPluginTypeByProperty=function(e,t){return t=t.toLowerCase(),0<(n=n.filter(function(n){return n[e]==t})).length?n[0]:null},e.getPluginTypeInfoByName=function(n){return e.getPluginTypeByProperty("name",n)},e.getPluginTypeInfoById=function(n){return e.getPluginTypeByProperty("pluginTypeId",n)},e.getPluginTypeInfoByToken=function(n){return e.getPluginTypeByProperty("token",n)},e.getPluginInstances=function(n,e){var t=n.domain+"/plugin/search/"+n.appId+"/pluginInstances/1/primary/0/";r.post(t,{page:0,pageSize:0,withDynamicData:!0,recordCount:!1}).success(function(n){e(null,n)}).error(function(n){e(n)})},e.getLocalPromoUrl=function(n){return"/pages/pluginPromo/templates/"+n+".html"},e.upgrade=function(n){var e="//"+n.selfProvDomain+"/upgrade.html#/app/"+n.appId+"/"+n.username;window.location.href=e},e}]);
"use strict";$app.service("marketplaceServices",["$rootScope","$http","$timeout","$location",function(e,r,n,o){var p={isPluginFree:function(e){return e.wasPurchased||0==e.price||!e.price},markPurchased:function(e){return e.map(function(e){return e.license&&(e.wasPurchased=!0),e})},_marketplacePromotedData:null,_analyticsAppIdKeyName:"marketplace_analytics",_trackAction:function(e,t,n,o){o||(o={});var a=window.bfHelper.Cookies.get("verticalData"),r=window.authAPI.getCurrentUser();r&&(o.user={userId:r.userToken,userEmail:r.email,username:r.username,displayName:r.displayName}),o.app={appId:window.appContext.currentApp.appId,name:window.appContext.currentApp.name,clonedFromAppId:window.appContext.currentApp.clonedFromAppId,config:{id:window.appContext.currentApp.configId,type:window.appContext.currentApp.config.type},marketIndustry:a&&a.industry||null};var i=t||this._analyticsAppIdKeyName;(AnalyticsAPI&&new AnalyticsAPI(i,n)).trackAction(e,o)},_daysDiff:function(e,t){if(!e||!t)return!1;var n=e.getTime(),o=t.getTime(),a=Math.abs(o-n);return Math.round(a/864e5)},markPluginPurchased:function(e){if(p._marketplacePromotedData)for(var t=0;t<p._marketplacePromotedData.length;t++)if(p._marketplacePromotedData[t].token==e.token){p._marketplacePromotedData[t].wasPurchased=!0;break}},removePromotedPlugin:function(e){if(p._marketplacePromotedData)for(var t=0;t<p._marketplacePromotedData.length;t++)if(p._marketplacePromotedData[t].token==e.token){p._marketplacePromotedData.splice(t,1);break}},_getPluginConfig:function(o){return new Promise(function(t,n){o&&o.folderName||n({message:"missing pluginFolder in plugin"});var e=window.siteConfig.endPoints.pluginHost+"/"+o.folderName+"/plugin.json?v="+(o.lastUpdatedOn?o.lastUpdatedOn:"");r.get(e).success(function(e){t(e)}).error(function(e){n(e)})})},_setUserReachedPlugins:function(e){var t={lastSyncDate:new Date,plugins:e};localStorage.setItem("marketplace_"+window.appContext.currentApp.appId+"_promoted_plugins",JSON.stringify(t))},_getUserReachedPlugins:function(){var t=localStorage.getItem("marketplace_"+window.appContext.currentApp.appId+"_promoted_plugins");try{t=JSON.parse(t)}catch(e){t={plugins:{}}}return t||{plugins:{}}},getPromotedPlugins:function(l){return new Promise(function(a,t){var i=p;function n(n){var r;if(n)if(l.excludeInstalledPlugins){var e=n.map(function(e){return e.token});(r=e,new Promise(function(n,o){if(!i._installedPlugins||l.reloadInstalledPlugins){var e=new DatastoreAPI(appContext.currentApp.appId,"pluginInstances",1,0,appContext.currentApp.keys.datastoreKey),t={};r&&(t["$json.token"]={$in:r||[]});var a={obj:{filter:t,fields:["token"],page:0,pageSize:100},tag:""};e.search(a,function(e,t){e?o(e):(i._installedPlugins=t,i._installedPlugins||(i._installedPlugins=[]),n(t||[]))})}else n(i._installedPlugins)})).then(function(e){for(var t=0;t<e.length;t++)l.excludedPlugins[e[t].data.token]=e[t].data;o()})}else o();else a(n=[]);function o(){for(var e=[],t=0;t<n.length;t++)l.excludedPlugins[n[t].token]||e.push(n[t]);a(function(e){for(var t,n,o=e.length;0<o;)n=Math.floor(Math.random()*o),t=e[--o],e[o]=e[n],e[n]=t;return e}(e))}}l?(l.excludedPlugins||(l.excludedPlugins={}),void 0===l.excludeInstalledPlugins&&(l.excludeInstalledPlugins=!0),void 0===l.reloadPromotedPlugins&&(l.reloadPromotedPlugins=!1),void 0===l.reloadInstalledPlugins&&(l.reloadInstalledPlugins=!1)):l={excludedPlugins:{},excludeInstalledPlugins:!0,reloadPromotedPlugins:!1,reloadInstalledPlugins:!1},8===userContext.role.roleId&&(i._marketplacePromotedData=[]),i._marketplacePromotedData&&!l.reloadPromotedPlugins?n(i._marketplacePromotedData):r.get("/api/marketplace/whitelabel/"+window.whitelabelContext.whitelabelId+"/plugins/promoted",{params:{appId:appContext.currentApp.appId}},{}).success(function(e){e&&e[0]&&(i._marketplacePromotedData=e[0],i._marketplacePromotedData=i.markPurchased(i._marketplacePromotedData),n(i._marketplacePromotedData))}).error(function(e){e&&console.error("Marketplace Service: get promoted plugins",e),t(e)})})},showPopup:function(u){var s=p,c=window.siteConfig.endPoints.pluginHost.replace("http:","https:");s._getPluginConfig(u).then(function(e){!function(e){s._trackAction("cp/promotedPluginNotification/reach",null,u.token,{appId:window.appContext.currentApp.appId}),p();var t=document.querySelector("#marketplace-plugins-promotion_template").content.cloneNode(!0);document.querySelector("body").appendChild(t);var n=document.querySelector("#cpSideMenu .app-components").getBoundingClientRect(),o=document.querySelector("#marketplace-plugins-promotion");o.style.left="17px",o.style.top=n.height+n.top+8+"px";var a=document.querySelector("#marketplace-plugins-promotion");a.querySelector("#plugin-promotion-name").innerText=u.pluginTypeName||"";var r=u.description;r&&170<r.length&&(r=r.substring(0,165)+"...");a.querySelector("#plugin-promotion-description").innerText=r||"";var i=ImageLibAPI.tools.resizeImage(c+"/"+u.folderName+"/resources/icon.png?v="+(u.lastUpdatedOn?u.lastUpdatedOn:""),{width:63,height:63,disablePixelRation:!0});a.querySelector("#plugin-promotion-icon").src=i;var l=ImageLibAPI.tools.resizeImage(c+"/"+u.folderName+"/resources/image.png?v="+(u.lastUpdatedOn?u.lastUpdatedOn:""),{width:480,height:270,disablePixelRation:!0});e&&e.media&&e.media[0]&&"image-resource"==e.media[0].type&&(l=ImageLibAPI.tools.resizeImage(c+"/"+u.folderName+"/resources/"+e.media[0].path,{width:480,height:270,disablePixelRation:!0}));a.querySelector("#plugin-promotion-image").src=l,document.querySelector("#cpSideMenu .app-components .main-item-title").classList.add("promoted-badge");new Audio("/ghost.mp3").play();function p(){document.querySelector("#cpSideMenu .app-components .main-item-title").classList.remove("promoted-badge"),document.querySelector("#marketplace-plugins-promotion")&&(document.querySelector("#marketplace-plugins-promotion").classList.remove("bounceInLeft"),document.querySelector("#marketplace-plugins-promotion").classList.add("bounceOutLeft"),setTimeout(function(){document.querySelector("#marketplace-plugins-promotion")&&document.querySelector("#marketplace-plugins-promotion").remove()},3e3))}a.querySelector("#plugin-promotion-close-btn").addEventListener("click",function(e){s._trackAction("cp/promotedPluginNotification/close",null,u.token,{appId:window.appContext.currentApp.appId}),e.stopPropagation(),p()}),a.querySelector(".promoted-body").addEventListener("click",function(e){p();var t={templateUrl:"/pages/plugins/addPlugin/modals/pluginDetails.html",controller:"pluginDetailsCtrl",size:"lg",data:{plugin:u,options:{popupPromotions:!0}}};window.openDialog(t)}),setTimeout(function(){p()},6e4)}(e)},function(e){console.error("MarketplaceServices","showPopup","Error in getting plugin config ")})},startPopupPromotions:function(){var n=p;if(!n.popupPromotionsBusy){n.popupPromotionsBusy=!0;var o=n._getUserReachedPlugins(),e=!1;if(o&&o.lastSyncDate){var t=new Date,a=o.lastSyncDate?new Date(o.lastSyncDate):new Date;1<=n._daysDiff(a,t)&&(e=!0)}else e=!0;if(e)n.getPromotedPlugins({excludedPlugins:o.plugins}).then(function(e){if(e&&0<e.length){var t=e[Math.floor(Math.random()*e.length)];o.plugins||(o.plugins={}),o.plugins[t.token]=t,n._setUserReachedPlugins(o.plugins),n.showPopup(t)}n.popupPromotionsBusy=!1},function(e){n.popupPromotionsBusy=!1});else n.popupPromotionsBusy=!1}},coreFeaturesSuggestions:{search:function(e,i){e||(e={});var t=e.query,l=[];if(t)if((t=t.toLowerCase()).length<3)i(null,[]);else{var p=new RegExp("\\b"+t+"\\b","i");r.get("/bf-marketplace-core-features.json",{}).success(function(e){var t=e&&e.data;if(t){for(var n=0;n<t.length;n++){var o=t[n].title&&t[n].title||"",a=t[n].description&&t[n].description||"",r=t[n].keywords&&t[n].keywords||"";-1==o.search(p)?-1==r.search(p)?-1!=a.search(p)&&l.push(t[n]):l.push(t[n]):l.unshift(t[n])}3<l.length&&(l.length=3)}i(null,l)})}else i(null,[])},goTo:function(e,t){if(e||(e={}),e.feature&&e.searchQuery)switch(p._trackAction("cp/marketplace/core-feature-suggestion/click",window.appContext.currentApp.appId,null,{feature:e.feature,searchQuery:e.searchQuery}),e.feature.type){case"article":e.feature.url&&window.open(e.feature.url,"_blank");break;case"plugin":return t(null,e.feature);case"core":e.feature.url&&o.path(e.feature.url)}t()}}};return e.$on("pluginPurchased",function(e,t){t&&(p.markPluginPurchased(t),n(function(){p.removePromotedPlugin(t)},5e3))}),e.$on("pluginInserted",function(e,t){t&&p.removePromotedPlugin({token:t})}),p}]);
"use strict";$app.service("$searchEngineService",[function(){return{save:function(e,i){(e||(e={}),e.pluginId)?e.instanceId?e.key?e.tag?e.title?searchEngineAPI?new searchEngineAPI({appId:appContext.currentApp.appId,instanceId:e.instanceId,pluginId:e.pluginId}).save({key:e.key,tag:e.tag,title:e.title},function(e,n){e&&console.error("Search Engine Service","add plugin title to searchEngineAPI",e),i&&i(e,n)}):console.error("Search Engine Service","searchEngineAPI is undefined"):console.error("Search Engine Service","save method","Missing options (title)"):console.error("Search Engine Service","save method","Missing options (tag)"):console.error("Search Engine Service","save method","Missing options (key)"):console.error("Search Engine Service","save method","Missing options (instanceId)"):console.error("Search Engine Service","save method","Missing options (pluginId)")},savePluginTitle:function(e,i){e||(e={}),e.pluginId?e.instanceId?e.title?(e.key="$_buildfire_controlPanel_pluginTitle",e.tag="appPlugins",this.save(e,function(e,n){i&&i(e,n)}),i&&i(null,!0)):console.error("Search Engine Service","savePluginTitle Method","Missing options (title)"):console.error("Search Engine Service","savePluginTitle Method","Missing options (instanceId)"):console.error("Search Engine Service","savePluginTitle Method","Missing options (pluginId)")}}}]);
"use strict";var _createClass=function(){function a(e,n){for(var i=0;i<n.length;i++){var a=n[i];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(e,n,i){return n&&a(e.prototype,n),i&&a(e,i),e}}();function _classCallCheck(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}var DeeplinksAPI=function(){function n(e){_classCallCheck(this,n),this.appData=new AppDatastoreAPI(e)}return _createClass(n,[{key:"searchDeeplinks",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},n=arguments[1];if(!e.instanceId)return n({message:"instanceId not provided"},null);var i={filter:{"_buildfire.index.string1":e.instanceId},sort:{"_buildfire.index.text":1}};e.pageSize&&(i.pageSize=e.pageSize),0<=e.pageIndex&&(i.page=e.pageIndex),e.deeplinkName&&(i.filter["_buildfire.index.text"]={$regex:null!=e.deeplinkName?e.deeplinkName:"",$options:"-i"}),this.appData.search({obj:i,tag:"$$deeplinks"},n)}},{key:"getDeeplinkById",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},n=arguments[1];if(!e.instanceId)return n({message:"instanceId not provided"},null);if(!e.deeplinkId)return n({message:"deeplinkId not provided"},null);var i={filter:{"_buildfire.index.string1":e.instanceId}};i.filter["_buildfire.index.array1.string1"]=e.deeplinkId,this.appData.search({obj:i,tag:"$$deeplinks"},n)}}]),n}();