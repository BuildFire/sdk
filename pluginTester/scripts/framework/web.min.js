"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var imageLibCurrentApp=null;function ImageLibAPI(e){this.context={},angular.copy(e,this.context),this.context.datastoreWriteKey&&(this.context.writeKey=this.context.datastoreWriteKey),this.init()}$app.directive("scrolly",function(){return{restrict:"A",link:function(e,t,o){var i=t[0];console.log("loading directive"),t.bind("scroll",function(){i.scrollTop+i.offsetHeight+10>=i.scrollHeight&&e.$apply(o.scrolly)})}}}),$app.service("ImageLibService",["$http",function(a){var o=null,n=null;return{loadImages:function(i){var e,s=i.appId;function t(){return new Promise(function(t,o){var e="".concat(siteConfig.endPoints.datastoreHost,"/app/").concat(s,"/image");a.get(e,{params:i}).then(function(e){t(e?e.data:null)}).catch(function(e){o(e)})})}return void 0!==i.startIndex||i.startKey||(i.startIndex=0),0!=i.startIndex||i.startWith?t():(n&&(e=(new Date).getTime()-n.getTime(),30<Math.round(e%864e5%36e5/6e4)&&(o=n=null)),o=o||t())},resetCachedImages:function(e){n=o=null,e&&e()}}}]),ImageLibAPI.prototype={init:function(e){imageLibCurrentApp=this},showDialog:function(e,t){this&&this.context&&(imageLibCurrentApp.context=this.context),imageLibCurrentApp.options=e;e="pages/imageLib/imageLib.html",e={templateUrl:e=void 0!==imageLibCurrentApp&&imageLibCurrentApp.imageLibTemplate?imageLibCurrentApp.imageLibTemplate:e,controller:"imageLibCtrl",size:"lg",position:"modal-pos"};window.openDialog(e,function(e){t&&t(null,e)})}},ImageLibAPI.tools={resizeImage:function(e,t){if(!e)return null;if("gif"==e.split(".").pop().toLowerCase())return e;var o=t.disablePixelRation?1:window.devicePixelRatio;if(t){if("object"!=_typeof(t))throw"options not an object"}else t={width:window.innerWidth};"full"==t.width&&(t.width=window.innerWidth),"full"==t.height&&(t.height=window.innerHeight);var i="https://apmyztgbko.cloudimg.io/s/";return t.width&&!t.height?i+"width/"+Math.floor(t.width*o)+"/"+e:!t.width&&t.height?i+"height/"+Math.floor(t.height*o)+"/"+e:t.width&&t.height?i+"resizenp/"+Math.floor(t.width*o)+"x"+Math.floor(t.height*o)+"/"+e:e},cropImage:function(e,t){if(!e)return null;var o=t.disablePixelRation?1:window.devicePixelRatio;if("object"!=_typeof(t))throw"options not an object";if("full"==(t=t.width||t.height?t:{width:"full",height:"full"}).width&&(t.width=window.innerWidth),"full"==t.height&&(t.height=window.innerHeight),!t.width||!t.height)return console.warn("cropImage doenst have width or height please fix. returning original url"),e;return"https://apmyztgbko.cloudimg.io/s/crop/"+Math.floor(t.width*o)+"x"+Math.floor(t.height*o)+"/"+e},checkTransparent:function(e,s){var a=document.createElement("img"),n=(a.crossOrigin="Anonymous",a.onload=function(){n.width=a.width,n.height=a.height;for(var e=n.getContext("2d"),t=(e.drawImage(a,0,0),e.getImageData(0,0,n.width,n.height).data),o=!1,i=0;i<t.length;i+=4)if(t[i+3]<255){o=!0;break}s(null,o)},a.src=e,document.createElement("canvas"))}},$app.controller("imageLibRemoveCtrl",["$scope","$http","$dialog","$data",function(e,t,o,i){e.close=function(){o.close(null)},e.confirm=function(){o.close(i)}}]),$app.controller("imageLibCtrl",["$scope","Upload","$http","$dialog","$interval","$timeout","angularGridInstance","ImageLibService",function(r,o,l,a,i,s,n,c){r.helpLink="https://learn.appdocumentation.com/en/articles/805514-using-the-media-library",r.readyToShowFiles=!1,r.tools=ImageLibAPI.tools,r.invalidFileType=r.showProgressMessage=r.showSuccessMessage=r.showErrorMessage=r.invalidFileSize=!1,r.hideMessage=function(){r.invalidFileType=r.showProgressMessage=r.showSuccessMessage=r.showErrorMessage=!1},r.showMessage=function(e){r.hideMessage(),r[e]=!0,"showSuccessMessage"===e&&s(function(){r.hideMessage(),r.$digest()},1e4)};function g(e){var t=!0;r.invalidFileSize=!1;for(var o=0;o<e.length;o++)if(10485760<e[o].size){r.invalidFileSize=!(t=!1);break}return t}function e(e,t){var o;0!==e.length&&(1===e.length?(o="".concat(siteConfig.endPoints.datastoreHost,"/app/").concat(imageLibCurrentApp.context.appId,"/validateImage"),l.get(o,{params:{filename:e[0]}}).success(function(e){t(null,e)}).error(function(e){t(e,null),console.error(e)})):(o="".concat(siteConfig.endPoints.datastoreHost,"/app/").concat(imageLibCurrentApp.context.appId,"/validateImage"),l.post(o,{filesNames:e}).success(function(e){t(null,e)}).error(function(e){t(e,null),console.error(e)})))}var t=null,d=(r.files=[],r.selectedFiles={},r.stockImages=[],r.selectedStockImages={},r.loadingFiles=!0,r.hoveredImageName="",r.selectedIcons={},r.iconsShown=!1,r.filesShown=!1,r.stockShown=!1,r.iconsActive=!1,r.filesActive=!1,r.stockActive=!1,r.activeType=function(e){r.iconsActive=!1,r.filesActive=!1,r.stockActive=!1,r.clearSelection(),void 0!==e&&(r[e]=!0)},r.activeFiles=function(){r.selectedFiles={},r.activeType("filesActive")},r.activeIcons=function(){r.selectedIcons={},r.activeType("iconsActive")},r.activeStockImages=function(){r.selectedStockImages={},r.activeType("stockImagesActive")},r.isImageSelected=!1,r.clearSelection=function(){if(r.isImageSelected=!1,r.selectedFiles={},r.files)for(var e=0;e<r.files.length;e++)r.files[e].selected=!1;if(r.selectedIcons={},r.icons)for(e=0;e<r.icons.length;e++)r.icons[e].selected=!1;if(r.selectedStockImages={},r.stockImages)for(e=0;e<r.stockImages.length;e++)r.stockImages[e].selected=!1},r.close=function(){a.close({selectedFiles:[],selectedIcons:[],selectedStockImages:[]})},r.insertSelection=function(){var e=[];if(r.selectedFiles)for(var t in r.selectedFiles)t&&r.selectedFiles[t]&&e.push(r.selectedFiles[t]);var o=[];if(r.selectedIcons)for(var i in r.selectedIcons)i&&r.selectedIcons[i]&&o.push(r.selectedIcons[i]);if(r.selectedStockImages){for(var s in r.selectedStockImages)s&&r.selectedStockImages[s]&&e.push(r.selectedStockImages[s]);r.appendStockImageToSavedList(r.selectedStockImages),I(r.selectedStockImages)}a.close({selectedFiles:e,selectedIcons:o})},r.appendStockImageToSavedList=function(e){if(!(r.cachedStockImages&&50<=r.cachedStockImages.length)){var t,o=!1;for(t in e){var i=d(t);u(i)||(i.selected=!1,r.cachedStockImages.push(i),o=!0)}o&&r.saveStockImages(r.cachedStockImages)}},function(e){for(var t in r.stockImages)if(r.stockImages[t].key==e)return r.stockImages[t]}),u=function(e){for(var t in r.cachedStockImages)if(r.cachedStockImages[t].key==e.key)return!0;return!1},p=(r.saveStockImages=function(e){t.save({tag:"",obj:e},function(e,t){})},r.showRecentUsedLabel=!1,r.getStockImages=function(){r.stockImages=[],t.get({tag:""},function(e,t){if(e)console.error(e);else if(t&&t.data){if(r.cachedStockImages=[],t.data.length&&0!=t.data.length){for(var o in t.data)t.data[o].isCached=!0,r.atLeastOneSearchMade=!0,r.cachedStockImages.push(t.data[o]);r.showRecentUsedLabel=!0}else r.stockImageSearch();r.stockImages=r.cachedStockImages}})},r.selectFile=function(e){"mediaLibraryManagement"!=r.mode&&(imageLibCurrentApp.options&&!1===imageLibCurrentApp.options.multiSelection&&r.clearSelection(),e&&(r.isImageSelected=!0,e.selected=!e.selected,e.selected?r.selectedFiles[e.key]=e.url:delete r.selectedFiles[e.key]))},r.changeFilesView=function(e){"small"!==(r.filesView=e)||r.startWith||r.getFiles()},r.selectIcon=function(e){imageLibCurrentApp.options&&!1===imageLibCurrentApp.options.multiSelection&&r.clearSelection(),e&&(r.isImageSelected=!0,e.selected=!e.selected,e.selected?r.selectedIcons[e.key]=e.class:delete r.selectedIcons[e.class])},r.selectStockImage=function(e){imageLibCurrentApp.options&&!1===imageLibCurrentApp.options.multiSelection&&r.clearSelection(),e&&(r.isImageSelected=!0,e.selected=!e.selected,e.selected?r.selectedStockImages[e.key]=e.url:delete r.selectedStockImages[e.key])},r.$watch("uploadFiles",function(){var i;!r.uploadFiles||r.uploadFiles.length<=0||(r.uploadFiles&&r.uploadFiles.length<1&&(r.invalidFileType=!0),r.uploadFiles&&0<r.uploadFiles.length&&!g(r.uploadFiles)||(r.uploadFiles&&1===r.uploadFiles.length?r.uploadFiles[0].name&&(r.showMessage("showProgressMessage"),e([r.uploadFiles[0].name],function(e,t){e?(console.error(e),r.showMessage("showErrorMessage")):!t||t.isInvalidFilename||t.isFileExist?(e={newFile:r.uploadFiles[0],fileValidateInfo:t},p(e,!0).then(function(){return r.showMessage("showSuccessMessage")}).catch(function(e){r.hideMessage()})):(r.hideMessage(),r.upload(r.uploadFiles[0],function(e){e?r.showMessage("showErrorMessage"):r.showMessage("showSuccessMessage")}))})):r.uploadFiles&&1<r.uploadFiles.length&&(i=r.uploadFiles.map(function(e){return e.name.toLowerCase()}),r.showMessage("showProgressMessage"),e(i,function(e,t){var o;e?(console.error(e),r.showMessage("showErrorMessage")):(o=i,t.reduce(function(e,t){return e.then(function(){var e=r.uploadFiles.find(function(e){return e.name.toLowerCase()===t.filename.toLowerCase()});return e?t.isFileExist||t.isInvalidFilename?p({newFile:e,filesNames:o,fileValidateInfo:t},!1).catch(function(e){throw e}):(r.upload(e),Promise.resolve()):Promise.resolve()}).catch(function(e){throw e})},Promise.resolve()).catch(function(e){throw e}).then(function(){return r.showMessage("showSuccessMessage")}).catch(function(e){"The user canceled the upload"!==e?(console.error(e),r.showMessage("showErrorMessage")):r.hideMessage()}))}))))}),function(e,i){return new Promise(function(t,o){window.openDialog({templateUrl:"imageRenameAndReplace.html",controller:"imageRenameAndReplaceCtrl",data:e,size:"md",backdrop:"static",keyboard:!1},function(e){e&&("cancel"===e.action?o("The user canceled the upload"):"replace"===e.action?r.replaceFileApi(e.existingFile,e.newFile,i):"rename"===e.action&&r.upload(e.newFile)),t()})})}),m=(r.replaceFileApi=function(s,e,a){var t;s||e?g([e])&&(t=window.siteConfig.endPoints.datastoreHost+"/app/"+imageLibCurrentApp.context.appId+"/image/replace",o.upload({url:t,fields:{},data:{existingFileKey:s.key},file:e,headers:{writeKey:imageLibCurrentApp.context.writeKey}}).progress(function(e){r.progressMessage=!0,a&&r.showMessage("showProgressMessage")}).success(function(e,t,o,i){s.url=s.url+"?cacheBuster="+Math.random(),h(s,function(e){var t;e&&(t=r.files.findIndex(function(e){return e.key==s.key}),r.files.splice(t,1),r.files.push(e),c.resetCachedImages(),r.refreshFiles({delay:3e3,forceRefresh:!0}))}),r.addCacheBusterImage(s),a&&r.showMessage("showSuccessMessage")}).error(function(e){a&&r.showMessage("showErrorMessage")})):r.invalidFileType=!0},r.searchFiles=function(){var e={startIndex:0};r.startWith&&(e.startWith=r.startWith),r.readyToShowFiles=!1,r.loadingFiles=!0,r.getFiles(e,function(){})},r.validateFile=function(e,o){var t;e&&(t=window.siteConfig.endPoints.datastoreHost+"/app/"+imageLibCurrentApp.context.appId+"/validateImage",l.get(t,{params:{filename:e}}).success(function(e,t){o(e)}).error(function(e,t){o(e),console.error(e)}))},r.removeFilePopup=function(e){window.openDialog({templateUrl:"imageLibRemove.html",controller:"imageLibRemoveCtrl",data:e,size:"sm"},r.removeFile)},r.removeStockImagePopup=function(e){window.openDialog({templateUrl:"imageLibRemove.html",controller:"imageLibRemoveCtrl",data:e,size:"sm"},r.removeStockImage)},r.removeStockImage=function(e){void 0!==e&&null!=e&&r.cachedStockImages[e]&&r.cachedStockImages[e].key&&(r.cachedStockImages.splice(e,1),r.saveStockImages(r.cachedStockImages))},!(r.removeFile=function(s){var e;void 0!==s&&null!=s&&(r.files[s]&&r.files[s].key?(e=window.siteConfig.endPoints.datastoreHost+"/app/"+imageLibCurrentApp.context.appId+"/image/delete",l.post(e,{key:r.files[s].key},{headers:{writekey:imageLibCurrentApp.context.writeKey}}).success(function(e,t,o,i){r.files.splice(s,1),c.resetCachedImages(),r.refreshFiles({delay:1e3,forceRefresh:!0})}).error(function(e,t,o,i){console.error(e)})):console.log("invalid key to remove"))})),h=(r.refreshFiles=function(e,t){e=e||{},m&&!e.forceRefresh||(m=!0,s(function(){m=!1,n.gallery&&n.gallery.refresh&&n.gallery.refresh(),r.readyToShowFiles=!0,r.loadingFiles=!1,r.$$phase||r.$digest(),t&&t()},e.delay||50))},function(t,o){var e,i,s;!t||r.files.find(function(e){return e.url==t.url})?o&&o():((e=new Image).onload=function(e){t.actualHeight=this.height,t.actualWidth=this.width,o&&o(t)},e.onerror=function(){o&&o()},i=t.url,(s=r.checkCacheBusterImage(t))&&(i+="?cacheBuster="+s.getTime()),"gif"===(s=t.key.split(".").pop()).toLowerCase()||"svg"===s.toLowerCase()?t.clientUrl=e.src=t.url:t.clientUrl=e.src=r.tools.resizeImage(i,{width:200,cacheBusting:!0}))}),f=(r.onImageHover=function(e){r.hoveredImageName=e.key.split("/").pop()},r.onImageHoverLeave=function(){r.hoveredImageName=""},r.isEditImageOptionShown=function(e){e=e.clientUrl.split(".").pop();return"gif"!==e.toLowerCase()&&"svg"!==e.toLowerCase()},r.addCacheBusterImage=function(e){var t=window.localStorage.getItem("cacheBusterImages");t?(t=JSON.parse(t))[e.key]=new Date:(t={})[e.key]=new Date,window.localStorage.setItem("cacheBusterImages",JSON.stringify(t))},r.checkCacheBusterImage=function(e){var t=window.localStorage.getItem("cacheBusterImages");if(!t)return null;var o=(t=JSON.parse(t))[e.key];if(!o)return null;var i=new Date,o=new Date(o);return 8<Math.abs(i.getTime()-o.getTime())/36e5?(delete t[e.key],window.localStorage.setItem("cacheBusterImages",JSON.stringify(t)),null):o},r.editFile=function(n){var t={templateUrl:"imageLibReplace.html",controller:"imageLibReplaceCtrl",data:n,size:"sm"},e=r.files[n].url,o=r.checkCacheBusterImage(r.files[n]);o&&(e+="?cacheBuster="+o.getTime()),imageEditor.launchEditor("imgLibFile"+n,e,function(e,a){window.openDialog(t,function(e){var t,o,i,s;"replace"==e?(t=a,o=n,i=r.files[o],s=window.siteConfig.endPoints.datastoreHost+"/app/"+imageLibCurrentApp.context.appId+"/image/base64",r.showMessage("showProgressMessage"),l.post(s,{base64Data:t,existingImageKey:i.key},{headers:{writeKey:imageLibCurrentApp.context.writeKey}}).success(function(e){var t=angular.copy(i);t.url=i.url+"?cacheBuster="+Math.random(),h(t,function(e){e&&(r.files.splice(o,1),r.files.push(e),c.resetCachedImages(),r.refreshFiles({delay:3e3,forceRefresh:!0}))}),r.showMessage("showSuccessMessage"),r.addCacheBusterImage(i)}).error(function(e){console.log(e),r.showMessage("showErrorMessage")})):"dontReplace"==e&&(s=a,t=window.siteConfig.endPoints.datastoreHost+"/app/"+imageLibCurrentApp.context.appId+"/image/base64",r.showMessage("showProgressMessage"),l.post(t,{base64Data:s},{headers:{writeKey:imageLibCurrentApp.context.writeKey}}).success(function(e){h({key:e.key,url:e.url,selected:!1},function(e){e&&r.files.splice(0,0,e),c.resetCachedImages(),r.refreshFiles({delay:1e3,forceRefresh:!0},function(){var e=document.getElementById("media-library-upload-imgs");e&&(e.scrollTop=0)})}),r.showMessage("showSuccessMessage")}).error(function(e){console.log(e),r.showMessage("showErrorMessage")}),r.$$phase||r.$digest())})},function(e){console.error(e)})},r.upload=function(e,s){var t=null;imageLibCurrentApp&&(t=window.siteConfig.endPoints.datastoreHost+"/app/"+imageLibCurrentApp.context.appId+"/image"),e&&o.upload({url:t,fields:{},data:{filename:e.name},file:e,headers:{writeKey:imageLibCurrentApp.context.writeKey}}).progress(function(e){r.progressMessage=!0}).success(function(e,t,o,i){h({key:e.key,url:e.url,selected:!1},function(e){e&&r.files.splice(0,0,e),c.resetCachedImages(),r.refreshFiles({delay:1e3,forceRefresh:!0},function(){var e=document.getElementById("media-library-upload-imgs");e&&(e.scrollTop=0)})}),s&&s()}).error(function(e){s&&s(e)})},r.onScroll=function(){r.notscrolly&&r.notEmptyData&&r.getFiles()},[]),w=[],I=(r.getFiles=function(e,a){r.notEmptyData=!0,imageLibCurrentApp?2<f.length?r.loadingFiles=!0:(void 0===(e=e||{}).startIndex?r.files&&r.files.length&&(e.startKey=r.files[r.files.length-1].key):(r.files=[],n.gallery&&n.gallery.refresh&&n.gallery.refresh()),r.startWith&&(e.startWith=r.startWith),e.appId=imageLibCurrentApp.context.appId,r.notscrolly=!1,c.loadImages(e).then(function(t){var i=20;function s(){if(f&&!(f.length<1))for(var t=0,o=0;t<i&&f&&!(f.length<1);){t++;var e=f.splice(0,1);e&&e[0]&&h(e[0],function(e){o++,e&&w.push(e),o==t&&setTimeout(function(){for(var t=0;t<w.length;t++)r.files.find(function(e){return e.url==w[t].url})||r.files.push(w[t]);w=[],r.refreshFiles(),setTimeout(function(){s()},100)},10)})}}0<t.length&&0<r.files.length&&r.files.find(function(e){return e.key===t[t.length-1].key})&&(r.notEmptyData=!1);for(var e=0;e<t.length;e++){var o=t[e];o.selected=!1,f.push(o)}0<f.length&&(r.loadingFiles=!0,s()),(!t||t.length<=0)&&(r.notEmptyData=!1,r.loadingFiles=!1,r.readyToShowFiles=!0),r.notscrolly=!0,a&&a(null,t)}).catch(function(e){console.error(e),a&&a(data,null)})):a&&a({msg:"Invalid folder"},null)},void 0!==imageLibCurrentApp&&(imageLibCurrentApp.options||(imageLibCurrentApp.options={}),r.iconsShown=!(!1===imageLibCurrentApp.options.showIcons),r.filesShown=!(!1===imageLibCurrentApp.options.showFiles),r.stockShown=!(!1===imageLibCurrentApp.options.showStockImages),r.mode=imageLibCurrentApp.options.mode,r.stockShown&&(window.appContext&&window.appContext.currentApp&&window.appContext.currentApp.appId&&window.appContext.currentApp.keys&&window.appContext.currentApp.keys.datastoreKey?t=new DatastoreAPI({appId:window.appContext.currentApp.appId,pluginId:"stockImages",instanceId:"stockImages",liveMode:0,writeKey:window.appContext.currentApp.keys.datastoreKey}):(imageLibCurrentApp.options.showStockImages=!1,r.stockShown=!1,console.error("stockImages error: missing appId or datastoreKey")))),"mediaLibraryManagement"===r.mode?r.filesView="large":r.filesView="small",r.stockShown&&(r.activeTab=2,r.activeStockImages(),r.getStockImages()),r.iconsShown&&(r.activeTab=0,l.get(siteConfig.endPoints.appHost+"/styles/bootstrapIcons.css").success(function(e){var t,a,o=angular.element(document.querySelector("#iconsFrame"))[0],n=o.contentDocument;(n=!n&&o&&o.contentWindow&&o.contentWindow.document?o.contentWindow.document:n)?(n.head.innerHTML="<style id='iconStyle' type='text/css'>"+e+"</style>",a=0,o=function(){a++;try{for(var e,t=n.styleSheets[n.styleSheets.length-1],o=t.rules||t.cssRules,i=[],s=0;s<o.length;s++)void 0!==o[s].selectorText&&0==o[s].selectorText.indexOf(".glyphicon-")&&(e=(e=(e=(e=(e=o[s].selectorText.replace(".glyphicon-","")).replace("::before","")).replace(":before","")).replace(":after","")).replace("::after",""),i.indexOf(e)<0&&i.push({key:"glyphicon glyphicon-"+e,class:"glyphicon glyphicon-"+e,selected:!1}));r.icons=i}catch(e){if(10==a&&(r.stopInterval(),console.error("stop trying")),e&&"InvalidAccessError"==e.name)return void console.warn("icons css document not parsed yet");console.error(e)}r.stopInterval()},r.stopInterval=function(){angular.isDefined(t)&&(i.cancel(t),t=void 0)},t=i(o,50),o()):console.warn("innerDoc was not found")}),r.activeIcons()),r.filesShown&&(r.activeTab=1,r.activeFiles(),r.getFiles({startIndex:0},function(){})),r.currentStockImagePage=1,r.totalStockImagesPages=1,r.showNoResultLabel=!1,r.atLeastOneSearchMade=!1,r.stockImageSearch=function(){r.selectedStockImages={},r.stockImages=[],r.currentStockImagePage=1,r.retrieveStockImage()},r.retrieveStockImage=function(){var e;r.stockImagesKeyword&&(e=r.stockImagesKeyword?escape(r.stockImagesKeyword):"",r.loadingStockImage=!0,r.atLeastOneSearchMade=!0,l.post(siteConfig.endPoints.appHost+"/api/stockImages/search",{query:e,page:r.currentStockImagePage}).success(function(e){r.showRecentUsedLabel=!1,r.totalStockImagesPages=e.totalPages;var t=(new Date).getTime();r.showNoResultLabel=0==e.images.length;for(var o=0;o<e.images.length;o++){var i={key:t+"_"+o,url:e.images[o].urls.regular,imageId:e.images[o].imageId,photographerName:e.images[o].photographerName,selected:!1};r.stockImages.push(i)}r.loadingStockImage=!1}).error(function(e){console.error(e),r.loadingStockImage=!1}))},r.loadMoreStockImages=function(){r.stockActive&&!r.loadingStockImage&&r.totalStockImagesPages!=r.currentStockImagePage&&(r.currentStockImagePage++,r.retrieveStockImage())},function(e){var t,o=[];for(t in e){var i=d(t);i.imageId&&o.push(i.imageId)}0<o.length&&l.post(siteConfig.endPoints.appHost+"/api/stockImages/view",{ids:o}).success(function(e){}).error(function(e){})})}]),$app.controller("imageLibReplaceCtrl",["$scope","$http","$dialog","$data",function(e,t,o,i){e.close=function(){o.close(null)},e.confirm=function(e){o.close(e)}}]),$app.controller("imageRenameAndReplaceCtrl",["$scope","$http","$dialog","$data",function(s,a,n,t){s.loading=!1,s.errors={},s.data={newFile:t.newFile,isInvalidFilename:t.fileValidateInfo.isInvalidFilename,isFileExist:t.fileValidateInfo.isFileExist,existingFile:t.fileValidateInfo.file,fileExtension:"."+t.newFile.name.split(".").pop(),uploadedFilesNames:t.filesNames},s.encodeImageFileAsURL=function(){var e=new FileReader;e.onloadend=function(){return s.imageBase64=e.result},e.readAsDataURL(t.newFile)},s.encodeImageFileAsURL();s.rename=function(){if(s.errors.fileName=null,s.newFilename&&0!==s.newFilename.length){var o=s.newFilename.trim()+s.data.fileExtension;if((o=o.toLowerCase())===s.data.newFile.name)return s.errors.fileName="Can't use same file name";s.loading=!0,s.data.uploadedFilesNames&&-1<s.data.uploadedFilesNames.indexOf(o)?s.errors.fileName="Name is already in use":(i=function(e,t){s.loading=!1,t&&t.isInvalidFilename?s.errors.fileName="Wrong, image name can't contains any of the following characters:  < > : \" / \\ | ? *":t&&!t.isFileExist?(s.errors=null,Object.defineProperty(s.data.newFile,"name",{writable:!0,value:o}),n.close({action:"rename",newFile:s.data.newFile})):s.errors.fileName="Name is already in use"},0!==(e=o).length&&(t="".concat(siteConfig.endPoints.datastoreHost,"/app/").concat(imageLibCurrentApp.context.appId,"/validateImage"),a.get(t,{params:{filename:e}}).success(function(e,t){i(null,e)}).error(function(e,t){console.error(e),i(e,null)})))}else s.errors.fileName="Image name cannot be empty";var e,i,t},s.replace=function(){s.close({action:"replace",newFile:s.data.newFile,existingFile:s.data.existingFile})},s.close=function(){n.close(0<arguments.length&&void 0!==arguments[0]?arguments[0]:null)}}]);
"use strict";function ColorLibAPI(o){this.context={},angular.copy(o,this.context),this.init()}ColorLibAPI.prototype={init:function(){},showDialog:function(t,e){var r=this,o=(t=t||{},""),o={templateUrl:(o=window.siteConfig&&window.siteConfig.endPoints&&window.siteConfig.endPoints.appHost?window.siteConfig.endPoints.appHost:o)+"/pages/colorLib/colorLib.html",controller:"colorLibCtrl",size:"sm",backdrop:t.backdrop,position:t.position,data:{options:t,onChange:function(o,t){r._onChange&&r._onChange(t)}}};window.openDialog(o,function(o){e&&e(null,o||t.data)})},onChange:function(o){this._onChange=o}},$app.controller("colorLibCtrl",["$scope","$dialog","$data","$window",function(r,o,i,t){r.tools=ImageLibAPI.tools,r.appHost=window.siteConfig.endPoints.appHost,i.options||(i.options={}),r.gradientTypes={"to bottom":"Bottom","to right":"Right","to top left":"Top Left","to top right":"Top Right","to top":"Top","to left":"Left","to bottom left":"Bottom Left","to bottom right":"Bottom Right"},!i.options.data||angular.equals(i.options.data,{})?r.items={gradient:{colors:[{color:"",percentage:0,opacity:100},{color:"",percentage:100,opacity:100}],gradientType:"to bottom"},solid:{color:"",opacity:100}}:(r.items={},angular.copy(i.options.data,r.items),r.items.gradient||(r.items.gradient={colors:[{color:"",percentage:0,opacity:100},{color:"",percentage:100,opacity:100}],gradientType:"to bottom"}),r.items.solid||(r.items.solid={color:"",opacity:100})),r.colorTypes={};var e=r.items.colorType;function c(o,t){void 0===t&&(t=100);var o=(o=o||"#ffffff").substring(0,7);return t=t,o=(o=o).replace("#",""),"rgba("+parseInt(o.substring(0,2),16)+","+parseInt(o.substring(2,4),16)+","+parseInt(o.substring(4,6),16)+","+t/100+")"}e=i.options.hideGradient?"gradient"===e?null:"solid":(r.colorTypes.gradient="Gradient",e||"gradient"),i.options.hideSolid?e="solid"===e?null:"gradient":r.colorTypes.solid="Solid",r.items.colorType=e,angular.element(t).bind("mousedown",function(){r.config={},r.$apply()}),r.$watch("items.gradient",function(o,t){var e;o&&(o.colors&&o.colors[0]&&o.colors[0].color&&-1<o.colors[0].color.indexOf("#")&&(o.colors[0].colorHex=o.colors[0].color),o.colors&&o.colors[0]&&(void 0===o.colors[0].percentage&&(r.items.gradient.colors[0].percentage=o.colors[0].percentage=0),void 0===o.colors[0].opacity&&(r.items.gradient.colors[0].opacity=o.colors[0].opacity=100)),r.items.gradient.colors[0].color=c(o.colors[0].colorHex,o.colors[0].opacity),o.colors&&o.colors[1]&&o.colors[1].color&&-1<o.colors[1].color.indexOf("#")&&(o.colors[1].colorHex=o.colors[1].color),o.colors&&o.colors[1]&&(void 0===o.colors[1].percentage&&(r.items.gradient.colors[1].percentage=o.colors[1].percentage=100),void 0===o.colors[1].opacity&&(r.items.gradient.colors[1].opacity=o.colors[1].opacity=100)),r.items.gradient.colors[1].color=c(o.colors[1].colorHex,o.colors[1].opacity),e=(e=(e=(e=(e=(e="linear-gradient({gradientType}, {colorOne} {colorOnePercentage}%, {colorTwo} {colorTwoPercentage}%)").replace("{gradientType}",o.gradientType)).replace("{colorOne}",o.colors[0]?o.colors[0].color:"")).replace("{colorOnePercentage}",o.colors[0]?o.colors[0].percentage:0)).replace("{colorTwo}",o.colors[1]?o.colors[1].color:"")).replace("{colorTwoPercentage}",o.colors[1]?o.colors[1].percentage:100),r.items.gradient.backgroundCSS="background: "+e,r.items.gradient.backgroundCSSValue=e,i.onChange&&i.onChange(null,r.items))},!0),r.$watch("items.solid",function(o,t){o&&(o.color&&-1<o.color.indexOf("#")&&(o.colorHex=o.color),r.items.solid.color=c(o.colorHex,o.opacity),r.items.solid.backgroundCSS="background: "+r.items.solid.color,r.items.solid.colorCSS="color: "+r.items.solid.color,i.onChange&&i.onChange(null,r.items))},!0),r.$watch("items.colorType",function(o,t){o&&i.onChange&&i.onChange(null,r.items)},!0),r.save=function(){o.close(r.items)},r.closeDialog=function(){o.close(null)}}]);
"use strict";$app.service("authManager",["$http","$rootScope",function(l,i){var e={_currentUser:null,attemptAutoLogin:function(){var r=this.getCurrentUser();return r&&this._loggedIn(r),r},getCurrentUser:function(){if(this._currentUser)return this._currentUser;if(localStorage.user){var r;try{r=JSON.parse(localStorage.user)}catch(r){this.setCurrentUser(null)}if(r&&r.userToken)return r;try{localStorage.removeItem("user")}catch(r){}return null}return null},setCurrentUser:function(r){if(e._currentUser=r)try{localStorage.setItem("user",JSON.stringify(r)),localStorage.removeItem("lastRequest")}catch(r){if(r&&(22==r.code||"QUOTA_EXCEEDED_ERR"==r.name))return void alert("Your browser does not support using storage. Please switch to normal mode if you are using private mode or use another browser.")}else try{localStorage.removeItem("user")}catch(r){}i.$broadcast("userChanged",r)},isUserLoggedIn:function(){return null!=this.getCurrentUser()},validate:function(){l.post("/api/login/validate",null)},_login:function(r,e,t,o){var n="";return l.post(n+=r,{email:e,password:t},{bypassInterceptorForStatus:404}).success(this.setCurrentUser).error(function(r){r&&"NOTFOUND"==r.code&&i.$broadcast("apiError",{code:"NOTFOUND",message:"Invalid username or password"})})},logout:function(){null!=this.getCurrentUser()&&this.setCurrentUser(null),l.post("/logout",null).finally(function(){}),localStorage.removeItem("user"),this.logoutHandler()},logoutHandler:function(){window.location="/logout"},resetPassword:function(r,e){},loginAdminPortal:function(r,e,t){return this._login("/api/login/adminPortal/",r,e,t)},loginWhitelabelContrlPanel:function(r,e,t){return this._login("/api/login/whitelabelControlPanel/",r,e,t)},loginDeveloperPortal:function(r,e,t){return this._login("/api/login/developerPortal/",r,e,t)},loginControlPanel:function(r,e,t){return this._login("/api/login/controlPanel/",r,e,t)},loginApi:null};return e}]);
"use strict";var PopupLibAPI={confirm:function(t,e){!1!==(t=t||{}).allowHtml&&(t.allowHtml=!0),t.message?(t.confirmButton||(t.confirmButton={text:"Confirm",type:"primary",key:"confirm"}),t.confirmButton.text||(t.confirmButton.text="Confirm"),t.confirmButton.key||(t.confirmButton.key="confirm"),t.confirmButton.type||(t.confirmButton.type="primary"),t.cancelButton||(t.cancelButton={text:"Cancel",type:"default",key:"cancel"}),t.cancelButton.text||(t.cancelButton.text="Cancel"),t.cancelButton.key||(t.cancelButton.key="cancel"),t.cancelButton.type||(t.cancelButton.type="default"),PopupLibAPI.showDialog({title:t.title||"Are you sure?",message:t.message,buttons:[t.confirmButton,t.cancelButton],size:t.size},e)):e("invalid parameter, missing message",null)},alert:function(t,e){!1!==(t=t||{}).allowHtml&&(t.allowHtml=!0),t.message?(t.okButton||(t.okButton={text:"OK",type:"primary",key:"ok"}),t.okButton.text||(t.okButton.text="OK"),t.okButton.key||(t.okButton.key="ok"),t.okButton.type||(t.okButton.type="primary"),PopupLibAPI.showDialog({title:t.title||"Alert",message:t.message,buttons:[t.okButton],size:t.size},e)):e("invalid parameter, messing message",null)},showDialog:function(t,e){if(!1!==(t=t||{}).allowHtml&&(t.allowHtml=!0),t.title){if(t.buttons&&0<t.buttons.length)for(var o=0;o<t.buttons.length;o++){if(!t.buttons[o].text)return void e("invalid parameter, missing text button");if(!t.buttons[o].key)return void e("invalid parameter, missing key button");t.buttons[o].type||(t.buttons[o].type="default")}else t.buttons=[];var n="",n={templateUrl:(n=window.siteConfig&&window.siteConfig.endPoints&&window.siteConfig.endPoints.appHost?window.siteConfig.endPoints.appHost:n)+"/pages/popupLib/popupLib.html",controller:"popupLibCtrl",size:t.size||"sm",data:t};window.openDialog(n,function(t){e&&e(null,t)})}else e("invalid parameter, messing title",null)}};$app.controller("popupLibCtrl",["$scope","$dialog","$data","$sce",function(t,o,e,n){t.allowHtml=e.allowHtml,t.popupData=e,t.popupData.message=n.trustAsHtml(e.message),t.message=e.message,t.title=e.title,t.buttons=e.buttons,t.size=e.size,t.subtitle=e.subtitle,t.hideCloseIcon=e.hideCloseIcon,t.closeDialog=function(){o.close(null)},t.selectedButton=function(t){var e={};t&&(e.selectedButton=angular.copy(t)),o.close(e)}}]);
"use strict";$app.factory("commonPluginService",["$http","promoService","$location",function(i,a,l){var o={redirect:function(n,e){l.path(n).search("token",e).search("showHeader",!1).search("pluginTypeId",null).search("folderName",null)},redirectToActivePlugins:function(n){o.redirect("/activePlugins",n)},addPlugin:function(n){o.redirect("/addPlugin",n)},getPluginJson:function(n,e,t){n=window.siteConfig.endPoints.pluginHost+"/"+n+"/plugin.json?v="+(e||"");i.get(n).success(function(n){t(null,n)}).error(function(n){t(n)})},getMatchingInstances:function(e,n){return n.filter(function(n){return e==n.token})},filteredPluginInstances:function(n,t){a.getPluginInstances(n,function(n,e){n?t(n):(e=e.map(function(n){return n.data}).map(function(n){return{instanceId:n.instanceId,pluginTypeId:n.pluginTypeId,token:n.token,title:n.title}}),t(null,e))})},redirectToInstance:function(n){var e=n.token,t=n.pluginInstanceId,i=n.pluginTitle,n=n.folderName,e="/pluginControl/{1}/{2}/{3}/{4}/false".replace("{1}",e).replace("{2}",t).replace("{3}",i).replace("{4}",n);l.path(e)},instanceExists:function(t,i){var l={isInUse:!1};o.getPluginJson(t.folderName,t.lastUpdatedOn,function(n,e){n?i(n):e.singleton?a.getPluginInstances(t,function(n,e){n?i(n):(0<(n=e.filter(function(n){return n.data.pluginTypeId==t.pluginTypeId})).length&&(l.isInUse=!0,l.matches=n),i(null,l))}):i(null,l)})}};return o.clone=function(t,i,l){var n;i&&i.data&&(t=t||{},n={domain:window.siteConfig.endPoints.datastoreHost,appId:appContext.currentApp.appId,folderName:i.data._buildfire.pluginType.result[0].folderName,pluginTypeId:i.data._buildfire.pluginType.result[0].pluginTypeId},o.instanceExists(n,function(n,e){n?console.error(n):e.isInUse?!(e={token:(n=e.matches[0].data).token,pluginInstanceId:n.instanceId,pluginTitle:n.title,folderName:n._buildfire.pluginType.result[0].folderName})===t.allowSingletonRedirection?window.PopupLibAPI.alert({title:"Singleton Feature",message:"Singleton feature already exist!"},function(n,e){}):(toast("Singleton. Redirecting to instance.","warning"),o.redirectToInstance(e)):(n={templateUrl:"/pages/plugins/clonePlugin/clonePluginDialog.html",controller:"clonePluginDialogCtrl",size:"sm",data:{plugin:angular.fromJson(angular.toJson(i)),includePluginData:t.includePluginData}},window.openDialog(n,function(n){n&&l(n)}))}))},o.navigateToPlugin=function(n){n={token:n.data._buildfire.pluginType.result[0].token,pluginInstanceId:n.data.instanceId||n.data.refId,pluginTitle:n.data.title,folderName:n.data._buildfire.pluginType.result[0].folderName};o.redirectToInstance(n)},o}]);
"use strict";$app.controller("openDialogCtrl",["$uibModal",function(n){function l(o,e){this.modalInstance=null,this.options=o,this.callback=e}l.prototype.open=function(o){var e=this,t=o||this.options;this.modalInstance=n.open({animation:!0,windowClass:t.position||"",templateUrl:t.templateUrl,controller:t.controller,size:t.size,backdrop:void 0===t.backdrop||t.backdrop,keyboard:void 0===t.keyboard||t.keyboard,resolve:{$data:function(){return t.data},$dialog:function(){return e}}}),this.modalInstance.result.then(function(o){e.callback&&e.callback(o)},function(){t.useCallbackWhenNoAction&&e.callback&&e.callback()})},l.prototype.close=function(o){this.modalInstance.close(o)},window.openDialog=function(o,e){if(!o)throw"options have not been provided to openDialog";o.controller||console.warn("window.openDialog :: You have to pass the controller value to the openDialog function");var t=window._appRoot||"",t=(o.controller=o.controller||"modalCtrl",o.templateUrl=o.templateUrl||t+"pages/templates/modal.html",new l(o,e));return t.open(),t}}]).directive("googleLangOptions",function(){return{restrict:"A",link:function(o,e,t){window.googleTranslateLoadedCallback=function(){console.log("loaded google translate widget ..............");var o=document.querySelector("iframe.goog-te-menu-frame"),o=(o.contentDocument||o.contentWindow.document).querySelector("body"),e=document.createElement("link");e.rel="stylesheet",e.href="/styles/googleTranslate.css",o.appendChild(e)}}}});
"use strict";$app.controller("pluginInstanceDialog",["$scope","$data","$dialog",function(n,e,t){n.appHost="",n.siteScope="",window.siteConfig&&window.siteConfig.endPoints&&window.siteConfig.endPoints.appHost&&"sdk"==window.siteConfig.scope&&(n.appHost=window.siteConfig.endPoints.appHost,n.siteScope="sdk"),n.showPluginInstances=!0,n.showAddPlugin=!1,n.hideAddPlugin=!1,n.skipPluginInstances=!1,n.hideAddToSideMenuCheckbox=!1,n.selectedPluginsInstances=[],e&&e.options&&(e.options.skipPluginInstances&&(n.showPluginInstances=!1,n.showAddPlugin=!0,n.skipPluginInstances=!0),e.options.hideAddPlugin&&(n.hideAddPlugin=e.options.hideAddPlugin),e.options.hideAddToSideMenuCheckbox&&(n.hideAddToSideMenuCheckbox=e.options.hideAddToSideMenuCheckbox)),n.cancel=function(){t.close(null)},n.close=function(e){t.close(e)},n.goToPluginInstances=function(){var e=(0<arguments.length&&void 0!==arguments[0]?arguments[0]:{}).selectedPluginInstance,e=void 0===e?null:e;n.showAddPlugin=!1,n.showPluginInstances=!0,e&&n.selectedPluginsInstances.push(e)},n.goToAddPluginDialog=function(){n.showPluginInstances=!1,n.showAddPlugin=!0},n.refreshPluginInstances=function(){n.$broadcast("searchPluginInstances",{})}}]),$app.controller("pluginInstanceSearchCtrl",["$scope","$rootScope","$analytics","commonPluginService","addPluginService",function(c,e,n,t,u){c.appHost="",window.siteConfig&&window.siteConfig.endPoints&&window.siteConfig.endPoints.appHost&&"sdk"==window.siteConfig.scope&&(c.appHost=window.siteConfig.endPoints.appHost),c.contextOptions={allowAddFeatureBtn:!0,showCloneBtn:!0};var i,a={controller:"pluginInstanceDialog",appId:window.appContext.currentApp.appId,liveMode:window.appContext.currentApp.liveMode,pluginId:"pluginInstances",instanceId:1,writeKey:appContext.currentApp.keys.datastoreKey},r=(c.tools=ImageLibAPI.tools,appContext.currentApp.config&&(c.marketplaceButton=appContext.currentApp.config.marketplaceButton),c.data={},c.tools=ImageLibAPI.tools,new DatastoreAPI(appContext.currentApp.appId,"pluginInstances",1,0,appContext.currentApp.keys.datastoreKey));new PluginInstanceAPI(a);function o(){var t;c.$parent&&c.$parent.selectedPluginsInstances&&0<c.$parent.selectedPluginsInstances.length&&(t=c.$parent.selectedPluginsInstances.map(function(e){return e.instanceId}),c.getPluginInstances({instanceIds:t},c.pageSize,1,function(e,n){n&&0<n.length&&c.pluginInstances.forEach(function(e,n){-1<t.indexOf(e.data.instanceId)&&(e.selected=!0,c.onSelectPlugin(e,!0),c.pluginInstances.splice(n,1),c.pluginInstances.unshift(e))})}))}c.getPluginInstances=function(e,n,t,a){function i(e){r.search({obj:{filter:e,page:t-1,pageSize:n,withDynamicData:!0,recordCount:!0},tag:""},function(e,n){if(e)a&&a(e,null);else{for(var e=n.result||[],t=e.filter(function(n){return!c.pluginInstances.find(function(e){return e.data.instanceId===n.data.instanceId})}),i=0;i<t.length;i++)t[i]&&t[i].data&&t[i].data.instanceId&&null!=c.instances[t[i].data.instanceId]&&(t[i].selected=!0);c.totalItems=n.totalRecord,c.pluginInstances=c.pluginInstances.concat(t),0===e.length&&(c.notEmptyData=!1),c.notscrolly=!0,c.loading=!1,a&&a(null,e)}})}var o=e.searchName,e=e.instanceIds,s=(c.loading=!0,{"$json.title":{$regex:null!=o?o:"",$options:"-i"}}),l=(e&&0<e.length&&(s["$json.instanceId"]={$in:e}),{$or:[s]});if(!o)return i(l);var d,p=[];d={pluginTypeName:o,appId:appContext.currentApp.appId,whitelabelId:window.whitelabelContext.whitelabelId,reload:!u.miniSearchLoaded,fuzzy:.2,fields:["pluginTypeName"]},new Promise(function(t,i){u.searchAppPluginTypes(d,function(e,n){if(e)return i(e);t(n)})}).then(function(e){e.plugins.forEach(function(e){p.push({"$json.pluginTypeId":e.pluginTypeId})}),p&&0<p.length&&l.$or.push({$or:p}),i(l)})},c.save=function(){var e,n=[];for(e in c.instances)c.instances.hasOwnProperty(e)&&n.push(c.instances[e]);c.close(n)},c.search=function(){c.loading=!0,c.pluginInstances=[],clearTimeout(i),i=setTimeout(function(){c.notEmptyData=!0,c.notscrolly=!1,c.pageIndex=1,c.setPage()},500)},c.clone=function(e){t.clone({allowSingletonRedirection:!1},e,function(e){c.search()})},c.onSelectPlugin=function(e,n){var e=e.pluginInstance||e,n=(void 0===e.selected||n?e.selected=!0:e.selected=!e.selected,e.data.instanceId),t=e.data.iconUrl,i=e.data._buildfire.pluginType.result[0].token,a=e.data._buildfire.pluginType.result[0].folderName,o=e.data._buildfire.pluginType.result[0].name,s=e.data.title,l=e.data.iconClassName;e.selected?c.instances[(e={instanceId:n,iconUrl:t,title:s,pluginTypeId:i,pluginTypeName:o,folderName:a,iconClassName:l}).instanceId]=e:delete c.instances[n]},c.setPage=function(e){c.getPluginInstances({searchName:c.level.pluginTitle},c.pageSize,c.pageIndex,e)},c.onScroll=function(){c.notscrolly&&c.notEmptyData&&(c.notscrolly=!1,c.pageIndex++,c.setPage())},c.init=function(){c.instances={},c.level={},c.pageIndex=1,c.pageSize=40,c.maxSize=20,c.loading=!1,c.notEmptyData=!0,c.notscrolly=!1,c.level.pluginTitle="",c.pluginInstances=[],c.setPage(function(){o()})},c.init(),e.$on("plugin-instance-created",function(e,n){c.setPage(function(){o()})})}]),$app.controller("addPluginInstanceCtrl",["$scope","$rootScope","$http","$analytics","commonPluginService",function(s,n,l,d,p){s.pluginHost=window.siteConfig.endPoints.pluginHost,s.tools=ImageLibAPI.tools;function e(e,n,t){var i=window.siteConfig.endPoints.appHost+"/api/appPluginTypes/search",a=localStorage.getItem("user");a?(a=JSON.parse(a),l.get(i,{headers:{auth:a.auth,userToken:a.userToken},params:{appId:window.appContext.currentApp.appId,pluginTypeName:e,pageSize:n,pageIndex:t}}).success(function(e){s.plugins=e.data,s.totalItems=e.total})):(s.plugins=[],s.totalItems=0)}var c=new DatastoreAPI(appContext.currentApp.appId,"pluginInstances",1,0,appContext.currentApp.keys.datastoreKey),i=new DatastoreAPI(appContext.currentApp.appId,"sideMenu",1,0,appContext.currentApp.keys.datastoreKey),t=(s.openAddPageDialog=function(o){var t,i,a,e;o&&(t=function(n){"addPage"==n.operation&&null!=n.title&&l.get("/api/appPluginTypes/validateToAdd",{params:{appId:window.appContext.currentApp.appId,token:o.token}}).success(function(e){e&&e.isActive?i(n):toast("Invalid to add, the plugin is inactive","danger")})},i=function(e){var n,t,i,a;"addPage"==e.operation&&null!=e.title&&(n=e.title,t=e.addToSideMenu,window.appContext.currentApp.appId,o.token,e.title,o.folderName,i=o.token+"-"+Date.now(),a={tag:"",obj:{pluginTypeId:o.pluginTypeId,token:o.token,title:n,instanceId:i,refId:i,iconUrl:window.siteConfig.endPoints.pluginHost+"/"+o.folderName+"/resources/icon.png",_buildfire:{pluginType:{dataType:"pluginType",data:o.token}}}},c.insert(a,function(e,n){e?console.log(e):(d.eventTrack("cp/pluginInstanceAdded",{pluginTypeId:o.pluginTypeId,pluginTypeName:o.pluginTypeName,marketItemId:o.marketItemId}),e={instanceId:i,iconUrl:window.siteConfig.endPoints.pluginHost+"/"+o.folderName+"/resources/icon.png",title:a.obj.title,pluginTypeId:o.token,pluginTypeName:o.pluginTypeName,folderName:o.folderName,iconClassName:null},t&&!s.hideAddToSideMenuCheckbox&&s.addToSideMenu(e),s.close([e]))}))},a={templateUrl:"addPage.html",controller:"addPageDialogCtrl",size:"sm",data:{options:{hideAddToSideMenuCheckbox:s.hideAddToSideMenuCheckbox}}},e={domain:window.siteConfig.endPoints.datastoreHost,appId:appContext.currentApp.appId,folderName:o.folderName,pluginTypeId:o.pluginTypeId,lastUpdatedOn:o.lastUpdatedOn},p.instanceExists(e,function(e,n){e?console.error(e):n.isInUse?(n={token:(e=n.matches[0].data).token,pluginInstanceId:e.instanceId,pluginTitle:e.title,folderName:e._buildfire.pluginType.result[0].folderName},s.close(),toast("Singleton. Redirecting to instance.","warning"),p.redirectToInstance(n)):window.openDialog(a,t)}))},s.setPage=function(){e(s.pluginTypeName,s.pageSize,s.pageIndex)},s.addToSideMenu=function(e){s.sideMenu.result.push({id:e.instanceId,data:e}),s.sideMenu.data.push(e.instanceId),t(s.sideMenu)},function(e){var n,t;null!=e&&(t=(n={_buildfire:{sideMenu:e}})._buildfire.sideMenu.result,n._buildfire.sideMenu.result&&delete n._buildfire.sideMenu.result,i.save({tag:"",obj:n},function(e,n){e||!n?alert(JSON.stringify(e)):(emulatorSync.triggerSideMenuOnUpdate(n),console.log("data saved"))}),e.result=t)});function a(){s.sideMenu={dataType:"pluginInstance",data:[]},i.get({withDynamicData:!0},function(e,n){var t,i,a;n&&(n.data&&n.data._buildfire&&n.data._buildfire.sideMenu&&((t=n.data._buildfire.sideMenu).content&&t.content.loadAllPlugins||(t.result=(i=t.result,a=t.data,i.sort(function(e,n){e=a.indexOf(e.data.instanceId),n=a.indexOf(n.data.instanceId);return n<e?1:e<n?-1:0}),i)),s.sideMenu=t),s.id=n.id,s.$$phase||s.$digest())})}s.init=function(){s.totalItems=100,s.pageIndex=1,s.pageSize=10,s.maxSize=5,e(s.pluginTypeName,s.pageSize,s.pageIndex),a()},s.onCreateNewPlugin=function(e){e&&e.obj&&e.obj.instanceId?s.$parent&&s.$parent.goToPluginInstances&&(s.$parent.goToPluginInstances({selectedPluginInstance:{title:e.obj.title,instanceId:e.obj.instanceId}}),n.$broadcast("plugin-instance-created",{})):(window.openDialog({templateUrl:"addPage.html",controller:"addPageDialogCtrl",size:"sm"}),s.$$phase||s.$digest())},n.$on("onCreateNewPlugin",function(e,n){s.onCreateNewPlugin(n)}),s.onCreateSingletonPlugin=function(){window.PopupLibAPI.alert({title:"Singleton Feature",message:"Singleton feature already exist!"},function(e,n){})},s.init()}]),$app.controller("addPageDialogCtrl",["$scope","$dialog",function(e,n){e.addPage=function(){n.close({operation:"addPage",title:e.title})},e.closeDialog=function(){n.close({operation:"close",title:""})}}]);
"use strict";$app.factory("promoService",["$http",function(r){var e={},n=window.siteConfig.menuShortcutsPlugins;return e.getPluginTypeByProperty=function(e,t){return t=t.toLowerCase(),0<(n=n.filter(function(n){return n[e]==t})).length?n[0]:null},e.getPluginTypeInfoByName=function(n){return e.getPluginTypeByProperty("name",n)},e.getPluginTypeInfoById=function(n){return e.getPluginTypeByProperty("pluginTypeId",n)},e.getPluginTypeInfoByToken=function(n){return e.getPluginTypeByProperty("token",n)},e.getPluginInstances=function(n,e){var t=n.domain,n=n.appId;r.post(t+"/plugin/search/"+n+"/pluginInstances/1/primary/0/",{page:0,pageSize:0,withDynamicData:!0,recordCount:!1}).success(function(n){e(null,n)}).error(function(n){e(n)})},e.getLocalPromoUrl=function(n){return"/pages/pluginPromo/templates/"+n+".html"},e.upgrade=function(n){n="//"+n.selfProvDomain+"/upgrade.html#/app/"+n.appId+"/"+n.username;window.location.href=n},e}]);
"use strict";$app.controller("addPageCtrl",["$scope","$dialog","$data",function(e,d,i){i&&i.options&&(i.options.hideAddToSideMenuCheckbox&&(e.hideAddToSideMenuCheckbox=i.options.hideAddToSideMenuCheckbox,e.addToSideMenu=!0),e.pluginTypeName=i.options.pluginTypeName||""),e.addPage=function(){null!=e.title&&""!=e.title?-1!=e.title.indexOf("/")?e.errorMessage='A plugin title may not contain character "/"':(e.adding=!0,i.addingHandler?i.addingHandler({operation:"addPage",title:e.title,addToSideMenu:e.addToSideMenu,$dialog:d}):d.close({operation:"addPage",title:e.title,addToSideMenu:e.addToSideMenu})):e.errorMessage="Please enter a title"},e.closeDialog=function(){d.close({operation:"close",title:""})}}]);
"use strict";function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _iterableToArray(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _createForOfIteratorHelper(e,t){var n,i="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!i){if(Array.isArray(e)||(i=_unsupportedIterableToArray(e))||t&&e&&"number"==typeof e.length)return i&&(e=i),n=0,{s:t=function(){},n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:t};throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,a=!0,l=!1;return{s:function(){i=i.call(e)},n:function(){var e=i.next();return a=e.done,e},e:function(e){l=!0,o=e},f:function(){try{a||null==i.return||i.return()}finally{if(l)throw o}}}}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Map"===(n="Object"===n&&e.constructor?e.constructor.name:n)||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=new Array(t);n<t;n++)i[n]=e[n];return i}"undefined"==typeof ActionItemsAPI&&(window.ActionItemsAPI=function(e){this.templateUrl="pages/share/actionBuilder.html",this.controller="actionItemsCtrl",this.context=e,this.init()}),ActionItemsAPI.prototype.init=function(){},ActionItemsAPI.prototype.showDialog=function(e,t){e={templateUrl:this.templateUrl,controller:this.controller,size:"lg",data:e};window.openDialog(e,function(e){t&&t(null,e)})},$app.controller("actionItemsCtrl",["$scope","$data","$dialog",function(s,e,t){s.appConfig=window.appContext.currentApp.config,s.$dialog=t,s.showTitle=!1,s.tools=ImageLibAPI.tools,s.selectedItemAction=null,s.showCommunicationServices=!1,s.showSocialMedia=!1,s.appHost="",window.siteConfig&&window.siteConfig.endPoints&&window.siteConfig.endPoints.appHost&&"sdk"==window.siteConfig.scope&&(s.appHost=window.siteConfig.endPoints.appHost),s.originalActionItem={},s.init=function(){s.errors={},s.actionItem={},s.options={},s.actionItemAlreadyHasIcon=!1,e&&!e.options&&(e.options={}),e&&e.options&&(s.options=e.options,s.options.showTitle?(s.displayTitle="Display Title",s.showTitle=s.options.showTitle):s.displayTitle="Action Button Text",e.options.actionTextLabel&&(s.displayTitle=e.options.actionTextLabel),void 0!==e.options.allowNoAction?s.options.allowNoAction=e.options.allowNoAction:s.options.allowNoAction=!0,void 0!==e.options.removePurchase?s.options.removePurchase=e.options.removePurchase:s.options.removePurchase=!1),"enabled"!=s.appConfig.inAppPurchases&&(s.options.removePurchase=!0),s.actionItemsList=[{title:"App Sections",icon:s.appHost+"/images/ai_app_content.svg",type:"parent",show:!0,enabled:!0,children:[{title:"App Content",actionName:"linkToApp",show:!0,enabled:!0,image:s.appHost+"/images/ai_app_content.svg",description:"This action will link the user to App Content."},{title:"App Settings",actionName:"navigateToAppSettings",show:!0,enabled:!0,image:s.appHost+"/images/ai_settings.svg",description:"This action will link the user  to the  App Settings screen."},{title:"Bookmarks",actionName:"navigateToBookmarks",show:!0,enabled:!0,image:s.appHost+"/images/ai_bookmarks.svg",description:"This action will link the user to the Bookmarks screen."},{title:"Notifications",actionName:"navigateToNotifications",show:!0,enabled:!0,image:s.appHost+"/images/ai_notifications.svg",description:"This action will link the user to the Notifications screen."},{title:"Notes",actionName:"navigateToNotes",show:!0,enabled:!0,image:s.appHost+"/images/ai_notes.svg",description:"This action will link the user to the Notes screen."},{title:"Search",actionName:"navigateToSearch",show:!0,enabled:"enterprise"==s.appConfig.type,image:s.appHost+"/images/ai_search.svg",description:"This action will link the user to the Search screen."},{title:"Login",actionName:"navigateToLogin",show:!0,enabled:!0,image:s.appHost+"/images/ai_login.svg",description:"This action will link the user to the Login screen."}]},{title:"Contact",icon:s.appHost+"/images/ai_communication.svg",type:"parent",show:!0,enabled:!0,children:[{title:"Send an Email",actionName:"sendEmail",show:!0,enabled:!0,image:s.appHost+"/images/ai_email.svg",description:"This action will link the user to send an Email."},{title:"Send SMS Text Message",actionName:"sendSms",show:!0,enabled:!0,image:s.appHost+"/images/ai_sms.svg",description:"This action will link the user to send an SMS text message."},{title:"Call Phone Number",actionName:"callNumber",show:!0,enabled:!0,image:s.appHost+"/images/ai_phone.svg",description:"This action will link the user to call a phone number."}]},{title:"Map",actionName:"navigateToAddress",icon:s.appHost+"/images/ai_map.svg",image:s.appHost+"/images/ai_map.svg",type:"item",show:!0,enabled:!0,description:"This action will link the user to a location in a map."},{title:"Purchase",actionName:"purchase",icon:s.appHost+"/images/ai_purchase.svg",image:s.appHost+"/images/ai_purchase.svg",type:"item",show:!s.options.removePurchase,enabled:!0,description:"This action will link the user to in app purchases."},{title:"Social Media",icon:s.appHost+"/images/ai_social_media.svg",type:"parent",show:!0,enabled:!0,children:[{title:"Facebook Page",actionName:"linkToSocialFacebook",show:!0,enabled:!0,image:s.appHost+"/images/ai_facebook.png",description:"This action will link the user to a Facebook page."},{title:"Twitter Page",actionName:"linkToSocialTwitter",show:!0,enabled:!0,image:s.appHost+"/images/ai_twitter.png",description:"This action will link the user to a Twitter page."},{title:"Instagram Page",actionName:"linkToSocialInstagram",show:!0,enabled:!0,image:s.appHost+"/images/ai_instagram.png",description:"This action will link the user to a Instagram page."},{title:"LinkedIn Page",actionName:"linkToSocialLinkedIn",show:!0,enabled:!0,image:s.appHost+"/images/ai_linkedin.png",description:"This action will link the user to a LinkedIn page."}]},{title:"Web Content",actionName:"linkToWeb",icon:s.appHost+"/images/ai_web_content.svg",image:s.appHost+"/images/ai_web_content.svg",type:"item",show:!0,enabled:!0,description:"This action will link the user to web content."},{title:"No Action",actionName:"noAction",icon:s.appHost+"/images/ai_no_action.svg",image:s.appHost+"/images/ai_no_action.svg",type:"item",show:!0,enabled:s.options.allowNoAction,hasDivider:!0,description:"This action will link the user to no action."}],e&&e.actionItem&&e.actionItem.action?(s.actionItem=e.actionItem,Object.assign(s.originalActionItem,e.actionItem),(e.actionItem.iconUrl||e.actionItem.iconClassName)&&(s.actionItemAlreadyHasIcon=!0),n(s.actionItem.action)):n("linkToApp")};var n=function(e){var t,n=null,i=_createForOfIteratorHelper(s.actionItemsList);try{for(i.s();!(t=i.n()).done;){var o=t.value;if("parent"!==o.type&&o.actionName===e)return n=o,void s.changeAction(n);if("parent"===o.type&&o.children){var a,l=_createForOfIteratorHelper(o.children);try{for(l.s();!(a=l.n()).done;){var r=a.value;if(r.actionName===e)return n=r,o.isToggled=!0,void s.changeAction(n)}}catch(e){l.e(e)}finally{l.f()}}}}catch(e){i.e(e)}finally{i.f()}};s.onChangeAction=function(e,t){var n,i,o,a,l=_createForOfIteratorHelper(s.actionItemsList);try{for(l.s();!(n=l.n()).done;){var r=n.value;t?"parent"===r.type&&r.children&&r.title!==t.title&&(r.isToggled=!1):"parent"===r.type&&r.children&&r.title!==e.title&&(r.isToggled=!1)}}catch(e){l.e(e)}finally{l.f()}"parent"===e.type?e.isToggled=!e.isToggled:(s.originalActionItem&&0<Object.keys(s.originalActionItem).length&&e.actionName===s.originalActionItem.action?Object.assign(s.actionItem,s.originalActionItem):(i=s.actionItem.title,o=s.actionItem.iconUrl,a=s.actionItem.iconClassName,s.actionItem={},s.actionItem.title=i,s.actionItem.iconUrl=o,s.actionItem.iconClassName=a),"purchase"===e.actionName?s.actionItem.title="Buy Now!":s.originalActionItem&&0<Object.keys(s.originalActionItem).length&&s.originalActionItem.title&&(s.actionItem.title=s.originalActionItem.title),document.querySelector(".action-builder-scrollable").scrollTop=0,s.changeAction(e))},s.changeAction=function(e){switch(s.currentActionItem=e,s.actionItem.action=e.actionName,s.errors={},s.showLinkToAppContent=!1,s.showLinkToWeb=!1,s.showLinkToSocialMedia=!1,s.showSendEmail=!1,s.showSendSms=!1,s.showNavigateToAddress=!1,s.showNoAction=!1,s.showCallNumber=!1,s.showPurchase=!1,s.showSearchInApp=!1,e.actionName){case"purchase":s.showPurchase=!0;break;case"linkToApp":s.showLinkToAppContent=!0;break;case"linkToWeb":s.showLinkToWeb=!0;break;case"sendEmail":s.showSendEmail=!0;break;case"callNumber":s.showCallNumber=!0;break;case"sendSms":s.showSendSms=!0;break;case"navigateToAddress":s.showNavigateToAddress=!0;break;case"navigateToSearch":s.showSearchInApp=!0;break;case"linkToSocialFacebook":case"linkToSocialInstagram":case"linkToSocialTwitter":case"linkToSocialLinkedIn":s.showLinkToSocialMedia=!0;break;case"noAction":case"navigateToLogin":case"navigateToAppSettings":case"navigateToNotifications":case"navigateToBookmarks":case"navigateToNotes":s.showNoAction=!0}},s.openImageLib=function(){s.options&&!s.options.imgLibOptions&&(s.options.imgLibOptions={showIcons:!1}),window.imageLibCurrentApp.showDialog({showIcons:s.options.imgLibOptions.showIcons||!1,showFiles:!0,multiSelection:!1},function(e,t){t&&t.selectedIcons&&0<t.selectedIcons.length&&(s.actionItem.iconClassName=t.selectedIcons[0],s.actionItem.iconUrl=null),t&&t.selectedFiles&&0<t.selectedFiles.length&&(s.actionItem.iconUrl=t.selectedFiles[0],s.actionItem.iconClassName=null)})},s.clearIconUrl=function(){s.actionItem.iconUrl=null,s.actionItem.iconClassName=null,s.actionItemAlreadyHasIcon=!1},s.validUrl=function(e){return!!new RegExp("^(http:/|https:/|http://|https://)[a-z0-9]").test(e)},s.resizeImage=function(e){return e?ImageLibAPI.tools.resizeImage(e,{width:92,height:88}):""},s.close=function(){s.$dialog.close(null)},s.init()}]),$app.controller("pluginSelectorCtrl",["$scope","$dialog",function(i,e){i.$dialog=e,i.tools=ImageLibAPI.tools,i.cancel=function(){i.$dialog.close(null)},i.save=function(){i.$dialog.close(i.selectedPluginInstance)};var e={controller:"pluginInstanceDialog",appId:window.appContext.currentApp.appId,liveMode:window.appContext.currentApp.liveMode,pluginId:"pluginInstances",instanceId:1,writeKey:appContext.currentApp.keys.datastoreKey},o=(i.selectPluginInstance=function(e){var t=e.pluginInstance;e.clearQueryString;i.selectedPluginInstance=t},new PluginInstanceAPI(e));i.getPluginInstances=function(e,t,n){o.search({title:e,pageSize:t,pageIndex:n-1},function(e,t){e?i.pluginInstances=[]:(i.pluginInstances=t.result,i.totalItems=t.totalRecord)})},i.init=function(){i.totalItems=100,i.pageIndex=1,i.pageSize=10,i.maxSize=5,i.pluginTitle=null,i.getPluginInstances(i.pluginTitle,i.pageSize,i.pageIndex)},i.init()}]),$app.controller("linkToWebCtrl",["$scope",function(t){void 0===t.actionItem.openIn&&(t.actionItem.openIn="_blank"),t.checkUrlFormat=function(){null!=t.actionItem.url&&""!=t.actionItem.url&&t.actionItem.url.indexOf("://")<0&&(t.actionItem.url="http://"+t.actionItem.url)},t.cancel=function(){t.$dialog.close(null)},t.save=function(){t.validate()&&t.$dialog.close(t.actionItem)},t.validate=function(){var e=!0;return t.errors.title="",t.errors.urlError="",t.errors.openInError="",!t.options||t.options.hideActionText||null!=t.actionItem.title&&""!=t.actionItem.title||(e=!1,t.errors.title="Required"),null!=t.actionItem.url&&""!=t.actionItem.url||(e=!1,t.errors.urlError="Required"),null!=t.actionItem.openIn&&""!=t.actionItem.openIn||(e=!1,t.errors.openInError="Required"),e}}]),$app.controller("sendSmsCtrl",["$scope",function(t){t.cancel=function(){t.$dialog.close(null)},t.save=function(){t.validate()&&t.$dialog.close(t.actionItem)},t.validate=function(){var e=!0;return t.errors.title="",t.errors.phoneNumberError="",!t.options||t.options.hideActionText||null!=t.actionItem.title&&""!=t.actionItem.title||(e=!1,t.errors.title="Required"),null!=t.actionItem.phoneNumber&&""!=t.actionItem.phoneNumber||(e=!1,t.errors.phoneNumberError="Required"),e}}]),$app.controller("sendEmailCtrl",["$scope",function(t){t.cancel=function(){t.$dialog.close(null)},t.save=function(){t.validate()&&t.$dialog.close(t.actionItem)},t.isValidEmail=function(e){return/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z\-0-9]{2,}))$/.test(e)},t.validate=function(){var e=!0;return t.errors.title="",t.errors.email="",t.errors.subject="",t.errors.body="",!t.options||t.options.hideActionText||null!=t.actionItem.title&&""!=t.actionItem.title||(e=!1,t.errors.title="Required"),null==t.actionItem.email||""==t.actionItem.email?(e=!1,t.errors.email="Required"):t.isValidEmail(t.actionItem.email)||(e=!1,t.errors.email="Invalid Email"),null!=t.actionItem.subject&&""!=t.actionItem.subject||(e=!1,t.errors.subject="Required"),null!=t.actionItem.body&&""!=t.actionItem.body||(e=!1,t.errors.body="Required"),e}}]),$app.controller("linkToSocialMediaCtrl",["$scope",function(t){t.cancel=function(){t.$dialog.close(null)},t.save=function(){t.validate()&&t.$dialog.close(t.actionItem)},t.validate=function(){var e=!0;return t.errors.title="",t.errors.urlError="",!t.options||t.options.hideActionText||null!=t.actionItem.title&&""!=t.actionItem.title||(e=!1,t.errors.title="Required"),null==t.actionItem.url||""==t.actionItem.url?(e=!1,t.errors.urlError="Required"):t.validUrl(t.actionItem.url)||(e=!1,t.errors.urlError="Invalid URL format. Example: http://www.google.com"),e}}]),$app.controller("linkToAppContentCtrl",["$scope","addPluginService",function(r,s){r.contextOptions={title:"Select Feature"};function n(){r.deeplinks={data:[],selectedDeeplink:null,actionItemDeeplink:null,active:!1,isCustomQueryString:!1,customQueryString:"",queryString:"",options:{instanceId:null,deeplinkName:null,pageIndex:0,pageSize:5}},r.deeplinksDataEmpty=!1}var e,t,i,c=new DatastoreAPI(appContext.currentApp.appId,"pluginInstances",1,appContext.currentApp.liveMode,appContext.currentApp.keys.datastoreKey),o=(r.getPluginInstances=function(e,t,n){function i(e){c.search({obj:{filter:e,page:n-1,pageSize:t,withDynamicData:!0,recordCount:!0},tag:""},function(e,t){e?console.error(e):(e=t.result||[],r.totalItems=t.totalRecord,r.pluginInstances=r.pluginInstances.concat(e),0===e.length&&(r.notEmptyData=!1),r.notscrolly=!0,r.loading=!1)})}r.loading=!0;var o={$or:[{"$json.title":{$regex:null!=e?e:"",$options:"-i"}}]};if(!e)return i(o);var a,l=[];a={pluginTypeName:e,appId:appContext.currentApp.appId,whitelabelId:window.whitelabelContext.whitelabelId,reload:!s.miniSearchLoaded,fuzzy:.2,fields:["pluginTypeName"]},new Promise(function(n,i){s.searchAppPluginTypes(a,function(e,t){if(e)return i(e);n(t)})}).then(function(e){e.plugins.forEach(function(e){l.push({"$json.pluginTypeId":e.pluginTypeId})}),l&&0<l.length&&o.$or.push({$or:l}),i(o)})},r.getSelectedPluginInformation=function(){var e={};e.obj={filter:{"$json.instanceId":r.actionItem.instanceId},pageSize:1},c.search(e,function(e,t){t&&t.length&&r.onSelectPlugin({pluginInstance:t[0],clearQueryString:!1})})},r.init=function(){r.level={},r.level.pluginTitle="",r.pluginInstances=[],r.deepLinkPlugin={},r.totalItems=100,r.pageIndex=1,r.pageSize=40,r.maxSize=5,r.action="Add",r.loading=!1,r.notEmptyData=!0,r.notscrolly=!1,r.actionItem.instanceId&&(r.getSelectedPluginInformation(),r.action="Edit"),r.setPage()},r.setPage=function(){r.getPluginInstances(r.level.pluginTitle,r.pageSize,r.pageIndex)},n(),r.onSelectPlugin=function(e){var t=e.pluginInstance,e=e.clearQueryString;void 0!==r.options.showIcon&&0==r.options.showIcon&&r.options.hideActionText&&(r.hideDeeplinkLine=!0),r.errors.selectPlugin="",r.actionItem.instanceId=t.data.instanceId,r.selectedPluginInstance=t,"Add"===r.action&&(r.actionItem.title=t.data.title,r.actionItemAlreadyHasIcon||(r.actionItem.iconUrl=t.data.iconUrl,r.actionItem.iconClassName=t.data.iconClassName)),e?(r.actionItem.queryString="",n()):r.actionItem&&r.actionItem.queryString&&0<r.actionItem.queryString.length&&(r.deeplinks.customQueryString=r.actionItem.queryString,r.deeplinks.active=!0,r.actionItem.deeplinkId||(r.deeplinks.isCustomQueryString=!0)),r.deeplinks.options.instanceId=t.data.instanceId,!e&&r.actionItem&&r.actionItem.deeplinkId&&r.getDeeplinkById(r.actionItem.deeplinkId),a()},new DeeplinksAPI(window.appContext.currentApp.appId)),a=(r.searchDeeplinks=function(){r.deeplinksLoading=!0,r.deeplinksDataEmpty=!1,r.deeplinks.data=[],r.deeplinks.options.pageIndex=0,clearTimeout(e),e=setTimeout(function(){r.loadPluginDeeplinks()},500)},r.onDeeplinkChange=function(e){r.deeplinks.customQueryString="dld=".concat(encodeURIComponent(JSON.stringify(e.data.deeplinkData))),r.deeplinks.queryString="dld=".concat(encodeURIComponent(JSON.stringify(e.data.deeplinkData))),(r.deeplinks.selectedDeeplink=e).data.name&&(r.actionItem.title=e.data.name),e.data.imageUrl&&(r.actionItem.iconUrl=e.data.imageUrl)},r.getDeeplinkById=function(e){var t=r.deeplinks.options.instanceId;o.getDeeplinkById({instanceId:t,deeplinkId:e},function(e,t){if(e)return console.error(e);t&&t[0]&&r.onDeeplinkChange(t[0])})},r.onIsCustomQueryStingChange=function(){r.deeplinks.isCustomQueryString&&(r.deeplinks.selectedDeeplink=null,r.actionItem.deeplinkId=null),r.errors.noQueryString=null},function(){r.deeplinksLoading=!0,clearTimeout(t),t=setTimeout(function(){r.loadPluginDeeplinks()},500)});r.loadPluginDeeplinks=function(){r.deeplinks&&r.deeplinks.options&&r.deeplinks.options.instanceId?(r.deeplinksLoading=!0,o.searchDeeplinks(r.deeplinks.options,function(e,t){if(e)return r.deeplinksLoading=!1,console.error(e);t.length<5&&(r.deeplinksDataEmpty=!0);e=t.filter(function(e){return e.data&&e.data.deeplinkData});r.deeplinks.options.pageIndex++,(t=r.deeplinks.data).push.apply(t,_toConsumableArray(e)),r.deeplinksLoading=!1})):r.deeplinksLoading=!1},r.cancel=function(){r.$dialog.close(null)},r.save=function(){r.deeplinks.active?r.deeplinks.isCustomQueryString?(r.actionItem.queryString=r.deeplinks.customQueryString,r.actionItem.deeplinkId=null):r.deeplinks.selectedDeeplink&&r.deeplinks.selectedDeeplink.data&&r.deeplinks.selectedDeeplink.data._buildfire&&r.deeplinks.selectedDeeplink.data._buildfire.index&&r.deeplinks.selectedDeeplink.data._buildfire.index.array1[0]&&r.deeplinks.selectedDeeplink.data._buildfire.index.array1[0].string1?(r.actionItem.deeplinkId=r.deeplinks.selectedDeeplink.data._buildfire.index.array1[0].string1,r.actionItem.queryString=r.deeplinks.queryString):r.actionItem.queryString=null:(r.actionItem.queryString=null,r.actionItem.deeplinkId=null),r.validate()&&r.$dialog.close(r.actionItem)},r.onScroll=function(){r.notscrolly&&r.notEmptyData&&(r.notscrolly=!1,r.pageIndex++,r.setPage())},r.search=function(){r.loading=!0,r.pluginInstances=[],clearTimeout(i),i=setTimeout(function(){r.notEmptyData=!0,r.notscrolly=!1,r.pageIndex=1,r.setPage()},500)},r.validate=function(){var e=!0;return r.errors.title="",r.errors.selectPlugin="",!r.options||r.options.hideActionText||null!=r.actionItem.title&&""!=r.actionItem.title||(e=!1,r.errors.title="Required"),null!=r.actionItem.instanceId&&""!=r.actionItem.instanceId||(e=!1,r.errors.selectPlugin="Please select a feature"),r.deeplinks.active&&!r.actionItem.queryString&&(e=!1,r.errors.noQueryString="Required"),e},r.init()}]),$app.controller("navigateToAddress",["$scope",function(i){i.marker=null,i.$watch("addressDetails",function(){i.marker&&(i.marker.setMap(null),i.actionItem.lat=null,i.actionItem.lng=null),i.addressDetails&&(i.actionItem.lat=i.addressDetails.geometry.location.lat(),i.actionItem.lng=i.addressDetails.geometry.location.lng(),n())}),i.$on("mapInitialized",function(e,t){i.map=t,i.actionItem.lat&&i.actionItem.lng&&n()}),i.cancel=function(){i.$dialog.close(null)},i.save=function(){i.validate()&&i.$dialog.close(i.actionItem)},i.validate=function(){var e=!0;return i.errors.title="",i.errors.address="",!i.options||i.options.hideActionText||null!=i.actionItem.title&&""!=i.actionItem.title||(e=!1,i.errors.title="Required"),null!=i.actionItem.lat&&null!=i.actionItem.lng||(e=!1,i.errors.address="Required"),e};var n=function(){var e=new google.maps.LatLng(i.actionItem.lat,i.actionItem.lng);i.marker=new google.maps.Marker({position:e,map:i.map,draggable:!0,animation:google.maps.Animation.DROP}),i.map.setCenter(i.marker.getPosition()),i.map.setZoom(12),google.maps.event.addListener(i.marker,"dragend",function(e){i.actionItem.lat=e.latLng.lat(),i.actionItem.lng=e.latLng.lng();var e=i.actionItem.lat,t=i.actionItem.lng,n=function(e){i.actionItem.address=e||"",i.$apply()};e=new google.maps.LatLng(e,t),(new google.maps.Geocoder).geocode({latLng:e},function(e,t){t==google.maps.GeocoderStatus.OK?(t=e[0].formatted_address,n(t)):n(null)})})}}]),$app.controller("noActionCtrl",["$scope",function(t){t.cancel=function(){t.$dialog.close(null)},t.save=function(){t.validate()&&t.$dialog.close(t.actionItem)},t.validate=function(){var e=!0;return!t.options||t.options.hideActionText||null!=t.actionItem.title&&""!=t.actionItem.title||(e=!1,t.errors.title="Required"),e}}]),$app.controller("callNumberCtrl",["$scope",function(t){t.cancel=function(){t.$dialog.close(null)},t.save=function(){t.validate()&&t.$dialog.close(t.actionItem)},t.validate=function(){var e=!0;return t.errors.title="",t.errors.phoneNumberError="",!t.options||t.options.hideActionText||null!=t.actionItem.title&&""!=t.actionItem.title||(e=!1,t.errors.title="Required"),null!=t.actionItem.phoneNumber&&""!=t.actionItem.phoneNumber||(e=!1,t.errors.phoneNumberError="Required"),e}}]),$app.controller("searchInAppCtrl",["$scope",function(e){e.cancel=function(){e.$dialog.close(null)},e.save=function(){e.validate()&&e.$dialog.close(e.actionItem)},e.validate=function(){return!(e.errors.searchAppValueError="")}}]);
"use strict";$app.controller("pluginAnalyticsCtrl",["$scope","$http","$routeParams","$timeout","upgradePlanService",function(n,a,e,t,s){function o(){n.events=[{title:"Opened",key:"app/openedPlugin",description:"",type:"build_in"}],n.selectedEvent=n.events[0],n.selectedDaysRange=n.daysRange[0],y=0,n.eventsDataEmpty=!1}function r(){n.reports={dailyReport:{options:{responsive:!0},total:0,labels:[],series:["Daily Views"],data:[[]]},topUsersReport:{options:{responsive:!0,scales:{xAxes:[{display:!1,maxBarThickness:70}],yAxes:[{ticks:{beginAtZero:!0}}]}},total:0,labels:[],series:["Top Users"],data:[[]]},topUsersGrid:{data:[]},userDetails:{readyToScroll:!1,data:[],skip:0}}}function i(e,t){if(!n.selectedEvent)return n.reports.userDetails.busy=!1,n.reports.userDetails.isComplete=!0,n.reports.userDetails.data=[];var s;n.reports.userDetails.busy||(n.reports.userDetails.busy=!0,s="",s=(s=window.siteConfig&&window.siteConfig.endPoints&&window.siteConfig.endPoints.appHost&&"sdk"==window.siteConfig.scope?window.siteConfig.endPoints.appHost:s)+"/api/app/analytics/"+window.appContext.currentApp.appId+"/eventSearch",a.post(s,{fromDate:e||n.fromDate,toDate:t||n.toDate,eventName:n.selectedEvent.key,context:{pluginId:d,instanceId:c},options:{skip:n.reports.userDetails.skip,limit:15}}).success(function(e){if(n.reports.userDetails.busy=!1,n.reports.userDetails.isComplete=!0,n.reports.userDetails.readyToScroll=!0,e&&e.length)for(var t=0;t<e.length;t++){var s=e[t].metadata.user.firstName||e[t].metadata.user.lastName?(e[t].metadata.user.firstName||"")+" "+(e[t].metadata.user.lastName||""):e[t].metadata.user.username;n.reports.userDetails.data.push({createdOn:e[t].createdOn,user:e[t].metadata.user,displayName:s,platform:e[t].metadata.platform})}}).error(function(e){n.reports.userDetails.busy=!1,n.reports.userDetails.isComplete=!0,n.reports.userDetails.readyToScroll=!0,console.error(e),window.toast("error getting analytics","danger")}),n.reports.userDetails.skip+=15)}function p(){"promo"==n.analyticsAccess&&"app/openedPlugin"!=n.selectedEvent.key||"promo"==n.analyticsAccess&&"app/openedPlugin"==n.selectedEvent.key&&30<n.selectedDaysRange.value||(n.fromDate=new Date,n.fromDate.setDate(n.fromDate.getDate()-n.selectedDaysRange.value),n.toDate=new Date,function(e,t){if(!n.selectedEvent)return n.reports.dailyReport.isComplete=!0,n.reports.dailyReport.data=[[]],n.reports.dailyReport.labels=[],n.reports.dailyReport.total=0;var s="",s=(s=window.siteConfig&&window.siteConfig.endPoints&&window.siteConfig.endPoints.appHost&&"sdk"==window.siteConfig.scope?window.siteConfig.endPoints.appHost:s)+"/api/app/analytics/"+window.appContext.currentApp.appId+"/dailyEvent/groupCount";a.post(s,{fromDate:e,toDate:t,eventName:n.selectedEvent.key,context:{pluginId:d,instanceId:c}}).success(function(e){if(n.reports.dailyReport.isComplete=!0,n.reports.dailyReport.data=[[]],n.reports.dailyReport.labels=[],n.reports.dailyReport.total=0,e.hasAggregation&&(n.reports.dailyReport.options.legend={display:!0,position:"bottom"},n.reports.dailyReport.data=[[],[],[],[],[]],n.reports.dailyReport.series.push("Avg"),n.reports.dailyReport.series.push("Sum"),n.reports.dailyReport.series.push("Min"),n.reports.dailyReport.series.push("Max")),e&&e.days&&0<e.days.length)for(var t,s=0;s<e.days.length;s++)n.reports.dailyReport.labels.push(e.days[s].dayName),n.reports.dailyReport.data[0].push(e.days[s].count),e.hasAggregation&&(t=0,e.days[s].aggregation&&e.days[s].aggregation.sum&&e.days[s].count&&(t=Math.round(e.days[s].aggregation.sum/e.days[s].count*100)/100),n.reports.dailyReport.data[1].push(t||0),n.reports.dailyReport.data[2].push(e.days[s].aggregation&&e.days[s].aggregation.sum||0),n.reports.dailyReport.data[3].push(e.days[s].aggregation&&e.days[s].aggregation.min||0),n.reports.dailyReport.data[4].push(e.days[s].aggregation&&e.days[s].aggregation.max||0));n.reports.dailyReport.total=e.total}).error(function(e){n.reports.dailyReport.isComplete=!0,window.toast("error getting analytics","danger")})}(n.fromDate,n.toDate),function(e,t){if(!n.selectedEvent)return n.reports.topUsersReport.isComplete=!0,n.reports.topUsersGrid.isComplete=!0,n.reports.topUsersReport.data=[[]],n.reports.topUsersReport.labels=[],n.reports.topUsersGrid.data=[];var s="",s=(s=window.siteConfig&&window.siteConfig.endPoints&&window.siteConfig.endPoints.appHost&&"sdk"==window.siteConfig.scope?window.siteConfig.endPoints.appHost:s)+"/api/app/analytics/"+window.appContext.currentApp.appId+"/userEvent/count";a.post(s,{fromDate:e,toDate:t,eventName:n.selectedEvent.key,context:{pluginId:d,instanceId:c}}).success(function(e){if(n.reports.topUsersReport.isComplete=!0,n.reports.topUsersGrid.isComplete=!0,n.reports.topUsersReport.data=[[]],n.reports.topUsersReport.labels=[],n.reports.topUsersGrid.data=[],e&&e.length){console.error("result",e);for(var t=0;t<e.length;t++){var s=e[t].user.firstName||e[t].user.lastName?(e[t].user.firstName||"")+" "+(e[t].user.lastName||""):e[t].user.username;t<=9&&(n.reports.topUsersReport.total+=e[t].total||0,n.reports.topUsersReport.labels.push(s),n.reports.topUsersReport.data[0].push(e[t].total)),n.reports.topUsersGrid.data.push({total:e[t].total,user:e[t].user,displayName:s})}}console.error("topUsersReport",n.reports.topUsersReport)}).error(function(e){n.reports.topUsersReport.isComplete=!0,window.toast("error getting analytics","danger")})}(n.fromDate,n.toDate),i(n.fromDate,n.toDate))}var l,d=null,d=(n.invokeReportsFromPopup?n:e).pluginId,c=null,c=(n.invokeReportsFromPopup?n:e).instanceId,u=null,u=(n.invokeReportsFromPopup?n:e).activeEvent,g=(n.activeEvent=u,n.activeEvent&&(n.initLoading=!0),new AnalyticsAPI(appContext.currentApp.appId,d,c,0)),y=(void 0===appContext.currentApp.config.advancedPluginAnalytics?"enterprise"==appContext.currentApp.config.type?n.analyticsAccess="enabled":n.analyticsAccess="promo":"disabled"==appContext.currentApp.config.advancedPluginAnalytics?n.analyticsAccess="promo":n.analyticsAccess=appContext.currentApp.config.advancedPluginAnalytics,n.daysRange=[{name:"30",value:"30"},{name:"60",value:"60"},{name:"90",value:"90"}],0);n.eventsDataEmpty=!1,o(),r(),n.userDetailsReportOnScroll=function(){n.reports.userDetails.readyToScroll&&i()},n.getUserManagmentUrl=function(e){return"#/appUserManagement/?email="+encodeURIComponent(e)+"&activeTab=activity"};n.loadPluginEvents=function(r){n.customEventsLoading=!0,t(function(){var e,t;"enabled"==n.analyticsAccess||"promo"==n.analyticsAccess?(e={skip:y,limit:50,sort:{_titleLowerCase:1},filter:{}},n.customEventSearch&&(t={"$json.title":{$regex:n.customEventSearch,$options:"i"}},e.filter={$or:[t]}),u&&!n.customEventSearch&&(t={"$json.key":{$regex:u,$options:"i"}},e.filter.$or?e.filter.$or.push(t):e.filter.$or=[t]),g.getPluginEvents(e,function(e,t){if(n.customEventsLoading=!1,n.initLoading=!1,t&&0<t.length){y+=50;for(var s=0;s<t.length;s++)if(t[s].data&&t[s].data.title&&t[s].data.key){for(var a=!1,o=0;o<n.events.length;o++)if(n.events[o].key==t[s].data.key){a=!0;break}a||(t[s].data.type="custom",n.events.push(t[s].data)),u==t[s].data.key&&(n.selectedEvent=t[s].data)}}else n.eventsDataEmpty=!0;r&&r()})):(n.customEventsLoading=!1,n.initLoading=!1,r&&r())},10)},n.searchCustomEvents=function(){t.cancel(l),l=t(function(){y=0,n.eventsDataEmpty=!1,n.events=[{title:"Opened",key:"app/openedPlugin",description:"",type:"build_in"}],n.loadPluginEvents()},500)},n.changeEvent=function(e){n.customEventSearch="",n.selectedEvent=e,r(),p()},n.changeDaysRange=function(e){n.selectedDaysRange=e,r(),p()},n.upgradePlan=s.upgrade,n.start=function(){n.analyticsStarted||(n.analyticsStarted=!0,o(),r(),u?n.loadPluginEvents(function(){p()}):(n.loadPluginEvents(),p()))},n.$on("pluginAnalyticsTabOpened",function(e,t){n.start()}),!n.invokeReportsFromPopup&&"analytics"!=e.activeTab||n.start(),n.invokeReportsFromPopup||cpNotification.analyticsPluginDailyOpen({pluginId:d,instanceId:c})}]);
"use strict";$app.controller("pluginAnalyticsPopupCtrl",["$scope","$http","$data","$dialog",function(n,i,o,t){n.invokeReportsFromPopup=!0,n.pluginId=o.pluginId,n.instanceId=o.instanceId,n.activeEvent=o.activeEvent,n.appHost="",window.siteConfig&&window.siteConfig.endPoints&&window.siteConfig.endPoints.appHost&&"sdk"==window.siteConfig.scope&&(n.appHost=window.siteConfig.endPoints.appHost),n.close=function(){t.close()}}]);
"use strict";"undefined"!=typeof AnalyticsAPI&&(AnalyticsAPI.prototype.registerPluginEvent=function(i,s){var e,t,o;i?(i.data||(i.data={}),i.options||(i.options={}),(e=i.data).key?e.title?(e._titleLowerCase=e.title.toLowerCase(),t=this.instanceId+"_pluginEvents",(o=new DatastoreAPI(this.appId,this.pluginId,t,this.liveMode)).searchAndUpdate({tag:"events",obj:{$set:e},search:{key:e.key}},function(t,n){null==t&&n&&0==n.nModified?o.insert({tag:"events",obj:e,checkDuplicate:!1},function(t,n){var e=new CustomEvent("pluginAnalyticsRegisterEvent",{detail:{data:i.data,options:i.options}});document.dispatchEvent(e),s&&s(t,n)}):s&&s(t,n)})):s&&s("Missing event title",null):s&&s("Missing event key",null)):s&&s("invalid params",null)},AnalyticsAPI.prototype.unregisterPluginEvent=function(t,i){var n,s;t&&t.key?(n=this.instanceId+"_pluginEvents",(s=new DatastoreAPI(this.appId,this.pluginId,n,this.liveMode)).search({tag:"events",obj:{filter:{"$json.key":t.key}}},function(t,n){if(!t&&n&&0<n.length)for(var e=0;e<n.length;e++)s.delete({tag:"events",id:n[e].id},function(t,n){i&&i(t,n)});else i&&i(t,n)})):i&&i("Missing event key",null)},AnalyticsAPI.prototype.showReports=function(t,n){var e="";window.siteConfig&&window.siteConfig.endPoints&&window.siteConfig.endPoints.appHost&&"sdk"==window.siteConfig.scope&&(e=window.siteConfig.endPoints.appHost),window.openDialog({templateUrl:e+"/pages/plugins/pluginControl/analytics/pluginAnalyticsPopup.html",controller:"pluginAnalyticsPopupCtrl",size:"lg",data:{pluginId:this.pluginId,instanceId:this.instanceId,activeEvent:t.eventKey}},function(t){}),n(null,!0)});
"use strict";function UsersLibAPI(e){this.context={},angular.copy(e,this.context),this.init()}UsersLibAPI.prototype={init:function(){},showSearchDialog:function(e,i){var s="",s={templateUrl:(s=window.siteConfig&&window.siteConfig.endPoints&&window.siteConfig.endPoints.appHost&&"sdk"==window.siteConfig.scope?window.siteConfig.endPoints.appHost:s)+"/pages/common/userSearch.html",controller:"userSearchDialogCtrl",size:"lg",data:{appId:this.context.appId,source:"sdk"}};window.openDialog(s,function(e){if(e){if(e.users&&0<e.users.length)for(var s=0;s<e.users.length;s++)e.users[s]={userId:e.users[s]._id,firstName:e.users[s].firstName||null,lastName:e.users[s].lastName||null,displayName:e.users[s].displayName||null,username:e.users[s].username||null,isActive:e.users[s].isActive,userProfile:e.users[s].userProfile||null,imageUrl:e.users[s].imageUrl||null};delete e.criteria,delete e.criteriaTranslation,delete e.selectAll,i&&i(null,e)}else i&&i(null,null)})},showTagsSearchDialog:function(e,s){var i="",i={templateUrl:(i=window.siteConfig&&window.siteConfig.endPoints&&window.siteConfig.endPoints.appHost&&"sdk"==window.siteConfig.scope?window.siteConfig.endPoints.appHost:i)+"/pages/common/tagSearch.html",controller:"tagSearchDialogCtrl",size:"lg",data:{appId:this.context.appId,source:"sdk"}};window.openDialog(i,function(e){s&&s(null,e)})}};
"use strict";$app.controller("userSearchDialogCtrl",["$scope","$dialog",function(e,t){t.options&&t.options.data&&t.options.data.source&&(e.source=t.options.data.source),e.isPopupUserSearch=!0,e.close=function(){t.close(null)},e.returnSearchResult=function(e){t.close(e)}}]),$app.controller("userSearchCtrl",["$scope","$rootScope","userService",function(i,e,t){i.activeAll=!0,i.activeRange=!1,i.errors={},i.tagsHave=!0,i.tagsAll=!0,i.activeType=function(e){i.activeAll=!1,i.activeRange=!1,void 0!==e&&(i[e]=!0)},i.export=function(){i.exporting=!0;var e=s(),t=(delete e.skip,delete e.limit,"");window.siteConfig&&window.siteConfig.endPoints&&window.siteConfig.endPoints.appHost&&"sdk"==window.siteConfig.scope&&(t=window.siteConfig.endPoints.appHost),$http.post(t+"/api/userTagging/userExport/"+window.appContext.currentApp.appId+"/",e).success(function(e){i.exporting=!1;var t=document.createElement("a");t.setAttribute("href","data:text/csv;charset=utf-8,"+encodeURIComponent(e)),t.setAttribute("download","users.csv"),t.click()}).error(function(e){i.exporting=!1,console.error(e),window.toast("Search Error","danger")})},e.$on("searchUsers",function(e,t){i.searchUsers()}),i.selectTagHave=function(e){i.tagsHave=e};var s=function(){var r,e={filter:{},skip:(i.pageIndex-1)*i.pageSize,limit:i.pageSize},t=[];if(i.searchName&&(r=[],i.searchName.split(",").forEach(function(e){var t,s;e=e.trim(),s=!1,(s=!(0!==(t=e).indexOf("facebook")&&0!==t.indexOf("twitter")&&!/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z\-0-9]{2,}))$/.test(t))||s)?r.push({email:e.toLowerCase()}):e&&r.push({displayName:{$regex:e,$options:"-i"}},{email:{$regex:e,$options:"-i"}})}),t.push({$or:r})),-1!=i.currentUserStatusFilter&&(e.isActive=1==i.currentUserStatusFilter),i.showAdvancedSearch){i.searchFromDate&&(e.signupDateFrom=i.searchFromDate),i.searchToDate&&(e.signupDateTo=i.searchToDate);var s=[];if(i.searchTags&&i.searchTags.length){for(var n=0;n<i.searchTags.length;n++)s.push(i.searchTags[n].tagName);if(i.tagsHave)if(i.tagsAll)for(n=0;n<s.length;n++)t.push({tags:{$elemMatch:{tagName:s[n]}}});else t.push({tags:{$elemMatch:{tagName:{$in:s}}}});else if(i.tagsAll)for(n=0;n<s.length;n++)t.push({tags:{$not:{$elemMatch:{tagName:s[n]}}}});else{for(var a=[],n=0;n<s.length;n++)a.push({tags:{$not:{$elemMatch:{tagName:s[n]}}}});t.push({$or:a})}}}return i.sortBy&&(e.sort=i.sortBy),i.isReversed&&(e.isReversed=i.isReversed),0<t.length&&(e.filter.$and=t),e},a=(i.getUsers=function(){i.searching=!0;var n=s(),e="";window.siteConfig&&window.siteConfig.endPoints&&window.siteConfig.endPoints.appHost&&"sdk"==window.siteConfig.scope&&(e=window.siteConfig.endPoints.appHost),$http.post(e+"/api/userTagging/userSearch/"+window.appContext.currentApp.appId+"/",n).success(function(e){i.totalItems=e.usersCount,i.searching=!1;for(var t=0;t<e.users.length;t++){var s=e.users[t];if(i.users.push(s),i.selectedUsers&&i.selectedUsers.length)for(var r=0;r<i.selectedUsers.length;r++)i.selectedUsers[r]._id==s._id&&(s.selected=!0)}delete n.isReversed,delete n.limit,delete n.skip,delete n.sort,0<e.users.length&&(i.busy=!1),i.currentSearchCriteria=n,i.hasSearchCriteria=!(!i.currentSearchCriteria||!(1<Object.keys(i.currentSearchCriteria).length)&&a(i.currentSearchCriteria.filter)),i.loading=!1,i.sortLoading=!1}).error(function(e){i.searching=!1,i.busy=!1,console.error(e),window.toast("Search Error","danger")}).finally(function(){})},i.changeSorting=function(e){i.sortBy===e?i.isReversed=!i.isReversed:(i.sortBy=e,i.isReversed=!1),i.sortLoading=!0,i.users=[],i.busy=!1,i.pageIndex=0,i.setPage()},i.getUserStatus=function(e){e=e.externalApps[window.appContext.currentApp.appId].isActive;return e||void 0===e?"Active":"Banned"},i.setUserStatus=function(e,t){var s=e.externalApps[window.appContext.currentApp.appId].isActive;void 0===s&&t||s===t||(e.externalApps[window.appContext.currentApp.appId].isActive=t,i.updateUserStatus(e))},i.updateUserStatus=function(e){var t={isActive:e.externalApps[window.userContext.currentApp.appId].isActive};$http.post("/api/userTagging/updateUserStatus/"+window.userContext.currentApp.appId+"/"+e._id,t).success(function(e){window.toast("Saved","success")}).error(function(e){window.toast("save error","danger")})},i.setStatusFilter=function(e){"-1"==(i.currentUserStatusFilter=e)?i.currentUserStatusFilterText="All":"0"==e?i.currentUserStatusFilterText="Banned":"1"==e&&(i.currentUserStatusFilterText="Active")},i.showHideAdvancedSearch=function(){i.showAdvancedSearch=!i.showAdvancedSearch},i.setPage=function(){i.busy||(i.busy=!0,i.pageIndex+=1,i.getUsers())},i.managUser=function(e){window.location.hash="appUserManagement?email="+encodeURIComponent(e.email)},i.resetPassword=function(e){window.openDialog({templateUrl:"userManagementResetPassword.html",controller:"userManagementResetPasswordCtrl",size:"md",data:{user:e}},function(){})},i.uploadFile=function(){},i.init=function(){var e;i.appConfig=window.appContext.currentApp.config,i.showDuplicateWarning=!1,i.totalItems=100,i.pageIndex=0,i.pageSize=10,i.maxSize=10,i.username=null,i.sortColumn="",i.currentUserStatusFilter="-1",i.currentUserStatusFilterText="All",i.searchText="",i.showAdvancedSearch=!0,i.currentUserStatusFilter="-1",i.currentUserStatusFilterText="All",i.sortBy="createdOn",i.isReversed=!1,i.selectedUsers=null,i.hasSearchCriteria=!1,i.busy=!1,i.users=[],i.loading=!0,i.sortLoading=!1,i.scopeLoading=!1,i.isNonFederatedApp=!1,i.setPage(),i.scopeLoading=!0,e="",window.siteConfig&&window.siteConfig.endPoints&&window.siteConfig.endPoints.appHost&&"sdk"==window.siteConfig.scope&&(e=window.siteConfig.endPoints.appHost),$http.get(e+"/api/app/"+appContext.currentApp.appId+"/users/scope").success(function(e){i.scopeLoading=!1,i.isNonFederatedApp=!(!e||!e.scope)}).error(function(e){i.scopeLoading=!1,console.error(e)})},i.init(),i.returnSearchResult=function(){var e={};if(i.currentSearchCriteria&&a(i.currentSearchCriteria.filter)&&delete i.currentSearchCriteria.filter,a(i.currentSearchCriteria)||(e.criteria=JSON.stringify(i.currentSearchCriteria),e.criteriaTranslation=function(){var e="";if(i.searchName&&(e="name or email in ("+i.searchName,e+=")"),-1!=i.currentUserStatusFilter&&(0<e.length&&(e+=" and "),1==i.currentUserStatusFilter&&(e+="Active"),0==i.currentUserStatusFilter&&(e+="Banned")),i.showAdvancedSearch){i.searchFromDate&&(0<e.length&&(e+=" and "),e+="Signup date <  "+i.searchFromDate.toLocaleString()),i.searchToDate&&(0<e.length&&(e+=" and "),e+="Signup date <  "+i.searchToDate.toLocaleString());var t=[];if(i.searchTags&&i.searchTags.length){0<e.length&&(e+=" and ");for(var s=0;s<i.searchTags.length;s++)t.push(i.searchTags[s].tagName);i.tagsHave?i.tagsAll?e+="has these tags ("+t.toString(",")+")":e+="has some of these tags ("+t.toString(",")+")":i.tagsAll?e+="does not have these tags ("+t.toString(",")+")":e+="does not have some of these tags ("+t.toString()+")"}}return e}()),e.users=i.selectedUsers,e.selectAll=!0,e.userIds=null,i.selectedUsers){e.selectAll=!1,e.userIds=[];for(var t=0;t<e.users.length;t++)e.userIds.push(e.users[t]._id)}i.$parent.returnSearchResult(e)},function(e){return!e||!Object.keys(e).length});i.loadTags=function(e){return t.searchTags({filter:{tagName:e},skip:0,limit:20}).then(function(e){return e.tags})},i.changeUserSelection=function(e){if(i.selectedUsers||(i.selectedUsers=[]),e.selected)i.selectedUsers.push(e);else for(var t=0;i.selectedUsers&&t<i.selectedUsers.length;t++)i.selectedUsers[t]._id==e._id&&(i.selectedUsers.splice(t,1),i.selectedUsers.length||(i.selectedUsers=null))},i.searchUsers=function(){i.loading=!0,i.users=[],i.busy=!1,i.pageIndex=0,i.setPage()}}]);
"use strict";function _createForOfIteratorHelper(e,t){var r,a="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!a){if(Array.isArray(e)||(a=_unsupportedIterableToArray(e))||t&&e&&"number"==typeof e.length)return a&&(e=a),r=0,{s:t=function(){},n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:t};throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var n,s=!0,o=!1;return{s:function(){a=a.call(e)},n:function(){var e=a.next();return s=e.done,e},e:function(e){o=!0,n=e},f:function(){try{s||null==a.return||a.return()}finally{if(o)throw n}}}}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Map"===(r="Object"===r&&e.constructor?e.constructor.name:r)||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,a=new Array(t);r<t;r++)a[r]=e[r];return a}$app.controller("tagSearchDialogCtrl",["$scope","$dialog",function(e,t){t.options&&t.options.data&&t.options.data.source&&(e.source=t.options.data.source),e.close=function(){t.close(null)},e.returnSearchResult=function(e){t.close(e)}}]),$app.controller("tagSearchCtrl",["$scope","$http","$rootScope",function(o,r,e){o.getTags=function(e){o.searching=!0;var t="";window.siteConfig&&window.siteConfig.endPoints&&window.siteConfig.endPoints.appHost&&"sdk"==window.siteConfig.scope&&(t=window.siteConfig.endPoints.appHost),r.get(t+"/api/userTagging/searchTags/"+window.appContext.currentApp.appId+"/",{params:e}).success(function(e){o.totalItems=(e=e||{tags:[],tagsCount:0}).tagsCount,e.tags=0<e.tagsCount?e.tags:[];var t,r=_createForOfIteratorHelper(e.tags);try{for(r.s();!(t=r.n()).done;){var a=t.value;if(o.tags.push(a),o.selectedTags&&o.selectedTags.length){var n,s=_createForOfIteratorHelper(o.selectedTags);try{for(s.s();!(n=s.n()).done;)n.value._id==a._id&&(a.selected=!0)}catch(e){s.e(e)}finally{s.f()}}}}catch(e){r.e(e)}finally{r.f()}0<e.tags.length&&(o.busy=!1),o.searching=!1,o.sortLoading=!1,o.loading=!1}).finally(function(){o.loading=!1})},o.search=function(e){o.pageIndex=void 0===e?1:e;e={filter:{},skip:(o.pageIndex-1)*o.pageSize,limit:o.pageSize,sortBy:o.sortBy,sort:o.reverse?1:-1};o.searchText&&(e.filter.tagName=o.searchText.trim()),o.getTags(e)},o.getDataPage=function(e){var t=[];if(o.searchText)for(var r in e)-1<e[r].tagName.toLowerCase().indexOf(o.searchText.toLowerCase())&&t.push(e[r]);else t=e;return t},o.setSort=function(e,t){o.sortCriteria=e,o.reverse=t,o.sort()},o.sort=function(){switch(o.sortCriteria){case"Newest First":o.sortBy="createdOn",o.reverse=!1;break;case"Oldest First":o.sortBy="createdOn",o.reverse=!0;break;case"Tag Name A-Z":o.sortBy="tagName",o.reverse=!0;break;case"Tag Name Z-A":o.sortBy="tagName",o.reverse=!1}o.sortLoading=!0,o.tags=[],o.busy=!1,o.pageIndex=0,o.setPage()},o.changeTagSelection=function(e){if(o.selectedTags||(o.selectedTags=[]),e.selected)o.selectedTags.push({id:e._id,tagName:e.tagName});else for(var t=0;o.selectedTags&&t<o.selectedTags.length;t++)o.selectedTags[t]&&o.selectedTags[t].id==e._id&&(o.selectedTags.splice(t,1),o.selectedTags.length||(o.selectedTags=null))},o.returnSearchResult=function(){o.$parent.returnSearchResult(o.selectedTags)},o.searchTags=function(){o.loading=!0,o.tags=[],o.busy=!1,o.pageIndex=0,o.setPage()},o.setPage=function(){o.busy||(o.busy=!0,o.pageIndex+=1,o.search(o.pageIndex))},o.init=function(){o.tags=[],o.currentPageTags=[],o.loading=!0,o.pageIndex=0,o.pageSize=20,o.sortColumn="",o.currentUserStatusFilter="-1",o.currentUserStatusFilterText="All",o.searchText="",o.sortCriteria="Newest First",o.sortBy="createdOn",o.reverse=!1,o.busy=!1,o.setPage()},o.init()}]);
"use strict";$app.factory("addPluginService",["$rootScope","$http","$q","$analytics","pluginManager","promoService","$searchEngineService",function(u,r,n,s,i,l,d){var c={};c.miniSearchLoaded=!1,c.currencyToInt=function(e,n){return parseInt((100*e).toFixed())},c._trackAction=function(e,n,t,i){i=i||{};var a=window.bfHelper.Cookies.get("verticalData"),r=window.authAPI.getCurrentUser();r&&(i.user={userId:r.userToken,userEmail:r.email,username:r.username,displayName:r.displayName}),i.app={appId:window.appContext.currentApp.appId,name:window.appContext.currentApp.name,clonedFromAppId:window.appContext.currentApp.clonedFromAppId,config:{id:window.appContext.currentApp.configId,type:window.appContext.currentApp.config.type},marketIndustry:a&&a.industry||null},(AnalyticsAPI&&new AnalyticsAPI(n||"marketplace_analytics",t)).trackAction(e,i)},c.sortResults=function(e,t){return e.sort(function(e,n){e=t.indexOf(e.data.instanceId),n=t.indexOf(n.data.instanceId);return n<e?1:e<n?-1:0}),e},c.getMarketplaceSettings=function(e){e(null,{showDevInfo:whitelabelContext.showDevInfo})},c.addLicense=function(e,n){var t={clientReferenceId:e.clientReferenceId,pluginId:e.pluginId,appId:e.appId,userId:e.userId,email:e.email};r.post("/api/stripe/charge",t).then(function(){i.removeRevokedPlugin(e.pluginId),n(null)},function(e){n(e)})},c.isPluginLicenseActive=function(e,n){r.get("/api/appPluginTypes/validateToAdd",{params:{appId:e.appId,token:e.pluginToken}}).success(function(e){e&&e.isActive?n(null,!0):n(null,!1)})},c.trackPluginAdded=function(e){s.eventTrack("cp/pluginInstanceAdded",{pluginTypeId:e.pluginTypeId,pluginTypeName:e.pluginTypeName,marketItemId:e.marketItemId})};var e=new DatastoreAPI(appContext.currentApp.appId,"sideMenu",1,0,appContext.currentApp.keys.datastoreKey);function t(a){var r={dataType:"pluginInstance",data:[],content:{securedFeaturesOption:"enable"},result:[]};e.get({withDynamicData:!0},function(e,n){var t,i;n&&n.data&&((n=n.data._buildfire&&n.data._buildfire.sideMenu)&&n.content?n.content.loadAllPlugins||(n.result=(t=n.result,i=n.data,t.sort(function(e,n){e=i.indexOf(e.data.instanceId),n=i.indexOf(n.data.instanceId);return n<e?1:e<n?-1:0}),t)):n=r,r=n),a(null,r)})}return c.addToSideMenu=function(n,i){var a=new DatastoreAPI(appContext.currentApp.appId,"sideMenu",1,0,appContext.currentApp.keys.datastoreKey);t(function(e,t){e?i&&i(e):t&&t.result&&(t.result.push({id:n.instanceId,data:n}),t.data||(t.data=[]),t.data.push(n.instanceId),(e={_buildfire:{sideMenu:t}})._buildfire.sideMenu.result&&delete e._buildfire.sideMenu.result,a.save({tag:"",obj:e},function(e,n){e||!n?(console.error(e),i&&i(e)):(i&&i(null,t),window.dispatchEvent(new CustomEvent("SideMenuUpdated",{detail:n})),emulatorSync.triggerSideMenuOnUpdate(n))}))})},c.addPluginToDataStore=function(l,o,p){(l=l||{}).pluginHost=window.siteConfig.endPoints.pluginHost.replace("http:","https:");var e=l.pluginHost+"/"+o.folderName+"/plugin.json?v="+(o.lastUpdatedOn||"");n.all([r.get(e),r.get("/api/appPluginTypes/validateToAdd",{params:{appId:l.appId,token:o.token}})]).then(function(e){var n,t,i,a,r=!1;e&&e[0].data&&(t=e[0].data)&&t.requireLogin&&(r=!0),(n=e&&e[1].data?e[1].data:n)&&n.isActive?(t=r,e=new DatastoreAPI(l.appId,"pluginInstances",1,0,appContext.currentApp.keys.datastoreKey),i=o.token+"-"+Date.now(),a={tag:"",obj:{pluginTypeId:o.pluginTypeId,token:o.token,title:l.title,instanceId:i,refId:i,iconUrl:l.pluginHost+"/"+o.folderName+"/resources/icon.png",_buildfire:{pluginType:{dataType:"pluginType",data:o.token}}}},t&&(a.obj.requiresLogin=!0,a.obj._forceRequireLoginInEmulator=!0),e.insert(a,function(e){e?(p(e),console.log(e)):(s.eventTrack("cp/pluginInstanceAdded",{pluginTypeId:o.pluginTypeId,pluginTypeName:o.pluginTypeName,marketItemId:o.marketItemId}),window.pluginInstancesManager.events.added(o),c._trackAction("cp/marketplace/pluginInstall",null,o.token,{plugin:{pluginTypeId:o.pluginTypeId,pluginTypeName:o.pluginTypeName,marketItemId:o.marketItemId}}),u.$broadcast("pluginInserted",o.token),e={instanceId:i,iconUrl:l.pluginHost+"/"+o.folderName+"/resources/icon.png",title:a.obj.title,pluginTypeId:o.token,pluginTypeName:o.pluginTypeName,folderName:o.folderName,iconClassName:null},d.savePluginTitle({instanceId:i,pluginId:o.token,title:a.obj.title},function(e,n){e&&console.error("addPluginCtrl","add plugin title to searchEngineAPI",e)}),l.addToSideMenu?c.addToSideMenu(e,function(){p(null,{pluginInstance:a,folderName:o.folderName})}):p(null,{pluginInstance:a,folderName:o.folderName}))})):p("plugin_inactive")})},c.getMarketPlacePlugins=function(e,n,t){return r.get("/api/marketplace/search",{params:{appId:n,search:e,whitelabelId:t}})},c.formatPluginLicenses=function(e){if(e)for(var n=0;n<e.length;n++)e[n]&&e[n].license&&(e[n].license=e[n].license.replace(/.(?=.{4})/g,"x"))},c.logToCrm=function(e,n,t){e=e.length||"0";crm&&1==t&&n&&(crm.set({lastPluginSearchOn:Date.now(),lastPluginSearchFor:n,lastPluginSearchFound:e}),0==e&&(crm.set({lastPluginSearchMissOn:Date.now(),lastPluginSearchMissFor:n}),crm.inc({pluginSearchMissCount:1})),crm.log("Searched for plugin: "+n+": "+e+" plugins found"))},c.checkAndSaveMissedKeywords=function(e,n){var t={totalScore:0,highestScore:0,searchResult:[],averageScore:0,threshold:10,totalResult:n&&n.length?n.length:0,exactMatch:!1,missedKeyword:!1,query:e};if(n&&0<n.length){for(var i=0;i<n.length;i++){for(var a=0;a<n[i].terms.length;a++)n[i].terms[a]==e.toLowerCase()&&(t.exactMatch=!0);if(0==i&&(t.highestScore=n[i].score),t.totalScore+=n[i].score,t.searchResult.push({name:n[i].pluginTypeName,pluginTypeId:n[i].pluginTypeId,terms:n[i].terms,isBuildFirePlugin:!!n[i].author&&"buildfire"===n[i].author.toLowerCase()}),3<=t.searchResult.length)break}t.averageScore=t.totalScore/n.length,t.highestScore-t.averageScore>t.threshold&&(t.missedKeyword=!0)}else t.missedKeyword=!0;c._trackAction("cp/marketplace/search",null,null,{result:t})},c.searchAppPluginTypes=function(n,t){var a=n.pluginTypeName,e=n.appId,r=n.whitelabelId;function i(i){c.getMarketPlacePlugins("",e,r).then(function(e){var n,t,e=e.data[0],e=(c.formatPluginLicenses(e),c.logToCrm(e,a,1),{plugins:e});n=e.plugins,t=new Set(["and","or","to","in","a","the","you","is","are"]),c.miniSearch=new MiniSearch({fields:["pluginTypeName","keywords","description"],storeFields:["pluginTypeId","description","author","awsAPIPublicKey","createdOn","folderName","lastUpdatedOn","license","marketplacepluginTypeId","pluginTypeId","pluginTypeName","price","publishableKey","stripePlan","supportEmail","supportLink","useCount","keywords","token"],boost:{pluginTypeName:3,keywords:2},idField:"pluginTypeId",prefix:!0,processTerm:function(e,n){return t.has(e)?null:e.toLowerCase()},searchOptions:{fuzzy:.3}}),c.miniSearch.addAll(n),c.miniSearchLoaded=!0,i(null,e)})}function l(){var e={prefix:!0},e=(n.fields&&(e.fields=n.fields),void 0!==n.fuzzy&&(e.fuzzy=n.fuzzy),void 0!==n.prefix&&(e.prefix=n.prefix),void 0!==n.filter&&(e.filter=n.filter),c.miniSearch.search(a,e));c.checkAndSaveMissedKeywords(a,e),t(null,{plugins:e})}a&&c.miniSearchLoaded?n.reload?i(function(){l()}):l():i(a?function(){l()}:t)},c.instanceExists=function(t,i){var e=window.siteConfig.endPoints.pluginHost+"/"+t.folderName+"/plugin.json?v="+(t.lastUpdatedOn||""),a={isInUse:!1};r.get(e).success(function(e){e.singleton?l.getPluginInstances(t,function(e,n){e?i(e):(0<(e=n.filter(function(e){return e.data.pluginTypeId==t.pluginTypeId})).length&&(a.isInUse=!0,a.matches=e),i(null,a))}):i(null,a)}).error(function(e){i(e)})},c.getPlanType=function(e){var n=null;if(e.stripePlan)try{n=JSON.parse(e.stripePlan)}catch(e){}switch(n.type){case"subscriptions":return"subscriptions";case"onetime":case e.price&&0<e.price:return"onetime";default:return"free"}},c}]);
"use strict";$app.service("pluginManager",["$http","$rootScope",function(e,n){var o={revokedPlugins:null,checkIfPluginIsRevoked:function(i,r){function e(){var e=!1;if(o.revokedPlugins)for(var n=0;n<o.revokedPlugins.length;n++)if(o.revokedPlugins[n].token==i){e=!0;break}r&&r(e)}o.revokedPlugins?e():u(e)},removeRevokedPlugin:function(e){if(o.revokedPlugins)for(var n=0;n<o.revokedPlugins.length;n++)if(o.revokedPlugins[n].pluginTypeId==e){o.revokedPlugins.splice(n,1);break}}},u=function n(i){e.get("/api/appPluginTypes/revoked",{params:{appId:window.appContext.currentApp.appId}}).success(function(e){o.revokedPlugins=e,i&&i(),setTimeout(n,3e5)}).error(function(e){i&&i()})};return o}]);
"use strict";$app.service("marketplaceServices",["$rootScope","$http","$timeout","$location","commonPluginService","addPluginService",function(s,i,t,o,d,c){var g,m=appContext.currentApp.appId,n=window.siteConfig.endPoints.datastoreHost,u=window.user.username,P={isPluginFree:function(e){return e.wasPurchased||0==e.price||!e.price},markPurchased:function(e){return e.map(function(e){return e.license&&(e.wasPurchased=!0),e})},_marketplacePromotedData:null,_trackAction:function(){c._trackAction.apply(c,arguments)},_daysDiff:function(e,n){if(!e||!n)return!1;e=e.getTime(),n=n.getTime(),n=Math.abs(n-e);return Math.round(n/864e5)},markPluginPurchased:function(e){if(P._marketplacePromotedData)for(var n=0;n<P._marketplacePromotedData.length;n++)if(P._marketplacePromotedData[n].token==e.token){P._marketplacePromotedData[n].wasPurchased=!0;break}},removePromotedPlugin:function(e){if(P._marketplacePromotedData)for(var n=0;n<P._marketplacePromotedData.length;n++)if(P._marketplacePromotedData[n].token==e.token){P._marketplacePromotedData.splice(n,1);break}},_getPluginConfig:function(o){return new Promise(function(n,t){o&&o.folderName||t({message:"missing pluginFolder in plugin"});var e=window.siteConfig.endPoints.pluginHost+"/"+o.folderName+"/plugin.json?v="+(o.lastUpdatedOn||"");i.get(e).success(function(e){n(e)}).error(function(e){t(e)})})},_setUserReachedPlugins:function(e){e={lastSyncDate:new Date,plugins:e};localStorage.setItem("marketplace_"+window.appContext.currentApp.appId+"_promoted_plugins",JSON.stringify(e))},_getUserReachedPlugins:function(){var n=localStorage.getItem("marketplace_"+window.appContext.currentApp.appId+"_promoted_plugins");try{n=JSON.parse(n)}catch(e){n={plugins:{}}}return n||{plugins:{}}},getPromotedPlugins:function(l){return new Promise(function(a,n){var r=P;function t(t){var e,i;function o(){for(var e=[],n=0;n<t.length;n++)l.excludedPlugins[t[n].token]||e.push(t[n]);a(function(e){for(var n,t,o=e.length;0<o;)t=Math.floor(Math.random()*o),n=e[--o],e[o]=e[t],e[t]=n;return e}(e))}t?l.excludeInstalledPlugins?(e=t.map(function(e){return e.token}),i=e,new Promise(function(t,o){var e,n;r._installedPlugins&&!l.reloadInstalledPlugins?t(r._installedPlugins):(e=new DatastoreAPI(appContext.currentApp.appId,"pluginInstances",1,0,appContext.currentApp.keys.datastoreKey),n={},i&&(n["$json.token"]={$in:i||[]}),e.search({obj:{filter:n,fields:["token"],page:0,pageSize:100},tag:""},function(e,n){e?o(e):(r._installedPlugins=n,r._installedPlugins||(r._installedPlugins=[]),t(n||[]))}))}).then(function(e){for(var n=0;n<e.length;n++)l.excludedPlugins[e[n].data.token]=e[n].data;o()})):o():a(t=[])}l?(l.excludedPlugins||(l.excludedPlugins={}),void 0===l.excludeInstalledPlugins&&(l.excludeInstalledPlugins=!0),void 0===l.reloadPromotedPlugins&&(l.reloadPromotedPlugins=!1),void 0===l.reloadInstalledPlugins&&(l.reloadInstalledPlugins=!1)):l={excludedPlugins:{},excludeInstalledPlugins:!0,reloadPromotedPlugins:!1,reloadInstalledPlugins:!1},8===userContext.role.roleId&&(r._marketplacePromotedData=[]),l.appType||!r._marketplacePromotedData||l.reloadPromotedPlugins?i.get("/api/marketplace/whitelabel/"+window.whitelabelContext.whitelabelId+"/plugins/promoted",{params:{appId:appContext.currentApp.appId,appType:l.appType||null}},{}).success(function(e){e&&e[0]&&e&&e[0]&&(l.appType?t(e[0]):(r._marketplacePromotedData=e[0],r._marketplacePromotedData=r.markPurchased(r._marketplacePromotedData),t(r._marketplacePromotedData)))}).error(function(e){e&&console.error("Marketplace Service: get promoted plugins",e),n(e)}):t(r._marketplacePromotedData)})},showPopup:function(i){var a=P,r=window.siteConfig.endPoints.pluginHost.replace("http:","https:");a._getPluginConfig(i).then(function(e){a._trackAction("cp/promotedPluginNotification/reach",null,i.token,{appId:window.appContext.currentApp.appId}),o();var n=document.querySelector("#marketplace-plugins-promotion_template").content.cloneNode(!0),n=(document.querySelector("body").appendChild(n),document.querySelector("#cpSideMenu .app-components").getBoundingClientRect()),t=document.querySelector("#marketplace-plugins-promotion");function o(){document.querySelector("#cpSideMenu .app-components .main-item-title").classList.remove("promoted-badge"),document.querySelector("#marketplace-plugins-promotion")&&(document.querySelector("#marketplace-plugins-promotion").classList.remove("bounceInLeft"),document.querySelector("#marketplace-plugins-promotion").classList.add("bounceOutLeft"),setTimeout(function(){document.querySelector("#marketplace-plugins-promotion")&&document.querySelector("#marketplace-plugins-promotion").remove()},3e3))}t.style.left="17px",t.style.top=n.height+n.top+8+"px",(t=document.querySelector("#marketplace-plugins-promotion")).querySelector("#plugin-promotion-name").innerText=i.pluginTypeName||"",(n=i.description)&&170<n.length&&(n=n.substring(0,165)+"..."),t.querySelector("#plugin-promotion-description").innerText=n||"",n=ImageLibAPI.tools.resizeImage(r+"/"+i.folderName+"/resources/icon.png?v="+(i.lastUpdatedOn||""),{width:63,height:63,disablePixelRation:!0}),t.querySelector("#plugin-promotion-icon").src=n,n=ImageLibAPI.tools.resizeImage(r+"/"+i.folderName+"/resources/image.png?v="+(i.lastUpdatedOn||""),{width:480,height:270,disablePixelRation:!0}),e&&e.media&&e.media[0]&&"image-resource"==e.media[0].type&&(n=ImageLibAPI.tools.resizeImage(r+"/"+i.folderName+"/resources/"+e.media[0].path,{width:480,height:270,disablePixelRation:!0})),t.querySelector("#plugin-promotion-image").src=n,document.querySelector("#cpSideMenu .app-components .main-item-title").classList.add("promoted-badge"),new Audio("/ghost.mp3").play(),t.querySelector("#plugin-promotion-close-btn").addEventListener("click",function(e){a._trackAction("cp/promotedPluginNotification/close",null,i.token,{appId:window.appContext.currentApp.appId}),e.stopPropagation(),o()}),t.querySelector(".promoted-body").addEventListener("click",function(e){o(),window.openDialog({templateUrl:"/pages/plugins/addPlugin/modals/pluginDetails.html",controller:"pluginDetailsCtrl",size:"lg",data:{plugin:i,options:{popupPromotions:!0}}})}),setTimeout(function(){o()},6e4)},function(e){console.error("MarketplaceServices","showPopup","Error in getting plugin config ")})},startPopupPromotions:function(){var n,e,t,o,i=P;i.popupPromotionsBusy||(e=!(i.popupPromotionsBusy=!0),(n=i._getUserReachedPlugins())&&n.lastSyncDate?(t=new Date,o=n.lastSyncDate?new Date(n.lastSyncDate):new Date,1<=i._daysDiff(o,t)&&(e=!0)):e=!0,e?i.getPromotedPlugins({excludedPlugins:n.plugins}).then(function(e){e&&0<e.length&&(e=e[Math.floor(Math.random()*e.length)],n.plugins||(n.plugins={}),n.plugins[e.token]=e,i._setUserReachedPlugins(n.plugins),i.showPopup(e)),i.popupPromotionsBusy=!1},function(e){i.popupPromotionsBusy=!1}):i.popupPromotionsBusy=!1)},coreFeaturesSuggestions:{search:function(e,r){var l,e=(e=e||{}).query,u=[];!e||(e=e.toLowerCase()).length<3?r(null,[]):(l=new RegExp("\\b"+e+"\\b","i"),i.get("/bf-marketplace-core-features.json",{}).success(function(e){var n=e&&e.data;if(n){for(var t=0;t<n.length;t++){var o=n[t].title&&n[t].title||"",i=n[t].description&&n[t].description||"",a=n[t].keywords&&n[t].keywords||"";-1!=o.search(l)?u.unshift(n[t]):-1==a.search(l)&&-1==i.search(l)||u.push(n[t])}3<u.length&&(u.length=3)}r(null,u)}))},goTo:function(e,n){if((e=e||{}).feature&&e.searchQuery)switch(P._trackAction("cp/marketplace/core-feature-suggestion/click",window.appContext.currentApp.appId,null,{feature:e.feature,searchQuery:e.searchQuery}),e.feature.type){case"article":e.feature.url&&window.open(e.feature.url,"_blank");break;case"plugin":return n(null,e.feature);case"core":e.feature.url&&o.path(e.feature.url)}n()}},viewDetails:function(e,n){n=n||{},window.openDialog({templateUrl:"/pages/plugins/addPlugin/modals/pluginDetails.html",controller:"pluginDetailsCtrl",size:"lg",data:{plugin:e,options:n}},function(){})},addPlugin:function(e){var t=e.plugin,o=e.onProgress,i=e.onClose,a=e.onError,r=e.onComplete,l=e.hideAddToSideMenuCheckbox,u=e.skipRedirect,p=P.isPluginFree(t),e={domain:n,appId:m,folderName:t.folderName,pluginTypeId:t.pluginTypeId,lastUpdatedOn:t.lastUpdatedOn};d.instanceExists(e,function(e,n){if(e)return console.error(e);n.isInUse?(n={token:(e=n.matches[0].data).token,pluginInstanceId:e.instanceId,pluginTitle:e.title,folderName:e._buildfire.pluginType.result[0].folderName},toast("Singleton. Redirecting to instance.","warning"),d.redirectToInstance(n)):p?P.openAddPageDialog({plugin:t,onProgress:o,onClose:i,onError:a,onComplete:r,hideAddToSideMenuCheckbox:l,skipRedirect:u}):P.purchase({plugin:t,onProgress:o,onClose:i,onError:a,onComplete:r,hideAddToSideMenuCheckbox:l,skipRedirect:u})})},openAddPageDialog:function(e){var o=e.plugin,i=e.onError,a=e.onComplete,n=e.hideAddToSideMenuCheckbox,r=e.skipRedirect;o&&(e={templateUrl:"/pages/plugins/addPlugin/modals/addPage.html",controller:"addPageCtrl",size:"sm",data:{options:{hideAddToSideMenuCheckbox:n,pluginTypeName:o.pluginTypeName},addingHandler:function(e){var t;e&&"addPage"==e.operation&&null!=e.title&&(t=e.$dialog,c.addPluginToDataStore({appId:appContext.currentApp.appId,addToSideMenu:e.addToSideMenu,title:e.title},o,function(e,n){t.close(),e?"plugin_inactive"===e&&(toast("Invalid to add, the plugin is inactive","danger"),i&&i(e)):(a&&a("Plugin added successfully"),r?s.$broadcast("onCreateNewPlugin",{}):window.location.hash="/pluginControl/"+o.token+"/"+n.pluginInstance.obj.instanceId+"/"+encodeURIComponent(n.pluginInstance.obj.title)+"/"+n.folderName+"/false")}))}}},window.openDialog(e))},purchase:function(e){var n,t=e.plugin,o=e.onProgress,i=e.onClose,a=e.onError,r=e.onComplete,l=e.hideAddToSideMenuCheckbox,u=e.skipRedirect,e=(t._DisableButton=!0,new StripeAPI({apiKeys:{awsApiPublicKey:t.awsAPIPublicKey,stripePublicKey:t.publishableKey},appId:m})),p={onProgress:function(e){h(t,e,o),o&&o()},onClose:function(){g&&(g.close(),t._DisableButton=!1),i&&i()}};"subscriptions"==c.getPlanType(t)?(n=JSON.parse(t.stripePlan),e.subscribe({openPaymentWindow:!1,items:[{planId:n.planId,quantity:1}],trialPeriodDays:n.trialDays,metaData:{appId:m,pluginName:t.pluginTypeName,pluginTypeId:t.pluginTypeId,token:t.token},events:p},function(e,n){if(e)return window.toast("Error in plugin subscription","danger"),delete t._DisableButton,void(a&&a(e));P._trackAction("cp/marketplace/pluginSubscribe",null,t.token,{plugin:{pluginTypeId:t.pluginTypeId,pluginTypeName:t.pluginTypeName,marketItemId:t.marketItemId}}),f({plugin:t,appId:m,clientReferenceId:n.client_reference_id,userId:window.user.userId,hideAddToSideMenuCheckbox:l,skipRedirect:u},function(e,n){delete t._DisableButton,e?a&&a(e):(t.wasPurchased=!0,s.$broadcast("pluginPurchased",t),r&&r("Plugin purchased successfully"))})})):e.charge({openPaymentWindow:!1,items:[{amount:parseInt((100*t.price).toFixed(0)),quantity:1,name:t.pluginTypeName}],events:p},function(e,n){if(e)return window.toast("Error in plugin purchasing","danger"),void delete t._DisableButton;P._trackAction("cp/marketplace/pluginPurchase",null,t.token,{plugin:{pluginTypeId:t.pluginTypeId,pluginTypeName:t.pluginTypeName,marketItemId:t.marketItemId}}),f({plugin:t,appId:m,clientReferenceId:n.client_reference_id,userId:window.user.userId,hideAddToSideMenuCheckbox:l,skipRedirect:u},function(e,n){delete t._DisableButton,e?a&&a(e):(t.wasPurchased=!0,s.$broadcast("pluginPurchased",t),r&&r("Plugin purchased successfully"))})})},showTryButton:function(e){if(e.wasPurchased)return!1;if(P.isPluginFree(e))return!1;var n=null;if(e.stripePlan)try{n=JSON.parse(e.stripePlan)}catch(e){}return!(!n||"subscriptions"!=n.type)},getPluginPrice:function(e){if(e.wasPurchased)return"";var n=P.isPluginFree(e),n=n?"Free":"$"+e.price,t=null;if(e.stripePlan)try{t=JSON.parse(e.stripePlan)}catch(e){}return n=t&&"subscriptions"==t.type?null:n}};function f(e,t){var o=e.plugin,n=e.appId,i=e.clientReferenceId,a=e.userId,r=e.hideAddToSideMenuCheckbox,l=e.skipRedirect,e={clientReferenceId:i,pluginId:o.pluginTypeId,appId:n,userId:a,email:u};o.addingLicense=!0,c.addLicense(e,function(e,n){if(delete o.addingLicense,e)return t(e),void toast("Error with feature purchase","danger");crm.log("Purchased plugin: "+o.pluginTypeName),crm.set({lastPurchasedPlugin:o,lastPurchasedOn:new Date}),crm.inc({pluginsPurchased:1,totalSpent:o.price}),o.wasPurchased=!0,P.openAddPageDialog({plugin:o,hideAddToSideMenuCheckbox:r,skipRedirect:l}),t&&t(null,n)})}var h=function(n,e,t){g=window.openDialog({templateUrl:"/pages/plugins/addPlugin/modals/paymentInProgressDialog.html",controller:"paymentInProgressDialogCtrl",size:"sm",data:{options:{invokePaymentWindow:e}},backdrop:"static",keyboard:!1},function(e){"close"===e&&(delete n._DisableButton,t&&t())})};return s.$on("pluginPurchased",function(e,n){n&&(P.markPluginPurchased(n),t(function(){P.removePromotedPlugin(n)},5e3))}),s.$on("pluginInserted",function(e,n){n&&P.removePromotedPlugin({token:n})}),s.$on("pluginDeleted",function(e,n){P.getPromotedPlugins({reloadPromotedPlugins:!0,reloadInstalledPlugins:!0})}),P}]);
"use strict";$app.service("$searchEngineService",[function(){return{save:function(e,i){(e=e||{}).pluginId?e.instanceId?e.key?e.tag?e.title?searchEngineAPI?new searchEngineAPI({appId:appContext.currentApp.appId,instanceId:e.instanceId,pluginId:e.pluginId}).save({key:e.key,tag:e.tag,title:e.title},function(e,n){e&&console.error("Search Engine Service","add plugin title to searchEngineAPI",e),i&&i(e,n)}):console.error("Search Engine Service","searchEngineAPI is undefined"):console.error("Search Engine Service","save method","Missing options (title)"):console.error("Search Engine Service","save method","Missing options (tag)"):console.error("Search Engine Service","save method","Missing options (key)"):console.error("Search Engine Service","save method","Missing options (instanceId)"):console.error("Search Engine Service","save method","Missing options (pluginId)")},savePluginTitle:function(e,i){(e=e||{}).pluginId?e.instanceId?e.title?(e.key="$_buildfire_controlPanel_pluginTitle",e.tag="appPlugins",this.save(e,function(e,n){i&&i(e,n)}),i&&i(null,!0)):console.error("Search Engine Service","savePluginTitle Method","Missing options (title)"):console.error("Search Engine Service","savePluginTitle Method","Missing options (instanceId)"):console.error("Search Engine Service","savePluginTitle Method","Missing options (pluginId)")}}}]);
"use strict";function _classCallCheck(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,n){for(var i=0;i<n.length;i++){var t=n[i];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(e,t.key,t)}}function _createClass(e,n,i){return n&&_defineProperties(e.prototype,n),i&&_defineProperties(e,i),Object.defineProperty(e,"prototype",{writable:!1}),e}var DeeplinksAPI=function(){function n(e){_classCallCheck(this,n),this.appData=new AppDatastoreAPI(e)}return _createClass(n,[{key:"searchDeeplinks",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},n=1<arguments.length?arguments[1]:void 0;if(!e.instanceId)return n({message:"instanceId not provided"},null);var i={filter:{"_buildfire.index.string1":e.instanceId},sort:{"_buildfire.index.text":1}};e.pageSize&&(i.pageSize=e.pageSize),0<=e.pageIndex&&(i.page=e.pageIndex),e.deeplinkName&&(i.filter["_buildfire.index.text"]={$regex:null!=e.deeplinkName?e.deeplinkName:"",$options:"-i"}),this.appData.search({obj:i,tag:"$$deeplinks"},n)}},{key:"getDeeplinkById",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},n=1<arguments.length?arguments[1]:void 0;if(!e.instanceId)return n({message:"instanceId not provided"},null);if(!e.deeplinkId)return n({message:"deeplinkId not provided"},null);var i={filter:{"_buildfire.index.string1":e.instanceId}};i.filter["_buildfire.index.array1.string1"]=e.deeplinkId,this.appData.search({obj:i,tag:"$$deeplinks"},n)}}]),n}();
"use strict";$app.factory("upgradePlanService",["$http","authManager",function(e,t){function a(e,n,t){var a,o=new RegExp("([?|&])"+n+"=.*?(&|#|$)","i");return e.match(o)?e.replace(o,"$1"+n+"="+t+"$2"):(o="",-1!==e.indexOf("#")&&(o=e.replace(/.*#/,"#"),e=e.replace(/#.*/,"")),a=-1!==e.indexOf("?")?"&":"?",e+a+n+"="+t+o)}var n={appId:window.appContext.currentApp.appId,pluginId:"publishingInfo",instanceId:"publishingInfo",liveMode:0,writeKey:window.appContext.currentApp.keys.datastoreKey};new DatastoreAPI(n);return{upgrade:function(){var n=t.getCurrentUser();n?(e({method:"GET",url:"/api/whitelabel/"+window.whitelabelContext.whitelabelId+"/plans/public"}).then(function(e){e.data.builtInPricePage?window.whitelabelContext.selfProvDomain?window.location.href="//"+window.whitelabelContext.selfProvDomain+"/upgrade.html#/app/"+window.appContext.currentApp.appId+"/"+n.username:window.toast("upgrade domain not setup","danger"):e.data.pricePageUrl?(e=a(e.data.pricePageUrl,"appId",encodeURIComponent(window.appContext.currentApp.appId)),e=a(e,"username",encodeURIComponent(n.username)),window.location.href=e):window.toast("no pricing page configured","danger")},function(e){window.toast("no upgrade plans configured","danger")}).finally(function(){}),crm&&(crm.set({clickedOnUpgrade:Date.now()}),crm.set({clickedOnUpgradeCount:1}))):t.logout()}}}]);
"use strict";$app.factory("userService",["$http",function(o){return{searchTags:function(t){var n="";return window.siteConfig&&window.siteConfig.endPoints&&window.siteConfig.endPoints.appHost&&"sdk"==window.siteConfig.scope&&(n=window.siteConfig.endPoints.appHost),o.get(n+"/api/userTagging/searchTags/"+window.userContext.currentApp.appId+"/",{params:t}).then(function(t){return{tags:(t=t.data)&&0<t.tagsCount?t.tags:[],count:t&&t.tagsCount?t.tagsCount:0}}).catch(function(t){console.error(t)})}}}]);