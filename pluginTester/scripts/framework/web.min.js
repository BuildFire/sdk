"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function ownKeys(t,e){var a,i=Object.keys(t);return Object.getOwnPropertySymbols&&(a=Object.getOwnPropertySymbols(t),e&&(a=a.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),i.push.apply(i,a)),i}function _objectSpread(t){for(var e=1;e<arguments.length;e++){var a=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(Object(a),!0).forEach(function(e){_defineProperty(t,e,a[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(a)):ownKeys(Object(a)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(a,e))})}return t}function _defineProperty(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}var imageLibCurrentApp=null;function ImageLibAPI(e){this.context={},angular.copy(e,this.context),this.context.datastoreWriteKey&&(this.context.writeKey=this.context.datastoreWriteKey),this.init()}$app.directive("scrolly",function(){return{restrict:"A",link:function(e,t,a){var i=t[0];console.log("loading directive"),t.bind("scroll",function(){i.scrollTop+i.offsetHeight+10>=i.scrollHeight&&e.$apply(a.scrolly)})}}}),$app.service("ImageLibService",["$http",function(n){var a=null,s=null;return{loadImages:function(i){var e,o=i.appId;function t(){return new Promise(function(t,a){var e="".concat(siteConfig.endPoints.datastoreHost,"/app/").concat(o,"/image");n.get(e,{params:i}).then(function(e){t(e?e.data:null)}).catch(function(e){a(e)})})}return void 0!==i.startIndex||i.startKey||(i.startIndex=0),0!=i.startIndex||i.startWith?t():(s&&(e=(new Date).getTime()-s.getTime(),30<Math.round(e%864e5%36e5/6e4)&&(a=s=null)),a=a||t())},resetCachedImages:function(e){s=a=null,e&&e()},loadCachedAISettings:function(){return{filters:function(){var e=window.localStorage.getItem("selectedAIFilters");if(e)try{return JSON.parse(e)}catch(e){return{}}return{}}(),colors:function(){var e=window.localStorage.getItem("selectedAIColors");if(e)try{return JSON.parse(e)}catch(e){return{}}return{}}(),aspectRatio:window.localStorage.getItem("selectedAIAspectRatio")||"1:1",description:window.localStorage.getItem("selectedAIDescription")||""}}}}]),ImageLibAPI.prototype={init:function(e){imageLibCurrentApp=this},showDialog:function(e,t){this&&this.context&&(imageLibCurrentApp.context=this.context),imageLibCurrentApp.options?imageLibCurrentApp.options=_objectSpread(_objectSpread({},imageLibCurrentApp.options),e):imageLibCurrentApp.options=e;e="pages/imageLib/imageLib.html";void 0!==imageLibCurrentApp&&imageLibCurrentApp.imageLibTemplate&&(e=imageLibCurrentApp.imageLibTemplate),window.openDialog({templateUrl:e,controller:"imageLibCtrl",size:"lg",position:"modal-pos"},function(e){t&&t(null,e)})}},ImageLibAPI.tools={resizeImage:function(e,t){if(!e)return null;var a=window.forceImgix?this._imgix:this._cloudImg,i=window.forceImgix?this._cloudImg:this._imgix,o=a;if(a.isSupportedUrl(e))o=a;else{if(!i.isSupportedUrl(e))return console.warn("URL is not supported by resizeImage. Returning original URL: "+e),e;console.warn("Primary handler does not support URL for resizeImage. Using fallback handler."),o=i}t.disablePixelRation||window.devicePixelRatio;if(t){if("object"!=_typeof(t))throw"options not an object"}else t={width:window.innerWidth};return"full"==t.width&&(t.width=window.innerWidth),"full"==t.height&&(t.height=window.innerHeight),o.constructUrl({width:t.width,height:t.height,url:e,method:"resize"})},cropImage:function(e,t){if(!e)return null;var a=window.forceImgix?this._imgix:this._cloudImg,i=window.forceImgix?this._cloudImg:this._imgix,o=a;if(a.isSupportedUrl(e))o=a;else{if(!i.isSupportedUrl(e))return console.warn("URL is not supported by cropImage. Returning original URL: "+e),e;console.warn("Primary handler does not support URL for cropImage. Using fallback handler."),o=i}return"full"==(t=!t.width&&!t.height?{width:"full",height:"full"}:t).width&&(t.width=window.innerWidth),"full"==t.height&&(t.height=window.innerHeight),o.constructUrl({width:t.width,height:t.height,url:e,method:"crop"})},checkTransparent:function(n,s){var r,c;n&&"string"==typeof n.imageUrl?((r=document.createElement("img")).crossOrigin="Anonymous",r.onload=function(){c.width=r.width,c.height=r.height;var e=c.getContext("2d");e.drawImage(r,0,0);for(var t=e.getImageData(0,0,c.width,c.height).data,a=!1,i=0,e=0,o=0;o<t.length;o+=4)if(t[o+3]<255){if(a=!0,!n.computePercentage)break;i++}n.computePercentage?0<i&&0<t.length&&(e=i/(t.length/4)*100):e=null;s(null,{hasTransparency:a,transparencyPercentage:e})},r.src=n.imageUrl,c=document.createElement("canvas")):s("imageUrl is required",null)},_imgix:{isSupportedUrl:function(e){var t=/\.(png|jpg|jpeg|gif|jfif|svg|webp)(\?.*)?$/gi.test(e),a=-1!==e.indexOf("images.unsplash.com");return!(!t&&!a)&&null!=this._transformToImgix(e)},constructUrl:function(e){var t=e.width,a=e.height,i=e.url,o=e.blur,n=e.method,e=this._transformToImgix(i);if(!e)return i;e=this._removeImageParams(e,["width","height","fit"]),e=new URL(e);return"crop"===n&&(t||a)&&e.searchParams.set("fit","crop"),t&&e.searchParams.set("width",t),a&&e.searchParams.set("height",a),o&&e.searchParams.set("blur",o),e.toString()},_imgixWhitelistedUrls:{"http://imageserver.prod.s3.amazonaws.com":"https://buildfire.imgix.net","http://s3-us-west-2.amazonaws.com/imageserver.prod":"https://buildfire.imgix.net","http://pluginserver.buildfire.com":"https://bfplugins.imgix.net","http://s3.amazonaws.com/Kaleo.DevBucket":"https://bflegacy.imgix.net","http://s3-us-west-2.amazonaws.com/imagelibserver":"https://buildfire-uat.imgix.net","http://s3-us-west-2.amazonaws.com/pluginserver.uat":"https://bfplugins-uat.imgix.net","http://s3-us-west-2.amazonaws.com/pluginserver.uat2":"https://bfplugins-uat.imgix.net","http://s3-us-west-2.amazonaws.com/pluginserver.uat3":"https://bfplugins-uat.imgix.net","http://s3.us-west-2.amazonaws.com/imageserver.prod":"https://buildfire.imgix.net","http://s3.us-west-2.amazonaws.com/pluginserver.prod":"https://bfplugins.imgix.net","http://s3-us-west-2.amazonaws.com/pluginserver.prod":"https://bfplugins.imgix.net","http://imagelibserver.s3.amazonaws.com":"https://buildfire-uat.imgix.net","http://d1q5x1plk9guz6.cloudfront.net":"https://bfplugins-uat.imgix.net","http://d3lkxgii6udy4q.cloudfront.net":"https://bfplugins-uat.imgix.net","http://d26kqod42fnsx0.cloudfront.net":"https://bfplugins-uat.imgix.net","http://images.unsplash.com":"https://images.unsplash.com","http://buildfire.imgix.net":"https://buildfire.imgix.net","http://bfplugins.imgix.net":"https://bfplugins.imgix.net","http://bflegacy.imgix.net":"https://bflegacy.imgix.net","http://buildfire-uat.imgix.net":"https://buildfire-uat.imgix.net","http://bfplugins-uat.imgix.net":"https://bfplugins-uat.imgix.net"},_transformToImgix:function(e){var t,a,i,o=e;for(i in e=(e=e.replace(/^https:\/\//i,"http://")).replace(/^https:\//i,"http://"),this._imgixWhitelistedUrls)if(0===e.indexOf(i))return-1!==e.indexOf("images.unsplash.com")&&(e=this._sanitizeUnsplashImage(e)),this._imgixWhitelistedUrls[i]+e.split(i)[1];null===(t=window.appContext)||void 0===t||null===(a=t.currentApp)||void 0===a||a.appId;return"https://buildfire-proxy.imgix.net/cdn/"+encodeURIComponent(o)},_sanitizeUnsplashImage:function(e){var t=new URL(e),a=["ixid","ixlib","fm"];return Array.from(t.searchParams.keys()).forEach(function(e){a.includes(e)||t.searchParams.delete(e)}),t.toString()},_removeImageParams:function(t,e){try{var a=new URL(t),i=a.searchParams;return e.forEach(function(e){i.delete(e)}),a.toString()}catch(e){return console.warn("Invalid URL provided to _removeImageParams:",t),t}}},_cloudImg:{isSupportedUrl:function(e){return-1===e.indexOf("images.unsplash.com")&&!(/\..{3,4}(?!.)/g.test(e)&&!/.(png|jpg|jpeg|gif|jfif|svg|webp)(?!.)/gi.test(e))},constructUrl:function(e){var t=e.width,a=e.height,i=e.url,o=e.blur,e=e.method,i=i.includes("cloudimg.io")?i:"https://alnnibitpo.cloudimg.io/v7/"+i,i=this._removeImageParams(i,["width","height","func","ci_info"]),i=new URL(i);return(t||a)&&i.searchParams.set("func","crop"===e?"crop":"bound"),t&&i.searchParams.set("width",t),a&&i.searchParams.set("height",a),o&&i.searchParams.set("blur",o),i.toString()},_removeImageParams:function(t,e){try{var a=new URL(t),i=a.searchParams;return e.forEach(function(e){i.delete(e)}),a.toString()}catch(e){return console.warn("Invalid URL provided to _removeImageParams:",t),t}}}},$app.controller("imageLibRemoveCtrl",["$scope","$http","$dialog","$data",function(e,t,a,i){e.close=function(){a.close(null)},e.confirm=function(){a.close(i)}}]),$app.controller("imageLibCtrl",["$scope","Upload","$http","$dialog","$interval","$timeout","angularGridInstance","ImageLibService",function(l,i,g,n,o,a,s,c){l.helpLink="https://learn.appdocumentation.com/en/articles/805514-using-the-media-library",l.readyToShowFiles=!1,l.readyToShowAIFiles=!1,l.tools=ImageLibAPI.tools,l.invalidFileType=l.showProgressMessage=l.showSuccessMessage=l.showErrorMessage=l.invalidFileSize=!1,l.hideMessage=function(){l.invalidFileType=l.showProgressMessage=l.showSuccessMessage=l.showErrorMessage=!1},l.showMessage=function(e){l.hideMessage(),l[e]=!0,"showSuccessMessage"===e&&a(function(){l.hideMessage(),l.$digest()},1e4)};var t=null,r=new DatastoreAPI({appId:window.appContext.currentApp.appId,pluginId:"appearance",instanceId:"appearance",liveMode:0,writeKey:window.appContext.currentApp.keys.datastoreKey});l.files=[],l.selectedFiles={},l.filterIcons=[],l.stockImages=[],l.selectedStockImages={},l.loadingFiles=!0,l.loadingAIFiles=!0,l.hoveredImageName="",l.iconSearchKeyword="",l.selectedIcons={},l.iconsShown=!1,l.filesShown=!1,l.stockShown=!1,l.aIShown=!1,l.iconsActive=!1,l.filesActive=!1,l.stockActive=!1,l.aIActive=!1,l.shouldRefreshFiles=!1,l.appearanceIconsObj={iconPack:"glyphicon"},l.appearance={},l.iconPacksObj={glyphicon:"Glyphicons",bootstrap:"Bootstrap Icons"},l.iconPacks=Object.entries(l.iconPacksObj).map(function(e){return{name:e[1],key:e[0]}}),l.activeType=function(e){l.iconsActive=!1,l.filesActive=!1,l.stockActive=!1,l.aIActive=!1,l.clearSelection(),void 0!==e&&(l[e]=!0),l.filesActive&&l.shouldRefreshFiles&&(l.searchFiles(),l.shouldRefreshFiles=!1)},l.activeFiles=function(){l.selectedFiles={},l.activeType("filesActive")},l.activeIcons=function(){l.selectedIcons={},l.activeType("iconsActive")},l.activeStockImages=function(){l.selectedStockImages={},l.activeType("stockImagesActive")},l.activeAIImages=function(){l.activeType("aIImagesActive")},l.isImageSelected=!1,l.clearSelection=function(){if(l.isImageSelected=!1,l.selectedFiles={},l.files)for(var e=0;e<l.files.length;e++)l.files[e].selected=!1;if(l.selectedIcons={},l.icons)for(e=0;e<l.icons.length;e++)l.icons[e].selected=!1;if(l.selectedStockImages={},l.stockImages)for(e=0;e<l.stockImages.length;e++)l.stockImages[e].selected=!1},l.close=function(){n.close({selectedFiles:[],selectedIcons:[],selectedStockImages:[],selectedAIFiles:[]})},l.insertSelection=function(){var e=[];if(l.selectedFiles)for(var t in l.selectedFiles)t&&l.selectedFiles[t]&&e.push(l.selectedFiles[t]);var a=[];if(l.selectedIcons)for(var i in l.selectedIcons)i&&l.selectedIcons[i]&&a.push(l.selectedIcons[i]);if(l.selectedStockImages){for(var o in l.selectedStockImages)o&&l.selectedStockImages[o]&&e.push(l.selectedStockImages[o]);l.appendStockImageToSavedList(l.selectedStockImages),v(l.selectedStockImages)}n.close({selectedFiles:e,selectedIcons:a})},l.appendStockImageToSavedList=function(e){if(!(l.cachedStockImages&&50<=l.cachedStockImages.length)){var t,a=!1;for(t in e){var i=p(t);d(i)||(i.selected=!1,l.cachedStockImages.push(i),a=!0)}a&&l.saveStockImages(l.cachedStockImages)}};var p=function(e){for(var t in l.stockImages)if(l.stockImages[t].key==e)return l.stockImages[t]},d=function(e){for(var t in l.cachedStockImages)if(l.cachedStockImages[t].key==e.key)return!0;return!1};l.saveStockImages=function(e){t.save({tag:"",obj:e},function(e,t){})},l.showRecentUsedLabel=!1,l.getStockImages=function(){l.stockImages=[],t.get({tag:""},function(e,t){if(e)console.error(e);else if(t&&t.data){if(l.cachedStockImages=[],t.data.length&&0!=t.data.length){for(var a in t.data)t.data[a].isCached=!0,l.atLeastOneSearchMade=!0,l.cachedStockImages.push(t.data[a]);l.showRecentUsedLabel=!0}else l.stockImageSearch();l.stockImages=l.cachedStockImages}})},l.selectFile=function(e){"mediaLibraryManagement"!=l.mode&&(imageLibCurrentApp.options&&!1===imageLibCurrentApp.options.multiSelection&&l.clearSelection(),e&&(l.isImageSelected=!0,e.selected=!e.selected,e.selected?l.selectedFiles[e.key]=e.url:delete l.selectedFiles[e.key]))},l.changeFilesView=function(e){"small"!==(l.filesView=e)||l.startWith||l.getFiles()},l.selectIcon=function(e){imageLibCurrentApp.options&&!1===imageLibCurrentApp.options.multiSelection&&l.clearSelection(),e&&(l.isImageSelected=!0,e.selected=!e.selected,e.selected?l.selectedIcons[e.key]=e.class:delete l.selectedIcons[e.class])},l.selectStockImage=function(e){imageLibCurrentApp.options&&!1===imageLibCurrentApp.options.multiSelection&&l.clearSelection(),e&&(l.isImageSelected=!0,e.selected=!e.selected,e.selected?l.selectedStockImages[e.key]=e.url:delete l.selectedStockImages[e.key])};function m(e){var t=!0;l.invalidFileSize=!1;for(var a=0;a<e.length;a++)if(10485760<e[a].size){l.invalidFileSize=!(t=!1);break}return t}function e(e,t){var a;0!==e.length&&(1===e.length?(a="".concat(siteConfig.endPoints.datastoreHost,"/app/").concat(imageLibCurrentApp.context.appId,"/validateImage"),g.get(a,{params:{filename:e[0]}}).success(function(e){t(null,e)}).error(function(e){t(e,null),console.error(e)})):(a="".concat(siteConfig.endPoints.datastoreHost,"/app/").concat(imageLibCurrentApp.context.appId,"/validateImage"),g.post(a,{filesNames:e}).success(function(e){t(null,e)}).error(function(e){t(e,null),console.error(e)})))}l.$watch("uploadFiles",function(){var i;!l.uploadFiles||l.uploadFiles.length<=0||(l.uploadFiles&&l.uploadFiles.length<1&&(l.invalidFileType=!0),l.uploadFiles&&0<l.uploadFiles.length&&!m(l.uploadFiles)||(l.uploadFiles&&1===l.uploadFiles.length?l.uploadFiles[0].name&&(l.showMessage("showProgressMessage"),e([l.uploadFiles[0].name],function(e,t){e?(console.error(e),l.showMessage("showErrorMessage")):!t||t.isInvalidFilename||t.isFileExist?(t={newFile:l.uploadFiles[0],fileValidateInfo:t},u(t,!0).then(function(){return l.showMessage("showSuccessMessage")}).catch(function(e){l.hideMessage()})):(l.hideMessage(),l.upload(l.uploadFiles[0],function(e){e?l.showMessage("showErrorMessage"):l.showMessage("showSuccessMessage")}))})):l.uploadFiles&&1<l.uploadFiles.length&&(i=l.uploadFiles.map(function(e){return e.name.toLowerCase()}),l.showMessage("showProgressMessage"),e(i,function(e,t){var a;e?(console.error(e),l.showMessage("showErrorMessage")):(a=i,t.reduce(function(e,t){return e.then(function(){var e=l.uploadFiles.find(function(e){return e.name.toLowerCase()===t.filename.toLowerCase()});return e?t.isFileExist||t.isInvalidFilename?u({newFile:e,filesNames:a,fileValidateInfo:t},!1).catch(function(e){throw e}):(l.upload(e),Promise.resolve()):Promise.resolve()}).catch(function(e){throw e})},Promise.resolve()).catch(function(e){throw e}).then(function(){return l.showMessage("showSuccessMessage")}).catch(function(e){"The user canceled the upload"!==e?(console.error(e),l.showMessage("showErrorMessage")):l.hideMessage()}))}))))});var u=function(e,i){return new Promise(function(t,a){window.openDialog({templateUrl:"imageRenameAndReplace.html",controller:"imageRenameAndReplaceCtrl",data:e,size:"md",backdrop:"static",keyboard:!1},function(e){e&&("cancel"===e.action?a("The user canceled the upload"):"replace"===e.action?l.replaceFileApi(e.existingFile,e.newFile,i):"rename"===e.action&&l.upload(e.newFile)),t()})})};l.replaceFileApi=function(o,e,n){var t,a;o||e?m([e])&&(t=window.siteConfig.endPoints.datastoreHost+"/app/"+imageLibCurrentApp.context.appId+"/image/replace",a=(a=l.tools.resizeImage(o.url,{})).split("?")[0],i.upload({url:t,fields:{},data:{existingFileKey:o.key,cdnUrl:a},file:e,headers:{writeKey:imageLibCurrentApp.context.writeKey}}).progress(function(e){l.progressMessage=!0,n&&l.showMessage("showProgressMessage")}).success(function(e,t,a,i){o.url=o.url+"?cacheBuster="+Math.random(),f(o,function(e){var t;e&&(t=l.files.findIndex(function(e){return e.key==o.key}),l.files.splice(t,1),l.files.push(e),c.resetCachedImages(),l.refreshFiles({delay:3e3,forceRefresh:!0}))}),l.addCacheBusterImage(o),n&&l.showMessage("showSuccessMessage")}).error(function(e){n&&l.showMessage("showErrorMessage")})):l.invalidFileType=!0},l.searchFiles=function(){var e={startIndex:0};l.startWith&&(e.startWith=l.startWith),l.readyToShowFiles=!1,l.loadingFiles=!0,l.getFiles(e,function(){})},l.validateFile=function(e,a){var t;e&&(t=window.siteConfig.endPoints.datastoreHost+"/app/"+imageLibCurrentApp.context.appId+"/validateImage",g.get(t,{params:{filename:e}}).success(function(e,t){a(e)}).error(function(e,t){a(e),console.error(e)}))},l.removeFilePopup=function(e){window.openDialog({templateUrl:"imageLibRemove.html",controller:"imageLibRemoveCtrl",data:e,size:"sm"},l.removeFile)},l.removeStockImagePopup=function(e){window.openDialog({templateUrl:"imageLibRemove.html",controller:"imageLibRemoveCtrl",data:e,size:"sm"},l.removeStockImage)},l.removeStockImage=function(e){void 0!==e&&null!=e&&l.cachedStockImages[e]&&l.cachedStockImages[e].key&&(l.cachedStockImages.splice(e,1),l.saveStockImages(l.cachedStockImages))};var h=!(l.removeFile=function(s){var r,e;void 0!==s&&null!=s&&(l.files[s]&&l.files[s].key?(r=l.files[s].key,e=window.siteConfig.endPoints.datastoreHost+"/app/"+imageLibCurrentApp.context.appId+"/image/delete",g.post(e,{key:l.files[s].key},{headers:{writekey:imageLibCurrentApp.context.writeKey}}).success(function(e,t,a,i){var o,n;l.files.splice(s,1),c.resetCachedImages(),l.refreshFiles({delay:1e3,forceRefresh:!0}),o="cp/mediaLib/removedFile",n={fileName:r},"undefined"!=typeof AnalyticsAPI&&new AnalyticsAPI(imageLibCurrentApp.context.appId).trackAction(o,n)}).error(function(e,t,a,i){console.error(e)})):console.log("invalid key to remove"))});l.refreshFiles=function(e,t){e=e||{},h&&!e.forceRefresh||(h=!0,a(function(){h=!1,s.gallery&&s.gallery.refresh&&s.gallery.refresh(),l.readyToShowFiles=!0,l.loadingFiles=!1,l.$$phase||l.$digest(),t&&t()},e.delay||50))};var f=function(t,a){var e,i,o;!t||l.files.find(function(e){return e.url==t.url})?a&&a():((e=new Image).onload=function(e){t.actualHeight=this.height,t.actualWidth=this.width,a&&a(t)},e.onerror=function(){a&&a()},i=t.url,(o=l.checkCacheBusterImage(t))&&(i+="?cacheBuster="+o.getTime()),"gif"===(o=t.key.split(".").pop()).toLowerCase()||"svg"===o.toLowerCase()?t.clientUrl=e.src=t.url:t.clientUrl=e.src=l.tools.resizeImage(i,{width:200,cacheBusting:!0}))};l.onImageHover=function(e){l.hoveredImageName=e.key.split("/").pop()},l.onImageHoverLeave=function(){l.hoveredImageName=""},l.isEditImageOptionShown=function(e){e=e.clientUrl.split(".").pop();return"gif"!==e.toLowerCase()&&"svg"!==e.toLowerCase()},l.addCacheBusterImage=function(e){var t=window.localStorage.getItem("cacheBusterImages");t?(t=JSON.parse(t))[e.key]=new Date:(t={})[e.key]=new Date,window.localStorage.setItem("cacheBusterImages",JSON.stringify(t))},l.checkCacheBusterImage=function(e){var t=window.localStorage.getItem("cacheBusterImages");if(!t)return null;var a=(t=JSON.parse(t))[e.key];if(!a)return null;var i=new Date,a=new Date(a);return 8<Math.abs(i.getTime()-a.getTime())/36e5?(delete t[e.key],window.localStorage.setItem("cacheBusterImages",JSON.stringify(t)),null):a},l.editFile=function(s){var t={templateUrl:"imageLibReplace.html",controller:"imageLibReplaceCtrl",data:s,size:"sm"},e=l.files[s].url,a=l.checkCacheBusterImage(l.files[s]);a&&(e+="?cacheBuster="+a.getTime()),imageEditor.launchEditor("imgLibFile"+s,e,function(e,n){window.openDialog(t,function(e){var t,a,i,o;"replace"==e?(t=n,a=s,i=l.files[a],o=window.siteConfig.endPoints.datastoreHost+"/app/"+imageLibCurrentApp.context.appId+"/image/base64",l.showMessage("showProgressMessage"),g.post(o,{base64Data:t,existingImageKey:i.key,cdnUrl:i.clientUrl},{headers:{writeKey:imageLibCurrentApp.context.writeKey}}).success(function(e){var t=angular.copy(i);t.url=i.url+"?cacheBuster="+Math.random(),f(t,function(e){e&&(l.files.splice(a,1),l.files.push(e),c.resetCachedImages(),l.refreshFiles({delay:3e3,forceRefresh:!0}))}),l.showMessage("showSuccessMessage"),l.addCacheBusterImage(i)}).error(function(e){console.log(e),l.showMessage("showErrorMessage")})):"dontReplace"==e&&(t=n,e=window.siteConfig.endPoints.datastoreHost+"/app/"+imageLibCurrentApp.context.appId+"/image/base64",l.showMessage("showProgressMessage"),g.post(e,{base64Data:t},{headers:{writeKey:imageLibCurrentApp.context.writeKey}}).success(function(e){f({key:e.key,url:e.url,selected:!1},function(e){e&&l.files.splice(0,0,e),c.resetCachedImages(),l.refreshFiles({delay:1e3,forceRefresh:!0},function(){var e=document.getElementById("media-library-upload-imgs");e&&(e.scrollTop=0)})}),l.showMessage("showSuccessMessage")}).error(function(e){console.log(e),l.showMessage("showErrorMessage")}),l.$$phase||l.$digest())})},function(e){console.error(e)})},l.upload=function(e,o){var t=null;imageLibCurrentApp&&(t=window.siteConfig.endPoints.datastoreHost+"/app/"+imageLibCurrentApp.context.appId+"/image"),e&&i.upload({url:t,fields:{},data:{filename:e.name},file:e,headers:{writeKey:imageLibCurrentApp.context.writeKey}}).progress(function(e){l.progressMessage=!0}).success(function(e,t,a,i){f({key:e.key,url:e.url,selected:!1},function(e){e&&l.files.splice(0,0,e),c.resetCachedImages(),l.refreshFiles({delay:1e3,forceRefresh:!0},function(){var e=document.getElementById("media-library-upload-imgs");e&&(e.scrollTop=0)})}),o&&o()}).error(function(e){o&&o(e)})},l.onScroll=function(){l.notscrolly&&l.notEmptyData&&l.getFiles()};var I=[],w=[];l.getFiles=function(e,n){l.notEmptyData=!0,imageLibCurrentApp?2<I.length?l.loadingFiles=!0:(void 0===(e=e||{}).startIndex?l.files&&l.files.length&&(e.startKey=l.files[l.files.length-1].key):(l.files=[],s.gallery&&s.gallery.refresh&&s.gallery.refresh()),l.startWith&&(e.startWith=l.startWith),e.appId=imageLibCurrentApp.context.appId,l.notscrolly=!1,c.loadImages(e).then(function(t){var i=20;function o(){if(I&&!(I.length<1))for(var t=0,a=0;t<i&&I&&!(I.length<1);){t++;var e=I.splice(0,1);e&&e[0]&&f(e[0],function(e){a++,e&&w.push(e),a==t&&setTimeout(function(){for(var t=0;t<w.length;t++)l.files.find(function(e){return e.url==w[t].url})||l.files.push(w[t]);w=[],l.refreshFiles(),setTimeout(function(){o()},100)},10)})}}0<t.length&&0<l.files.length&&l.files.find(function(e){return e.key===t[t.length-1].key})&&(l.notEmptyData=!1);for(var e=0;e<t.length;e++){var a=t[e];a.selected=!1,I.push(a)}0<I.length&&(l.loadingFiles=!0,o()),(!t||t.length<=0)&&(l.notEmptyData=!1,l.loadingFiles=!1,l.readyToShowFiles=!0),l.notscrolly=!0,n&&n(null,t)}).catch(function(e){console.error(e),n&&n(data,null)})):n&&n({msg:"Invalid folder"},null)};function y(){new Promise(function(a,i){r.get({tag:"appearance",withDynamicData:!0},function(e,t){e?i(e):t&&t.id?a(t):r.insert({obj:{},tag:"appearance",checkDuplicate:!0},function(e,t){e?i(e):a(t)})})}).then(function(e){l.appearance=e.data||{},l.appearance.icons&&(l.appearanceIconsObj=l.appearance.icons),b(l.appearanceIconsObj.iconPack)})}l.onIconPackChange=function(t){var e;e=function(e){e&&(l.filterIcons=[],l.iconSearchKeyword="",l.searchingIcons=!1,l.appearanceIconsObj.iconPack=t,cpInlineManual.injectFontIcon(t),emulatorSync.triggerAppearanceBeforeUpdate(),r.save({tag:"appearance",obj:{$set:{icons:l.appearanceIconsObj}}},function(e,t){l.appearance.icons=l.appearanceIconsObj,emulatorSync.reloadiFrame();var a=document.getElementById("controlIFrame");a.src=a.src,window.location.reload()}),"undefined"!=typeof crm&&(window.updatedAppearance||(crm.log("Updated appearance"),window.updatedAppearance=!0)),b(l.appearanceIconsObj.iconPack))},window.openDialog({templateUrl:"changeIconPackConfirmation.html",controller:"changeIconPackConfirmationCtrl",size:"md"},e)};var b=function(c){l.loadingIcons=!0;var e="".concat("bootstrap"===c?"/app/styles/icons/bootstrap@5.0/bootstrap-icons.css":"/styles/bootstrapIcons.css");g.get(e).success(function(e){var t,s,a=angular.element(document.querySelector("#iconsFrame"))[0],r=a.contentDocument;(r=!r&&a&&a.contentWindow&&a.contentWindow.document?a.contentWindow.document:r)?(r.head.innerHTML="<style id='iconStyle' type='text/css'>"+e+"</style>",s=0,e=function(){s++;try{for(var e=r.styleSheets[r.styleSheets.length-1],t=e.rules||e.cssRules,a=[],i=0;i<t.length;i++){var o,n="bootstrap"===c?"bi":"glyphicon";void 0!==t[i].selectorText&&0==t[i].selectorText.indexOf(".".concat(n,"-"))&&(o=(o=(o=(o=(o=t[i].selectorText.replace(".".concat(n,"-"),"")).replace("::before","")).replace(":before","")).replace(":after","")).replace("::after",""),a.indexOf(o)<0&&a.push({key:"".concat(n," ").concat(n,"-").concat(o),class:"".concat(n," ").concat(n,"-").concat(o),selected:!1}))}l.icons=a,l.allIcons=a,l.loadingIcons=!1,l.$$phase||l.$$phase()}catch(e){if(10==s&&(l.stopInterval(),console.error("stop trying")),e&&"InvalidAccessError"==e.name)return void console.warn("icons css document not parsed yet");console.error(e)}l.stopInterval()},l.stopInterval=function(){angular.isDefined(t)&&(o.cancel(t),t=void 0)},t=o(e,50),e()):console.warn("innerDoc was not found")})};l.searchIcons=function(){var t;l.searchingIcons=!!l.iconSearchKeyword,l.iconSearchKeyword?(t=escape(l.iconSearchKeyword),l.filterIcons=l.icons.filter(function(e){return e.key.includes(t)})):l.filterIcons=[],l.$$phase||l.$$phase()},void 0!==imageLibCurrentApp&&(imageLibCurrentApp.options||(imageLibCurrentApp.options={}),l.iconsShown=!(!1===imageLibCurrentApp.options.showIcons),l.filesShown=!(!1===imageLibCurrentApp.options.showFiles),l.stockShown=!(!1===imageLibCurrentApp.options.showStockImages),l.aIShown=!(!1===imageLibCurrentApp.options.showAiImages),l.mode=imageLibCurrentApp.options.mode,l.stockShown&&(window.appContext&&window.appContext.currentApp&&window.appContext.currentApp.appId&&window.appContext.currentApp.keys&&window.appContext.currentApp.keys.datastoreKey?t=new DatastoreAPI({appId:window.appContext.currentApp.appId,pluginId:"stockImages",instanceId:"stockImages",liveMode:0,writeKey:window.appContext.currentApp.keys.datastoreKey}):(imageLibCurrentApp.options.showStockImages=!1,l.stockShown=!1,console.error("stockImages error: missing appId or datastoreKey")))),"mediaLibraryManagement"===l.mode?l.filesView="large":l.filesView="small",l.stockShown&&(l.activeTab=2,l.activeStockImages(),l.getStockImages()),l.aIShown&&(l.activeTab=3,l.activeAIImages()),l.iconsShown&&(l.activeTab=0,y(),l.activeIcons()),l.filesShown&&(l.activeTab=1,l.activeFiles(),l.getFiles({startIndex:0},function(){})),l.currentStockImagePage=1,l.totalStockImagesPages=1,l.showNoResultLabel=!1,l.atLeastOneSearchMade=!1,l.stockImageSearch=function(){l.selectedStockImages={},l.stockImages=[],l.currentStockImagePage=1,l.retrieveStockImage()},l.retrieveStockImage=function(){var e;l.stockImagesKeyword&&(e=l.stockImagesKeyword?escape(l.stockImagesKeyword):"",l.loadingStockImage=!0,l.atLeastOneSearchMade=!0,g.post(siteConfig.endPoints.appHost+"/api/stockImages/search",{query:e,page:l.currentStockImagePage}).success(function(e){l.showRecentUsedLabel=!1,l.totalStockImagesPages=e.totalPages;var t=(new Date).getTime();l.showNoResultLabel=0==e.images.length;for(var a=0;a<e.images.length;a++){var i={key:t+"_"+a,url:e.images[a].urls.full,imageId:e.images[a].imageId,photographerName:e.images[a].photographerName,selected:!1};l.stockImages.push(i)}l.loadingStockImage=!1}).error(function(e){console.error(e),l.loadingStockImage=!1}))},l.loadMoreStockImages=function(){l.stockActive&&!l.loadingStockImage&&l.totalStockImagesPages!=l.currentStockImagePage&&(l.currentStockImagePage++,l.retrieveStockImage())},l.couldAddAIimage=function(){return(l.generatedImages[l.activeIndex-1]||{}).addedToLibrary},l.applyCachedAISettings=function(){var i=c.loadCachedAISettings();l.predefinedAIImages.forEach(function(a){"Aspect Ratio"!==a.title?a.images.map(function(e){var t=i.filters[a.title]||{};return e.selected=t[e.label]||!1,e}):a.images.map(function(e){return e.selected=e.aspectRatio==i.aspectRatio&&i.aspectRatio,e})}),l.colors.forEach(function(e){i.colors[e];e.selected=i.colors[e.key]||!1}),l.imageDescription=i.description||"",l.aspectRatio=i.aspectRatio||"1:1"};var v=function(e){var t,a=[];for(t in e){var i=p(t);i.imageId&&a.push(i.imageId)}0<a.length&&g.post(siteConfig.endPoints.appHost+"/api/stockImages/view",{ids:a}).success(function(e){}).error(function(e){})};l.imageDescription="",l.generateImagePrompt="",l.selectedAIFilters={},l.selectedAIColors={},l.aspectRatio="1:1",l.addedAIImages=[],l.predefinedAIImages=[{title:"Style",images:[{path:"images/aiImages/style/photo.png",label:"Photo"},{path:"images/aiImages/style/portrait.png",label:"Portrait"},{path:"images/aiImages/style/oil-painting.jpg",label:"Oil Painting"},{path:"images/aiImages/style/watercolor.jpg",label:"Watercolor"},{path:"images/aiImages/style/fantasy.jpg",label:"Fantasy"},{path:"images/aiImages/style/cartoon.jpg",label:"Cartoon"},{path:"images/aiImages/style/digital-art.jpg",label:"Digital Art"},{path:"images/aiImages/style/pixel-art.jpg",label:"Pixel Art"},{path:"images/aiImages/style/pencil-sketch.jpg",label:"Pencil Sketch"},{path:"images/aiImages/style/comic-book.jpg",label:"Comic Book"},{path:"images/aiImages/style/childrens-book.jpg",label:"Children’s Book"},{path:"images/aiImages/style/anime.jpg",label:"Anime"},{path:"images/aiImages/style/flat-design.jpg",label:"Flat Design"},{path:"images/aiImages/style/3d-low-polygon.jpg",label:"3D Low Polygon"},{path:"images/aiImages/style/3d-cute-character.jpg",label:"3D Cute Character"},{path:"images/aiImages/style/cyberpunk.jpg",label:"Cyberpunk"}],tooltip:"Choose a style that best describes the type of image you want to create"},{title:"Details",images:[{path:"images/aiImages/details/realistic.jpg",label:"Realistic"},{path:"images/aiImages/details/super-detailed.jpg",label:"Super Detailed"},{path:"images/aiImages/details/ultra-realistic.jpg",label:"Ultra-realistic"},{path:"images/aiImages/details/high-contrast.jpg",label:"High Contrast"},{path:"images/aiImages/details/sharp-focus.jpg",label:"Sharp Focus"},{path:"images/aiImages/details/blurred-background.jpg",label:"Blurry Background"}],tooltip:"Choose the level of detail you would like in the generated image."},{title:"Light Effects",images:[{path:"images/aiImages/light-effects/natural-light.jpg",label:"Natural"},{path:"images/aiImages/light-effects/studio-light.jpg",label:"Studio"},{path:"images/aiImages/light-effects/soft-light.jpg",label:"Soft"},{path:"images/aiImages/light-effects/dawn-light.jpg",label:"Dawn"},{path:"images/aiImages/light-effects/dusk-light.jpg",label:"Dusk"},{path:"images/aiImages/light-effects/dramatic-light.jpg",label:"Dramatic"},{path:"images/aiImages/light-effects/cinematic-light.jpg",label:"Cinematic"},{path:"images/aiImages/light-effects/neon-lights.jpg",label:"Neon"}],tooltip:"Choose the type of light you want to see in your image"},{title:"Framing",images:[{path:"images/aiImages/framing/wide-shot.jpg",label:"Wide Shot"},{path:"images/aiImages/framing/close-up.jpg",label:"Close-up"},{path:"images/aiImages/framing/macro.jpg",label:"Macro"},{path:"images/aiImages/framing/aerial-framing.jpg",label:"Aerial"},{path:"images/aiImages/framing/low-angle.png",label:"Low Angle"}],tooltip:"Choose the composition of the image or the distance between the camera and the subject"},{title:"Aspect Ratio",images:[{path:"images/aiImages/aspect-ratio/hero-image.jpg",label:"Hero Image",aspectRatio:"16:9"},{path:"images/aiImages/aspect-ratio/background-ratio.jpg",label:"Background",aspectRatio:"9:16"},{path:"images/aiImages/aspect-ratio/icon-ratio.jpg",label:"icon",aspectRatio:"1:1",selected:!0}],tooltip:"The aspect ratio depends on the purpose of the image you are creating."}],l.colors=[{key:"Red",selected:!1},{key:"Green",selected:!1},{key:"Blue",selected:!1},{key:"Yellow",selected:!1},{key:"Orange",selected:!1},{key:"Pink",selected:!1},{key:"Violet",selected:!1},{key:"Purple",selected:!1},{key:"Brown",selected:!1},{key:"Black",selected:!1},{key:"White",selected:!1},{key:"Grayscale",selected:!1},{key:"Beautiful",selected:!1},{key:"Gradient",selected:!1},{key:"Vibrant",selected:!1},{key:"Dramatic",selected:!1},{key:"Colorful",selected:!1}],l.applyCachedAISettings();function k(){var a=document.getElementById("txtAiImageDescription").value;l.imageDescription=a,l.selectedAIFilters={},l.selectedAIColors={},l.predefinedAIImages.forEach(function(t){"Aspect Ratio"!==t.title&&t.images.forEach(function(e){e.selected&&(a+=", ".concat(e.label," ").concat(t.title),l.selectedAIFilters[t.title]||(l.selectedAIFilters[t.title]={}),l.selectedAIFilters[t.title][e.label]=!0)})});var t="";return l.colors.forEach(function(e){e.selected?(t+="".concat(e.key," "),l.selectedAIColors[e.key]=!0):l.selectedAIColors[e.key]=!1}),t&&(a+=", ".concat(t,"colors")),l.generateImagePrompt=a,window.localStorage.setItem("selectedAIFilters",JSON.stringify(l.selectedAIFilters)),window.localStorage.setItem("selectedAIColors",JSON.stringify(l.selectedAIColors)),window.localStorage.setItem("selectedAIAspectRatio",l.aspectRatio),window.localStorage.setItem("selectedAIDescription",l.imageDescription),a}l.selectAIImageType=function(e,a){l.predefinedAIImages.forEach(function(t){t.title===e&&t.images.forEach(function(e){"Aspect Ratio"==t.title&&e.label===a&&(l.aspectRatio=e.selected?"1:1":e.aspectRatio),e.selected=e.label===a&&!e.selected})})},l.generateAIImage=function(){l.generateAIImageStarted=!0,l.start()},l.closeAIModal=function(){l.generateAIImageStarted=!1},l.next=function(){l.activeIndex++,l.activeIndex>l.generatedImages.length&&(l.activeIndex=1)},l.back=function(){l.activeIndex--,l.activeIndex<1&&(l.activeIndex=l.generatedImages.length)},l.generatedImages=[],l.activeIndex=1,l.uploadAIImageLoading=!1,l.generateAIImageStarted=!1,l.start=function(){AiAPI.startLoadingAnimation({lockCP:!0}),l.createImageLoading=!0,l.aiImageGenerated=!1,l.aiImageGeneratingError=!1,l.imageLoaded=!1,g({method:"POST",url:"/api/app/".concat(imageLibCurrentApp.context.appId,"/ai/generateImage"),data:{prompt:k(),numberOfImages:1,size:"1024x1024",responseFormat:"url"}}).then(function(e){l.createImageLoading=!1,l.aiImageGenerated=!0,e&&e.data&&e.data.content&&l.generatedImages.push({url:function(e){switch(1<arguments.length&&void 0!==arguments[1]?arguments[1]:"1:1"){case"1:1":return l.tools.cropImage(e,{});case"16:9":return l.tools.cropImage(e,{width:1024,height:576});case"9:16":return l.tools.cropImage(e,{width:576,height:1024});default:return l.tools.cropImage(e,{})}}(e.data.content,l.aspectRatio),isSaved:!1}),l.activeIndex=l.generatedImages.length,document.getElementById("renderedImage").addEventListener("load",function(){AiAPI.stopLoadingAnimation(),l.imageLoaded=!0,l.$apply()})},function(e){console.error("error",e),AiAPI.stopLoadingAnimation(),l.createImageLoading=!1,l.aiImageGeneratingError=!0})};l.uploadAIImageUrl=function(){l.uploadAIImageLoading=!0;var a,e=l.generatedImages[l.activeIndex-1].url,t=window.siteConfig.endPoints.datastoreHost+"/app/"+imageLibCurrentApp.context.appId+"/image/url";g.post(t,{imageUrl:e,fileExtension:".png",fileName:"ai-"+(a=(new Date).getTime(),"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=(a+16*Math.random())%16|0;return a=Math.floor(a/16),("x"==e?t:3&t|8).toString(16)}))+".png"},{headers:{writeKey:imageLibCurrentApp.context.writeKey}}).success(function(e){var t,a,i;l.uploadAIImageLoading=!1,l.generatedImages[l.activeIndex-1].addedToLibrary=!0,t={key:e.key,url:e.url,selected:!1},a=function(e){e&&l.files.splice(0,0,e),c.resetCachedImages(),l.refreshFiles({delay:1e3,forceRefresh:!0},function(){var e=document.getElementById("media-library-upload-imgs");e&&(e.scrollTop=0)}),l.shouldRefreshFiles=!0},!t||l.files.find(function(e){return e.url==t.url})?a&&a():((i=new Image).onload=function(e){t.actualHeight=this.height,t.actualWidth=this.width,a&&a(t)},i.onerror=function(){a&&a()},e=t.url,t.key.split(".").pop(),t.clientUrl=i.src=l.tools.resizeImage(e,{width:200,cacheBusting:!0})),window.toast("Added to My Images")}).error(function(e){l.uploadAIImageLoading=!1,console.log(e),window.toast("Error adding to My Images. Please try again","danger")}),l.$$phase||l.$digest()}}]),$app.controller("imageLibReplaceCtrl",["$scope","$http","$dialog","$data",function(e,t,a,i){e.close=function(){a.close(null)},e.confirm=function(e){a.close(e)}}]),$app.controller("imageRenameAndReplaceCtrl",["$scope","$http","$dialog","$data",function(o,n,s,t){o.loading=!1,o.errors={},o.data={newFile:t.newFile,isInvalidFilename:t.fileValidateInfo.isInvalidFilename,isFileExist:t.fileValidateInfo.isFileExist,existingFile:t.fileValidateInfo.file,fileExtension:"."+t.newFile.name.split(".").pop(),uploadedFilesNames:t.filesNames},o.encodeImageFileAsURL=function(){var e=new FileReader;e.onloadend=function(){return o.imageBase64=e.result},e.readAsDataURL(t.newFile)},o.encodeImageFileAsURL();o.rename=function(){if(o.errors.fileName=null,o.newFilename&&0!==o.newFilename.length){var a=o.newFilename.trim()+o.data.fileExtension;if((a=a.toLowerCase())===o.data.newFile.name)return o.errors.fileName="Can't use same file name";o.loading=!0,o.data.uploadedFilesNames&&-1<o.data.uploadedFilesNames.indexOf(a)?o.errors.fileName="Name is already in use":(i=function(e,t){o.loading=!1,t&&t.isInvalidFilename?o.errors.fileName="Wrong, image name can't contains any of the following characters:  < > : \" / \\ | ? *":t&&!t.isFileExist?(o.errors=null,Object.defineProperty(o.data.newFile,"name",{writable:!0,value:a}),s.close({action:"rename",newFile:o.data.newFile})):o.errors.fileName="Name is already in use"},0!==(e=a).length&&(t="".concat(siteConfig.endPoints.datastoreHost,"/app/").concat(imageLibCurrentApp.context.appId,"/validateImage"),n.get(t,{params:{filename:e}}).success(function(e,t){i(null,e)}).error(function(e,t){console.error(e),i(e,null)})))}else o.errors.fileName="Image name cannot be empty";var e,i,t},o.replace=function(){o.close({action:"replace",newFile:o.data.newFile,existingFile:o.data.existingFile})},o.close=function(){s.close(0<arguments.length&&void 0!==arguments[0]?arguments[0]:null)}}]),$app.controller("changeIconPackConfirmationCtrl",["$scope","$http","$dialog","$data",function(e,t,a,i){e.close=function(){a.close(null)},e.confirm=function(){a.close(!0)}}]);
"use strict";function ColorLibAPI(o){this.context={},angular.copy(o,this.context),this.init()}ColorLibAPI.prototype={init:function(){},showDialog:function(t,e){var r=this;t=t||{};var o="",o={templateUrl:(o=window.siteConfig&&window.siteConfig.endPoints&&window.siteConfig.endPoints.appHost?window.siteConfig.endPoints.appHost:o)+"/pages/colorLib/colorLib.html",controller:"colorLibCtrl",size:"sm",backdrop:t.backdrop||"static",position:t.position,data:{options:t,onChange:function(o,t){r._onChange&&r._onChange(t)}}};window.openDialog(o,function(o){e&&e(null,o||t.data)})},onChange:function(o){this._onChange=o}},$app.controller("colorLibCtrl",["$scope","$dialog","$data","$window",function(r,o,i,t){r.tools=ImageLibAPI.tools,r.appHost=window.siteConfig.endPoints.appHost,i.options||(i.options={}),r.gradientTypes={"to bottom":"Bottom","to right":"Right","to top left":"Top Left","to top right":"Top Right","to top":"Top","to left":"Left","to bottom left":"Bottom Left","to bottom right":"Bottom Right"},!i.options.data||angular.equals(i.options.data,{})?r.items={gradient:{colors:[{color:"",percentage:0,opacity:100},{color:"",percentage:100,opacity:100}],gradientType:"to bottom"},solid:{color:"",opacity:100}}:(r.items={},angular.copy(i.options.data,r.items),r.items.gradient||(r.items.gradient={colors:[{color:"",percentage:0,opacity:100},{color:"",percentage:100,opacity:100}],gradientType:"to bottom"}),r.items.solid||(r.items.solid={color:"",opacity:100})),r.colorTypes={};var e=r.items.colorType;function c(o,t){void 0===t&&(t=100);o=(o=o||"#ffffff").substring(0,7);return t=t,o=(o=o).replace("#",""),"rgba("+parseInt(o.substring(0,2),16)+","+parseInt(o.substring(2,4),16)+","+parseInt(o.substring(4,6),16)+","+t/100+")"}e=i.options.hideGradient?"gradient"===e?null:"solid":(r.colorTypes.gradient="Gradient",e||"gradient"),i.options.hideSolid?e="solid"===e?null:"gradient":r.colorTypes.solid="Solid",r.items.colorType=e,angular.element(t).bind("mousedown",function(){r.config={},r.$apply()}),r.$watch("items.gradient",function(o,t){var e;o&&(o.colors&&o.colors[0]&&o.colors[0].color&&-1<o.colors[0].color.indexOf("#")&&(o.colors[0].colorHex=o.colors[0].color),o.colors&&o.colors[0]&&(void 0===o.colors[0].percentage&&(r.items.gradient.colors[0].percentage=o.colors[0].percentage=0),void 0===o.colors[0].opacity&&(r.items.gradient.colors[0].opacity=o.colors[0].opacity=100)),r.items.gradient.colors[0].color=c(o.colors[0].colorHex,o.colors[0].opacity),o.colors&&o.colors[1]&&o.colors[1].color&&-1<o.colors[1].color.indexOf("#")&&(o.colors[1].colorHex=o.colors[1].color),o.colors&&o.colors[1]&&(void 0===o.colors[1].percentage&&(r.items.gradient.colors[1].percentage=o.colors[1].percentage=100),void 0===o.colors[1].opacity&&(r.items.gradient.colors[1].opacity=o.colors[1].opacity=100)),r.items.gradient.colors[1].color=c(o.colors[1].colorHex,o.colors[1].opacity),e=(e=(e=(e=(e=(e="linear-gradient({gradientType}, {colorOne} {colorOnePercentage}%, {colorTwo} {colorTwoPercentage}%)").replace("{gradientType}",o.gradientType)).replace("{colorOne}",o.colors[0]?o.colors[0].color:"")).replace("{colorOnePercentage}",o.colors[0]?o.colors[0].percentage:0)).replace("{colorTwo}",o.colors[1]?o.colors[1].color:"")).replace("{colorTwoPercentage}",o.colors[1]?o.colors[1].percentage:100),r.items.gradient.backgroundCSS="background: "+e,r.items.gradient.backgroundCSSValue=e,i.onChange&&i.onChange(null,r.items))},!0),r.$watch("items.solid",function(o,t){o&&(o.color&&-1<o.color.indexOf("#")&&(o.colorHex=o.color),r.items.solid.color=c(o.colorHex,o.opacity),r.items.solid.backgroundCSS="background: "+r.items.solid.color,r.items.solid.colorCSS="color: "+r.items.solid.color,i.onChange&&i.onChange(null,r.items))},!0),r.$watch("items.colorType",function(o,t){o&&i.onChange&&i.onChange(null,r.items)},!0),r.save=function(){o.close(r.items)},r.closeDialog=function(){o.close(null)}}]);
"use strict";$app.service("authManager",["$http","$rootScope",function(s,i){var r={_currentUser:null,attemptAutoLogin:function(){var e=this.getCurrentUser();return e&&this._loggedIn(e),e},getCurrentUser:function(){if(this._currentUser)return this._currentUser;if(localStorage.user){var e;try{e=JSON.parse(localStorage.user)}catch(e){this.setCurrentUser(null)}if(e&&e.userToken)return e;try{localStorage.removeItem("user")}catch(e){}return null}return null},setCurrentUser:function(e){if(r._currentUser=e)try{localStorage.setItem("user",JSON.stringify(e)),localStorage.removeItem("lastRequest")}catch(e){if(e&&(22==e.code||"QUOTA_EXCEEDED_ERR"==e.name))return void alert("Your browser does not support using storage. Please switch to normal mode if you are using private mode or use another browser.")}else try{localStorage.removeItem("user")}catch(e){}i.$broadcast("userChanged",e)},isUserLoggedIn:function(){return null!=this.getCurrentUser()},validate:function(){s.post("/api/login/validate",null)},_login:function(e,r,t,o,n){var l="";return s.post(l+=e,{email:r,password:t,accessToken:o},{bypassInterceptorForStatus:404}).success(this.setCurrentUser).error(function(e){e&&"NOTFOUND"==e.code&&i.$broadcast("apiError",{code:"NOTFOUND",message:"Invalid username or password"})})},logout:function(){null!=this.getCurrentUser()&&this.setCurrentUser(null),s.post("/logout",null).finally(function(){}),localStorage.removeItem("user"),this.logoutHandler()},logoutHandler:function(){window.location="/logout"},resetPassword:function(e,r){},loginAdminPortal:function(e,r,t){return this._login("/api/login/adminPortal/",e,r,t)},loginWhitelabelContrlPanel:function(e,r,t){return this._login("/api/login/whitelabelControlPanel/",e,r,t)},loginDeveloperPortal:function(e,r,t){return this._login("/api/login/developerPortal/",e,r,t)},loginControlPanel:function(e,r,t,o){return this._login("/api/login/controlPanel/",e,r,t,o)},loginApi:null};return r}]);
"use strict";var PopupLibAPI={confirm:function(t,e){!1!==(t=t||{}).allowHtml&&(t.allowHtml=!0),t.message?(t.confirmButton||(t.confirmButton={text:"Confirm",type:"primary",key:"confirm"}),t.confirmButton.text||(t.confirmButton.text="Confirm"),t.confirmButton.key||(t.confirmButton.key="confirm"),t.confirmButton.type||(t.confirmButton.type="primary"),t.cancelButton||(t.cancelButton={text:"Cancel",type:"default",key:"cancel"}),t.cancelButton.text||(t.cancelButton.text="Cancel"),t.cancelButton.key||(t.cancelButton.key="cancel"),t.cancelButton.type||(t.cancelButton.type="default"),PopupLibAPI.showDialog({title:t.title||"Are you sure?",message:t.message,buttons:[t.confirmButton,t.cancelButton],size:t.size},e)):e("invalid parameter, missing message",null)},alert:function(t,e){!1!==(t=t||{}).allowHtml&&(t.allowHtml=!0),t.message?(t.okButton||(t.okButton={text:"OK",type:"primary",key:"ok"}),t.okButton.text||(t.okButton.text="OK"),t.okButton.key||(t.okButton.key="ok"),t.okButton.type||(t.okButton.type="primary"),PopupLibAPI.showDialog({title:t.title||"Alert",message:t.message,buttons:[t.okButton],size:t.size},e)):e("invalid parameter, messing message",null)},showDialog:function(t,e){if(!1!==(t=t||{}).allowHtml&&(t.allowHtml=!0),t.title){if(t.buttons&&0<t.buttons.length)for(var o=0;o<t.buttons.length;o++){if(!t.buttons[o].text)return void e("invalid parameter, missing text button");if(!t.buttons[o].key)return void e("invalid parameter, missing key button");t.buttons[o].type||(t.buttons[o].type="default")}else t.buttons=[];var n="",n={templateUrl:(n=window.siteConfig&&window.siteConfig.endPoints&&window.siteConfig.endPoints.appHost?window.siteConfig.endPoints.appHost:n)+"/pages/popupLib/popupLib.html",controller:"popupLibCtrl",size:t.size||"sm",data:t};window.openDialog(n,function(t){e&&e(null,t)})}else e("invalid parameter, messing title",null)}};$app.controller("popupLibCtrl",["$scope","$dialog","$data","$sce",function(t,o,e,n){t.allowHtml=e.allowHtml,t.popupData=e,t.popupData.message=n.trustAsHtml(e.message),t.message=e.message,t.title=e.title,t.buttons=e.buttons,t.size=e.size,t.subtitle=e.subtitle,t.hideCloseIcon=e.hideCloseIcon,t.closeDialog=function(){o.close(null)},t.selectedButton=function(t){var e={};t&&(e.selectedButton=angular.copy(t)),o.close(e)}}]);
"use strict";$app.factory("commonPluginService",["$rootScope","$http","promoService","$location",function(l,i,o,r){var u={},a=new DatastoreAPI(appContext.currentApp.appId,"pluginInstances",1,0,appContext.currentApp.keys.datastoreKey);return u.redirect=function(n,e){r.path(n).search("token",e).search("showHeader",!1).search("pluginTypeId",null).search("folderName",null)},u.redirectToActivePlugins=function(n){u.redirect("/activePlugins",n)},u.addPlugin=function(n){u.redirect("/addPlugin",n)},u.getPluginJson=function(n,e,t){e=window.siteConfig.endPoints.pluginHost+"/"+n+"/plugin.json?v="+(e||"");i.get(e).success(function(n){t(null,n)}).error(function(n){t(n)})},u.getMatchingInstances=function(e,n){return n.filter(function(n){return e==n.token})},u.filteredPluginInstances=function(n,t){o.getPluginInstances(n,function(n,e){n?t(n):(e=e.map(function(n){return n.data}).map(function(n){return{instanceId:n.instanceId,pluginTypeId:n.pluginTypeId,token:n.token,title:n.title}}),t(null,e))})},u.redirectToInstance=function(n){var e=n.token,t=n.pluginInstanceId,i=n.pluginTitle,a=n.folderName,n="/pluginControl/{1}/{2}/{3}/{4}/false",n="/pluginControl/{1}/{2}/{3}/{4}/false".replace("{1}",e).replace("{2}",t).replace("{3}",i).replace("{4}",a);l.closeMarketplace&&l.closeMarketplace(),r.path(n)},u.instanceExists=function(t,i){var a={isInUse:!1};u.getPluginJson(t.folderName,t.lastUpdatedOn,function(n,e){n?i(n):e.singleton?o.getPluginInstances(t,function(n,e){n?i(n):(0<(e=e.filter(function(n){return n.data.pluginTypeId==t.pluginTypeId})).length&&(a.isInUse=!0,a.matches=e),i(null,a))}):i(null,a)})},u.clone=function(i,a,l){var n;a&&a.data&&(i=i||{},n={domain:window.siteConfig.endPoints.datastoreHost,appId:appContext.currentApp.appId,folderName:a.data._buildfire.pluginType.result[0].folderName,pluginTypeId:a.data._buildfire.pluginType.result[0].pluginTypeId,token:a.data._buildfire.pluginType.result[0].token},u.instanceExists(n,function(n,e){var t;n?console.error(n):e.isInUse?!(t={token:(t=e.matches[0].data).token,pluginInstanceId:t.instanceId,pluginTitle:t.title,folderName:t._buildfire.pluginType.result[0].folderName})===i.allowSingletonRedirection?window.PopupLibAPI.alert({title:"Singleton Feature",message:"Singleton feature already exist!"},function(n,e){}):(toast("Singleton. Redirecting to instance.","warning"),u.redirectToInstance(t)):(t={templateUrl:"/pages/plugins/clonePlugin/clonePluginDialog.html",controller:"clonePluginDialogCtrl",size:"sm",data:{plugin:angular.fromJson(angular.toJson(a)),includePluginData:i.includePluginData}},window.openDialog(t,function(n){n&&l(n)}))}))},u.navigateToPlugin=function(n){var e;n.data&&n.data._buildfire?(t=n.data._buildfire.pluginType.result[0].folderName,e=n.data._buildfire.pluginType.result[0].token):n.data&&n.data.pluginType&&(t=n.data.pluginType.folderName,e=n.data.pluginType.token);var t={token:e,pluginInstanceId:n.data.instanceId||n.data.refId,pluginTitle:n.data.title,folderName:t};u.redirectToInstance(t)},u.getFeaturesByInstancesIds=function(n,e,t){e={obj:{filter:{$or:[{"$json.instanceId":{$in:n}}]},withDynamicData:!0,limit:e.limit,skip:e.skip},tag:""};a.search(e,function(n,e){return n?t(n,null):null!=e&&0<e.length?t(null,e):t(null,[])})},u}]);
"use strict";$app.controller("openDialogCtrl",["$uibModal",function(l){function e(o,t){this.modalInstance=null,this.options=o,this.callback=t}e.prototype.open=function(o){var t=this,n=o||this.options;this.modalInstance=l.open({animation:!0,windowClass:n.position||"",templateUrl:n.templateUrl,controller:n.controller,size:n.size,backdrop:void 0===n.backdrop||n.backdrop,keyboard:void 0===n.keyboard||n.keyboard,resolve:{$data:function(){return n.data},$dialog:function(){return t}}}),this.modalInstance.result.then(function(o){t.callback&&t.callback(o)},function(){n.useCallbackWhenNoAction&&t.callback&&t.callback()})},e.prototype.close=function(o){this.modalInstance.close(o)},window.openDialog=function(o,t){if(!o)throw"options have not been provided to openDialog";o.controller||console.warn("window.openDialog :: You have to pass the controller value to the openDialog function");var n=window._appRoot||"";o.controller=o.controller||"modalCtrl",o.templateUrl=o.templateUrl||n+"pages/templates/modal.html";t=new e(o,t);return t.open(),t}}]);
"use strict";$app.controller("pluginInstanceDialog",["$scope","$data","$dialog",function(n,e,t){n.appHost="",n.siteScope="",window.siteConfig&&window.siteConfig.endPoints&&window.siteConfig.endPoints.appHost&&"sdk"==window.siteConfig.scope&&(n.appHost=window.siteConfig.endPoints.appHost,n.siteScope="sdk"),n.showPluginInstances=!0,n.allowAddFeatureBtn=!0,n.showAddPlugin=!1,n.hideAddPlugin=!1,n.skipPluginInstances=!1,n.hideAddToSideMenuCheckbox=!1,n.selectedPluginsInstances=[],e&&e.options&&(e.options.skipPluginInstances&&(n.showPluginInstances=!1,n.showAddPlugin=!0,n.skipPluginInstances=!0),e.options.hideAddPlugin&&(n.hideAddPlugin=e.options.hideAddPlugin),e.options.hideAddToSideMenuCheckbox&&(n.hideAddToSideMenuCheckbox=e.options.hideAddToSideMenuCheckbox),void 0!==e.options.allowAddFeatureBtn&&(n.allowAddFeatureBtn=e.options.allowAddFeatureBtn)),n.cancel=function(){t.close(null)},n.close=function(e){t.close(e)},n.goToPluginInstances=function(){var e=(0<arguments.length&&void 0!==arguments[0]?arguments[0]:{}).selectedPluginInstance,e=void 0===e?null:e;n.showAddPlugin=!1,n.showPluginInstances=!0,e&&n.selectedPluginsInstances.push(e)},n.goToAddPluginDialog=function(){n.showPluginInstances=!1,n.showAddPlugin=!0},n.refreshPluginInstances=function(){n.$broadcast("searchPluginInstances",{})}}]),$app.controller("pluginInstanceSearchCtrl",["$scope","$rootScope","$analytics","commonPluginService","addPluginService",function(u,e,n,t,c){u.appHost="",window.siteConfig&&window.siteConfig.endPoints&&window.siteConfig.endPoints.appHost&&"sdk"==window.siteConfig.scope&&(u.appHost=window.siteConfig.endPoints.appHost),u.contextOptions={allowAddFeatureBtn:void 0===u.allowAddFeatureBtn||u.allowAddFeatureBtn,showCloneBtn:!0};var i={controller:"pluginInstanceDialog",appId:window.appContext.currentApp.appId,liveMode:window.appContext.currentApp.liveMode,pluginId:"pluginInstances",instanceId:1,writeKey:appContext.currentApp.keys.datastoreKey};u.tools=ImageLibAPI.tools,appContext.currentApp.config&&(u.marketplaceButton=appContext.currentApp.config.marketplaceButton),u.data={},u.tools=ImageLibAPI.tools;var a,r=new DatastoreAPI(appContext.currentApp.appId,"pluginInstances",1,0,appContext.currentApp.keys.datastoreKey);new PluginInstanceAPI(i);function o(){var t;u.$parent&&u.$parent.selectedPluginsInstances&&0<u.$parent.selectedPluginsInstances.length&&(t=u.$parent.selectedPluginsInstances.map(function(e){return e.instanceId}),u.getPluginInstances({instanceIds:t},u.pageSize,1,function(e,n){n&&0<n.length&&u.pluginInstances.forEach(function(e,n){-1<t.indexOf(e.data.instanceId)&&(e.selected=!0,u.onSelectPlugin(e,!0),u.pluginInstances.splice(n,1),u.pluginInstances.unshift(e))})}))}u.getPluginInstances=function(e,n,t,a){var i=e.searchName,o=e.instanceIds;u.loading=!0;function s(e){r.search({obj:{filter:e,page:t-1,pageSize:n,withDynamicData:!0,recordCount:!0},tag:""},function(e,n){if(e)a&&a(e,null);else{for(var e=n.result||[],t=e.filter(function(n){return!u.pluginInstances.find(function(e){return e.data.instanceId===n.data.instanceId})}),i=0;i<t.length;i++)t[i]&&t[i].data&&t[i].data.instanceId&&null!=u.instances[t[i].data.instanceId]&&(t[i].selected=!0);u.totalItems=n.totalRecord,u.pluginInstances=u.pluginInstances.concat(t),0===e.length&&(u.notEmptyData=!1),u.notscrolly=!0,u.loading=!1,a&&a(null,e)}})}e={"$json.title":{$regex:null!=i?i:"",$options:"i"}};o&&0<o.length&&(e["$json.instanceId"]={$in:o});var l={$or:[e]};if(!i)return s(l);var d,p=[];d={pluginTypeName:i,appId:appContext.currentApp.appId,whitelabelId:window.whitelabelContext.whitelabelId,reload:!c.miniSearchLoaded,fuzzy:.2,fields:["pluginTypeName"]},new Promise(function(t,i){c.searchAppPluginTypes(d,function(e,n){return e?i(e):void t(n)})}).then(function(e){e.plugins.forEach(function(e){p.push({"$json.pluginTypeId":e.pluginTypeId})}),p&&0<p.length&&l.$or.push({$or:p}),s(l)})},u.save=function(){var e,n=[];for(e in u.instances)u.instances.hasOwnProperty(e)&&n.push(u.instances[e]);u.close(n)},u.search=function(){u.loading=!0,u.pluginInstances=[],clearTimeout(a),a=setTimeout(function(){u.notEmptyData=!0,u.notscrolly=!1,u.pageIndex=1,u.setPage()},500)},u.clone=function(e){t.clone({allowSingletonRedirection:!1},e,function(e){u.search()})},u.onSelectPlugin=function(e,n){var t=e.pluginInstance||e;void 0===t.selected||n?t.selected=!0:t.selected=!t.selected;var i,a,o,s=t.data.instanceId,l=t.data.iconUrl;t.data._buildfire&&t.data._buildfire.pluginType?(i=t.data._buildfire.pluginType.result[0].token,a=t.data._buildfire.pluginType.result[0].folderName,o=t.data._buildfire.pluginType.result[0].name):t.data.pluginType&&(i=t.data.pluginType.token,a=t.data.pluginType.folderName,o=t.data.pluginType.name);e=t.data.title,n=t.data.iconClassName;t.selected?u.instances[(n={instanceId:s,iconUrl:l,title:e,pluginTypeId:i,pluginTypeName:o,folderName:a,iconClassName:n}).instanceId]=n:delete u.instances[s]},u.clearSearch=function(){u.level.pluginTitle="";var e=document.getElementById("searchPluginsInput");e&&e.focus(),u.search()},u.setPage=function(e){u.getPluginInstances({searchName:u.level.pluginTitle},u.pageSize,u.pageIndex,e)},u.onScroll=function(){u.notscrolly&&u.notEmptyData&&(u.notscrolly=!1,u.pageIndex++,u.setPage())},u.init=function(){u.instances={},u.level={},u.pageIndex=1,u.pageSize=40,u.maxSize=20,u.loading=!1,u.notEmptyData=!0,u.notscrolly=!1,u.level.pluginTitle="",u.pluginInstances=[],u.setPage(function(){o()})},u.init(),e.$on("plugin-instance-created",function(e,n){u.setPage(function(){o()})})}]),$app.controller("addPluginInstanceCtrl",["$scope","$rootScope","$http","$analytics","commonPluginService",function(s,n,l,d,p){s.pluginHost=window.siteConfig.endPoints.pluginHost,s.tools=ImageLibAPI.tools;function e(e,n,t){var i=window.siteConfig.endPoints.appHost+"/api/appPluginTypes/search",a=localStorage.getItem("user");a?(a=JSON.parse(a),l.get(i,{headers:{auth:a.auth,userToken:a.userToken},params:{appId:window.appContext.currentApp.appId,pluginTypeName:e,pageSize:n,pageIndex:t}}).success(function(e){s.plugins=e.data,s.totalItems=e.total})):(s.plugins=[],s.totalItems=0)}var u=new DatastoreAPI(appContext.currentApp.appId,"pluginInstances",1,0,appContext.currentApp.keys.datastoreKey),i=new DatastoreAPI(appContext.currentApp.appId,"sideMenu",1,0,appContext.currentApp.keys.datastoreKey);s.openAddPageDialog=function(o){var t,i,a,e;o&&(t=function(n){"addPage"==n.operation&&null!=n.title&&l.get("/api/appPluginTypes/validateToAdd",{params:{appId:window.appContext.currentApp.appId,token:o.token}}).success(function(e){e&&e.isActive?i(n):toast("Invalid to add, the plugin is inactive","danger")})},i=function(e){var n,t,i,a;"addPage"==e.operation&&null!=e.title&&(n=e.title,t=e.addToSideMenu,window.appContext.currentApp.appId,o.token,e.title,o.folderName,i=o.token+"-"+Date.now(),a={tag:"",obj:{pluginTypeId:o.pluginTypeId,token:o.token,title:n,instanceId:i,refId:i,iconUrl:window.siteConfig.endPoints.pluginHost+"/"+o.folderName+"/resources/icon.png",_buildfire:{pluginType:{dataType:"pluginType",data:o.token}}}},u.insert(a,function(e,n){e?console.log(e):(d.eventTrack("cp/pluginInstanceAdded",{pluginTypeId:o.pluginTypeId,pluginTypeName:o.pluginTypeName,marketItemId:o.marketItemId}),e={instanceId:i,iconUrl:window.siteConfig.endPoints.pluginHost+"/"+o.folderName+"/resources/icon.png",title:a.obj.title,pluginTypeId:o.token,pluginTypeName:o.pluginTypeName,folderName:o.folderName,iconClassName:null},t&&(s.hideAddToSideMenuCheckbox||s.addToSideMenu(e)),s.close([e]))}))},a={templateUrl:"addPage.html",controller:"addPageDialogCtrl",size:"sm",data:{options:{hideAddToSideMenuCheckbox:s.hideAddToSideMenuCheckbox}}},e={domain:window.siteConfig.endPoints.datastoreHost,appId:appContext.currentApp.appId,folderName:o.folderName,pluginTypeId:o.pluginTypeId,lastUpdatedOn:o.lastUpdatedOn,token:o.token},p.instanceExists(e,function(e,n){e?console.error(e):n.isInUse?(n={token:(n=n.matches[0].data).token,pluginInstanceId:n.instanceId,pluginTitle:n.title,folderName:n._buildfire.pluginType.result[0].folderName},s.close(),toast("Singleton. Redirecting to instance.","warning"),p.redirectToInstance(n)):window.openDialog(a,t)}))},s.setPage=function(){e(s.pluginTypeName,s.pageSize,s.pageIndex)},s.addToSideMenu=function(e){s.sideMenu.result.push({id:e.instanceId,data:e}),s.sideMenu.data.push(e.instanceId),t(s.sideMenu)};var t=function(e){var n,t;null!=e&&(t=(n={_buildfire:{sideMenu:e}})._buildfire.sideMenu.result,n._buildfire.sideMenu.result&&delete n._buildfire.sideMenu.result,i.save({tag:"",obj:n},function(e,n){e||!n?alert(JSON.stringify(e)):(emulatorSync.triggerSideMenuOnUpdate(n),console.log("data saved"))}),e.result=t)};function a(){s.sideMenu={dataType:"pluginInstance",data:[]},i.get({withDynamicData:!0},function(e,n){var t,i,a;n&&(n.data&&n.data._buildfire&&n.data._buildfire.sideMenu&&((t=n.data._buildfire.sideMenu).content&&t.content.loadAllPlugins||(t.result=(i=t.result,a=t.data,i.sort(function(e,n){e=a.indexOf(e.data.instanceId),n=a.indexOf(n.data.instanceId);return n<e?1:e<n?-1:0}),i)),s.sideMenu=t),s.id=n.id,s.$$phase||s.$digest())})}s.init=function(){s.totalItems=100,s.pageIndex=1,s.pageSize=10,s.maxSize=5,e(s.pluginTypeName,s.pageSize,s.pageIndex),a()},s.onCreateNewPlugin=function(e){e&&e.obj&&e.obj.instanceId?s.$parent&&s.$parent.goToPluginInstances&&(s.$parent.goToPluginInstances({selectedPluginInstance:{title:e.obj.title,instanceId:e.obj.instanceId}}),n.$broadcast("plugin-instance-created",{})):(window.openDialog({templateUrl:"addPage.html",controller:"addPageDialogCtrl",size:"sm"}),s.$$phase||s.$digest())},n.$on("onCreateNewPlugin",function(e,n){s.onCreateNewPlugin(n)}),s.onCreateSingletonPlugin=function(){window.PopupLibAPI.alert({title:"Singleton Feature",message:"Singleton feature already exist!"},function(e,n){})},s.init()}]),$app.controller("addPageDialogCtrl",["$scope","$dialog",function(e,n){e.addPage=function(){n.close({operation:"addPage",title:e.title})},e.closeDialog=function(){n.close({operation:"close",title:""})}}]);
"use strict";$app.factory("promoService",["$http",function(o){var e={},n=window.siteConfig.menuShortcutsPlugins;return e.getPluginTypeByProperty=function(e,t){return t=t.toLowerCase(),0<(n=n.filter(function(n){return n[e]==t})).length?n[0]:null},e.getPluginTypeInfoByName=function(n){return e.getPluginTypeByProperty("name",n)},e.getPluginTypeInfoById=function(n){return e.getPluginTypeByProperty("pluginTypeId",n)},e.getPluginTypeInfoByToken=function(n){return e.getPluginTypeByProperty("token",n)},e.getPluginInstances=function(n,e){var t=n.domain+"/plugin/search/"+n.appId+"/pluginInstances/1/primary/0/",r={page:0,pageSize:0,withDynamicData:!0,recordCount:!1};n.token&&(r.filter={"$json.token":n.token}),o.post(t,r).success(function(n){e(null,n)}).error(function(n){e(n)})},e.getLocalPromoUrl=function(n){return"/pages/pluginPromo/templates/"+n+".html"},e.upgrade=function(n){n="//"+n.selfProvDomain+"/upgrade.html#/app/"+n.appId+"/"+n.username;window.location.href=n},e}]);
"use strict";$app.controller("addPageCtrl",["$scope","$dialog","$data",function(e,t,i){i&&i.options&&(i.options.hideAddToSideMenuCheckbox&&(e.hideAddToSideMenuCheckbox=i.options.hideAddToSideMenuCheckbox,e.addToSideMenu=!0),e.pluginTypeName=i.options.pluginTypeName||""),e.addPage=function(){e.title?(e.title=e.title.trim(),"."!==e.title&&".."!==e.title?-1==e.title.indexOf("/")?(e.adding=!0,i.addingHandler?i.addingHandler({operation:"addPage",title:e.title,addToSideMenu:e.addToSideMenu,$dialog:t}):t.close({operation:"addPage",title:e.title,addToSideMenu:e.addToSideMenu})):e.errorMessage='A plugin title may not contain character "/"':e.errorMessage='You can’t use the symbol "." to name this feature'):e.errorMessage="Please enter a title"},e.closeDialog=function(){t.close({operation:"close",title:""})}}]);
"use strict";function _typeof(i){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(i){return typeof i}:function(i){return i&&"function"==typeof Symbol&&i.constructor===Symbol&&i!==Symbol.prototype?"symbol":typeof i})(i)}"undefined"==typeof AiAPI&&(window.AiAPI=function(i){this.context=i,this._loadingContainer=null}),AiAPI.prototype.showGenerateTextDialog=function(i,n){window.openDialog({templateUrl:"pages/share/aiTextGenerator/aiTextGenerator.html",controller:"aiTextGeneratorCtrl",size:"md",data:i},function(i){n&&n(null,i)})},AiAPI.startLoadingAnimation=function(i){var n=this,t=(i=!i||"object"!=_typeof(i)?{}:i).lockCP;this.lockCP=t,this._loadingContainer||((i=document.createElement("div")).id="aiLoadingAnimationContainer",document.body.appendChild(i),i.innerHTML='<div class="loading-holder d-flex justify-center text-center flex flex-align-center flex-justify-center h-100">\n            <div class="ai-animation">\n                <div class="blob"></div>\n                <div class="blob1"></div>\n                <div class="blob2"></div>\n                <div class="blob3">\n                </div>  \n            </div>\n        </div>',this._loadingContainer=i,document.addEventListener("click",function(i){n.lockCP||n._loadingContainer.contains(i.target)||AiAPI.stopLoadingAnimation()})),t?(this._loadingContainer.classList.remove("z-index-0"),this._loadingContainer.classList.add("ai-container-overlay")):(this._loadingContainer.classList.remove("ai-container-overlay"),this._loadingContainer.classList.add("z-index-0")),this._loadingContainer.classList.remove("stop"),document.body.classList.add("fixed-position")},AiAPI.stopLoadingAnimation=function(){this._loadingContainer&&(this._loadingContainer.classList.add("stop"),document.body.classList.remove("fixed-position"))};
"use strict";"undefined"==typeof loggerAPI&&(window.loggerAPI={}),window.loggerAPI.log=function(){var n=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};window.loggingTracker&&(n.tags&&n.tags.length&&window.appContext&&window.appContext.environment&&n.tags.push(window.appContext.environment),window.loggingTracker.log(n))};
"use strict";function ownKeys(n,e){var t,r=Object.keys(n);return Object.getOwnPropertySymbols&&(t=Object.getOwnPropertySymbols(n),e&&(t=t.filter(function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})),r.push.apply(r,t)),r}function _objectSpread(n){for(var e=1;e<arguments.length;e++){var t=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(Object(t),!0).forEach(function(e){_defineProperty(n,e,t[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(t)):ownKeys(Object(t)).forEach(function(e){Object.defineProperty(n,e,Object.getOwnPropertyDescriptor(t,e))})}return n}function _defineProperty(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function _createForOfIteratorHelper(e,n){var t="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!t){if(Array.isArray(e)||(t=_unsupportedIterableToArray(e))||n&&e&&"number"==typeof e.length){t&&(e=t);var r=0,n=function(){};return{s:n,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,a=!0,i=!1;return{s:function(){t=t.call(e)},n:function(){var e=t.next();return a=e.done,e},e:function(e){i=!0,o=e},f:function(){try{a||null==t.return||t.return()}finally{if(i)throw o}}}}function _unsupportedIterableToArray(e,n){if(e){if("string"==typeof e)return _arrayLikeToArray(e,n);var t=Object.prototype.toString.call(e).slice(8,-1);return"Map"===(t="Object"===t&&e.constructor?e.constructor.name:t)||"Set"===t?Array.from(e):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?_arrayLikeToArray(e,n):void 0}}function _arrayLikeToArray(e,n){(null==n||n>e.length)&&(n=e.length);for(var t=0,r=new Array(n);t<n;t++)r[t]=e[t];return r}$app.controller("aiTextGeneratorCtrl",["$scope","$data","$dialog","$http","$window","$sce",function(p,e,n,s,t,r){var o=AnalyticsAPI&&new AnalyticsAPI("ai_analytics",null);p.close=function(){p.$dialog.close(null)},p.outputTypeOptions=[{name:"Article"},{name:"List"},{name:"Product Description"},{name:"Questions & Answers"},{name:"Video Description"},{name:"Song Description"},{name:"Event Promotion"},{name:"Profile Bio"},{name:"Customer Testimonial"},{name:"Job Description"}],p.perspectiveOptions=[{name:"First Person Singular"},{name:"First Person Plural"},{name:"Second Person"},{name:"Third Person"}],p.toneOptions=[{name:"Professional"},{name:"Casual"},{name:"Exciting"},{name:"Funny"},{name:"Dramatic"},{name:"Inspirational"},{name:"Engaging"}],p.styleOptions=[{name:"Doctor"},{name:"Journalist"},{name:"Comedian"},{name:"Chef"},{name:"Teenager"},{name:"Mark Twain"},{name:"Steve Jobs"},{name:"Barack Obama"},{name:"Donald Trump"}],p.wordsOptions=[{name:"Up to 50",value:"50",reference:["List","Product Description","Video Description","Song Description","Customer Testimonial"]},{name:"Up to 100",value:"100",reference:["Event Promotion","Profile Bio","Job Description","Questions & Answers"]},{name:"Up to 150",value:"150"},{name:"Up to 200",value:"200",reference:["Article"]},{name:"Up to 250",value:"250"},{name:"Up to 300",value:"300"}],p.onOutputTypeSelect=function(e){p.textOptions.outputType=e.name;var n,t=_createForOfIteratorHelper(p.wordsOptions);try{for(t.s();!(n=t.n()).done;){var r=n.value;if(r.reference&&r.reference.includes(e.name)){p.textOptions.words=_objectSpread({},r);break}}}catch(e){t.e(e)}finally{t.f()}};p.nextPage=function(){p.page<p.generatedContent.length-1&&(p.page+=1)},p.prePage=function(){0<p.page&&--p.page},p.copy=function(){var e=document.createElement("textarea");e.style.position="fixed",e.style.opacity="0",e.textContent=p.generatedContent[p.page];var n=document.getElementsByTagName("body")[0];n.appendChild(e),e.select(),document.execCommand("copy"),n.removeChild(e),p.isTextCopied=!0,p.$$phase||p.$digest()},p.trustAsHtml=function(e){return r.trustAsHtml(e)},angular.element(t).bind("mousedown",function(){p.colorPickers={},p.$apply(),p.isTextCopied=!1}),p.trackAction=function(e,n){n=n||{};var t=window.bfHelper.Cookies.get("verticalData"),r=window.authAPI.getCurrentUser();r&&(n.user={userId:r.userToken,userEmail:r.email,username:r.username,displayName:r.displayName}),n.app={appId:window.appContext.currentApp.appId,name:window.appContext.currentApp.name,clonedFromAppId:window.appContext.currentApp.clonedFromAppId,config:{id:window.appContext.currentApp.configId,type:window.appContext.currentApp.config.type},marketIndustry:t&&t.industry||null},o&&o.trackAction(e,n)},p.generateText=function(e){var n,t,r,o,a,i;e.$invalid||(p.error=!1,p.generating=!0,AiAPI.startLoadingAnimation({lockCP:!0}),i="",window.siteConfig&&window.siteConfig.endPoints&&window.siteConfig.endPoints.appHost&&"sdk"==window.siteConfig.scope&&(i=window.siteConfig.endPoints.appHost),s.post(i+"/api/app/"+window.userContext.currentApp.appId+"/ai/generateText",{prompt:(n=p.textOptions,t=n.outputType,r=n.style,o=n.perspective,a=n.tone,e=n.words,i=n.contentSummary,n="Create",n+=" a ".concat((e||p.wordsOptions[0]).value," words"),t&&(n+=" ".concat(t)),n+=" on ".concat(i),r&&(n+=" in style of ".concat(r)),a&&(n+=" using ".concat(a," tone")),o&&(n+=" and ".concat(o," perspective")),n)}).success(function(e){p.generating=!1,AiAPI.stopLoadingAnimation(),0<p.generatedContent.length&&(p.page=p.generatedContent.length),p.generatedContent.push(e.content),p.trackAction("cp/ai/generate-text")}).error(function(e){console.error(e),p.generating=!1,AiAPI.stopLoadingAnimation(),p.error=!0}))},p.save=function(){p.trackAction("cp/ai/save-generated-text"),p.$dialog.close({content:p.generatedContent[p.page]})};p.$dialog=n,p.textOptions={outputType:p.outputTypeOptions[0].name,perspective:p.perspectiveOptions[0].name,words:p.wordsOptions[3],tone:p.toneOptions[0].name},p.generating=!1,p.generatedContent=[],p.page=0,p.isTextCopied=!1,p.error=!1}]);
"use strict";function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _iterableToArray(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _createForOfIteratorHelper(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=_unsupportedIterableToArray(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var a=0,t=function(){};return{s:t,n:function(){return a>=e.length?{done:!0}:{done:!1,value:e[a++]}},e:function(e){throw e},f:t}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,o=!0,r=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return o=e.done,e},e:function(e){r=!0,i=e},f:function(){try{o||null==n.return||n.return()}finally{if(r)throw i}}}}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Map"===(n="Object"===n&&e.constructor?e.constructor.name:n)||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,a=new Array(t);n<t;n++)a[n]=e[n];return a}function asyncGeneratorStep(e,t,n,a,i,o,r){try{var c=e[o](r),s=c.value}catch(e){return void n(e)}c.done?t(s):Promise.resolve(s).then(a,i)}function _asyncToGenerator(c){return function(){var e=this,r=arguments;return new Promise(function(t,n){var a=c.apply(e,r);function i(e){asyncGeneratorStep(a,t,n,i,o,"next",e)}function o(e){asyncGeneratorStep(a,t,n,i,o,"throw",e)}i(void 0)})}}"undefined"==typeof ActionItemsAPI&&(window.ActionItemsAPI=function(e){this.templateUrl="pages/share/actionBuilder.html",this.controller="actionItemsCtrl",this.context=e,this.init()}),ActionItemsAPI.prototype.init=function(){},ActionItemsAPI.prototype.executeOpenWebLink=function(e,t){ActionItemsAPI.prototype.openWebLink(e.url,e.openIn,t)},ActionItemsAPI.prototype.openWebLink=function(e,t,n){e&&window.open(e,t,"location=no")};var getActionItemAnalyticsData=function(e){return new Promise(function(n){new AnalyticsAPI(window.appContext.currentApp.appId,"action-items-analytics","action-items-analytics").searchRegisteredActionItems({filter:{"$json.key":{$eq:e}},skip:0,limit:1},function(e,t){return!e&&t&&t.length?void n(t[0].data):n({})})})};ActionItemsAPI.prototype.showDialog=function(){var n=_asyncToGenerator(regeneratorRuntime.mark(function e(t,n){var a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t&&t.actionItem&&t.actionItem.analyticsTracking&&t.actionItem.analyticsTracking.enabled)return e.next=3,getActionItemAnalyticsData(t.actionItem.analyticsTracking.key);e.next=5;break;case 3:(a=e.sent)&&a.title&&(t.actionItem.analyticsTracking.name=a.title);case 5:a={templateUrl:this.templateUrl,controller:this.controller,size:"lg",data:t},window.openDialog(a,function(e){n&&n(null,e)});case 7:case"end":return e.stop()}},e,this)}));return function(e,t){return n.apply(this,arguments)}}(),$app.controller("actionItemsCtrl",["$scope","$data","$dialog","$timeout","searchService",function(l,e,t,n,a){l.appConfig=window.appContext.currentApp.config,l.$dialog=t,l.showTitle=!1,l.tools=ImageLibAPI.tools,l.selectedItemAction=null,l.showCommunicationServices=!1,l.showSocialMedia=!1,l.hasRequiredFeatures=!0,l.hasRequiredFeaturesError=null,l.checkRequiredFeaturesLoading=!0,l.appHost="",window.siteConfig&&window.siteConfig.endPoints&&window.siteConfig.endPoints.appHost&&"sdk"==window.siteConfig.scope&&(l.appHost=window.siteConfig.endPoints.appHost),l.originalActionItem={},l.init=function(){l.errors={},l.actionItem={},l.options={},l.actionItemAlreadyHasIcon=!1,e&&!e.options&&(e.options={}),e&&e.options&&(l.options=e.options,l.options.showTitle?(l.displayTitle="Display Title",l.showTitle=l.options.showTitle):l.displayTitle="Action Button Text",void 0!==e.options.allowNoAction?l.options.allowNoAction=e.options.allowNoAction:l.options.allowNoAction=!0,void 0!==e.options.removePurchase?l.options.removePurchase=e.options.removePurchase:l.options.removePurchase=!1),"enabled"!=l.appConfig.inAppPurchases&&(l.options.removePurchase=!0),l.actionItemsList=[{title:"App Sections",icon:l.appHost+"/images/ai_app_content.svg",type:"parent",show:!0,enabled:!0,children:[{title:"App Content",actionName:"linkToApp",show:!0,enabled:!0,image:l.appHost+"/images/ai_app_content.svg",description:"This action will link the user to App Content."},{title:"App Settings",actionName:"navigateToAppSettings",show:!0,enabled:!0,image:l.appHost+"/images/ai_settings.svg",description:"This action will link the user  to the  App Settings screen."},{title:"Bookmarks",actionName:"navigateToBookmarks",show:!0,enabled:!0,image:l.appHost+"/images/ai_bookmarks.svg",description:"This action will link the user to the Bookmarks screen."},{title:"Notifications",actionName:"navigateToNotifications",show:!0,enabled:!0,image:l.appHost+"/images/ai_notifications.svg",description:"This action will link the user to the Notifications screen."},{title:"Notes",actionName:"navigateToNotes",show:!0,enabled:!0,image:l.appHost+"/images/ai_notes.svg",description:"This action will link the user to the Notes screen."},{title:"Search",actionName:"navigateToSearch",show:!0,enabled:"enterprise"==l.appConfig.type,image:l.appHost+"/images/ai_search.svg",description:"This action will link the user to the Search screen."},{title:"Login",actionName:"navigateToLogin",show:!0,enabled:!0,image:l.appHost+"/images/ai_login.svg",description:"This action will link the user to the Login screen."}]},{title:"Push Notification",actionName:"sendPushNotification",icon:l.appHost+"/images/ai_notifications.svg",image:l.appHost+"/images/ai_notifications.svg",type:"item",show:!0,enabled:!l.options||!l.options.removePushNotifications,description:"This action will send a push notification"},{title:"Contact",icon:l.appHost+"/images/ai_communication.svg",type:"parent",show:!0,enabled:!0,children:[{title:"Send an Email",actionName:"sendEmail",show:!0,enabled:!0,image:l.appHost+"/images/ai_email.svg",description:"This action will link the user to send an Email."},{title:"Send SMS Text Message",actionName:"sendSms",show:!0,enabled:!0,image:l.appHost+"/images/ai_sms.svg",description:"This action will link the user to send an SMS text message."},{title:"Call Phone Number",actionName:"callNumber",show:!0,enabled:!0,image:l.appHost+"/images/ai_phone.svg",description:"This action will link the user to call a phone number."},"sdk"==window.siteConfig.scope?void 0:{title:"Chat With Someone",actionName:"chat",show:!0,enabled:!0,image:l.appHost+"/images/ai_sms.svg",description:"Start a private chat with the current user and the selected people."}]},{title:"Map",actionName:"navigateToAddress",icon:l.appHost+"/images/ai_map.svg",image:l.appHost+"/images/ai_map.svg",type:"item",show:!0,enabled:!0,description:"This action will link the user to a location in a map."},{title:"Purchase",actionName:"purchase",icon:l.appHost+"/images/ai_purchase.svg",image:l.appHost+"/images/ai_purchase.svg",type:"item",show:!l.options.removePurchase,enabled:!0,description:"This action will link the user to in app purchases."},{title:"Social Media",icon:l.appHost+"/images/ai_social_media.svg",type:"parent",show:!0,enabled:!0,children:[{title:"Facebook Page",actionName:"linkToSocialFacebook",show:!0,enabled:!0,image:l.appHost+"/images/ai_facebook.png",description:"This action will link the user to a Facebook page."},{title:"X Page",actionName:"linkToSocialTwitter",show:!0,enabled:!0,image:l.appHost+"/images/ai_twitter.png",description:"This action will link the user to a Twitter page."},{title:"Instagram Page",actionName:"linkToSocialInstagram",show:!0,enabled:!0,image:l.appHost+"/images/ai_instagram.png",description:"This action will link the user to a Instagram page."},{title:"LinkedIn Page",actionName:"linkToSocialLinkedIn",show:!0,enabled:!0,image:l.appHost+"/images/ai_linkedin.png",description:"This action will link the user to a LinkedIn page."}]},{title:"Web Content",actionName:"linkToWeb",icon:l.appHost+"/images/ai_web_content.svg",image:l.appHost+"/images/ai_web_content.svg",type:"item",show:!0,enabled:!0,description:"This action will link the user to web content."},{title:"No Action",actionName:"noAction",icon:l.appHost+"/images/ai_no_action.svg",image:l.appHost+"/images/ai_no_action.svg",type:"item",show:!0,enabled:l.options.allowNoAction,hasDivider:!0,description:"This action will link the user to no action."}],"sdk"==window.siteConfig.scope&&l.actionItemsList.forEach(function(e,t){"sendPushNotification"==e.actionName&&l.actionItemsList.splice(t,1)}),e&&e.actionItem&&e.actionItem.action?(l.actionItem=e.actionItem,Object.assign(l.originalActionItem,e.actionItem),(e.actionItem.iconUrl||e.actionItem.iconClassName)&&(l.actionItemAlreadyHasIcon=!0),i(l.actionItem.action)):i("linkToApp"),o()};var i=function(e){var t,n=null,a=_createForOfIteratorHelper(l.actionItemsList);try{for(a.s();!(t=a.n()).done;){var i=t.value;if("parent"!==i.type&&i.actionName===e)return n=i,void l.changeAction(n);if("parent"===i.type&&i.children){var o,r=_createForOfIteratorHelper(i.children);try{for(r.s();!(o=r.n()).done;){var c=o.value;if(c&&c.actionName===e)return n=c,i.isToggled=!0,void l.changeAction(n)}}catch(e){r.e(e)}finally{r.f()}}}}catch(e){a.e(e)}finally{a.f()}};l.validateActionItemTrackingData=function(){var e=!0,t={analyticsTrackingNameError:"",analyticsTrackingIdError:""};return l.actionItem.analyticsTracking.name&&""!=l.actionItem.analyticsTracking.name||(e=!1,t.analyticsTrackingNameError="Required"),l.actionItem.analyticsTracking.key&&""!=l.actionItem.analyticsTracking.key?(l.actionItem.analyticsTracking.key=l.actionItem.analyticsTracking.key.trim(),bfHelper.isKebabCase(l.actionItem.analyticsTracking.key)||(e=!1,t.analyticsTrackingIdError="Must be 3-30 characters, using only lowercase letters, numbers, and dashes (e.g., button-click).")):(e=!1,t.analyticsTrackingIdError="Required"),n(function(){l.$digest()}),{valid:e,errors:t}},l.onChangeAction=function(e,t){var n,a,i,o,r,c=_createForOfIteratorHelper(l.actionItemsList);try{for(c.s();!(n=c.n()).done;){var s=n.value;t?"parent"===s.type&&s.children&&s.title!==t.title&&(s.isToggled=!1):"parent"===s.type&&s.children&&s.title!==e.title&&(s.isToggled=!1)}}catch(e){c.e(e)}finally{c.f()}"parent"!==e.type?(l.originalActionItem&&0<Object.keys(l.originalActionItem).length&&e.actionName===l.originalActionItem.action?Object.assign(l.actionItem,l.originalActionItem):(a=l.actionItem.title,i=l.actionItem.iconUrl,o=l.actionItem.iconClassName,r=l.actionItem.analyticsTracking,l.actionItem={},l.actionItem.title=a,l.actionItem.iconUrl=i,l.actionItem.iconClassName=o,l.actionItem.analyticsTracking=r),"purchase"===e.actionName?l.actionItem.title="Buy Now!":l.originalActionItem&&0<Object.keys(l.originalActionItem).length&&l.originalActionItem.title&&(l.actionItem.title=l.originalActionItem.title),document.querySelector(".action-builder-scrollable").scrollTop=0,l.changeAction(e)):e.isToggled=!e.isToggled},l.changeAction=function(e){switch(l.currentActionItem=e,l.actionItem.action=e.actionName,l.errors={},l.showLinkToAppContent=!1,l.showLinkToWeb=!1,l.showLinkToSocialMedia=!1,l.showSendEmail=!1,l.showSendSms=!1,l.showNavigateToAddress=!1,l.showNoAction=!1,l.showCallNumber=!1,l.showChat=!1,l.showPurchase=!1,l.showSearchInApp=!1,l.showPushNotification=!1,e.actionName){case"purchase":l.showPurchase=!0;break;case"linkToApp":l.showLinkToAppContent=!0;break;case"linkToWeb":l.showLinkToWeb=!0;break;case"sendEmail":l.showSendEmail=!0;break;case"callNumber":l.showCallNumber=!0;break;case"sendSms":l.showSendSms=!0;break;case"chat":l.showChat=!0;break;case"navigateToAddress":l.showNavigateToAddress=!0;break;case"navigateToSearch":l.showSearchInApp=!0;break;case"linkToSocialFacebook":case"linkToSocialInstagram":case"linkToSocialTwitter":case"linkToSocialLinkedIn":l.showLinkToSocialMedia=!0;break;case"noAction":case"navigateToLogin":case"navigateToAppSettings":case"navigateToNotifications":case"navigateToBookmarks":case"navigateToNotes":l.showNoAction=!0;break;case"sendPushNotification":l.showPushNotification=!0}"noAction"===e.actionName?l.actionType="No action":"navigateToLogin"===e.actionName?l.actionType="Login":"navigateToAppSettings"===e.actionName?l.actionType="App Settings":"navigateToNotifications"===e.actionName?l.actionType="Notifications":"navigateToBookmarks"===e.actionName?l.actionType="Bookmarks":"navigateToNotes"===e.actionName&&(l.actionType="Notes")},l.openImageLib=function(){l.options&&!l.options.imgLibOptions&&(l.options.imgLibOptions={showIcons:!1}),window.imageLibCurrentApp.showDialog({showIcons:l.options.imgLibOptions.showIcons||!1,showFiles:!0,multiSelection:!1},function(e,t){t&&t.selectedIcons&&0<t.selectedIcons.length&&(l.actionItem.iconClassName=t.selectedIcons[0],l.actionItem.iconUrl=null),t&&t.selectedFiles&&0<t.selectedFiles.length&&(l.actionItem.iconUrl=t.selectedFiles[0],l.actionItem.iconClassName=null)})},l.clearIconUrl=function(){l.actionItem.iconUrl=null,l.actionItem.iconClassName=null,l.actionItemAlreadyHasIcon=!1};var o=function(){function e(e){return new Promise(function(t){a.searchMyFeaturesByType(e,1,function(e){t(e)})})}Promise.all([e([{"$json.token":"b15c62f2-7a99-48dc-a37a-e42d46bd3289"}]),e([{"$json.token":"135d1549-efd2-4a70-a476-99ac45e1d1d4"}])]).then(function(e){var t=e[0]&&e[0][0]&&e[0][0].data&&"b15c62f2-7a99-48dc-a37a-e42d46bd3289"===e[0][0].data.token,e=e[0]&&e[1][0]&&e[1][0].data&&"135d1549-efd2-4a70-a476-99ac45e1d1d4"===e[1][0].data.token;l.hasRequiredFeatures=!0,t||(l.hasRequiredFeaturesError={community:!0},l.hasRequiredFeatures=!1),e||(l.hasRequiredFeaturesError?l.hasRequiredFeaturesError.inbox=!0:l.hasRequiredFeaturesError={inbox:!0},l.hasRequiredFeatures=!1),l.checkRequiredFeaturesLoading=!1})};l.validUrl=function(e){return!!new RegExp("^(http:/|https:/|http://|https://)[a-z0-9]").test(e)},l.resizeImage=function(e){return e?ImageLibAPI.tools.resizeImage(e,{width:92,height:88}):""},l.close=function(){l.$dialog.close(null)},l.goToMarketplace=function(e){window.location.hash="/addPlugin?token=".concat(e),t.close()},l.goToUseProfile=function(e){window.location.hash="/appUserManagement?email=".concat(encodeURIComponent(e.email)),t.close()},l.saveAction=function(n){n&&n.analyticsTracking&&n.analyticsTracking.enabled?new AnalyticsAPI(window.appContext.currentApp.appId,"action-items-analytics","action-items-analytics").registerActionItemEvent(n,function(e,t){e&&console.error("Error registering action item analytics event:",e),l.$dialog.close(n)}):l.$dialog.close(n)},l.init()}]),$app.controller("pluginSelectorCtrl",["$scope","$dialog",function(a,e){a.$dialog=e,a.tools=ImageLibAPI.tools,a.cancel=function(){a.$dialog.close(null)},a.save=function(){a.saveAction(a.selectedPluginInstance)};e={controller:"pluginInstanceDialog",appId:window.appContext.currentApp.appId,liveMode:window.appContext.currentApp.liveMode,pluginId:"pluginInstances",instanceId:1,writeKey:appContext.currentApp.keys.datastoreKey};a.selectPluginInstance=function(e){var t=e.pluginInstance;e.clearQueryString;a.selectedPluginInstance=t};var i=new PluginInstanceAPI(e);a.getPluginInstances=function(e,t,n){i.search({title:e,pageSize:t,pageIndex:n-1},function(e,t){e?a.pluginInstances=[]:(a.pluginInstances=t.result,a.totalItems=t.totalRecord)})},a.init=function(){a.totalItems=100,a.pageIndex=1,a.pageSize=10,a.maxSize=5,a.pluginTitle=null,a.getPluginInstances(a.pluginTitle,a.pageSize,a.pageIndex)},a.init()}]),$app.controller("linkToWebCtrl",["$scope","$analytics",function(n,e){void 0===n.actionItem.openIn&&(n.actionItem.openIn="_blank"),n.checkUrlFormat=function(){null!=n.actionItem.url&&""!=n.actionItem.url&&n.actionItem.url.indexOf("://")<0&&(n.actionItem.url="http://"+n.actionItem.url)},n.cancel=function(){n.$dialog.close(null)},n.save=function(){n.validate()&&(e.eventTrack("cp/linkToWebActionItemAdded"),n.actionItem.analyticsTracking&&n.actionItem.analyticsTracking.enabled&&(n.actionItem.analyticsTracking.actionType="Web Content"),n.saveAction(n.actionItem))},n.validate=function(){var e,t=!0;return n.errors.title="",n.errors.urlError="",n.errors.openInError="",n.errors.analyticsTrackingNameError="",n.errors.analyticsTrackingIdError="",!n.options||n.options.hideActionText||null!=n.actionItem.title&&""!=n.actionItem.title||(t=!1,n.errors.title="Required"),null!=n.actionItem.url&&""!=n.actionItem.url||(t=!1,n.errors.urlError="Required"),null!=n.actionItem.openIn&&""!=n.actionItem.openIn||(t=!1,n.errors.openInError="Required"),n.actionItem.analyticsTracking&&n.actionItem.analyticsTracking.enabled&&(t=(e=n.validateActionItemTrackingData()).valid&&t,n.errors.analyticsTrackingNameError=e.errors.analyticsTrackingNameError,n.errors.analyticsTrackingIdError=e.errors.analyticsTrackingIdError),t}}]),$app.controller("sendSmsCtrl",["$scope","$analytics",function(n,e){n.cancel=function(){n.$dialog.close(null)},n.save=function(){n.validate()&&(e.eventTrack("cp/sendSmsActionItemAdded"),n.actionItem.analyticsTracking&&n.actionItem.analyticsTracking.enabled&&(n.actionItem.analyticsTracking.actionType="Contact (Send SMS)"),n.saveAction(n.actionItem))},n.validate=function(){var e,t=!0;return n.errors.title="",n.errors.phoneNumberError="",n.errors.analyticsTrackingNameError="",n.errors.analyticsTrackingIdError="",!n.options||n.options.hideActionText||null!=n.actionItem.title&&""!=n.actionItem.title||(t=!1,n.errors.title="Required"),n.actionItem.phoneNumber||(t=!1,n.errors.phoneNumberError="Required"),n.actionItem.analyticsTracking&&n.actionItem.analyticsTracking.enabled&&(t=(e=n.validateActionItemTrackingData()).valid&&t,n.errors.analyticsTrackingNameError=e.errors.analyticsTrackingNameError,n.errors.analyticsTrackingIdError=e.errors.analyticsTrackingIdError),t}}]),$app.controller("sendEmailCtrl",["$scope","$analytics",function(n,e){n.cancel=function(){n.$dialog.close(null)},n.save=function(){n.validate()&&(e.eventTrack("cp/sendEmailActionItemAdded"),n.actionItem.analyticsTracking&&n.actionItem.analyticsTracking.enabled&&(n.actionItem.analyticsTracking.actionType="Contact (Send Email)"),n.saveAction(n.actionItem))},n.isValidEmail=function(e){return/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z\-0-9]{2,}))$/.test(e)},n.validate=function(){var e,t=!0;return n.errors.title="",n.errors.email="",n.errors.subject="",n.errors.body="",n.errors.analyticsTrackingNameError="",n.errors.analyticsTrackingIdError="",!n.options||n.options.hideActionText||null!=n.actionItem.title&&""!=n.actionItem.title||(t=!1,n.errors.title="Required"),null==n.actionItem.email||""==n.actionItem.email?(t=!1,n.errors.email="Required"):n.isValidEmail(n.actionItem.email)||(t=!1,n.errors.email="Invalid Email"),null!=n.actionItem.subject&&""!=n.actionItem.subject||(t=!1,n.errors.subject="Required"),null!=n.actionItem.body&&""!=n.actionItem.body||(t=!1,n.errors.body="Required"),n.actionItem.analyticsTracking&&n.actionItem.analyticsTracking.enabled&&(t=(e=n.validateActionItemTrackingData()).valid&&t,n.errors.analyticsTrackingNameError=e.errors.analyticsTrackingNameError,n.errors.analyticsTrackingIdError=e.errors.analyticsTrackingIdError),t}}]),$app.controller("linkToSocialMediaCtrl",["$scope","$analytics",function(n,e){n.cancel=function(){n.$dialog.close(null)},n.save=function(){n.validate()&&(e.eventTrack("cp/linkToSocialMediaActionItemAdded"),n.actionItem.analyticsTracking&&n.actionItem.analyticsTracking.enabled&&("linkToSocialFacebook"===n.actionItem.action?n.actionItem.analyticsTracking.actionType="Social Media (Facebook Page)":"linkToSocialInstagram"===n.actionItem.action?n.actionItem.analyticsTracking.actionType="Social Media (Instagram Page)":"linkToSocialTwitter"===n.actionItem.action?n.actionItem.analyticsTracking.actionType="Social Media (X Page)":"linkToSocialLinkedIn"===n.actionItem.action&&(n.actionItem.analyticsTracking.actionType="Social Media (LinkedIn Page)")),n.saveAction(n.actionItem))},n.validate=function(){var e,t=!0;return n.errors.title="",n.errors.urlError="",n.errors.analyticsTrackingNameError="",n.errors.analyticsTrackingIdError="",!n.options||n.options.hideActionText||null!=n.actionItem.title&&""!=n.actionItem.title||(t=!1,n.errors.title="Required"),null==n.actionItem.url||""==n.actionItem.url?(t=!1,n.errors.urlError="Required"):n.validUrl(n.actionItem.url)||(t=!1,n.errors.urlError="Invalid URL format. Example: http://www.google.com"),n.actionItem.analyticsTracking&&n.actionItem.analyticsTracking.enabled&&(t=(e=n.validateActionItemTrackingData()).valid&&t,n.errors.analyticsTrackingNameError=e.errors.analyticsTrackingNameError,n.errors.analyticsTrackingIdError=e.errors.analyticsTrackingIdError),t}}]),$app.controller("linkToAppContentCtrl",["$scope","addPluginService","$analytics",function(c,s,e){var n;c.contextOptions={title:"Select Feature"};var l=new DatastoreAPI(appContext.currentApp.appId,"pluginInstances",1,appContext.currentApp.liveMode,appContext.currentApp.keys.datastoreKey);c.getPluginInstances=function(e,t,n){function a(e){l.search({obj:{filter:e,page:n-1,pageSize:t,withDynamicData:!0,recordCount:!0},tag:""},function(e,t){e?console.error(e):(e=t.result||[],c.totalItems=t.totalRecord,c.pluginInstances=c.pluginInstances.concat(e),0===e.length&&(c.notEmptyData=!1),c.notscrolly=!0,c.loading=!1)})}c.loading=!0;var i={$or:[{"$json.title":{$regex:null!=e?e:"",$options:"i"}}]};if(!e)return a(i);var o,r=[];o={pluginTypeName:e,appId:appContext.currentApp.appId,whitelabelId:window.whitelabelContext.whitelabelId,reload:!s.miniSearchLoaded,fuzzy:.2,fields:["pluginTypeName"]},new Promise(function(n,a){s.searchAppPluginTypes(o,function(e,t){return e?a(e):void n(t)})}).then(function(e){e.plugins.forEach(function(e){r.push({"$json.pluginTypeId":e.pluginTypeId})}),r&&0<r.length&&i.$or.push({$or:r}),a(i)})},c.getSelectedPluginInformation=function(){var e={};e.obj={filter:{"$json.instanceId":c.actionItem.instanceId},pageSize:1},l.search(e,function(e,t){t&&t.length&&c.onSelectPlugin({pluginInstance:t[0],clearQueryString:!1})})},c.init=function(){c.level={},c.level.pluginTitle="",c.pluginInstances=[],c.deepLinkPlugin={},c.totalItems=100,c.pageIndex=1,c.pageSize=40,c.maxSize=5,c.action="Add",c.loading=!1,c.notEmptyData=!0,c.notscrolly=!1,c.keepInitialData=!0,c.actionItem.instanceId&&(c.getSelectedPluginInformation(),c.action="Edit",c.keepInitialData=!0),c.setPage()},c.setPage=function(){c.getPluginInstances(c.level.pluginTitle,c.pageSize,c.pageIndex)};function a(){c.deeplinks={data:[],selectedDeeplink:null,actionItemDeeplink:null,active:!1,isCustomQueryString:!1,customQueryString:"",queryString:"",options:{instanceId:null,deeplinkName:null,pageIndex:0,pageSize:5}},c.deeplinksDataEmpty=!1}a(),c.onSelectPlugin=function(e){var t=e.pluginInstance,e=e.clearQueryString;void 0!==c.options.showIcon&&0==c.options.showIcon&&c.options.hideActionText&&(c.hideDeeplinkLine=!0),n=t.data,c.errors.selectPlugin="",c.actionItem.instanceId=t.data.instanceId,c.selectedPluginInstance=t,c.keepInitialData&&"Add"!==c.action?c.keepInitialData=!1:(c.actionItem.title=t.data.title,c.actionItem.iconUrl=t.data.iconUrl,c.actionItem.iconClassName=t.data.iconClassName),e?(c.actionItem.queryString="",a()):c.actionItem&&c.actionItem.queryString&&0<c.actionItem.queryString.length&&(c.deeplinks.customQueryString=c.actionItem.queryString,c.deeplinks.active=!0,c.actionItem.deeplinkId||(c.deeplinks.isCustomQueryString=!0)),c.deeplinks.options.instanceId=t.data.instanceId,!e&&c.actionItem&&c.actionItem.deeplinkId&&c.getDeeplinkById(c.actionItem.deeplinkId),d()};var t,i,o=new DeeplinksAPI(window.appContext.currentApp.appId);c.searchDeeplinks=function(){c.deeplinksLoading=!0,c.deeplinksDataEmpty=!1,c.deeplinks.data=[],c.deeplinks.options.pageIndex=0,clearTimeout(t),t=setTimeout(function(){c.loadPluginDeeplinks()},500)},c.onDeeplinkChange=function(e){c.deeplinks.customQueryString="dld=".concat(encodeURIComponent(JSON.stringify(e.data.deeplinkData))),c.deeplinks.queryString="dld=".concat(encodeURIComponent(JSON.stringify(e.data.deeplinkData))),(c.deeplinks.selectedDeeplink=e).data.name&&(c.actionItem.title=e.data.name),e.data.imageUrl&&(c.actionItem.iconUrl=e.data.imageUrl)},c.getDeeplinkById=function(e){var t=c.deeplinks.options.instanceId;o.getDeeplinkById({instanceId:t,deeplinkId:e},function(e,t){return e?console.error(e):void(t&&t[0]&&c.onDeeplinkChange(t[0]))})},c.onIsCustomQueryStingChange=function(){c.deeplinks.isCustomQueryString&&(c.deeplinks.selectedDeeplink=null,c.actionItem.deeplinkId=null),c.errors.noQueryString=null};var r,d=function(){c.deeplinksLoading=!0,clearTimeout(i),i=setTimeout(function(){c.loadPluginDeeplinks()},500)};c.loadPluginDeeplinks=function(){c.deeplinks&&c.deeplinks.options&&c.deeplinks.options.instanceId?(c.deeplinksLoading=!0,o.searchDeeplinks(c.deeplinks.options,function(e,t){if(e)return c.deeplinksLoading=!1,console.error(e);t.length<5&&(c.deeplinksDataEmpty=!0);e=t.filter(function(e){return e.data&&e.data.deeplinkData});c.deeplinks.options.pageIndex++,(t=c.deeplinks.data).push.apply(t,_toConsumableArray(e)),c.deeplinksLoading=!1})):c.deeplinksLoading=!1},c.cancel=function(){c.$dialog.close(null)},c.save=function(){c.deeplinks.active?c.deeplinks.isCustomQueryString?(c.actionItem.queryString=c.deeplinks.customQueryString,c.actionItem.deeplinkId=null):c.deeplinks.selectedDeeplink&&c.deeplinks.selectedDeeplink.data&&c.deeplinks.selectedDeeplink.data._buildfire&&c.deeplinks.selectedDeeplink.data._buildfire.index&&c.deeplinks.selectedDeeplink.data._buildfire.index.array1[0]&&c.deeplinks.selectedDeeplink.data._buildfire.index.array1[0].string1?(c.actionItem.deeplinkId=c.deeplinks.selectedDeeplink.data._buildfire.index.array1[0].string1,c.actionItem.queryString=c.deeplinks.queryString):c.actionItem.queryString=null:(c.actionItem.queryString=null,c.actionItem.deeplinkId=null),c.validate()&&(c.actionItem.analyticsTracking&&c.actionItem.analyticsTracking.enabled&&(c.actionItem.analyticsTracking.actionType="App Content (".concat(n.title,")")),c.saveAction(c.actionItem),e.eventTrack("cp/linkToAppContentActionItemAdded"))},c.onScroll=function(){c.notscrolly&&c.notEmptyData&&(c.notscrolly=!1,c.pageIndex++,c.setPage())},c.search=function(){c.loading=!0,c.pluginInstances=[],clearTimeout(r),r=setTimeout(function(){c.notEmptyData=!0,c.notscrolly=!1,c.pageIndex=1,c.setPage()},500)},c.clearSearch=function(){c.level.pluginTitle="";var e=document.getElementById("searchPluginsInput");e&&e.focus(),c.search()},c.validate=function(){var e,t=!0;return c.errors.title="",c.errors.selectPlugin="",c.errors.analyticsTrackingNameError="",c.errors.analyticsTrackingIdError="",!c.options||c.options.hideActionText||null!=c.actionItem.title&&""!=c.actionItem.title||(t=!1,c.errors.title="Required"),null!=c.actionItem.instanceId&&""!=c.actionItem.instanceId||(t=!1,c.errors.selectPlugin="Please select a feature"),c.deeplinks.active&&(c.actionItem.queryString||(t=!1,c.errors.noQueryString="Required")),c.actionItem.analyticsTracking&&c.actionItem.analyticsTracking.enabled&&(t=(e=c.validateActionItemTrackingData()).valid&&t,c.errors.analyticsTrackingNameError=e.errors.analyticsTrackingNameError,c.errors.analyticsTrackingIdError=e.errors.analyticsTrackingIdError),t},c.init()}]),$app.controller("navigateToAddress",["$scope","$analytics",function(a,e){a.marker=null,a.$watch("addressDetails",function(){a.marker&&(a.marker.setMap(null),a.actionItem.lat=null,a.actionItem.lng=null),console.log(a.addressDetails),a.addressDetails&&(a.actionItem.lat=a.addressDetails.geometry.location.lat(),a.actionItem.lng=a.addressDetails.geometry.location.lng(),n())}),a.$on("mapInitialized",function(e,t){a.map=t,a.actionItem.lat&&a.actionItem.lng&&n()}),a.cancel=function(){a.$dialog.close(null)},a.save=function(){a.validate()&&(a.actionItem.analyticsTracking&&a.actionItem.analyticsTracking.enabled&&(a.actionItem.analyticsTracking.actionType="Map"),a.saveAction(a.actionItem),e.eventTrack("cp/navigateToAddressActionItemAdded"))},a.validate=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=!0,a.errors.title="",a.errors.address="",a.errors.analyticsTrackingNameError="",a.errors.analyticsTrackingIdError="",!a.options||a.options.hideActionText||null!=a.actionItem.title&&""!=a.actionItem.title||(t=!1,a.errors.title="Required"),null!=a.actionItem.lat&&null!=a.actionItem.lng||(t=!1,a.errors.address="Required"),a.actionItem.analyticsTracking&&a.actionItem.analyticsTracking.enabled&&(n=a.validateActionItemTrackingData(),t=n.valid&&t,a.errors.analyticsTrackingNameError=n.errors.analyticsTrackingNameError,a.errors.analyticsTrackingIdError=n.errors.analyticsTrackingIdError),e.abrupt("return",t);case 9:case"end":return e.stop()}},e)}));var n=function(){var e=new google.maps.LatLng(a.actionItem.lat,a.actionItem.lng);a.marker=new google.maps.Marker({position:e,map:a.map,draggable:!0,animation:google.maps.Animation.DROP}),a.map.setCenter(a.marker.getPosition()),a.map.setZoom(12),google.maps.event.addListener(a.marker,"dragend",function(e){a.actionItem.lat=e.latLng.lat(),a.actionItem.lng=e.latLng.lng(),function(e,t,n){t=new google.maps.LatLng(e,t);(new google.maps.Geocoder).geocode({latLng:t},function(e,t){t==google.maps.GeocoderStatus.OK?(e=e[0].formatted_address,n(e)):n(null)})}(a.actionItem.lat,a.actionItem.lng,function(e){a.actionItem.address=e||"",a.$apply()})})}}]),$app.controller("noActionCtrl",["$scope","$analytics",function(n,e){n.cancel=function(){n.$dialog.close(null)},n.save=function(){n.validate()&&(e.eventTrack("cp/noActionActionItemAdded"),n.actionItem.analyticsTracking&&n.actionItem.analyticsTracking.enabled&&(n.actionItem.analyticsTracking.actionType=n.actionType||"No Action"),n.saveAction(n.actionItem))},n.validate=function(){var e,t=!0;return!n.options||n.options.hideActionText||null!=n.actionItem.title&&""!=n.actionItem.title||(t=!1,n.errors.title="Required"),n.actionItem.analyticsTracking&&n.actionItem.analyticsTracking.enabled&&(t=(e=n.validateActionItemTrackingData()).valid&&t,n.errors.analyticsTrackingNameError=e.errors.analyticsTrackingNameError,n.errors.analyticsTrackingIdError=e.errors.analyticsTrackingIdError),t}}]),$app.controller("callNumberCtrl",["$scope","$analytics",function(n,e){n.cancel=function(){n.$dialog.close(null)},n.save=function(){n.validate()&&(n.actionItem.analyticsTracking&&n.actionItem.analyticsTracking.enabled&&(n.actionItem.analyticsTracking.actionType="Phone Call"),n.saveAction(n.actionItem),e.eventTrack("cp/callNumberActionItemAdded"))},n.validate=function(){var e,t=!0;return n.errors.title="",n.errors.phoneNumberError="",n.errors.analyticsTrackingNameError="",n.errors.analyticsTrackingIdError="",!n.options||n.options.hideActionText||null!=n.actionItem.title&&""!=n.actionItem.title||(t=!1,n.errors.title="Required"),null!=n.actionItem.phoneNumber&&""!=n.actionItem.phoneNumber||(t=!1,n.errors.phoneNumberError="Required"),n.actionItem.analyticsTracking&&n.actionItem.analyticsTracking.enabled&&(t=(e=n.validateActionItemTrackingData()).valid&&t,n.errors.analyticsTrackingNameError=e.errors.analyticsTrackingNameError,n.errors.analyticsTrackingIdError=e.errors.analyticsTrackingIdError),t}}]),$app.controller("chatCtrl",["$scope","searchService","$http","$analytics",function(i,e,n,t){i.tools=ImageLibAPI.tools;i.cancel=function(){i.$dialog.close(null)},i.save=function(){var n;i.actionItem.chatId||(i.actionItem.chatId=(n=(new Date).getTime(),"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=(n+16*Math.random())%16|0;return n=Math.floor(n/16),("x"==e?t:3&t|8).toString(16)}))),i.validate()&&(i.actionItem.analyticsTracking&&i.actionItem.analyticsTracking.enabled&&(i.actionItem.analyticsTracking.actionType="Chat"),i.saveAction(i.actionItem),t.eventTrack("cp/chatActionItemAdded"))},i.getIconImage=function(e){return i.tools.cropImage(e,{width:60,height:60})},i.addPersons=function(){i.errors.persons="";var e={templateUrl:"/pages/common/userSearch.html",controller:"userSearchDialogCtrl",size:"lg",position:"modal-pos",data:{appId:window.appContext.currentApp.appId,submitBtnText:"Add",responseType:"users"}};window.openDialog(e,function(e){if(e&&e.users){var t,n=_createForOfIteratorHelper(e.users);try{for(n.s();!(t=n.n()).done;){var a=t.value;!i.actionItem.userIds.includes(a._id)&&i.actionItem.userIds.length<i.maxLimit&&(i.actionItem.userIds.push(a._id),i.selectedUsers.push(a))}}catch(e){n.e(e)}finally{n.f()}}})},i.deleteUser=function(t){i.actionItem.userIds=i.actionItem.userIds.filter(function(e){return e!==t._id}),i.selectedUsers=i.selectedUsers.filter(function(e){return e._id!==t._id})};i.getUsername=function(e){return e?e.firstName?e.firstName+" "+e.lastName:e.displayName||e.email:""},i.validate=function(){var e,t=!0;return i.errors.title="",i.errors.persons="",i.errors.analyticsTrackingNameError="",i.errors.analyticsTrackingIdError="",!i.options||i.options.hideActionText||null!=i.actionItem.title&&""!=i.actionItem.title||(t=!1,i.errors.title="Required"),i.actionItem.userIds&&i.actionItem.userIds.length||(t=!1,i.errors.persons="Required"),i.actionItem.analyticsTracking&&i.actionItem.analyticsTracking.enabled&&(t=(e=i.validateActionItemTrackingData()).valid&&t,i.errors.analyticsTrackingNameError=e.errors.analyticsTrackingNameError,i.errors.analyticsTrackingIdError=e.errors.analyticsTrackingIdError),t};i.maxLimit=10,i.selectedUsers=[],i.actionItem.userIds=i.actionItem.userIds||[],i.actionItem.userIds&&i.actionItem.userIds.length&&function(e){i.searching=!0;var t="";window.siteConfig&&window.siteConfig.endPoints&&window.siteConfig.endPoints.appHost&&"sdk"==window.siteConfig.scope&&(t=window.siteConfig.endPoints.appHost),n.post(t+"/api/userTagging/userSearch/"+window.appContext.currentApp.appId+"/",{filter:{},userIds:e}).success(function(e){i.selectedUsers=e.users||[],i.searching=!1}).error(function(e){i.searching=!1,console.error(e)})}(i.actionItem.userIds)}]),$app.controller("searchInAppCtrl",["$scope","$analytics",function(e,t){e.cancel=function(){e.$dialog.close(null)},e.save=function(){e.validate()&&(e.actionItem.analyticsTracking&&e.actionItem.analyticsTracking.enabled&&(e.actionItem.analyticsTracking.actionType="Search"),t.eventTrack("cp/chatActionItemAdded"),e.saveAction(e.actionItem))},e.validate=function(){return!(e.errors.searchAppValueError="")}}]);
"use strict";function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_unsupportedIterableToArray(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _iterableToArrayLimit(e,t){var a=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=a){var r,n,o=[],s=!0,i=!1;try{for(a=a.call(e);!(s=(r=a.next()).done)&&(o.push(r.value),!t||o.length!==t);s=!0);}catch(e){i=!0,n=e}finally{try{s||null==a.return||a.return()}finally{if(i)throw n}}return o}}function _arrayWithHoles(e){if(Array.isArray(e))return e}function asyncGeneratorStep(e,t,a,r,n,o,s){try{var i=e[o](s),l=i.value}catch(e){return void a(e)}i.done?t(l):Promise.resolve(l).then(r,n)}function _asyncToGenerator(i){return function(){var e=this,s=arguments;return new Promise(function(t,a){var r=i.apply(e,s);function n(e){asyncGeneratorStep(r,t,a,n,o,"next",e)}function o(e){asyncGeneratorStep(r,t,a,n,o,"throw",e)}n(void 0)})}}function _createForOfIteratorHelper(e,t){var a="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!a){if(Array.isArray(e)||(a=_unsupportedIterableToArray(e))||t&&e&&"number"==typeof e.length){a&&(e=a);var r=0,t=function(){};return{s:t,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:t}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var n,o=!0,s=!1;return{s:function(){a=a.call(e)},n:function(){var e=a.next();return o=e.done,e},e:function(e){s=!0,n=e},f:function(){try{o||null==a.return||a.return()}finally{if(s)throw n}}}}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var a=Object.prototype.toString.call(e).slice(8,-1);return"Map"===(a="Object"===a&&e.constructor?e.constructor.name:a)||"Set"===a?Array.from(e):"Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var a=0,r=new Array(t);a<t;a++)r[a]=e[a];return r}$app.controller("pluginAnalyticsCtrl",["$scope","$http","$routeParams","$timeout","upgradePlanService","$element",function(g,r,e,n,t,a){var s=!1,o=null,o=(g.invokeReportsFromPopup?g:e).pluginId,i=null,i=(g.invokeReportsFromPopup?g:e).instanceId,l=null,l=(g.invokeReportsFromPopup?g:e).activeEvent;g.activeEvent=l,g.activeEvent&&(g.initLoading=!0);var m=null,m=(g.invokeReportsFromPopup?g:e).series;m=Array.isArray(m)?m.map(function(e){return e.toLowerCase()}):["avg","sum","min","max"];var p=new AnalyticsAPI(appContext.currentApp.appId,o,i,0);void 0===appContext.currentApp.config.advancedPluginAnalytics?"enterprise"==appContext.currentApp.config.type?g.analyticsAccess="enabled":g.analyticsAccess="promo":"disabled"==appContext.currentApp.config.advancedPluginAnalytics?g.analyticsAccess="promo":g.analyticsAccess=appContext.currentApp.config.advancedPluginAnalytics,g.daysRange=[{name:"30",value:"30"},{name:"60",value:"60"},{name:"90",value:"90"}];var c=0;g.eventsDataEmpty=!1,g.showCustomUserFilters=!1;function u(){g.events=[],"action-items-analytics"!==g.pluginId&&g.events.push({title:"Opened",key:"app/openedPlugin",description:"",type:"build_in"}),g.selectedEvent=g.events[0],g.selectedDaysRange=g.daysRange[0],c=0,g.eventsDataEmpty=!1}function d(){g.reports={dailyReport:{options:{responsive:!0},total:0,labels:[],series:["Daily Views"],data:[[]]},topUsersReport:{options:{responsive:!0,scales:{xAxes:[{display:!1,maxBarThickness:70}],yAxes:[{ticks:{beginAtZero:!0}}]}},total:0,labels:[],series:["Top Users"],data:[[]]},topUsersGrid:{data:[]},userDetails:{readyToScroll:!1,data:[],skip:0}}}u(),d();function f(e,t){if(!g.selectedEvent)return g.reports.userDetails.busy=!1,g.reports.userDetails.isComplete=!0,g.reports.userDetails.data=[],0;var a;g.reports.userDetails.busy||(g.reports.userDetails.busy=!0,a="",a=(a=window.siteConfig&&window.siteConfig.endPoints&&window.siteConfig.endPoints.appHost&&"sdk"==window.siteConfig.scope?window.siteConfig.endPoints.appHost:a)+"/api/app/analytics/"+window.appContext.currentApp.appId+"/eventSearch",r.post(a,{fromDate:e||g.fromDate,toDate:t||g.toDate,eventName:g.selectedEvent.key,context:{pluginId:o,instanceId:i},options:{skip:g.reports.userDetails.skip,limit:15}}).success(function(e){if(g.reports.userDetails.busy=!1,g.reports.userDetails.isComplete=!0,g.reports.userDetails.readyToScroll=!0,e&&e.length){for(var t=0;t<e.length;t++){var a=e[t].metadata.user.firstName||e[t].metadata.user.lastName?(e[t].metadata.user.firstName||"")+" "+(e[t].metadata.user.lastName||""):e[t].metadata.user.username,r=w(e[t].metadata.user,h.fieldTags);g.reports.userDetails.data.push({createdOn:e[t].createdOn,user:e[t].metadata.user,displayName:a,platform:e[t].metadata.platform,processedData:r})}g.scrollToAdditionalColumns&&(n(function(){var e=document.getElementById("tableContainer").querySelector("th.fixed-col-medium");e&&e.scrollIntoView({behavior:"smooth",block:"nearest",inline:"start"})},300),g.scrollToAdditionalColumns=!1)}}).error(function(e){g.reports.userDetails.busy=!1,g.reports.userDetails.isComplete=!0,g.reports.userDetails.readyToScroll=!0,console.error(e),window.toast("error getting analytics","danger")}),g.reports.userDetails.skip+=15)}g.userDetailsReportOnScroll=function(){g.reports.userDetails.readyToScroll&&f()},g.getUserManagmentUrl=function(e){return"#/appUserManagement/?email="+encodeURIComponent(e)+"&activeTab=activity"};function y(){"promo"==g.analyticsAccess&&"app/openedPlugin"!=g.selectedEvent.key||"promo"==g.analyticsAccess&&"app/openedPlugin"==g.selectedEvent.key&&30<g.selectedDaysRange.value||(g.startDate?g.fromDate=new Date(g.startDate):(g.fromDate=new Date,g.fromDate.setDate(g.fromDate.getDate()-g.selectedDaysRange.value)),g.endDate?g.toDate=new Date(g.endDate):g.toDate=new Date,function(e,t){if(!g.selectedEvent)return g.reports.dailyReport.isComplete=!0,g.reports.dailyReport.data=[[]],g.reports.dailyReport.labels=[],g.reports.dailyReport.total=0;var a="",a=(a=window.siteConfig&&window.siteConfig.endPoints&&window.siteConfig.endPoints.appHost&&"sdk"==window.siteConfig.scope?window.siteConfig.endPoints.appHost:a)+"/api/app/analytics/"+window.appContext.currentApp.appId+"/dailyEvent/groupCount";r.post(a,{fromDate:e,toDate:t,eventName:g.selectedEvent.key,context:{pluginId:o,instanceId:i}}).success(function(e){g.reports.dailyReport.isComplete=!0,g.reports.dailyReport.data=[[]],g.reports.dailyReport.labels=[],g.reports.dailyReport.total=0;var t,a={average:{label:"Avg",enabled:m.includes("avg"),data:[]},summation:{label:"Sum",enabled:m.includes("sum"),data:[]},minimum:{label:"Min",enabled:m.includes("min"),data:[]},maximum:{label:"Max",enabled:m.includes("max"),data:[]}};if(e.hasAggregation&&(g.reports.dailyReport.options.legend={display:!0,position:"bottom"}),e&&e.days&&0<e.days.length){var r,n=_createForOfIteratorHelper(e.days);try{for(n.s();!(r=n.n()).done;){var o,s,i,l,p,c=r.value;g.reports.dailyReport.labels.push(c.dayName),g.reports.dailyReport.data[0].push(c.count),e.hasAggregation&&(s=a.summation,i=a.minimum,l=a.maximum,(o=a.average).enabled&&(p=c.aggregation&&c.aggregation.sum&&c.count?Math.round(c.aggregation.sum/c.count*100)/100:0,o.data.push(p)),s.enabled&&s.data.push(c.aggregation&&c.aggregation.sum||0),i.enabled&&i.data.push(c.aggregation&&c.aggregation.min||0),l.enabled&&l.data.push(c.aggregation&&c.aggregation.max||0))}}catch(e){n.e(e)}finally{n.f()}}for(t in a){var u=a[t],d=u.enabled,f=u.label,u=u.data;d&&(g.reports.dailyReport.series.push(f),g.reports.dailyReport.data.push(u))}g.reports.dailyReport.total=e.total}).error(function(e){g.reports.dailyReport.isComplete=!0,window.toast("error getting analytics","danger")})}(g.fromDate,g.toDate),function(e,t){if(!g.selectedEvent)return g.reports.topUsersReport.isComplete=!0,g.reports.topUsersGrid.isComplete=!0,g.reports.topUsersReport.data=[[]],g.reports.topUsersReport.labels=[],g.reports.topUsersGrid.data=[];var a="",a=(a=window.siteConfig&&window.siteConfig.endPoints&&window.siteConfig.endPoints.appHost&&"sdk"==window.siteConfig.scope?window.siteConfig.endPoints.appHost:a)+"/api/app/analytics/"+window.appContext.currentApp.appId+"/userEvent/count";r.post(a,{fromDate:e,toDate:t,eventName:g.selectedEvent.key,context:{pluginId:o,instanceId:i}}).success(function(e){if(g.reports.topUsersReport.isComplete=!0,g.reports.topUsersGrid.isComplete=!0,g.reports.topUsersReport.data=[[]],g.reports.topUsersReport.labels=[],g.reports.topUsersGrid.data=[],e&&e.length)for(var t=0;t<e.length;t++){var a=e[t].user.firstName||e[t].user.lastName?(e[t].user.firstName||"")+" "+(e[t].user.lastName||""):e[t].user.username;t<=9&&(g.reports.topUsersReport.total+=e[t].total||0,g.reports.topUsersReport.labels.push(a),g.reports.topUsersReport.data[0].push(e[t].total)),g.reports.topUsersGrid.data.push({total:e[t].total,user:e[t].user,displayName:a})}}).error(function(e){g.reports.topUsersReport.isComplete=!0,window.toast("error getting analytics","danger")})}(g.fromDate,g.toDate),f(g.fromDate,g.toDate))}var v;g.loadPluginEvents=function(o){g.customEventsLoading=!0,n(function(){var e,t,a;"enabled"==g.analyticsAccess||"promo"==g.analyticsAccess?(e={skip:c,limit:50,sort:{_titleLowerCase:1},filter:{}},g.customEventSearch&&(t={"$json.title":{$regex:g.customEventSearch,$options:"i"}},e.filter={$or:[t]}),!l||g.enableAnalyticsChange||g.customEventSearch||(a={"$json.key":{$regex:l,$options:"i"}},e.filter.$or?e.filter.$or.push(a):e.filter.$or=[a]),a="action-items-analytics"===g.pluginId?"searchRegisteredActionItems":"getPluginEvents",p[a](e,function(e,t){if(g.customEventsLoading=!1,g.initLoading=!1,t&&0<t.length){c+=50;for(var a=0;a<t.length;a++)if(t[a].data&&t[a].data.title&&t[a].data.key){for(var r=!1,n=0;n<g.events.length;n++)if(g.events[n].key==t[a].data.key){r=!0;break}r||(t[a].data.type="custom",g.events.push(t[a].data)),l!=t[a].data.key||s||(g.selectedEvent=t[a].data,s=!0)}}else g.eventsDataEmpty=!0;o&&o()})):(g.customEventsLoading=!1,g.initLoading=!1,o&&o())},10)},g.searchCustomEvents=function(){n.cancel(v),v=n(function(){c=0,g.eventsDataEmpty=!1,g.events=[],"action-items-analytics"!==g.pluginId&&g.events.push({title:"Opened",key:"app/openedPlugin",description:"",type:"build_in"}),g.loadPluginEvents()},500)},g.changeEvent=function(e){g.customEventSearch="",g.selectedEvent=e,d(),y()},g.changeDaysRange=function(e){g.selectedDaysRange=e,d(),y()},g.upgradePlan=t.upgrade;var h=null;g.selectedFilters=[];var b=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t={appId:appContext.currentApp.appId,pluginId:o,instanceId:i},h=new FieldTagManager(t),e.next=4,h.init();case 4:g.showCustomUserFilters=h&&h.isCustomRegistrationEnabled&&h.fieldTags.length,g.showCustomUserFilters&&(g.selectedFilters=h.fieldTags.filter(function(e){return e.selected}));case 6:case"end":return e.stop()}},e)}));return function(){return e.apply(this,arguments)}}();g.start=_asyncToGenerator(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(g.analyticsStarted)return e.abrupt("return");e.next=4;break;case 4:g.analyticsStarted=!0;case 5:return e.next=7,b();case 7:u(),d(),l?g.loadPluginEvents(function(){y()}):(g.loadPluginEvents(),y());case 10:case"end":return e.stop()}},e)})),g.showAnalyticsFilterDialog=function(){var e={templateUrl:"analyticsFilters.html",controller:"analyticsFilterDialogCtrl",size:"md",data:{appId:window.appContext.currentApp.appId}};window.openDialog(e,function(e){e&&(h.fieldTags=e,g.selectedFilters=h.fieldTags.filter(function(e){return e.selected}),g.scrollToAdditionalColumns=!0,d(),y())})};var w=function(o,e){var s={},i=o.tags.reduce(function(e,t){var a=_slicedToArray(t.tagName.split(":"),2),t=a[0],a=a[1];return void 0!==a&&(e[t]=e[t]||[],e[t].push(a)),e},{}),l=["January","February","March","April","May","June","July","August","September","October","November","December"];return e.forEach(function(e){var t,a,r,n;e.selected&&("birthDate"===e.id?(a=i.$$profile_birth_year?i.$$profile_birth_year[0]:"",t=null!==(t=i.$$profile_birth_month?i.$$profile_birth_month[0]-1:null)?l[t]:"",s.birthDate=a&&t?"".concat(t,", ").concat(a):""):"address"===e.id?(t=i.$$profile_city?i.$$profile_city[0]:"",a=i.$$profile_state?i.$$profile_state[0]:"",n=i.$$profile_country?i.$$profile_country[0]:"",s.address=[t,a||n].filter(Boolean).join(", ")):(r=new Set,e.selectOptions.forEach(function(e){var t;e.tag&&(t=e.tag.toLowerCase().trim().replace(/ /g,"-"),o.tags.find(function(e){return e.tagName.toLowerCase()===t})&&r.add(e.label))}),0<r.size?s[e.id]=Array.from(r).join(", "):(n="$$profile_".concat(e.id.split("_").slice(1).join("_")),s[e.id]=i[n]?i[n].join(", "):"")))}),s};g.$on("pluginAnalyticsTabOpened",function(e,t){g.start()}),!g.invokeReportsFromPopup&&"analytics"!=e.activeTab||g.start(),g.invokeReportsFromPopup||cpNotification.analyticsPluginDailyOpen({pluginId:o,instanceId:i})}]),$app.controller("analyticsFilterDialogCtrl",["$scope","$dialog",function(e,t){t.options&&t.options.data&&t.options.data.source&&(e.source=t.options.data.source),e.close=function(e){t.close(e)}}]),$app.controller("analyticsFilterCtrl",["$scope","$routeParams",function(e,t){var a=window.appContext.currentApp.appId,r=t.pluginId||e.pluginId,t=t.instanceId||e.instanceId;e.tags=[],e.loadingFilters=!0;var n=new FieldTagManager({appId:a,pluginId:r,instanceId:t});n.init().then(function(){e.loadingFilters=!1,e.tags=n.fieldTags,e.$apply()}),e.changeTagSelection=function(e){e.selected=!e.selected},e.cancel=function(){e.$parent.close(null)},e.save=function(){n.saveSelectedFieldTags(),e.$parent.close(e.tags)}}]);
"use strict";$app.controller("pluginAnalyticsPopupCtrl",["$scope","$http","$data","$dialog",function(t,e,i,n){t.invokeReportsFromPopup=!0,t.pluginId=i.pluginId,t.instanceId=i.instanceId,t.activeEvent=i.activeEvent,t.series=i.series,t.disableIntervalFiltering=i.disableIntervalFiltering,t.filterLabelText=i.filterLabelText,t.startDate=i.startDate,t.endDate=i.endDate,t.appHost="",window.siteConfig&&window.siteConfig.endPoints&&window.siteConfig.endPoints.appHost&&"sdk"==window.siteConfig.scope&&(t.appHost=window.siteConfig.endPoints.appHost),t.close=function(){n.close()}}]);
"use strict";function _createForOfIteratorHelper(t,e){var n="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!n){if(Array.isArray(t)||(n=_unsupportedIterableToArray(t))||e&&t&&"number"==typeof t.length){n&&(t=n);var i=0,e=function(){};return{s:e,n:function(){return i>=t.length?{done:!0}:{done:!1,value:t[i++]}},e:function(t){throw t},f:e}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var r,a=!0,o=!1;return{s:function(){n=n.call(t)},n:function(){var t=n.next();return a=t.done,t},e:function(t){o=!0,r=t},f:function(){try{a||null==n.return||n.return()}finally{if(o)throw r}}}}function _unsupportedIterableToArray(t,e){if(t){if("string"==typeof t)return _arrayLikeToArray(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);return"Map"===(n="Object"===n&&t.constructor?t.constructor.name:n)||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(t,e):void 0}}function _arrayLikeToArray(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,i=new Array(e);n<e;n++)i[n]=t[n];return i}"undefined"!=typeof AnalyticsAPI&&function(){AnalyticsAPI.prototype.registerPluginEvent=function(n,i){var r,t,a;n?(n.data||(n.data={}),n.options||(n.options={}),(r=n.data).key?r.title?(AnalyticsAPI.prototype._prepareEvent(r),t=this.instanceId+"_pluginEvents",(a=new DatastoreAPI(this.appId,this.pluginId,t,this.liveMode)).searchAndUpdate({tag:"events",obj:{$set:r},search:{key:r.key}},function(t,e){null==t&&e&&0==e.nModified?a.insert({tag:"events",obj:r,checkDuplicate:!1},function(t,e){AnalyticsAPI.prototype._dispatchEvent(n.data,n.options),i&&i(t,e)}):i&&i(t,e)})):i&&i("Missing event title",null):i&&i("Missing event key",null)):i&&i("invalid params",null)},AnalyticsAPI.prototype.bulkRegisterPluginEvents=function(r,a){var o,e,t;r&&r.events&&Array.isArray(r.events)&&r.events.length?(r.options||(r.options={}),(o=r.events).every(function(t){return t.key})?o.every(function(t){return t.title})?(t=this.instanceId+"_pluginEvents",e=new DatastoreAPI(this.appId,this.pluginId,t,this.liveMode),t=o.map(function(t){return t.key}),this.bulkUnregisterPluginEvents({keys:t},function(t,n){var i;t?a&&a(t,null):(i=(o=o.map(function(t){return AnalyticsAPI.prototype._prepareEvent(t),t})).filter(function(e){return!n.some(function(t){return t.data.key===e.key})}),e.bulkInsert({tag:"events",obj:o},function(t,e){t?a&&a(t,null):(i.forEach(function(t){AnalyticsAPI.prototype._dispatchEvent(t,r.options)}),a&&a(null,o))}))})):a&&a("Missing event title",null):a&&a("Missing event key",null)):a&&a("invalid params",null)},AnalyticsAPI.prototype.unregisterPluginEvent=function(t,i){var e,r;t&&t.key?(e=this.instanceId+"_pluginEvents",(r=new DatastoreAPI(this.appId,this.pluginId,e,this.liveMode)).search({tag:"events",obj:{filter:{"$json.key":t.key}}},function(t,e){if(!t&&e&&0<e.length)for(var n=0;n<e.length;n++)r.delete({tag:"events",id:e[n].id},function(t,e){i&&i(t,e)});else i&&i(t,e)})):i&&i("Missing event key",null)},AnalyticsAPI.prototype.bulkUnregisterPluginEvents=function(t,n){var e,o,s,l,u;t&&t.keys&&Array.isArray(t.keys)&&t.keys.length?t.keys.every(function(t){return t})?(e=this.instanceId+"_pluginEvents",o=new DatastoreAPI(this.appId,this.pluginId,e,this.liveMode),s=50,l=t.keys,u=[],function n(i,r,a){o.search({obj:{limit:s,skip:r,sort:{title:1},filter:{"$json.key":{$in:l}}},tag:"events"},function(t,e){t?a&&a(t,null):(u=u.concat(e),e&&e.length>=s?n(i+1,r+s,a):a(null,u))})}(0,0,function(t,e){t?n&&n(t,null):o.bulkDelete({tag:"events",ids:u.map(function(t){return t.id})},function(t,e){t?n&&n(t,null):n(null,u)})})):n&&n("Missing event key",null):n&&n("invalid params",null)},AnalyticsAPI.prototype.showReports=function(t,e){var n="";window.siteConfig&&window.siteConfig.endPoints&&window.siteConfig.endPoints.appHost&&"sdk"==window.siteConfig.scope&&(n=window.siteConfig.endPoints.appHost);var i=this.pluginId,r=this.instanceId,a=t||{},o=a.eventKey,s=a.aggregates,l=a.disableIntervalFiltering,u=a.filterLabelText,t=a.startDate,a=a.endDate;if(Array.isArray(s)){var p,c=["avg","sum","min","max"],y=_createForOfIteratorHelper(s);try{for(y.s();!(p=y.n()).done;){var d=p.value;if(!c.includes(d.toLowerCase()))return e('"'.concat(d,'" is not a valid aggregation option. Supported options are: ').concat(c.join(", ")))}}catch(t){y.e(t)}finally{y.f()}}window.openDialog({templateUrl:n+"/pages/plugins/pluginControl/analytics/pluginAnalyticsPopup.html",controller:"pluginAnalyticsPopupCtrl",size:"lg",data:{pluginId:i,instanceId:r,series:s,activeEvent:o,disableIntervalFiltering:l,filterLabelText:u,startDate:t,endDate:a}},function(t){}),e(null,!0)};var t=AnalyticsAPI.prototype.trackAction,e=AnalyticsAPI.prototype.trackView;AnalyticsAPI.prototype.trackAction=function(){t.apply(this,arguments),"undefined"!=typeof dataLayer&&dataLayer.push&&arguments&&arguments[0]&&window.dataLayer.push({event:"custom_page_view",custom_title:arguments[0],app_id:this.appId})},AnalyticsAPI.prototype.trackView=function(){e.apply(this,arguments),"undefined"!=typeof dataLayer&&dataLayer.push&&arguments&&arguments[0]&&window.dataLayer.push({event:"custom_page_view",custom_title:arguments[0],app_id:this.appId})},AnalyticsAPI.prototype._prepareEvent=function(t){t._titleLowerCase=t.title.toLowerCase()},AnalyticsAPI.prototype._dispatchEvent=function(t,e){e=new CustomEvent("pluginAnalyticsRegisterEvent",{detail:{data:t,options:e}});document.dispatchEvent(e)}}();
"use strict";function ownKeys(t,e){var n,r=Object.keys(t);return Object.getOwnPropertySymbols&&(n=Object.getOwnPropertySymbols(t),e&&(n=n.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),r.push.apply(r,n)),r}function _objectSpread(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(Object(n),!0).forEach(function(e){_defineProperty(t,e,n[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):ownKeys(Object(n)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))})}return t}function _defineProperty(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function UsersLibAPI(e){this.context={},angular.copy(e,this.context),this.init()}UsersLibAPI.prototype={init:function(){},showSearchDialog:function(e,n){var t="",t={templateUrl:(t=window.siteConfig&&window.siteConfig.endPoints&&window.siteConfig.endPoints.appHost&&"sdk"==window.siteConfig.scope?window.siteConfig.endPoints.appHost:t)+"/pages/common/userSearch.html",controller:"userSearchDialogCtrl",size:"lg",data:_objectSpread({appId:this.context.appId,source:"sdk",responseType:"users"},e)};if(e&&e.maxUsers<=0)return n("Max users should be greater than zero or undefined for unlimited selection");window.openDialog(t,function(e){if(e){if(e,e.users&&0<e.users.length)for(var t=0;t<e.users.length;t++)e.users[t]={userId:e.users[t]._id,firstName:e.users[t].firstName||null,lastName:e.users[t].lastName||null,displayName:e.users[t].displayName||null,username:e.users[t].username||null,isActive:e.users[t].isActive,userProfile:e.users[t].userProfile||null,imageUrl:e.users[t].imageUrl||null};delete e.criteria,delete e.criteriaTranslation,delete e.selectAll,n&&n(null,e)}else n&&n(null,null)})},showTagsSearchDialog:function(e,t){var n="",n={templateUrl:(n=window.siteConfig&&window.siteConfig.endPoints&&window.siteConfig.endPoints.appHost&&"sdk"==window.siteConfig.scope?window.siteConfig.endPoints.appHost:n)+"/pages/common/tagSearch.html",controller:"tagSearchDialogCtrl",size:"lg",data:_objectSpread({appId:this.context.appId},e)};if(e&&e.maxTags<=0)return t("Max tags should be greater than zero or undefined for unlimited selection");window.openDialog(n,function(e){t&&t(null,e)})}};
"use strict";"undefined"!=typeof authAPI?(authAPI.searchUsers=function(e,s){var i={};(e=e||{}).searchText&&(i.searchText=e.searchText),e.emails&&(i.emails=e.emails),e.phoneNumbers&&(i.phoneNumbers=e.phoneNumbers),e.sort&&(i.sort=e.sort),e.limit&&(i.limit=e.limit),e.skip&&(i.skip=e.skip),e.page&&(i.page=e.page),e.pageSize&&(i.pageSize=e.pageSize);e="";window.siteConfig&&window.siteConfig.endPoints&&window.siteConfig.endPoints.appHost&&"sdk"==window.siteConfig.scope&&(e=window.siteConfig.endPoints.appHost),$http.post("".concat(e,"/api/app/").concat(appContext.currentApp.appId,"/users/search"),{searchCriteria:i}).success(function(e){s&&s(null,e)}).error(function(e){window.toast("Error occurred while fetching user data","danger")})},authAPI.cpSearchUsers=authAPI.searchUsers):console.error("authAPI is not loaded");
"use strict";$app.controller("userSearchDialogCtrl",["$scope","$dialog","$rootScope",function(e,t,s){t.options&&t.options.data&&(t.options.data.source&&(e.source=t.options.data.source),s.maxUsers=t.options.data.maxUsers||null),e.selectedLimit=t.options.data.selectedLimit,e.currentSelectedUsers=t.options.data.currentSelectedUsers,e.submitBtnText=t.options.data.submitBtnText,e.responseType=t.options.data.responseType,e.isPopupUserSearch=!0,e.responseType||("sdk"==e.source?e.responseType="users":e.responseType="searchCriteria"),e.close=function(){t.close(null)},e.returnSearchResult=function(e){t.close(e)}}]),$app.controller("userSearchCtrl",["$scope","$rootScope","userService",function(i,e,t){i.activeAll=!0,i.activeRange=!1,i.errors={},i.tagsHave=!0,i.tagsAll=!0,i.imageTools=ImageLibAPI.tools,i.activeType=function(e){i.activeAll=!1,i.activeRange=!1,void 0!==e&&(i[e]=!0)},i.export=function(){i.exporting=!0;var e=s();delete e.skip,delete e.limit;var t="";window.siteConfig&&window.siteConfig.endPoints&&window.siteConfig.endPoints.appHost&&"sdk"==window.siteConfig.scope&&(t=window.siteConfig.endPoints.appHost),$http.post(t+"/api/userTagging/userExport/"+window.appContext.currentApp.appId+"/",e).success(function(e){i.exporting=!1;var t=document.createElement("a");t.setAttribute("href","data:text/csv;charset=utf-8,"+encodeURIComponent(e)),t.setAttribute("download","users.csv"),t.click()}).error(function(e){i.exporting=!1,console.error(e),window.toast("Search Error","danger")})},e.$on("searchUsers",function(e,t){i.searchUsers()}),i.selectTagHave=function(e){i.tagsHave=e};var s=function(){var a,e={filter:{},skip:(i.pageIndex-1)*i.pageSize,limit:i.pageSize},t=[];if(i.searchName&&(a=[],i.searchName.split(",").forEach(function(e){var t,s,r;e=e.trim(),r=!1,(r=!(0!==(s=e).indexOf("facebook")&&0!==s.indexOf("twitter")&&!/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z\-0-9]{2,}))$/.test(s))||r)?a.push({email:e.toLowerCase()}):e&&(t=/[\!\@\#\$\%\^\&\*\)\(\+\=\.\<\>\{\}\[\]\:\;\'\"\|\~\`\_\-]/g,e=e.split("").map(function(e){return t.test(e)?"\\".concat(e):e}).join(""),a.push({displayName:{$regex:e,$options:"i"}},{email:{$regex:e,$options:"i"}}))}),t.push({$or:a})),-1!=i.currentUserStatusFilter&&(e.isActive=1==i.currentUserStatusFilter),i.showAdvancedSearch){i.searchFromDate&&(e.signupDateFrom=i.searchFromDate),i.searchToDate&&(e.signupDateTo=i.searchToDate);var s=[];if(i.searchTags&&i.searchTags.length){for(var r=0;r<i.searchTags.length;r++)s.push(i.searchTags[r].tagName);if(i.tagsHave)if(i.tagsAll)for(r=0;r<s.length;r++)t.push({tagsArray:{$elemMatch:{tagName:s[r]}}});else t.push({tagsArray:{$elemMatch:{tagName:{$in:s}}}});else if(i.tagsAll)for(r=0;r<s.length;r++)t.push({tagsArray:{$not:{$elemMatch:{tagName:s[r]}}}});else{for(var n=[],r=0;r<s.length;r++)n.push({tagsArray:{$not:{$elemMatch:{tagName:s[r]}}}});t.push({$or:n})}}}return i.sortBy&&(e.sort=i.sortBy),i.isReversed&&(e.isReversed=i.isReversed),0<t.length&&(e.filter.$and=t),e};i.getUsers=function(){i.searching=!0;var a=s(),e="";window.siteConfig&&window.siteConfig.endPoints&&window.siteConfig.endPoints.appHost&&"sdk"==window.siteConfig.scope&&(e=window.siteConfig.endPoints.appHost),$http.post(e+"/api/userTagging/userSearch/"+window.appContext.currentApp.appId+"/",a).success(function(e){i.totalItems=e.usersCount,i.searching=!1;for(var t=0;t<e.users.length;t++){var s=e.users[t];if(i.users.push(s),i.selectedUsers&&i.selectedUsers.length)for(var r=0;r<i.selectedUsers.length;r++)i.selectedUsers[r]._id==s._id&&(s.selected=!0)}delete a.isReversed,delete a.limit,delete a.skip,delete a.sort,0<e.users.length&&(i.busy=!1),i.currentSearchCriteria=a,i.hasSearchCriteria=!(!i.currentSearchCriteria||!(1<Object.keys(i.currentSearchCriteria).length)&&n(i.currentSearchCriteria.filter)),i.loading=!1,i.sortLoading=!1}).error(function(e){i.searching=!1,i.busy=!1,console.error(e),window.toast("Search Error","danger")}).finally(function(){})},i.changeSorting=function(e){i.sortBy===e?i.isReversed=!i.isReversed:(i.sortBy=e,i.isReversed=!1),i.sortLoading=!0,i.users=[],i.busy=!1,i.pageIndex=0,i.setPage()},i.getUserStatus=function(e){e=e.externalApps[window.appContext.currentApp.appId].isActive;return e||void 0===e?"Active":"Banned"},i.setUserStatus=function(e,t){var s=e.externalApps[window.appContext.currentApp.appId].isActive;void 0===s&&t||s===t||(e.externalApps[window.appContext.currentApp.appId].isActive=t,i.updateUserStatus(e))},i.updateUserStatus=function(e){var t={isActive:e.externalApps[window.userContext.currentApp.appId].isActive};$http.post("/api/userTagging/updateUserStatus/"+window.userContext.currentApp.appId+"/"+e._id,t).success(function(e){window.toast("Saved","success")}).error(function(e){window.toast("save error","danger")})},i.setStatusFilter=function(e){"-1"==(i.currentUserStatusFilter=e)?i.currentUserStatusFilterText="All":"0"==e?i.currentUserStatusFilterText="Banned":"1"==e&&(i.currentUserStatusFilterText="Active")},i.showHideAdvancedSearch=function(){i.showAdvancedSearch=!i.showAdvancedSearch},i.setPage=function(){i.busy||(i.busy=!0,i.pageIndex+=1,i.getUsers())},i.managUser=function(e){window.location.hash="appUserManagement?email="+encodeURIComponent(e.email)},i.resetPassword=function(e){window.openDialog({templateUrl:"userManagementResetPassword.html",controller:"userManagementResetPasswordCtrl",size:"md",data:{user:e}},function(){})};i.uploadFile=function(){},i.init=function(){i.appConfig=window.appContext.currentApp.config,i.showDuplicateWarning=!1,i.totalItems=100,i.pageIndex=0,i.pageSize=10,i.maxSize=10,i.username=null,i.sortColumn="",i.currentUserStatusFilter="-1",i.currentUserStatusFilterText="All",i.searchText="",i.showAdvancedSearch=!0,i.currentUserStatusFilter="-1",i.currentUserStatusFilterText="All",i.sortBy="createdOn",i.isReversed=!1,i.selectedUsers=i.currentSelectedUsers||null,i.hasSearchCriteria=!1,i.busy=!1,i.users=[],i.loading=!0,i.sortLoading=!1,i.scopeLoading=!1,i.isNonFederatedApp=!1,i.maxUsers=e.maxUsers||null,i.setPage(),function(){i.scopeLoading=!0;var e="";window.siteConfig&&window.siteConfig.endPoints&&window.siteConfig.endPoints.appHost&&"sdk"==window.siteConfig.scope&&(e=window.siteConfig.endPoints.appHost),$http.get(e+"/api/app/"+appContext.currentApp.appId+"/users/scope").success(function(e){i.scopeLoading=!1,i.isNonFederatedApp=!(!e||!e.scope)}).error(function(e){i.scopeLoading=!1,console.error(e)})}()},i.init();i.returnSearchResult=function(){var e={};if(i.currentSearchCriteria&&n(i.currentSearchCriteria.filter)&&delete i.currentSearchCriteria.filter,n(i.currentSearchCriteria)||(e.criteria=JSON.stringify(i.currentSearchCriteria),e.criteriaTranslation=function(){var e="";if(i.searchName&&(e="name or email in ("+i.searchName,e+=")"),-1!=i.currentUserStatusFilter&&(0<e.length&&(e+=" and "),1==i.currentUserStatusFilter&&(e+="Active"),0==i.currentUserStatusFilter&&(e+="Banned")),i.showAdvancedSearch){i.searchFromDate&&(0<e.length&&(e+=" and "),e+="Signup date <  "+i.searchFromDate.toLocaleString()),i.searchToDate&&(0<e.length&&(e+=" and "),e+="Signup date <  "+i.searchToDate.toLocaleString());var t=[];if(i.searchTags&&i.searchTags.length){0<e.length&&(e+=" and ");for(var s=0;s<i.searchTags.length;s++)t.push(i.searchTags[s].tagName);i.tagsHave?i.tagsAll?e+="has these tags ("+t.toString(",")+")":e+="has some of these tags ("+t.toString(",")+")":i.tagsAll?e+="does not have these tags ("+t.toString(",")+")":e+="does not have some of these tags ("+t.toString()+")"}}return e}()),e.users=i.selectedUsers,e.selectAll=!0,e.userIds=null,i.selectedUsers){e.selectAll=!1,e.userIds=[];for(var t=0;t<e.users.length;t++)e.userIds.push(e.users[t]._id)}i.$parent.returnSearchResult(e)};var n=function(e){return!e||!Object.keys(e).length};i.loadTags=function(e){return t.searchTags({filter:{tagName:e},skip:0,limit:20}).then(function(e){return e.tags})},i.changeUserSelection=function(e){if(i.selectedUsers||(i.selectedUsers=[]),e.selected)!i.maxUsers||i.selectedUsers.length<i.maxUsers?i.selectedUsers.push(e):e.selected=!1;else for(var t=0;i.selectedUsers&&t<i.selectedUsers.length;t++)i.selectedUsers[t]._id==e._id&&(i.selectedUsers.splice(t,1),i.selectedUsers.length||(i.selectedUsers=null))},i.searchUsers=function(){i.loading=!0,i.users=[],i.busy=!1,i.pageIndex=0,i.setPage()}}]);
"use strict";function _createForOfIteratorHelper(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=_unsupportedIterableToArray(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var a=0,t=function(){};return{s:t,n:function(){return a>=e.length?{done:!0}:{done:!1,value:e[a++]}},e:function(e){throw e},f:t}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var s,n=!0,o=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return n=e.done,e},e:function(e){o=!0,s=e},f:function(){try{n||null==r.return||r.return()}finally{if(o)throw s}}}}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Map"===(r="Object"===r&&e.constructor?e.constructor.name:r)||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,a=new Array(t);r<t;r++)a[r]=e[r];return a}$app.controller("tagSearchDialogCtrl",["$scope","$dialog","$rootScope",function(e,t,r){t.options&&t.options.data&&(t.options.data.source&&(e.source=t.options.data.source),r.maxTags=t.options.data.maxTags||null),e.close=function(){t.close(null)},e.returnSearchResult=function(e){t.close(e)}}]),$app.controller("tagSearchCtrl",["$scope","$http","$rootScope",function(o,r,e){o.getTags=function(e){o.searching=!0;var t="";window.siteConfig&&window.siteConfig.endPoints&&window.siteConfig.endPoints.appHost&&"sdk"==window.siteConfig.scope&&(t=window.siteConfig.endPoints.appHost),r.get(t+"/api/userTagging/searchTags/"+window.appContext.currentApp.appId+"/",{params:e}).success(function(e){o.totalItems=(e=e||{tags:[],tagsCount:0}).tagsCount,e.tags=0<e.tagsCount?e.tags:[];var t,r=_createForOfIteratorHelper(e.tags);try{for(r.s();!(t=r.n()).done;){var a=t.value;if(o.tags.push(a),o.selectedTags&&o.selectedTags.length){var s,n=_createForOfIteratorHelper(o.selectedTags);try{for(n.s();!(s=n.n()).done;)s.value._id==a._id&&(a.selected=!0)}catch(e){n.e(e)}finally{n.f()}}}}catch(e){r.e(e)}finally{r.f()}0<e.tags.length&&(o.busy=!1),o.searching=!1,o.sortLoading=!1,o.loading=!1}).finally(function(){o.loading=!1})},o.search=function(e){o.pageIndex=void 0===e?1:e;e={filter:{},skip:(o.pageIndex-1)*o.pageSize,limit:o.pageSize,sortBy:o.sortBy,sort:o.reverse?1:-1};o.searchText&&(e.filter.tagName=o.searchText.trim()),o.getTags(e)},o.getDataPage=function(e){var t=[];if(o.searchText)for(var r in e)-1<e[r].tagName.toLowerCase().indexOf(o.searchText.toLowerCase())&&t.push(e[r]);else t=e;return t},o.setSort=function(e,t){o.sortCriteria=e,o.reverse=t,o.sort()},o.sort=function(){switch(o.sortCriteria){case"Newest First":o.sortBy="createdOn",o.reverse=!1;break;case"Oldest First":o.sortBy="createdOn",o.reverse=!0;break;case"Tag Name A-Z":o.sortBy="tagName",o.reverse=!0;break;case"Tag Name Z-A":o.sortBy="tagName",o.reverse=!1}o.sortLoading=!0,o.tags=[],o.busy=!1,o.pageIndex=0,o.setPage()},o.changeTagSelection=function(e){if(o.selectedTags||(o.selectedTags=[]),e.selected)!o.maxTags||o.selectedTags.length<o.maxTags?o.selectedTags.push({id:e._id,tagName:e.tagName}):e.selected=!1;else for(var t=0;o.selectedTags&&t<o.selectedTags.length;t++)o.selectedTags[t]&&o.selectedTags[t].id==e._id&&(o.selectedTags.splice(t,1),o.selectedTags.length||(o.selectedTags=null))},o.returnSearchResult=function(){o.$parent.returnSearchResult(o.selectedTags)},o.searchTags=function(){o.loading=!0,o.tags=[],o.busy=!1,o.pageIndex=0,o.setPage()},o.setPage=function(){o.busy||(o.busy=!0,o.pageIndex+=1,o.search(o.pageIndex))},o.init=function(){o.tags=[],o.currentPageTags=[],o.loading=!0,o.pageIndex=0,o.pageSize=20,o.sortColumn="",o.currentUserStatusFilter="-1",o.currentUserStatusFilterText="All",o.searchText="",o.sortCriteria="Newest First",o.sortBy="createdOn",o.reverse=!1,o.busy=!1,o.maxTags=e.maxTags||null,o.setPage()},o.init()}]);
"use strict";$app.factory("addPluginService",["$rootScope","$http","$q","$analytics","pluginManager","promoService","$searchEngineService",function(d,r,n,c,i,l,g){var f={};f.miniSearchLoaded=!1,f.currencyToInt=function(e,n){return parseInt((100*e).toFixed())},f._trackAction=function(e,n,t,i){i=i||{};var a=window.bfHelper.Cookies.get("verticalData"),r=window.authAPI.getCurrentUser();r&&(i.user={userId:r.userToken,userEmail:r.email,username:r.username,displayName:r.displayName}),i.app={appId:window.appContext.currentApp.appId,name:window.appContext.currentApp.name,clonedFromAppId:window.appContext.currentApp.clonedFromAppId,config:{id:window.appContext.currentApp.configId,type:window.appContext.currentApp.config.type},marketIndustry:a&&a.industry||null},(AnalyticsAPI&&new AnalyticsAPI(n||"marketplace_analytics",t)).trackAction(e,i)},f.sortResults=function(e,t){return e.sort(function(e,n){e=t.indexOf(e.data.instanceId),n=t.indexOf(n.data.instanceId);return n<e?1:e<n?-1:0}),e},f.getMarketplaceSettings=function(e){e(null,{showDevInfo:whitelabelContext.showDevInfo})},f.addLicense=function(e,n){var t={clientReferenceId:e.clientReferenceId,pluginId:e.pluginId,appId:e.appId,userId:e.userId,email:e.email};r.post("/api/stripe/charge",t).then(function(){i.removeRevokedPlugin(e.pluginId),n(null)},function(e){n(e)})},f.isPluginLicenseActive=function(e,n){r.get("/api/appPluginTypes/validateToAdd",{params:{appId:e.appId,token:e.pluginToken}}).success(function(e){e&&e.isActive?n(null,!0):n(null,!1)})},f.trackPluginAdded=function(e){c.eventTrack("cp/pluginInstanceAdded",{pluginTypeId:e.pluginTypeId,pluginTypeName:e.pluginTypeName,marketItemId:e.marketItemId})};var e=new DatastoreAPI(appContext.currentApp.appId,"sideMenu",1,0,appContext.currentApp.keys.datastoreKey);function t(a){var r={dataType:"pluginInstance",data:[],content:{securedFeaturesOption:"enable"},result:[]};e.get({withDynamicData:!0},function(e,n){var t,i;n&&n.data&&((t=n.data._buildfire&&n.data._buildfire.sideMenu)&&t.content?t.content.loadAllPlugins||(t.result=(n=t.result,i=t.data,n.sort(function(e,n){e=i.indexOf(e.data.instanceId),n=i.indexOf(n.data.instanceId);return n<e?1:e<n?-1:0}),n)):t=r,r=t),a(null,r)})}return f.addToSideMenu=function(n,i){var a=new DatastoreAPI(appContext.currentApp.appId,"sideMenu",1,0,appContext.currentApp.keys.datastoreKey);t(function(e,t){e?i&&i(e):t&&t.result&&(t.result.push({id:n.instanceId,data:n}),t.data||(t.data=[]),t.data.push(n.instanceId),(e={_buildfire:{sideMenu:t}})._buildfire.sideMenu.result&&delete e._buildfire.sideMenu.result,a.save({tag:"",obj:e},function(e,n){e||!n?(console.error(e),i&&i(e)):(i&&i(null,t),window.dispatchEvent(new CustomEvent("SideMenuUpdated",{detail:n})),emulatorSync.triggerSideMenuOnUpdate(n))}))})},f.addPluginToDataStore=function(l,o,s){(l=l||{}).pluginHost=window.siteConfig.endPoints.pluginHost.replace("http:","https:");var u=void 0,p=void 0;l.iconClassName?p=l.iconClassName:u=l.iconUrl||l.pluginHost+"/"+o.folderName+"/resources/icon.png";var e=l.pluginHost+"/"+o.folderName+"/plugin.json?v="+(o.lastUpdatedOn||"");n.all([r.get(e),r.get("/api/appPluginTypes/validateToAdd",{params:{appId:l.appId,token:o.token}})]).then(function(e){var n,t,i,a,r=!1;e&&e[0].data&&(n=e[0].data)&&n.requireLogin&&(r=!0),(t=e&&e[1].data?e[1].data:t)&&t.isActive?(t=r,r=new DatastoreAPI(l.appId,"pluginInstances",1,0,appContext.currentApp.keys.datastoreKey),i=o.token+"-"+Date.now(),a={tag:"",obj:{pluginTypeId:o.pluginTypeId,token:o.token,title:l.title,instanceId:i,refId:i,iconUrl:u,iconClassName:p,_buildfire:{pluginType:{dataType:"pluginType",data:o.token,_source:l.source}}}},t&&(a.obj.requiresLogin=!0,a.obj._forceRequireLoginInEmulator=!0),r.insert(a,function(e){e?(s(e),console.log(e)):(emulatorSync.triggerPluginInstanceOnAdd(),c.eventTrack("cp/pluginInstanceAdded",{pluginTypeId:o.pluginTypeId,pluginTypeName:o.pluginTypeName,marketItemId:o.marketItemId}),window.pluginInstancesManager.events.added(o),f._trackAction("cp/marketplace/pluginInstall",null,o.token,{plugin:{pluginTypeId:o.pluginTypeId,pluginTypeName:o.pluginTypeName,marketItemId:o.marketItemId}}),d.$broadcast("pluginInserted",o.token),e={instanceId:i,iconUrl:l.pluginHost+"/"+o.folderName+"/resources/icon.png",title:a.obj.title,pluginTypeId:o.token,pluginTypeName:o.pluginTypeName,folderName:o.folderName,iconClassName:null},g.savePluginTitle({instanceId:i,pluginId:o.token,title:a.obj.title},function(e,n){e&&console.error("addPluginCtrl","add plugin title to searchEngineAPI",e)}),l.addToSideMenu?f.addToSideMenu(e,function(){s(null,{pluginInstance:a,folderName:o.folderName})}):s(null,{pluginInstance:a,folderName:o.folderName}))})):s("plugin_inactive")})},f.getMarketPlacePlugins=function(e,n,t){return r.get("/api/marketplace/search",{params:{appId:n,search:e,whitelabelId:t}})},f.formatPluginLicenses=function(e){if(e)for(var n=0;n<e.length;n++)e[n]&&e[n].license&&(e[n].license=e[n].license.replace(/.(?=.{4})/g,"x"))},f.logToCrm=function(e,n,t){e=e.length||"0";crm&&1==t&&n&&(crm.set({lastPluginSearchOn:Date.now(),lastPluginSearchFor:n,lastPluginSearchFound:e}),0==e&&(crm.set({lastPluginSearchMissOn:Date.now(),lastPluginSearchMissFor:n}),crm.inc({pluginSearchMissCount:1})),crm.log("Searched for plugin: "+n+": "+e+" plugins found"))},f.checkAndSaveMissedKeywords=function(e,n){var t={totalScore:0,highestScore:0,searchResult:[],averageScore:0,threshold:10,totalResult:n&&n.length?n.length:0,exactMatch:!1,missedKeyword:!1,query:e};if(n&&0<n.length){for(var i=0;i<n.length;i++){for(var a=0;a<n[i].terms.length;a++)n[i].terms[a]==e.toLowerCase()&&(t.exactMatch=!0);if(0==i&&(t.highestScore=n[i].score),t.totalScore+=n[i].score,t.searchResult.push({name:n[i].pluginTypeName,pluginTypeId:n[i].pluginTypeId,terms:n[i].terms,isBuildFirePlugin:!!n[i].author&&"buildfire"===n[i].author.toLowerCase()}),3<=t.searchResult.length)break}t.averageScore=t.totalScore/n.length,t.highestScore-t.averageScore>t.threshold&&(t.missedKeyword=!0)}else t.missedKeyword=!0;f._trackAction("cp/marketplace/search",null,null,{result:t})},f.searchAppPluginTypes=function(n,t){var a=n.pluginTypeName,e=n.appId,r=n.whitelabelId;function i(i){f.getMarketPlacePlugins("",e,r).then(function(e){var n=e.data[0];f.formatPluginLicenses(n),f.logToCrm(n,a,1);var t,e={plugins:n};n=e.plugins,t=new Set(["and","or","to","in","a","the","you","is","are"]),f.miniSearch=new MiniSearch({fields:["pluginTypeName","keywords","description"],storeFields:["pluginTypeId","description","author","awsAPIPublicKey","createdOn","folderName","lastUpdatedOn","license","marketplacepluginTypeId","pluginTypeId","pluginTypeName","price","publishableKey","stripePlan","supportEmail","supportLink","useCount","keywords","token","config"],boost:{pluginTypeName:3,keywords:2},idField:"pluginTypeId",prefix:!0,processTerm:function(e,n){return t.has(e)?null:e.toLowerCase()},searchOptions:{fuzzy:.3}}),f.miniSearch.addAll(n),f.miniSearchLoaded=!0,i(null,e)})}function l(){var e={prefix:!0};n.fields&&(e.fields=n.fields),void 0!==n.fuzzy&&(e.fuzzy=n.fuzzy),void 0!==n.prefix&&(e.prefix=n.prefix),void 0!==n.filter&&(e.filter=n.filter);e=f.miniSearch.search(a,e);f.checkAndSaveMissedKeywords(a,e),t(null,{plugins:e})}a&&f.miniSearchLoaded?n.reload?i(function(){l()}):l():i(a?function(){l()}:t)},f.instanceExists=function(t,i){var e=window.siteConfig.endPoints.pluginHost+"/"+t.folderName+"/plugin.json?v="+(t.lastUpdatedOn||""),a={isInUse:!1};r.get(e).success(function(e){e.singleton?l.getPluginInstances(t,function(e,n){e?i(e):(0<(n=n.filter(function(e){return e.data.pluginTypeId==t.pluginTypeId})).length&&(a.isInUse=!0,a.matches=n),i(null,a))}):i(null,a)}).error(function(e){i(e)})},f.getPlanType=function(e){var n=null;if(e.stripePlan)try{n=JSON.parse(e.stripePlan)}catch(e){}switch(n.type){case"subscriptions":return"subscriptions";case"onetime":case e.price&&0<e.price:return"onetime";default:return"free"}},f}]);
"use strict";$app.service("pluginManager",["$http","$rootScope",function(e,n){var o={revokedPlugins:null,checkIfPluginIsRevoked:function(i,r){function e(){var e=!1;if(o.revokedPlugins)for(var n=0;n<o.revokedPlugins.length;n++)if(o.revokedPlugins[n].token==i){e=!0;break}r&&r(e)}o.revokedPlugins?e():u(e)},removeRevokedPlugin:function(e){if(o.revokedPlugins)for(var n=0;n<o.revokedPlugins.length;n++)if(o.revokedPlugins[n].pluginTypeId==e){o.revokedPlugins.splice(n,1);break}}},u=function n(i){e.get("/api/appPluginTypes/revoked",{params:{appId:window.appContext.currentApp.appId}}).success(function(e){o.revokedPlugins=e,i&&i(),setTimeout(n,3e5)}).error(function(e){i&&i()})};return o}]);
"use strict";$app.service("marketplaceServices",["$rootScope","$http","$timeout","$location","commonPluginService","addPluginService",function(s,i,t,o,d,c){var g,m=appContext.currentApp.appId,n=window.siteConfig.endPoints.datastoreHost,u=window.user.username,P={isPluginFree:function(e){return e.wasPurchased||0==e.price||!e.price},markPurchased:function(e){return e.map(function(e){return e.license&&(e.wasPurchased=!0),e})},_marketplacePromotedData:null,_trackAction:function(){c._trackAction.apply(c,arguments)},_daysDiff:function(e,n){if(!e||!n)return!1;e=e.getTime(),n=n.getTime(),e=Math.abs(n-e);return Math.round(e/864e5)},markPluginPurchased:function(e){if(P._marketplacePromotedData)for(var n=0;n<P._marketplacePromotedData.length;n++)if(P._marketplacePromotedData[n].token==e.token){P._marketplacePromotedData[n].wasPurchased=!0;break}},removePromotedPlugin:function(e){if(P._marketplacePromotedData)for(var n=0;n<P._marketplacePromotedData.length;n++)if(P._marketplacePromotedData[n].token==e.token){P._marketplacePromotedData.splice(n,1);break}},_getPluginConfig:function(o){return new Promise(function(n,t){o&&o.folderName||t({message:"missing pluginFolder in plugin"});var e=window.siteConfig.endPoints.pluginHost+"/"+o.folderName+"/plugin.json?v="+(o.lastUpdatedOn||"");i.get(e).success(function(e){n(e)}).error(function(e){t(e)})})},_setUserReachedPlugins:function(e){e={lastSyncDate:new Date,plugins:e};localStorage.setItem("marketplace_"+window.appContext.currentApp.appId+"_promoted_plugins",JSON.stringify(e))},_getUserReachedPlugins:function(){var n=localStorage.getItem("marketplace_"+window.appContext.currentApp.appId+"_promoted_plugins");try{n=JSON.parse(n)}catch(e){n={plugins:{}}}return n||{plugins:{}}},getPlugins:function(l){return new Promise(function(a,n){var r=P,e="promoted";function t(t){var e,i;function o(){for(var e=[],n=0;n<t.length;n++)l.excludedPlugins[t[n].token]||e.push(t[n]);a(function(e){for(var n,t,o=e.length;0<o;)t=Math.floor(Math.random()*o),n=e[--o],e[o]=e[t],e[t]=n;return e}(e))}t?l.excludeInstalledPlugins?(e=t.map(function(e){return e.token}),i=e,new Promise(function(t,o){var e,n;!r._installedPlugins||l.reloadInstalledPlugins?(e=new DatastoreAPI(appContext.currentApp.appId,"pluginInstances",1,0,appContext.currentApp.keys.datastoreKey),n={},i&&(n["$json.token"]={$in:i||[]}),e.search({obj:{filter:n,fields:["token"],page:0,pageSize:100},tag:""},function(e,n){e?o(e):(r._installedPlugins=n,r._installedPlugins||(r._installedPlugins=[]),t(n||[]))})):t(r._installedPlugins)}).then(function(e){for(var n=0;n<e.length;n++)l.excludedPlugins[e[n].data.token]=e[n].data;o()})):o():a(t=[])}l?(l.excludedPlugins||(l.excludedPlugins={}),void 0===l.excludeInstalledPlugins&&(l.excludeInstalledPlugins=!0),void 0===l.reloadPromotedPlugins&&(l.reloadPromotedPlugins=!1),void 0===l.reloadInstalledPlugins&&(l.reloadInstalledPlugins=!1)):l={excludedPlugins:{},excludeInstalledPlugins:!0,reloadPromotedPlugins:!1,reloadInstalledPlugins:!1},e="suggestion"===l.type?"suggestion":"promoted",8===userContext.role.roleId&&(r._marketplacePromotedData=[]),l.appType||!r._marketplacePromotedData||l.reloadPromotedPlugins?i.get("/api/marketplace/whitelabel/"+window.whitelabelContext.whitelabelId+"/plugins/"+e,{params:{appId:appContext.currentApp.appId,appType:l.appType||null}},{}).success(function(e){e&&e[0]&&e&&e[0]&&(l.appType?t(r.markPurchased(e[0])):(r._marketplacePromotedData=e[0],r._marketplacePromotedData=r.markPurchased(r._marketplacePromotedData),t(r._marketplacePromotedData)))}).error(function(e){e&&console.error("Marketplace Service: get promoted plugins",e),n(e)}):t(r._marketplacePromotedData)})},showPopup:function(i){var a=P,r=window.siteConfig.endPoints.pluginHost.replace("http:","https:");a._getPluginConfig(i).then(function(e){!function(e){a._trackAction("cp/promotedPluginNotification/reach",null,i.token,{appId:window.appContext.currentApp.appId}),o();var n=document.querySelector("#marketplace-plugins-promotion_template").content.cloneNode(!0);document.querySelector("body").appendChild(n);var t=document.querySelector("#cpSideMenu .app-components").getBoundingClientRect(),n=document.querySelector("#marketplace-plugins-promotion");n.style.left="17px",n.style.top=t.height+t.top+8+"px";n=document.querySelector("#marketplace-plugins-promotion");n.querySelector("#plugin-promotion-name").innerText=i.pluginTypeName||"";t=i.description;t&&170<t.length&&(t=t.substring(0,165)+"...");n.querySelector("#plugin-promotion-description").innerText=t||"";t=ImageLibAPI.tools.resizeImage(r+"/"+i.folderName+"/resources/icon.png?v="+(i.lastUpdatedOn||""),{width:256,height:256,disablePixelRation:!0});n.querySelector("#plugin-promotion-icon").src=t;t=ImageLibAPI.tools.resizeImage(r+"/"+i.folderName+"/resources/image.png?v="+(i.lastUpdatedOn||""),{width:480,height:270,disablePixelRation:!0});e&&e.media&&e.media[0]&&"image-resource"==e.media[0].type&&(t=ImageLibAPI.tools.resizeImage(r+"/"+i.folderName+"/resources/"+e.media[0].path,{width:480,height:270,disablePixelRation:!0}));n.querySelector("#plugin-promotion-image").src=t,document.querySelector("#cpSideMenu .app-components .main-item-title").classList.add("promoted-badge");t=new Audio("/ghost.mp3").play();void 0!==t&&t.then(function(){}).catch(function(e){});function o(){document.querySelector("#cpSideMenu .app-components .main-item-title").classList.remove("promoted-badge"),document.querySelector("#marketplace-plugins-promotion")&&(document.querySelector("#marketplace-plugins-promotion").classList.remove("bounceInLeft"),document.querySelector("#marketplace-plugins-promotion").classList.add("bounceOutLeft"),setTimeout(function(){document.querySelector("#marketplace-plugins-promotion")&&document.querySelector("#marketplace-plugins-promotion").remove()},3e3))}n.querySelector("#plugin-promotion-close-btn").addEventListener("click",function(e){a._trackAction("cp/promotedPluginNotification/close",null,i.token,{appId:window.appContext.currentApp.appId}),e.stopPropagation(),o()}),n.querySelector(".promoted-body").addEventListener("click",function(e){o(),window.openDialog({templateUrl:"/pages/plugins/addPlugin/modals/pluginDetails.html",controller:"pluginDetailsCtrl",size:"lg",data:{plugin:i,options:{popupPromotions:!0}}})}),setTimeout(function(){o()},6e4)}(e)},function(e){console.error("MarketplaceServices","showPopup","Error in getting plugin config ")})},startPopupPromotions:function(){var n,e,t,o,i=P;i.popupPromotionsBusy||(e=!(i.popupPromotionsBusy=!0),(n=i._getUserReachedPlugins())&&n.lastSyncDate?(t=new Date,o=n.lastSyncDate?new Date(n.lastSyncDate):new Date,1<=i._daysDiff(o,t)&&(e=!0)):e=!0,e?i.getPlugins({excludedPlugins:n.plugins}).then(function(e){e&&0<e.length&&(e=e[Math.floor(Math.random()*e.length)],n.plugins||(n.plugins={}),n.plugins[e.token]=e,i._setUserReachedPlugins(n.plugins),i.showPopup(e)),i.popupPromotionsBusy=!1},function(e){i.popupPromotionsBusy=!1}):i.popupPromotionsBusy=!1)},coreFeaturesSuggestions:{search:function(e,r){var l,e=(e=e||{}).query,u=[];!e||(e=e.toLowerCase()).length<3?r(null,[]):(l=new RegExp("\\b"+e+"\\b","i"),i.get("/bf-marketplace-core-features.json",{}).success(function(e){var n=e&&e.data;if(n){for(var t=0;t<n.length;t++){var o=n[t].title&&n[t].title||"",i=n[t].description&&n[t].description||"",a=n[t].keywords&&n[t].keywords||"";-1==o.search(l)?-1==a.search(l)&&-1==i.search(l)||u.push(n[t]):u.unshift(n[t])}3<u.length&&(u.length=3)}r(null,u)}))},goTo:function(e,n){if((e=e||{}).feature&&e.searchQuery)switch(P._trackAction("cp/marketplace/core-feature-suggestion/click",window.appContext.currentApp.appId,null,{feature:e.feature,searchQuery:e.searchQuery}),e.feature.type){case"article":e.feature.url&&window.open(e.feature.url,"_blank");break;case"plugin":return n(null,e.feature);case"core":e.feature.url&&o.path(e.feature.url)}n()}},viewDetails:function(e,n){n=n||{},window.openDialog({templateUrl:"/pages/plugins/addPlugin/modals/pluginDetails.html",controller:"pluginDetailsCtrl",size:"lg",data:{plugin:e,options:n}},function(){})},addPlugin:function(e){var t=e.plugin,o=e.onProgress,i=e.onClose,a=e.onError,r=e.onComplete,l=e.hideAddToSideMenuCheckbox,u=e.skipRedirect,p=P.isPluginFree(t),e={domain:n,appId:m,folderName:t.folderName,pluginTypeId:t.pluginTypeId,lastUpdatedOn:t.lastUpdatedOn,token:t.token};d.instanceExists(e,function(e,n){return e?console.error(e):void(n.isInUse?(n={token:(n=n.matches[0].data).token,pluginInstanceId:n.instanceId,pluginTitle:n.title,folderName:n._buildfire.pluginType.result[0].folderName},toast("Singleton. Redirecting to instance.","warning"),d.redirectToInstance(n)):p?P.openAddPageDialog({plugin:t,onProgress:o,onClose:i,onError:a,onComplete:r,hideAddToSideMenuCheckbox:l,skipRedirect:u}):P.purchase({plugin:t,onProgress:o,onClose:i,onError:a,onComplete:r,hideAddToSideMenuCheckbox:l,skipRedirect:u}))})},openAddPageDialog:function(e){var o=e.plugin,i=e.onError,a=e.onComplete,n=e.hideAddToSideMenuCheckbox,r=e.skipRedirect;o&&(n={templateUrl:"/pages/plugins/addPlugin/modals/addPage.html",controller:"addPageCtrl",size:"sm",data:{options:{hideAddToSideMenuCheckbox:n,pluginTypeName:o.pluginTypeName},addingHandler:function(e){var t;e&&"addPage"==e.operation&&null!=e.title&&(t=e.$dialog,c.addPluginToDataStore({appId:appContext.currentApp.appId,addToSideMenu:e.addToSideMenu,title:e.title},o,function(e,n){t.close(),e?"plugin_inactive"===e&&(toast("Invalid to add, the plugin is inactive","danger"),i&&i(e)):(a&&a("Plugin added successfully"),r?s.$broadcast("onCreateNewPlugin",{}):(window["plugin-".concat(n.pluginInstance.obj.instanceId)]={clientCreatedOn:new Date},window.location.hash="/pluginControl/"+o.token+"/"+n.pluginInstance.obj.instanceId+"/"+encodeURIComponent(n.pluginInstance.obj.title)+"/"+n.folderName+"/false"))}))}}},window.openDialog(n))},purchase:function(e){var t=e.plugin,n=e.onProgress,o=e.onClose,i=e.onError,a=e.onComplete,r=e.hideAddToSideMenuCheckbox,l=e.skipRedirect;t._DisableButton=!0;var u=new StripeAPI({apiKeys:{awsApiPublicKey:t.awsAPIPublicKey,stripePublicKey:t.publishableKey},appId:m}),p={onProgress:function(e){h(t,e,n),n&&n()},onClose:function(){g&&(g.close(),t._DisableButton=!1),o&&o()}};"subscriptions"==c.getPlanType(t)?(e=JSON.parse(t.stripePlan),u.subscribe({openPaymentWindow:!1,items:[{planId:e.planId,quantity:1}],trialPeriodDays:e.trialDays,metaData:{appId:m,pluginName:t.pluginTypeName,pluginTypeId:t.pluginTypeId,token:t.token},events:p},function(e,n){if(e)return window.toast("Error in plugin subscription","danger"),delete t._DisableButton,void(i&&i(e));P._trackAction("cp/marketplace/pluginSubscribe",null,t.token,{plugin:{pluginTypeId:t.pluginTypeId,pluginTypeName:t.pluginTypeName,marketItemId:t.marketItemId}}),f({plugin:t,appId:m,clientReferenceId:n.client_reference_id,userId:window.user.userId,hideAddToSideMenuCheckbox:r,skipRedirect:l},function(e,n){delete t._DisableButton,e?i&&i(e):(t.wasPurchased=!0,s.$broadcast("pluginPurchased",t),a&&a("Plugin purchased successfully"))})})):u.charge({openPaymentWindow:!1,items:[{amount:parseInt((100*t.price).toFixed(0)),quantity:1,name:t.pluginTypeName}],events:p},function(e,n){if(e)return window.toast("Error in plugin purchasing","danger"),void delete t._DisableButton;P._trackAction("cp/marketplace/pluginPurchase",null,t.token,{plugin:{pluginTypeId:t.pluginTypeId,pluginTypeName:t.pluginTypeName,marketItemId:t.marketItemId}}),f({plugin:t,appId:m,clientReferenceId:n.client_reference_id,userId:window.user.userId,hideAddToSideMenuCheckbox:r,skipRedirect:l},function(e,n){delete t._DisableButton,e?i&&i(e):(t.wasPurchased=!0,s.$broadcast("pluginPurchased",t),a&&a("Plugin purchased successfully"))})})},showTryButton:function(e){if(e.wasPurchased)return!1;if(P.isPluginFree(e))return!1;var n=null;if(e.stripePlan)try{n=JSON.parse(e.stripePlan)}catch(e){}return!(!n||"subscriptions"!=n.type)},getPluginPrice:function(e){if(e.wasPurchased)return"";var n=P.isPluginFree(e),t=n?"Free":"$"+e.price,n=null;if(e.stripePlan)try{n=JSON.parse(e.stripePlan)}catch(e){}return t=n&&"subscriptions"==n.type?null:t}};function f(e,t){var o=e.plugin,n=e.appId,i=e.clientReferenceId,a=e.userId,r=e.hideAddToSideMenuCheckbox,l=e.skipRedirect,a={clientReferenceId:i,pluginId:o.pluginTypeId,appId:n,userId:a,email:u};o.addingLicense=!0,c.addLicense(a,function(e,n){return delete o.addingLicense,e?(t(e),void toast("Error with feature purchase","danger")):(crm.log("Purchased plugin: "+o.pluginTypeName),crm.set({lastPurchasedPlugin:o,lastPurchasedOn:new Date}),crm.inc({pluginsPurchased:1,totalSpent:o.price}),o.wasPurchased=!0,P.openAddPageDialog({plugin:o,hideAddToSideMenuCheckbox:r,skipRedirect:l}),void(t&&t(null,n)))})}var h=function(n,e,t){g=window.openDialog({templateUrl:"/pages/plugins/addPlugin/modals/paymentInProgressDialog.html",controller:"paymentInProgressDialogCtrl",size:"sm",data:{options:{invokePaymentWindow:e}},backdrop:"static",keyboard:!1},function(e){"close"===e&&(delete n._DisableButton,t&&t())})};return s.$on("pluginPurchased",function(e,n){n&&(P.markPluginPurchased(n),t(function(){P.removePromotedPlugin(n)},5e3))}),s.$on("pluginInserted",function(e,n){n&&P.removePromotedPlugin({token:n})}),s.$on("pluginDeleted",function(e,n){P.getPlugins({reloadPromotedPlugins:!0,reloadInstalledPlugins:!0})}),P}]);
"use strict";$app.service("$searchEngineService",[function(){return{save:function(e,i){(e=e||{}).pluginId?e.instanceId?e.key?e.tag?e.title?searchEngineAPI?new searchEngineAPI({appId:appContext.currentApp.appId,instanceId:e.instanceId,pluginId:e.pluginId}).save({key:e.key,tag:e.tag,title:e.title},function(e,n){e&&console.error("Search Engine Service","add plugin title to searchEngineAPI",e),i&&i(e,n)}):console.error("Search Engine Service","searchEngineAPI is undefined"):console.error("Search Engine Service","save method","Missing options (title)"):console.error("Search Engine Service","save method","Missing options (tag)"):console.error("Search Engine Service","save method","Missing options (key)"):console.error("Search Engine Service","save method","Missing options (instanceId)"):console.error("Search Engine Service","save method","Missing options (pluginId)")},savePluginTitle:function(e,i){(e=e||{}).pluginId?e.instanceId?e.title?(e.key="$_buildfire_controlPanel_pluginTitle",e.tag="appPlugins",this.save(e,function(e,n){i&&i(e,n)}),i&&i(null,!0)):console.error("Search Engine Service","savePluginTitle Method","Missing options (title)"):console.error("Search Engine Service","savePluginTitle Method","Missing options (instanceId)"):console.error("Search Engine Service","savePluginTitle Method","Missing options (pluginId)")}}}]);
"use strict";function _classCallCheck(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,n){for(var i=0;i<n.length;i++){var t=n[i];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(e,t.key,t)}}function _createClass(e,n,i){return n&&_defineProperties(e.prototype,n),i&&_defineProperties(e,i),e}var DeeplinksAPI=function(){function n(e){_classCallCheck(this,n),this.appData=new AppDatastoreAPI(e)}return _createClass(n,[{key:"searchDeeplinks",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},n=1<arguments.length?arguments[1]:void 0;if(!e.instanceId)return n({message:"instanceId not provided"},null);var i={filter:{"_buildfire.index.string1":e.instanceId},sort:{"_buildfire.index.text":1}};e.pageSize&&(i.pageSize=e.pageSize),0<=e.pageIndex&&(i.page=e.pageIndex),e.deeplinkName&&(i.filter["_buildfire.index.text"]={$regex:null!=e.deeplinkName?e.deeplinkName:"",$options:"i"}),this.appData.search({obj:i,tag:"$$deeplinks"},n)}},{key:"getDeeplinkById",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},n=1<arguments.length?arguments[1]:void 0;if(!e.instanceId)return n({message:"instanceId not provided"},null);if(!e.deeplinkId)return n({message:"deeplinkId not provided"},null);var i={filter:{"_buildfire.index.string1":e.instanceId}};i.filter["_buildfire.index.array1.string1"]=e.deeplinkId,this.appData.search({obj:i,tag:"$$deeplinks"},n)}}]),n}();
"use strict";window.pluginInstancesManager=function(){var e="MY_FEATURES_ADD",d="MY_FEATURES_DELETE",i="MY_FEATURES_OPEN";return{events:{added:function(n){window.dispatchEvent(new CustomEvent(e,{detail:{data:n}}))},deleted:function(n){window.dispatchEvent(new CustomEvent(d,{detail:{data:n}}))},opened:function(n){window.dispatchEvent(new CustomEvent(i,{detail:{data:n}}))},onAdded:function(t){window.addEventListener(e,function(n){n=n.detail.data;t&&t(n)},!1)},onDeleted:function(t){window.addEventListener(d,function(n){n=n.detail.data;t&&t(n)},!1)},onOpened:function(t){window.addEventListener(i,function(n){n=n.detail.data;t&&t(n)},!1)}}}}();
"use strict";$app.factory("upgradePlanService",["$timeout","$http","authManager","$analytics",function(t,e,n,r){var a={appId:window.appContext.currentApp.appId,pluginId:"publishingInfo",instanceId:"publishingInfo",liveMode:0,writeKey:window.appContext.currentApp.keys.datastoreKey},p=(new DatastoreAPI(a),{getUpgradeUrl:function(){return"http://".concat(whitelabelContext.cpDomain,"/app/").concat(encodeURIComponent(window.appContext.currentApp.appId),"/payments/upgrade")},getBillingPortalUrl:function(){return r.eventTrack("cp/billingPortal"),"".concat(p.getUpgradeUrl(),"?navigate=billing_portal")},upgrade:function(){n.getCurrentUser()?(crm&&(crm.set({clickedOnUpgrade:Date.now()}),crm.set({clickedOnUpgradeCount:1})),r.eventTrack("cp/upgradeClick"),t(function(){window.location.href="/app/".concat(encodeURIComponent(window.appContext.currentApp.appId),"/payments/upgrade")})):n.logout()},redirectToBillingPortal:function(){n.getCurrentUser()?window.location.href=p.getBillingPortalUrl():n.logout()}});return p}]);
"use strict";$app.factory("userService",["$http",function(o){return{searchTags:function(t){var n="";return window.siteConfig&&window.siteConfig.endPoints&&window.siteConfig.endPoints.appHost&&"sdk"==window.siteConfig.scope&&(n=window.siteConfig.endPoints.appHost),o.get(n+"/api/userTagging/searchTags/"+window.userContext.currentApp.appId+"/",{params:t}).then(function(t){return{tags:(t=t.data)&&0<t.tagsCount?t.tags:[],count:t&&t.tagsCount?t.tagsCount:0}}).catch(function(t){console.error(t)})}}}]);
"use strict";$app.service("searchService",["$rootScope","$http",function(e,n){var t={},r="lastOpenedPlugins_"+window.appContext.currentApp.appId,a="lastAddedPlugins_"+window.appContext.currentApp.appId,i=new DatastoreAPI(appContext.currentApp.appId,"pluginInstances",1,0,appContext.currentApp.keys.datastoreKey);t.searchMyFeatures=function(e,n,t){i.search({obj:{filter:{$or:[{"$json.title":{$regex:null!=e?e:"",$options:"i"}},{"$json.token":e}]},withDynamicData:!0,limit:n,skip:0},tag:""},function(e,n){e||(null!=n&&0<n.length?t(n):t([]))})},t.searchMyFeaturesByType=function(e,n,t){0!==e.length?i.search({obj:{filter:{$or:e},withDynamicData:!0,limit:n,skip:0},tag:""},function(e,n){e||(null!=n&&0<n.length?t(n):t([]))}):t([])},t.getLastOpenedPlugins=function(e){var n=window.localStorage.getItem("searchService");return(n=n?JSON.parse(n):null)&&n[r]?n[r].slice(0,e):[]},t.getLastAddedPlugins=function(e){var n=window.localStorage.getItem("searchService");return(n=n?JSON.parse(n):null)&&n[a]?n[a].slice(0,e):[]},window.pluginInstancesManager.events.onOpened(function(e){o(e)}),window.pluginInstancesManager.events.onDeleted(function(e){c(e)}),window.pluginInstancesManager.events.onAdded(function(e){s(e)});var o=function(n){var e=window.localStorage.getItem("searchService");return(e=e?JSON.parse(e):null)?e&&!e[r]?e[r]=[n]:(-1===e[r].findIndex(function(e){return e.data.instanceId===n.data.instanceId})||(e[r]=e[r].filter(function(e){return e.data.instanceId!==n.data.instanceId})),e[r].unshift(n),5<e[r].length&&e[r].pop()):(e={})[r]=[n],void window.localStorage.setItem("searchService",JSON.stringify(e))},c=function(n){var e=window.localStorage.getItem("searchService");(e=e?JSON.parse(e):null)&&e[r]&&(e[r]=e[r].filter(function(e){return e.data.instanceId!==n.data.instanceId}),window.localStorage.setItem("searchService",JSON.stringify(e)))};t.refreshLastOpenedPluginsInLocalStorage=function(){var e,a=(a=window.localStorage.getItem("searchService"))?JSON.parse(a):null;a&&a[r]&&(e=a[r].map(function(e){return e.data.pluginTypeId}),i.search({obj:{filter:{"$json.pluginTypeId":{$in:e}},withDynamicData:!1,skip:0},tag:""},function(e,n){var t;e||(t=[],null!=n&&0<n.length&&(t=n.map(function(e){return e.data.pluginTypeId})),a[r]=a[r].filter(function(e){return-1<t.indexOf(e.data.pluginTypeId)}),window.localStorage.setItem("searchService",JSON.stringify(a)))}))};var s=function(n){var e=window.localStorage.getItem("searchService");return(e=e?JSON.parse(e):null)?e&&!e[a]?e[a]=[n]:(-1===e[a].findIndex(function(e){return e.token===n.token})||(e[a]=e[a].filter(function(e){return e.token!==n.token})),e[a].unshift(n),5<e[a].length&&e[a].pop()):(e={})[a]=[n],void window.localStorage.setItem("searchService",JSON.stringify(e))};return t.refreshLastOpenedPluginsInLocalStorage(),t}]);