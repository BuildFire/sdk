var imageLibCurrentApp=null;function ImageLibAPI(e){this.context={},angular.copy(e,this.context),this.context.datastoreWriteKey&&(this.context.writeKey=this.context.datastoreWriteKey),this.init()}$app.directive("scrolly",function(){return{restrict:"A",link:function(e,t,o){var i=t[0];console.log("loading directive"),t.bind("scroll",function(){i.scrollTop+i.offsetHeight+10>=i.scrollHeight&&e.$apply(o.scrolly)})}}}),ImageLibAPI.prototype={init:function(e){imageLibCurrentApp=this},showDialog:function(e,t){this&&this.context&&(imageLibCurrentApp.context=this.context),imageLibCurrentApp.options=e;var o="pages/imageLib/imageLib.html";void 0!==imageLibCurrentApp&&imageLibCurrentApp.imageLibTemplate&&(o=imageLibCurrentApp.imageLibTemplate);var i={templateUrl:o,controller:"imageLibCtrl",size:"lg"};window.openDialog(i,function(e){t&&t(null,e)})}},ImageLibAPI.tools={resizeImage:function(e,t){if(!e)return null;var o=t.disablePixelRation?1:window.devicePixelRatio;if(t){if("object"!=typeof t)throw"options not an object"}else t={width:window.innerWidth};"full"==t.width&&(t.width=window.innerWidth),"full"==t.height&&(t.height=window.innerHeight);var i=("https:"==window.location.protocol?"https:":"http:")+"//czi3m2qn.cloudimg.io/s/";return t.width&&!t.height?i+"width/"+Math.floor(t.width*o)+"/"+e:!t.width&&t.height?i+"height/"+Math.floor(t.height*o)+"/"+e:t.width&&t.height?i+"resizenp/"+Math.floor(t.width*o)+"x"+Math.floor(t.height*o)+"/"+e:e},cropImage:function(e,t){if(!e)return null;var o=t.disablePixelRation?1:window.devicePixelRatio;if("object"!=typeof t)throw"options not an object";return t.width||t.height||(t={width:"full",height:"full"}),"full"==t.width&&(t.width=window.innerWidth),"full"==t.height&&(t.height=window.innerHeight),t.width&&t.height?("https:"==window.location.protocol?"https:":"http:")+"//czi3m2qn.cloudimg.io/s/crop/"+Math.floor(t.width*o)+"x"+Math.floor(t.height*o)+"/"+e:(console.warn("cropImage doenst have width or height please fix. returning original url"),e)}},$app.controller("imageLibRemoveCtrl",["$scope","$http","$dialog","$data",function(e,t,o,i){e.close=function(){o.close(null)},e.confirm=function(){o.close(i)}}]),$app.controller("imageLibCtrl",["$scope","Upload","$http","$dialog","$interval","$timeout","angularGridInstance",function(l,s,g,n,c,e,t){l.readyToShowFiles=!1,l.tools=ImageLibAPI.tools,l.invalidFileType=l.showProgressMessage=l.showSuccessMessage=l.showErrorMessage=l.invalidFileSize=!1,l.hideMessage=function(){l.invalidFileType=l.showProgressMessage=l.showSuccessMessage=l.showErrorMessage=!1},l.showMessage=function(e){l.hideMessage(),l[e]=!0};var o=null;l.files=[],l.selectedFiles={},l.stockImages=[],l.selectedStockImages={},l.selectedIcons={},l.iconsShown=!1,l.filesShown=!1,l.stockShown=!1,l.iconsActive=!1,l.filesActive=!1,l.stockActive=!1,l.activeType=function(e){l.iconsActive=!1,l.filesActive=!1,l.stockActive=!1,void 0!==e&&(l[e]=!0)},l.activeFiles=function(){l.selectedFiles={},l.activeType("filesActive")},l.activeIcons=function(){l.selectedIcons={},l.activeType("iconsActive")},l.activeStockImages=function(){l.selectedStockImages={},l.activeType("stockImagesActive")},l.isImageSelected=!1,l.clearSelection=function(){if(l.isImageSelected=!1,l.selectedFiles={},l.files)for(var e=0;e<l.files.length;e++)l.files[e].selected=!1;if(l.selectedIcons={},l.icons)for(e=0;e<l.icons.length;e++)l.icons[e].selected=!1;if(l.selectedStockImages={},l.stockImages)for(e=0;e<l.stockImages.length;e++)l.stockImages[e].selected=!1},l.close=function(){n.close({selectedFiles:[],selectedIcons:[],selectedStockImages:[]})},l.insertSelection=function(){var e=[];if(l.selectedFiles)for(var t in l.selectedFiles)t&&l.selectedFiles[t]&&e.push(l.selectedFiles[t]);var o=[];if(l.selectedIcons)for(var i in l.selectedIcons)i&&l.selectedIcons[i]&&o.push(l.selectedIcons[i]);if(l.selectedStockImages){for(var s in l.selectedStockImages)s&&l.selectedStockImages[s]&&e.push(l.selectedStockImages[s]);l.appendStockImageToSavedList(l.selectedStockImages),h(l.selectedStockImages)}n.close({selectedFiles:e,selectedIcons:o})},l.appendStockImageToSavedList=function(e){if(!(50<=l.cachedStockImages.length)){var t=!1;for(var o in e){var i=a(o);r(i)||(i.selected=!1,l.cachedStockImages.push(i),t=!0)}t&&l.saveStockImages(l.cachedStockImages)}};var a=function(e){for(var t in l.stockImages)if(l.stockImages[t].key==e)return l.stockImages[t]},r=function(e){for(var t in l.cachedStockImages)if(l.cachedStockImages[t].key==e.key)return!0;return!1};l.saveStockImages=function(e){o.save({tag:"",obj:e},function(e,t){})},l.showRecentUsedLabel=!1,l.getStockImages=function(){l.stockImages=[],o.get({tag:""},function(e,t){if(e)console.error(e);else if(t&&t.data){if(l.cachedStockImages=[],t.data.length&&0!=t.data.length){for(imageIndex in t.data)t.data[imageIndex].isCached=!0,l.atLeastOneSearchMade=!0,l.cachedStockImages.push(t.data[imageIndex]);l.showRecentUsedLabel=!0}else l.stockImageSearch();l.stockImages=l.cachedStockImages}})},l.selectFile=function(e){"mediaLibraryManagement"!=l.mode&&(imageLibCurrentApp.options&&!1===imageLibCurrentApp.options.multiSelection&&l.clearSelection(),e&&(l.isImageSelected=!0,e.selected=!e.selected,e.selected?l.selectedFiles[e.key]=e.url:delete l.selectedFiles[e.key]))},l.selectIcon=function(e){imageLibCurrentApp.options&&!1===imageLibCurrentApp.options.multiSelection&&l.clearSelection(),e&&(l.isImageSelected=!0,e.selected=!e.selected,e.selected?l.selectedIcons[e.key]=e.class:delete l.selectedIcons[e.class])},l.selectStockImage=function(e){imageLibCurrentApp.options&&!1===imageLibCurrentApp.options.multiSelection&&l.clearSelection(),e&&(l.isImageSelected=!0,e.selected=!e.selected,e.selected?l.selectedStockImages[e.key]=e.url:delete l.selectedStockImages[e.key])},l.$watch("uploadFiles",function(){l.upload(l.uploadFiles)}),l.removeFilePopup=function(e){var t={templateUrl:"imageLibRemove.html",controller:"imageLibRemoveCtrl",data:e,size:"sm"};window.openDialog(t,l.removeFile)},l.removeStockImagePopup=function(e){var t={templateUrl:"imageLibRemove.html",controller:"imageLibRemoveCtrl",data:e,size:"sm"};window.openDialog(t,l.removeStockImage)},l.removeStockImage=function(e){void 0!==e&&null!=e&&l.cachedStockImages[e]&&l.cachedStockImages[e].key&&(l.cachedStockImages.splice(e,1),l.saveStockImages(l.cachedStockImages))},l.removeFile=function(s){if(void 0!==s&&null!=s)if(l.files[s]&&l.files[s].key){var e=window.siteConfig.endPoints.datastoreHost+"/app/"+imageLibCurrentApp.context.appId+"/image/delete";g.post(e,{key:l.files[s].key},{headers:{writekey:imageLibCurrentApp.context.writeKey}}).success(function(e,t,o,i){l.files.splice(s,1),l.refreshFiles()}).error(function(e,t,o,i){console.error(e)})}else console.log("invalid key to remove")},l.refreshFiles=function(){l.$$phase||l.$digest(),e(function(){t.gallery.refresh()},1e3)};var d=function(t,o){if(t)if(l.files.find(function(e){return e.url==t.url}))o&&o();else{var e=new Image;e.onload=function(e){t.actualHeight=this.height,t.actualWidth=this.width,o&&o(t)},e.onerror=function(){o&&o()},t.clientUrl=e.src=l.tools.resizeImage(t.url,{width:200})}else o&&o()};l.editFile=function(r){var t={templateUrl:"imageLibReplace.html",controller:"imageLibReplaceCtrl",data:r,size:"sm"};imageEditor.launchEditor("imgLibFile"+r,l.files[r].url,function(e,c){window.openDialog(t,function(e){var t,o,i,s,n,a;"replace"==e?(i=c,s=r,n=l.files[s],a=window.siteConfig.endPoints.datastoreHost+"/app/"+imageLibCurrentApp.context.appId+"/image/url",l.showMessage("showProgressMessage"),g.post(a,{imageUrl:i,existingImageKey:n.key},{headers:{writeKey:imageLibCurrentApp.context.writeKey}}).success(function(e){var t=angular.copy(n);t.url=n.url+"?cacheBuster="+Math.random(),d(t,function(e){e&&(l.files[s]=e),l.refreshFiles()}),l.showMessage("showSuccessMessage")}).error(function(e){console.log(e),l.showMessage("showErrorMessage")})):"dontReplace"==e&&(t=c,o=window.siteConfig.endPoints.datastoreHost+"/app/"+imageLibCurrentApp.context.appId+"/image/url",l.showMessage("showProgressMessage"),g.post(o,{imageUrl:t},{headers:{writeKey:imageLibCurrentApp.context.writeKey}}).success(function(e){d({key:e.key,url:e.url,selected:!1},function(e){e&&l.files.splice(0,0,e),l.refreshFiles(),document.getElementById("media-library-upload-imgs").scrollTop=0}),l.showMessage("showSuccessMessage")}).error(function(e){console.log(e),l.showMessage("showErrorMessage")}),l.$$phase||l.$digest())})},function(e){console.log(e)})};l.upload=function(e){var t=null;if(imageLibCurrentApp&&(t=window.siteConfig.endPoints.datastoreHost+"/app/"+imageLibCurrentApp.context.appId+"/image"),e&&e.length<1&&(l.invalidFileType=!0),e&&0<e.length){if(!function(e){var t=!0;l.invalidFileSize=!1;for(var o=0;o<e.length;o++)if(10485760<e[o].size){t=!1,l.invalidFileSize=!0;break}return t}(e))return;l.hideMessage();for(var o=0;o<e.length;o++){var i=e[o];s.upload({url:t,fields:{},file:i,headers:{writeKey:imageLibCurrentApp.context.writeKey}}).progress(function(e){l.progressMessage=!0;var t=parseInt(100*e.loaded/e.total);console.log("progress: "+t+"% "+e.config.file.name),l.showMessage("showProgressMessage")}).success(function(e,t,o,i){console.log("file "+i.file.name+"uploaded. Response: "+e),d({key:e.key,url:e.url,selected:!1},function(e){e&&l.files.splice(0,0,e),l.refreshFiles(),document.getElementById("media-library-upload-imgs").scrollTop=0}),l.showMessage("showSuccessMessage")}).error(function(e){l.showMessage("showErrorMessage")})}}};var p=[],u=[],i=!0;l.getFiles=function(e,n){if(imageLibCurrentApp){if(2<p.length)return void(l.loadingFiles=!0);var t=window.siteConfig.endPoints.datastoreHost+"/app/"+imageLibCurrentApp.context.appId+"/image";e||(e={}),void 0===e.startIndex?l.files&&l.files.length&&(e.startKey=l.files[l.files.length-1].key):l.files=[],i&&(l.loadingFiles=!0),i=!1,g.get(t,{params:e}).success(function(e){var i=12;function s(){if(p&&!(p.length<1))for(var e=0,t=0;e<i&&p&&!(p.length<1);){e++;var o=p.splice(0,1);o&&o[0]&&d(o[0],function(e){t++,e&&u.push(e),(i<=t||p.length<1)&&setTimeout(function(){for(var t=0;t<u.length;t++)l.files.find(function(e){return e.url==u[t].url})||l.files.push(u[t]);u=[],(!p||p.length<1)&&(l.loadingFiles=!1),l.readyToShowFiles=!0,l.$$phase||l.$digest(),setTimeout(function(){s()},100)},10)})}}for(var t=0;t<e.length;t++){var o=e[t];o.selected=!1,p.push(o)}0<p.length&&(l.loadingFiles=!0,s()),(!e||e.length<=0)&&(l.loadingFiles=!1,l.readyToShowFiles=!0),n&&n(null,e)}).error(function(e,t,o,i){console.error(e),n&&n(e,null)})}else n&&n({msg:"Invalid folder"},null)},void 0!==imageLibCurrentApp&&(imageLibCurrentApp.options||(imageLibCurrentApp.options={}),l.iconsShown=!(!1===imageLibCurrentApp.options.showIcons),l.filesShown=!(!1===imageLibCurrentApp.options.showFiles),l.stockShown=!(!1===imageLibCurrentApp.options.showStockImages),l.mode=imageLibCurrentApp.options.mode,l.stockShown&&(window.appContext&&window.appContext.currentApp&&window.appContext.currentApp.appId&&window.appContext.currentApp.keys&&window.appContext.currentApp.keys.datastoreKey?o=new DatastoreAPI({appId:window.appContext.currentApp.appId,pluginId:"stockImages",instanceId:"stockImages",liveMode:0,writeKey:window.appContext.currentApp.keys.datastoreKey}):(imageLibCurrentApp.options.showStockImages=!1,l.stockShown=!1,console.error("stockImages error: missing appId or datastoreKey")))),l.stockShown&&(l.activeTab=2,l.activeStockImages(),l.getStockImages()),l.iconsShown&&(l.activeTab=0,g.get(siteConfig.endPoints.appHost+"/styles/bootstrapIcons.css").success(function(e){var t=angular.element(document.querySelector("#iconsFrame"))[0],n=t.contentDocument;if(!n&&t&&t.contentWindow&&t.contentWindow.document&&(n=t.contentWindow.document),n){var o,i="<style id='iconStyle' type='text/css'>"+e+"</style>";n.head.innerHTML=i;var a=0,s=function(){a++;try{for(var e=n.styleSheets[n.styleSheets.length-1],t=e.rules||e.cssRules,o=[],i=0;i<t.length;i++)if(void 0!==t[i].selectorText&&0==t[i].selectorText.indexOf(".glyphicon-")){var s=t[i].selectorText.replace(".glyphicon-","");s=(s=(s=(s=s.replace("::before","")).replace(":before","")).replace(":after","")).replace("::after",""),o.indexOf(s)<0&&o.push({key:"glyphicon glyphicon-"+s,class:"glyphicon glyphicon-"+s,selected:!1})}l.icons=o}catch(e){if(10==a&&(l.stopInterval(),console.error("stop trying")),e&&"InvalidAccessError"==e.name)return void console.warn("icons css document not parsed yet");console.error(e)}l.stopInterval()};l.stopInterval=function(){angular.isDefined(o)&&(c.cancel(o),o=void 0)},o=c(s,50),s()}else console.warn("innerDoc was not found")}),l.activeIcons()),l.filesShown&&(l.activeTab=1,l.activeFiles(),l.getFiles({startIndex:0},function(){})),l.currentStockImagePage=1,l.totalStockImagesPages=1,l.showNoResultLabel=!1,l.atLeastOneSearchMade=!1,l.stockImageSearch=function(){l.stockImages=[],l.currentStockImagePage=1,l.retrieveStockImage()},l.retrieveStockImage=function(){if(l.stockImagesKeyword){var e=l.stockImagesKeyword?escape(l.stockImagesKeyword):"";l.loadingStockImage=!0,l.atLeastOneSearchMade=!0,g.post(siteConfig.endPoints.appHost+"/api/stockImages/search",{query:e,page:l.currentStockImagePage}).success(function(e){l.showRecentUsedLabel=!1,l.totalStockImagesPages=e.totalPages;var t=(new Date).getTime();l.showNoResultLabel=0==e.images.length;for(var o=0;o<e.images.length;o++){var i={key:t+"_"+o,url:e.images[o].urls.regular,imageId:e.images[o].imageId,photographerName:e.images[o].photographerName,selected:!1};l.stockImages.push(i)}l.loadingStockImage=!1}).error(function(e){console.error(e),l.loadingStockImage=!1})}},l.loadMoreStockImages=function(){l.stockActive&&!l.loadingStockImage&&l.totalStockImagesPages!=l.currentStockImagePage&&(l.currentStockImagePage++,l.retrieveStockImage())};var h=function(e){var t=[];for(var o in e){var i=a(o);i.imageId&&t.push(i.imageId)}0<t.length&&g.post(siteConfig.endPoints.appHost+"/api/stockImages/view",{ids:t}).success(function(e){}).error(function(e){})}}]),$app.controller("imageLibReplaceCtrl",["$scope","$http","$dialog","$data",function(e,t,o,i){e.close=function(){o.close(null)},e.confirm=function(e){o.close(e)}}]);
function ColorLibAPI(o){this.context={},angular.copy(o,this.context),this.init()}ColorLibAPI.prototype={init:function(){},showDialog:function(t,e){var r=this;t||(t={});var o="";window.siteConfig&&window.siteConfig.endPoints&&window.siteConfig.endPoints.appHost&&(o=window.siteConfig.endPoints.appHost);var i={templateUrl:o+"/pages/colorLib/colorLib.html",controller:"colorLibCtrl",size:"sm",backdrop:t.backdrop,position:t.position,data:{options:t,onChange:function(o,t){r._onChange&&r._onChange(t)}}};window.openDialog(i,function(o){e&&e(null,o||t.data)})},onChange:function(o){this._onChange=o}},$app.controller("colorLibCtrl",["$scope","$dialog","$data","$window",function(i,o,c,t){i.tools=ImageLibAPI.tools,i.appHost=window.siteConfig.endPoints.appHost,c.options||(c.options={}),i.gradientTypes={"to bottom":"Bottom","to right":"Right","to top left":"Top Left","to top right":"Top Right","to top":"Top","to left":"Left","to bottom left":"Bottom Left","to bottom right":"Bottom Right"},!c.options.data||angular.equals(c.options.data,{})?i.items={gradient:{colors:[{color:"",percentage:0,opacity:100},{color:"",percentage:100,opacity:100}],gradientType:"to bottom"},solid:{color:"",opacity:100}}:(i.items={},angular.copy(c.options.data,i.items),i.items.gradient||(i.items.gradient={colors:[{color:"",percentage:0,opacity:100},{color:"",percentage:100,opacity:100}],gradientType:"to bottom"}),i.items.solid||(i.items.solid={color:"",opacity:100})),i.colorTypes={};var e=i.items.colorType;function n(o,t){o||(o="#ffffff"),void 0===t&&(t=100);var e,i,c=o.substring(0,7);return i=t,e=(e=c).replace("#",""),r=parseInt(e.substring(0,2),16),g=parseInt(e.substring(2,4),16),b=parseInt(e.substring(4,6),16),"rgba("+r+","+g+","+b+","+i/100+")"}c.options.hideGradient?e="gradient"===e?null:"solid":(i.colorTypes.gradient="Gradient",e||(e="gradient")),c.options.hideSolid?e="solid"===e?null:"gradient":i.colorTypes.solid="Solid",i.items.colorType=e,angular.element(t).bind("mousedown",function(){i.config={},i.$apply()}),i.$watch("items.gradient",function(o,t){if(o){o.colors&&o.colors[0]&&o.colors[0].color&&-1<o.colors[0].color.indexOf("#")&&(o.colors[0].colorHex=o.colors[0].color),o.colors&&o.colors[0]&&(void 0===o.colors[0].percentage&&(i.items.gradient.colors[0].percentage=o.colors[0].percentage=0),void 0===o.colors[0].opacity&&(i.items.gradient.colors[0].opacity=o.colors[0].opacity=100)),i.items.gradient.colors[0].color=n(o.colors[0].colorHex,o.colors[0].opacity),o.colors&&o.colors[1]&&o.colors[1].color&&-1<o.colors[1].color.indexOf("#")&&(o.colors[1].colorHex=o.colors[1].color),o.colors&&o.colors[1]&&(void 0===o.colors[1].percentage&&(i.items.gradient.colors[1].percentage=o.colors[1].percentage=100),void 0===o.colors[1].opacity&&(i.items.gradient.colors[1].opacity=o.colors[1].opacity=100)),i.items.gradient.colors[1].color=n(o.colors[1].colorHex,o.colors[1].opacity);var e="background: linear-gradient({gradientType}, {colorOne} {colorOnePercentage}%, {colorTwo} {colorTwoPercentage}%)";e=(e=(e=(e=(e=e.replace("{gradientType}",o.gradientType)).replace("{colorOne}",o.colors[0]?o.colors[0].color:"")).replace("{colorOnePercentage}",o.colors[0]?o.colors[0].percentage:0)).replace("{colorTwo}",o.colors[1]?o.colors[1].color:"")).replace("{colorTwoPercentage}",o.colors[1]?o.colors[1].percentage:100),i.items.gradient.backgroundCSS=e,c.onChange&&c.onChange(null,i.items)}},!0),i.$watch("items.solid",function(o,t){o&&(o.color&&-1<o.color.indexOf("#")&&(o.colorHex=o.color),i.items.solid.color=n(o.colorHex,o.opacity),i.items.solid.backgroundCSS="background: "+i.items.solid.color,i.items.solid.colorCSS="color: "+i.items.solid.color,c.onChange&&c.onChange(null,i.items))},!0),i.$watch("items.colorType",function(o,t){o&&c.onChange&&c.onChange(null,i.items)},!0),i.save=function(){o.close(i.items)},i.closeDialog=function(){o.close(null)}}]);
var PopupLibAPI={confirm:function(t,e){t||(t={}),!1!==t.allowHtml&&(t.allowHtml=!0),t.message?(t.confirmButton||(t.confirmButton={text:"Confirm",type:"primary",key:"confirm"}),t.confirmButton.text||(t.confirmButton.text="Confirm"),t.confirmButton.key||(t.confirmButton.key="confirm"),t.confirmButton.type||(t.confirmButton.type="primary"),t.cancelButton||(t.cancelButton={text:"Cancel",type:"default",key:"cancel"}),t.cancelButton.text||(t.cancelButton.text="Cancel"),t.cancelButton.key||(t.cancelButton.key="cancel"),t.cancelButton.type||(t.cancelButton.type="default"),PopupLibAPI.showDialog({title:t.title||"Are you sure?",message:t.message,buttons:[t.confirmButton,t.cancelButton],size:t.size},e)):e("invalid parameter, missing message",null)},alert:function(t,e){t||(t={}),!1!==t.allowHtml&&(t.allowHtml=!0),t.message?(t.okButton||(t.okButton={text:"Ok",type:"primary",key:"ok"}),t.okButton.text||(t.okButton.text="Ok"),t.okButton.key||(t.okButton.key="ok"),t.okButton.type||(t.okButton.type="primary"),PopupLibAPI.showDialog({title:t.title||"Alert",message:t.message,buttons:[t.okButton],size:t.size},e)):e("invalid parameter, messing message",null)},showDialog:function(t,e){if(t||(t={}),!1!==t.allowHtml&&(t.allowHtml=!0),t.title){if(t.buttons&&0<t.buttons.length)for(var o=0;o<t.buttons.length;o++){if(!t.buttons[o].text)return void e("invalid parameter, missing text button");if(!t.buttons[o].key)return void e("invalid parameter, missing key button");t.buttons[o].type||(t.buttons[o].type="default")}else t.buttons=[];var n="";window.siteConfig&&window.siteConfig.endPoints&&window.siteConfig.endPoints.appHost&&(n=window.siteConfig.endPoints.appHost);var i={templateUrl:n+"/pages/popupLib/popupLib.html",controller:"popupLibCtrl",size:t.size||"sm",data:t};window.openDialog(i,function(t){e&&e(null,t)})}else e("invalid parameter, messing title",null)}};$app.controller("popupLibCtrl",["$scope","$dialog","$data","$sce",function(t,o,e,n){t.allowHtml=e.allowHtml,t.popupData=e,t.popupData.message=n.trustAsHtml(e.message),t.message=e.message,t.title=e.title,t.buttons=e.buttons,t.size=e.size,t.closeDialog=function(){o.close(null)},t.selectedButton=function(t){var e={};t&&(e.selectedButton=angular.copy(t)),o.close(e)}}]);
$app.controller("openDialogCtrl",["$uibModal",function(n){function l(o,e){this.modalInstance=null,this.options=o,this.callback=e}l.prototype.open=function(o){var e=this,t=o||this.options;this.modalInstance=n.open({animation:!0,windowClass:t.position||"",templateUrl:t.templateUrl,controller:t.controller,size:t.size,backdrop:void 0===t.backdrop||t.backdrop,keyboard:void 0===t.keyboard||t.keyboard,resolve:{$data:function(){return t.data},$dialog:function(){return e}}}),this.modalInstance.result.then(function(o){e.callback&&e.callback(o)})},l.prototype.close=function(o){this.modalInstance.close(o)},window.openDialog=function(o,e){if(!o)throw"options have not been provided to openDialog";o.controller||console.warn("window.openDialog :: You have to pass the controller value to the openDialog function");var t=window._appRoot||"";o.controller=o.controller||"modalCtrl",o.templateUrl=o.templateUrl||t+"pages/templates/modal.html";var n=new l(o,e);return n.open(),n}}]).directive("googleLangOptions",function(){return{restrict:"A",link:function(o,e,t){window.googleTranslateLoadedCallback=function(){console.log("loaded google translate widget ..............");var o=document.querySelector("iframe.goog-te-menu-frame"),e=(o.contentDocument||o.contentWindow.document).querySelector("body"),t=document.createElement("link");t.rel="stylesheet",t.href="/styles/googleTranslate.css",e.appendChild(t)}}}});
"undefined"==typeof ActionItemsAPI&&(window.ActionItemsAPI=function(e){this.templateUrl="pages/share/actionBuilder.html",this.controller="actionItemsCtrl",this.context=e,this.init()}),ActionItemsAPI.prototype.init=function(){},ActionItemsAPI.prototype.showDialog=function(e,t){var n={templateUrl:this.templateUrl,controller:this.controller,size:"lg",data:e};window.openDialog(n,function(e){t&&t(null,e)})},$app.controller("actionItemsCtrl",["$scope","$data","$dialog",function(i,e,t){i.$dialog=t,i.showTitle=!0,i.tools=ImageLibAPI.tools,i.init=function(){i.errors={},i.actionItem={},i.options={},e&&e.options&&(i.options=e.options,i.options.showTitle?i.displayTitle="Display Title":i.displayTitle="Action Button Text"),e&&e.actionItem?(i.actionItem=e.actionItem,i.changeAction(i.actionItem.action)):i.changeAction("linkToWeb")},i.onChangeAction=function(e,t){var n=i.actionItem.title,o=i.actionItem.iconUrl;i.actionItem={},i.actionItem.title=n,i.actionItem.iconUrl=o,i.changeAction(e,t)},i.changeAction=function(e){switch(i.actionItem.action=e,i.showLinkToAppContent=!1,i.showLinkToWeb=!1,i.showLinkToSocialMedia=!1,i.showSendEmail=!1,i.showSendSms=!1,i.showNavigateToAddress=!1,i.showNoAction=!1,i.showCallNumber=!1,i.showPurchase=!1,e){case"purchase":i.showPurchase=!0,i.actionName="Purchase";break;case"linkToApp":i.showLinkToAppContent=!0,i.actionName="Link to App Content";break;case"linkToWeb":i.showLinkToWeb=!0,i.actionName="Link to Web Content";break;case"sendEmail":i.showSendEmail=!0,i.actionName="Send an Email";break;case"callNumber":i.showCallNumber=!0,i.actionName="Call Number";break;case"sendSms":i.showSendSms=!0,i.actionName="Send SMS Text Message";break;case"navigateToAddress":i.showNavigateToAddress=!0,i.actionName="Link to Map";break;case"linkToSocialGoogle":i.showLinkToSocialMedia=!0,i.actionName="Link to Google+ Page";break;case"linkToSocialFacebook":i.showLinkToSocialMedia=!0,i.actionName="Link to Facebook Page";break;case"linkToSocialInstagram":i.showLinkToSocialMedia=!0,i.actionName="Link to Instagram Page";break;case"linkToSocialTwitter":i.showLinkToSocialMedia=!0,i.actionName="Link to Twitter Page";break;case"linkToSocialLinkedIn":i.showLinkToSocialMedia=!0,i.actionName="Link to LinkedIn Page";break;case"noAction":i.showNoAction=!0,i.actionName="No action"}},i.openImageLib=function(){i.options&&!i.options.imgLibOptions&&(i.options.imgLibOptions={showIcons:!1}),window.imageLibCurrentApp.showDialog({showIcons:i.options.imgLibOptions.showIcons||!1,showFiles:!0,multiSelection:!1},function(e,t){t&&t.selectedIcons&&0<t.selectedIcons.length&&(i.actionItem.iconClassName=t.selectedIcons[0],i.actionItem.iconUrl=null),t&&t.selectedFiles&&0<t.selectedFiles.length&&(i.actionItem.iconUrl=t.selectedFiles[0],i.actionItem.iconClassName=null)})},i.clearIconUrl=function(){i.actionItem.iconUrl=null},i.validUrl=function(e){return!!new RegExp("^(http:/|https:/|http://|https://)[a-z0-9]").test(e)},i.resizeImage=function(e){return e?ImageLibAPI.tools.resizeImage(e,{width:92,height:88}):""},i.close=function(){i.$dialog.close(null)},i.init()}]),$app.controller("pluginSelectorCtrl",["$scope","$dialog",function(o,e){o.$dialog=e,o.tools=ImageLibAPI.tools,o.cancel=function(){o.$dialog.close(null)},o.save=function(){o.$dialog.close(o.selectedPluginInstance)};var t={controller:"pluginInstanceDialog",appId:window.appContext.currentApp.appId,liveMode:window.appContext.currentApp.liveMode,pluginId:"pluginInstances",instanceId:1,writeKey:appContext.currentApp.keys.datastoreKey};o.selectPluginInstance=function(e){o.selectedPluginInstance=e};var i=new PluginInstanceAPI(t);o.getPluginInstances=function(e,t,n){i.search({title:e,pageSize:t,pageIndex:n-1},function(e,t){e?o.pluginInstances=[]:(o.pluginInstances=t.result,o.totalItems=t.totalRecord)})},o.init=function(){o.totalItems=100,o.pageIndex=1,o.pageSize=10,o.maxSize=5,o.pluginTitle=null,o.getPluginInstances(o.pluginTitle,o.pageSize,o.pageIndex)},o.init()}]),$app.controller("linkToWebCtrl",["$scope",function(t){void 0===t.actionItem.openIn&&(t.actionItem.openIn="_blank"),t.checkUrlFormat=function(){null!=t.actionItem.url&&""!=t.actionItem.url&&t.actionItem.url.indexOf("://")<0&&(t.actionItem.url="http://"+t.actionItem.url)},t.cancel=function(){t.$dialog.close(null)},t.save=function(){t.validate()&&t.$dialog.close(t.actionItem)},t.validate=function(){var e=!0;return t.errors.title="",t.errors.urlError="",t.errors.openInError="",t.options&&t.options.showTitle&&(null==t.actionItem.title||""==t.actionItem.title)&&(e=!1,t.errors.title="Required"),null!=t.actionItem.url&&""!=t.actionItem.url||(e=!1,t.errors.urlError="Required"),null!=t.actionItem.openIn&&""!=t.actionItem.openIn||(e=!1,t.errors.openInError=!0),e}}]),$app.controller("sendSmsCtrl",["$scope",function(t){t.cancel=function(){t.$dialog.close(null)},t.save=function(){t.validate()&&t.$dialog.close(t.actionItem)},t.validate=function(){var e=!0;return t.errors.title="",t.errors.phoneNumberError="",t.options&&t.options.showTitle&&(null==t.actionItem.title||""==t.actionItem.title)&&(e=!1,t.errors.title="Required"),null!=t.actionItem.phoneNumber&&""!=t.actionItem.phoneNumber||(e=!1,t.errors.phoneNumberError="Required"),e}}]),$app.controller("sendEmailCtrl",["$scope",function(t){t.cancel=function(){t.$dialog.close(null)},t.save=function(){t.validate()&&t.$dialog.close(t.actionItem)},t.isValidEmail=function(e){return/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z\-0-9]{2,}))$/.test(e)},t.validate=function(){var e=!0;return t.errors.title="",t.errors.email="",t.errors.subject="",t.errors.body="",t.options&&t.options.showTitle&&(null==t.actionItem.title||""==t.actionItem.title)&&(e=!1,t.errors.title="Required"),e}}]),$app.controller("linkToSocialMediaCtrl",["$scope",function(t){t.cancel=function(){t.$dialog.close(null)},t.save=function(){t.validate()&&t.$dialog.close(t.actionItem)},t.validate=function(){var e=!0;return t.errors.title="",t.errors.urlError="",t.options&&t.options.showTitle&&(null==t.actionItem.title||""==t.actionItem.title)&&(e=!1,t.errors.title="Required"),null==t.actionItem.url||""==t.actionItem.url?(e=!1,t.errors.urlError="Required"):t.validUrl(t.actionItem.url)||(e=!1,t.errors.urlError="Invalid URL format. Example: http://www.google.com"),e}}]),$app.controller("linkToAppContentCtrl",["$scope",function(o){var e={controller:"pluginInstanceDialog",appId:window.appContext.currentApp.appId,liveMode:window.appContext.currentApp.liveMode,pluginId:"pluginInstances",instanceId:1,writeKey:appContext.currentApp.keys.datastoreKey},i=new PluginInstanceAPI(e);o.getPluginInstances=function(e,t,n){i.search({title:e,pageSize:t,pageIndex:n-1},function(e,t){e?o.pluginInstances=[]:(o.pluginInstances=t.result,o.totalItems=t.totalRecord)})},o.getSelectedPluginInformation=function(){var e=new DatastoreAPI(appContext.currentApp.appId,"pluginInstances",1,appContext.currentApp.liveMode),t={};t.obj={filter:{"$json.instanceId":o.actionItem.instanceId},pageSize:1},e.search(t,function(e,t){t&&t.length&&(o.selectedPluginInstance=t[0])})},o.init=function(){o.deepLinkPlugin={},o.totalItems=100,o.pageIndex=1,o.pageSize=10,o.maxSize=5,o.pluginTitle=null,o.actionItem.instanceId&&o.getSelectedPluginInformation(),o.getPluginInstances(o.pluginTitle,o.pageSize,o.pageIndex)},o.setPage=function(){o.getPluginInstances(o.pluginTitle,o.pageSize,o.pageIndex)},o.selectPluginInstance=function(e){o.errors.selectPlugin="",o.actionItem.instanceId=e.data.instanceId,o.selectedPluginInstance=e},o.cancel=function(){o.$dialog.close(null)},o.save=function(){o.validate()&&o.$dialog.close(o.actionItem)},o.search=function(){o.setPage()},o.validate=function(){var e=!0;return o.errors.title="",o.errors.selectPlugin="",o.options&&o.options.showTitle&&(null==o.actionItem.title||""==o.actionItem.title)&&(e=!1,o.errors.title="Required"),null!=o.actionItem.instanceId&&""!=o.actionItem.instanceId||(e=!1,o.errors.selectPlugin="Please select a plugin"),e},o.init()}]),$app.controller("navigateToAddress",["$scope",function(a){a.marker=null,a.$watch("addressDetails",function(){a.marker&&(a.marker.setMap(null),a.actionItem.lat=null,a.actionItem.lng=null),a.addressDetails&&(a.actionItem.lat=a.addressDetails.geometry.location.lat(),a.actionItem.lng=a.addressDetails.geometry.location.lng(),n())}),a.$on("mapInitialized",function(e,t){a.map=t,a.actionItem.lat&&a.actionItem.lng&&n()}),a.cancel=function(){a.$dialog.close(null)},a.save=function(){a.validate()&&a.$dialog.close(a.actionItem)},a.validate=function(){var e=!0;return a.errors.title="",a.errors.address="",a.options&&a.options.showTitle&&(null==a.actionItem.title||""==a.actionItem.title)&&(e=!1,a.errors.title="Required"),null!=a.actionItem.lat&&null!=a.actionItem.lng||(e=!1,a.errors.address="Required"),e};var n=function(){var e=new google.maps.LatLng(a.actionItem.lat,a.actionItem.lng);a.marker=new google.maps.Marker({position:e,map:a.map,draggable:!0,animation:google.maps.Animation.DROP}),a.map.setCenter(a.marker.getPosition()),a.map.setZoom(12),google.maps.event.addListener(a.marker,"dragend",function(e){var t,n,o,i;a.actionItem.lat=e.latLng.lat(),a.actionItem.lng=e.latLng.lng(),t=a.actionItem.lat,n=a.actionItem.lng,o=function(e){a.actionItem.address=e||"",a.$apply()},i=new google.maps.LatLng(t,n),(new google.maps.Geocoder).geocode({latLng:i},function(e,t){if(t==google.maps.GeocoderStatus.OK){var n=e[0].formatted_address;o(n)}else o(null)})})}}]),$app.controller("noActionCtrl",["$scope",function(t){t.cancel=function(){t.$dialog.close(null)},t.save=function(){t.validate()&&t.$dialog.close(t.actionItem)},t.validate=function(){var e=!0;return t.options&&t.options.showTitle&&(null==t.actionItem.title||""==t.actionItem.title)&&(e=!1,t.errors.title="Required"),e}}]),$app.controller("callNumberCtrl",["$scope",function(t){t.cancel=function(){t.$dialog.close(null)},t.save=function(){t.validate()&&t.$dialog.close(t.actionItem)},t.validate=function(){var e=!0;return t.errors.title="",t.errors.phoneNumberError="",t.options&&t.options.showTitle&&(null==t.actionItem.title||""==t.actionItem.title)&&(e=!1,t.errors.title="Required"),null!=t.actionItem.phoneNumber&&""!=t.actionItem.phoneNumber||(e=!1,t.errors.phoneNumberError="Required"),e}}]);
$app.controller("pluginInstanceDialog",["$scope","$data","$dialog",function(e,n,t){e.showPluginInstances=!0,e.showAddPlugin=!1,e.hideAddPlugin=!1,e.skipPluginInstances=!1,e.hideAddToSideMenuCheckbox=!1,n&&n.options&&(n.options.skipPluginInstances&&(e.showPluginInstances=!1,e.showAddPlugin=!0,e.skipPluginInstances=!0),n.options.hideAddPlugin&&(e.hideAddPlugin=n.options.hideAddPlugin),n.options.hideAddToSideMenuCheckbox&&(e.hideAddToSideMenuCheckbox=n.options.hideAddToSideMenuCheckbox)),e.cancel=function(){t.close(null)},e.close=function(e){t.close(e)},e.goToPluginInstances=function(){e.showAddPlugin=!1,e.showPluginInstances=!0},e.goToAddPluginDialog=function(){e.showPluginInstances=!1,e.showAddPlugin=!0},e.refreshPluginInstances=function(){e.$broadcast("searchPluginInstances",{})}}]),$app.controller("pluginInstanceSearchCtrl",["$scope","$analytics",function(p,e){var n={controller:"pluginInstanceDialog",appId:window.appContext.currentApp.appId,liveMode:window.appContext.currentApp.liveMode,pluginId:"pluginInstances",instanceId:1,writeKey:appContext.currentApp.keys.datastoreKey};p.tools=ImageLibAPI.tools,appContext.currentApp.config&&(p.marketplaceButton=appContext.currentApp.config.marketplaceButton),p.data={},p.tools=ImageLibAPI.tools;new DatastoreAPI(appContext.currentApp.appId,"pluginInstances",1,0,appContext.currentApp.keys.datastoreKey);var a=new PluginInstanceAPI(n);p.getPluginInstances=function(e,n,t){p.searching=!0,a.search({title:e,pageSize:n,pageIndex:t-1},function(e,n){if(!e&&(p.pluginInstances||(p.pluginInstances=[]),n.result&&0!=n.result.length?p.lastPageIndex=p.pageIndex:p.pageIndex=p.lastPageIndex,n.result)){for(var t=0;t<n.result.length;t++)n.result[t]&&n.result[t].data&&n.result[t].data.instanceId&&null!=p.instances[n.result[t].data.instanceId]&&(n.result[t].selected=!0);p.pluginInstances=p.pluginInstances.concat(n.result)}p.searching=!1,p.pluginInstanceReady=!0})},p.save=function(){var e=[];for(var n in p.instances)p.instances.hasOwnProperty(n)&&e.push(p.instances[n]);p.close(e)},p.search=function(){p.pageIndex=1,p.pluginInstances=null,p.pluginInstanceReady=!1,p.lastPageIndex=1,p.getPluginInstances(p.pluginTitle,p.pageSize,p.pageIndex)},p.clone=function(e){if(e&&e.data){var n={templateUrl:"/pages/plugins/clonePlugin/clonePluginDialog.html",controller:"clonePluginDialogCtrl",size:"sm",data:{plugin:angular.fromJson(angular.toJson(e))}};window.openDialog(n,function(e){e&&p.search()})}},p.selectInstance=function(e){var n=e.data.instanceId,t=e.data.iconUrl,a=e.data._buildfire.pluginType.result[0].token,i=e.data._buildfire.pluginType.result[0].folderName,o=e.data._buildfire.pluginType.result[0].name,l=e.data.title,s=e.data.iconClassName;if(e.selected){var d={instanceId:n,iconUrl:t,title:l,pluginTypeId:a,pluginTypeName:o,folderName:i,iconClassName:s};p.instances[d.instanceId]=d}else delete p.instances[n]},p.setPage=function(){p.searching||(p.lastPageIndex=p.pageIndex,p.pageIndex++,p.getPluginInstances(p.pluginTitle,p.pageSize,p.pageIndex))},p.init=function(){p.instances={},p.pageIndex=1,p.pageSize=20,p.maxSize=20,p.pluginTitle=null,p.search()},p.init()}]),$app.controller("addPluginInstanceCtrl",["$scope","$http","$analytics","commonPluginService",function(s,d,p,u){s.pluginHost=window.siteConfig.endPoints.pluginHost,s.tools=ImageLibAPI.tools;var c=new DatastoreAPI(appContext.currentApp.appId,"pluginInstances",1,0,appContext.currentApp.keys.datastoreKey),a=new DatastoreAPI(appContext.currentApp.appId,"sideMenu",1,0,appContext.currentApp.keys.datastoreKey),e=function(e,n,t){var a=window.siteConfig.endPoints.appHost+"/api/appPluginTypes/search",i=localStorage.getItem("user");i?(i=JSON.parse(i),d.get(a,{headers:{auth:i.auth,userToken:i.userToken},params:{appId:window.appContext.currentApp.appId,pluginTypeName:e,pageSize:n,pageIndex:t}}).success(function(e){s.plugins=e.data,s.totalItems=e.total})):(s.plugins=[],s.totalItems=0)};s.openAddPageDialog=function(l){if(l){var i=function(n){"addPage"==n.operation&&null!=n.title&&d.get("/api/appPluginTypes/validateToAdd",{params:{appId:window.appContext.currentApp.appId,token:l.token}}).success(function(e){e&&e.isActive?t(n):toast("Invalid to add, the plugin is inactive","danger")})},t=function(e){if("addPage"==e.operation&&null!=e.title){var n=e.title,a=e.addToSideMenu,i=(window.appContext.currentApp.appId,l.token,e.title,l.folderName,l.token+"-"+Date.now()),o={tag:"",obj:{pluginTypeId:l.pluginTypeId,token:l.token,title:n,instanceId:i,refId:i,iconUrl:window.siteConfig.endPoints.pluginHost+"/"+l.folderName+"/resources/icon.png",_buildfire:{pluginType:{dataType:"pluginType",data:l.token}}}};c.insert(o,function(e,n){if(e)console.log(e);else{p.eventTrack("cp/pluginInstanceAdded",{pluginTypeId:l.pluginTypeId,pluginTypeName:l.pluginTypeName,marketItemId:l.marketItemId});var t={instanceId:i,iconUrl:window.siteConfig.endPoints.pluginHost+"/"+l.folderName+"/resources/icon.png",title:o.obj.title,pluginTypeId:l.token,pluginTypeName:l.pluginTypeName,folderName:l.folderName,iconClassName:null};a&&(s.hideAddToSideMenuCheckbox||s.addToSideMenu(t)),s.close([t])}})}},o={templateUrl:"addPage.html",controller:"addPageDialogCtrl",size:"sm",data:{options:{hideAddToSideMenuCheckbox:s.hideAddToSideMenuCheckbox}}},e={domain:window.siteConfig.endPoints.datastoreHost,appId:appContext.currentApp.appId,folderName:l.folderName,pluginTypeId:l.pluginTypeId};u.instanceExists(e,function(e,n){if(e)console.error(e);else if(n.isInUse){var t=n.matches[0].data,a={token:t.token,pluginInstanceId:t.instanceId,pluginTitle:t.title,folderName:t._buildfire.pluginType.result[0].folderName};s.close(),toast("Singleton. Redirecting to instance.","warning"),u.redirectToInstance(a)}else window.openDialog(o,i)})}},s.setPage=function(){e(s.pluginTypeName,s.pageSize,s.pageIndex)},s.addToSideMenu=function(e){s.sideMenu.result.push({id:e.instanceId,data:e}),s.sideMenu.data.push(e.instanceId),n(s.sideMenu)};var n=function(e){if(null!=e){var n={_buildfire:{sideMenu:e}},t=n._buildfire.sideMenu.result;n._buildfire.sideMenu.result&&delete n._buildfire.sideMenu.result,a.save({tag:"",obj:n},function(e,n){e||!n?alert(JSON.stringify(e)):(emulatorSync.triggerSideMenuOnUpdate(n),console.log("data saved"))}),e.result=t}};s.init=function(){s.totalItems=100,s.pageIndex=1,s.pageSize=10,s.maxSize=5,e(s.pluginTypeName,s.pageSize,s.pageIndex),s.sideMenu={dataType:"pluginInstance",data:[]},a.get({withDynamicData:!0},function(e,n){if(n){if(n.data&&n.data._buildfire&&n.data._buildfire.sideMenu){var t=n.data._buildfire.sideMenu;t.content&&t.content.loadAllPlugins||(t.result=(a=t.result,i=t.data,a.sort(function(e,n){var t=i.indexOf(e.data.instanceId),a=i.indexOf(n.data.instanceId);return a<t?1:t<a?-1:0}),a)),s.sideMenu=t}s.id=n.id,s.$$phase||s.$digest()}var a,i})},s.onCreateNewPlugin=function(){window.openDialog({templateUrl:"addPage.html",controller:"addPageDialogCtrl",size:"sm"}),s.$$phase||s.$digest()},s.init()}]),$app.controller("addPageDialogCtrl",["$scope","$dialog",function(e,n){e.addPage=function(){n.close({operation:"addPage",title:e.title})},e.closeDialog=function(){n.close({operation:"close",title:""})}}]);