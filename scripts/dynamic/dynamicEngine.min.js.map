{"version":3,"sources":["../sdk/scripts/dynamic/dynamicEngine.js"],"names":["dynamicEngine","triggerContextChange","options","key","expressions","_evaluationRequests","request","context","_context","_usedProperties","contextProperty","_evaluate","evaluate","callback","id","evaluationRequest","_nanoid","destroy","_destroyRequest","this","expression","_prepareContext","err","handler","get","target","prop","set","preparedExpression","Proxy","evaluatedExpression","Function","bind","_getBaseContext","getContext","baseContext","Object","assign","extendedContext","_isServer","window","document","t","crypto","getRandomValues","Uint8Array","reduce","e","toString","toUpperCase"],"mappings":"AACA,MAAMA,cAAgB,CAQrBC,qBAAqBC,GACpB,IAAK,IAAIC,KAAOH,cAAcI,YAAYC,oBAAqB,CAC1DC,EAAUN,cAAcI,YAAYC,oBAAoBF,GACxDG,EAAQC,SAAWD,EAAQE,SAAsB,YAAEC,gBAAgBP,EAAQQ,kBAC9EV,cAAcI,YAAYO,UAAUL,KAIvCF,YAAa,CACZC,oBAAqB,GASrBO,SAASV,EAASW,GACjB,IAAQC,EAAOZ,EAAPY,MACFC,EAAoB,CACzBF,SAAAA,EACAX,QAAAA,EACAY,GAAIA,GAAMd,cAAcI,YAAYY,UACpCC,QAAS,WACRjB,cAAcI,YAAYc,gBAAgBC,KAAKL,MAQjD,OAJIA,GACHd,cAAcI,YAAYc,gBAAgBJ,GAE3Cd,cAAcI,YAAYO,UAAUI,GAC7BA,GAERJ,UAAW,SAASL,GACnB,MAAQF,EAAgBJ,cAAhBI,eACF,CAAEU,GAAAA,EAAID,SAAAA,GAAcP,EAClBc,EAAed,EAAQJ,QAAvBkB,cAERhB,EAAYiB,gBACXf,EAAQJ,QACR,CAACoB,EAAKf,KACL,IACC,IAAMgB,EAAU,CACfd,gBAAiB,GACjBe,IAAIC,EAAQC,GACX,MAAa,gBAATA,EAA+BP,KAC/BO,KAAQD,GACXN,KAAKV,gBAAgBiB,IAAQ,EACtBD,EAAOC,SAFf,GAMDC,MACC,KAAM,gBAGFC,EAAqB,IAAMR,EAAa,IAC9Cd,EAAQE,SAAW,IAAIqB,MAAMtB,EAASgB,GACtCjB,EAAQC,QAAUA,EAClB,IAAMuB,EAAuBC,uDAAuDH,MAAuBI,KAAK1B,EAAQE,SAA3FuB,IAC7B3B,EAAYC,oBAAoBS,GAAMR,GAC9BO,SAAS,KAAMiB,GACtB,MAAOR,GACRT,EAASS,OASbJ,gBAAiB,SAASJ,UAClBd,cAAcI,YAAYC,oBAAoBS,IAQtDmB,gBAAgB/B,EAASW,GAExBA,EAAS,KADS,KASnBqB,WAAWhC,EAASW,GACnBA,EAAS,KAAM,KAQhBQ,gBAAgBnB,EAASW,GACxBb,cAAcI,YAAY6B,gBAAgB,KAAM,CAACX,EAAKa,KACrDnC,cAAcI,YAAY8B,WAAW,CAAC5B,QAASJ,GAAU,CAACoB,EAAKf,KAC9D6B,OAAOC,OAAOF,EAAa5B,EAASL,EAAQoC,iBAC5CzB,EAAS,KAAMsB,QAQlBI,YACC,QAA2B,oBAAXC,QAA0BA,OAAOC,WAMlDzB,QAAQ0B,EAAE,IACT,OAAOC,OAAOC,gBAAgB,IAAIC,WAAWH,IAAII,OAAO,CAAEJ,EAAEK,IAAIL,IAAIK,GAAG,IAAI,GAAGA,EAAEC,SAAS,IAAID,EAAE,IAAIA,EAAE,IAAIC,SAAS,IAAIC,cAAgB,GAAFF,EAAK,IAAI,IAAK","file":"dynamicEngine.min.js","sourcesContent":["// eslint-disable-next-line no-redeclare\r\nconst dynamicEngine = {\r\n\t/**\r\n\t* Trigger reevaluation when (onLogin, onLogout, appTheme change) happens\r\n\t* @param {Object} options - information about the triggered source (contextProperty, data)\r\n\t* @param {string} options.contextProperty - The event that have been triggered (onLogin, onLogout, appTheme change)\r\n\t* @param {Object} options.data - Data coming from the event triggering\r\n\t* @public\r\n\t*/\r\n\ttriggerContextChange(options) {\r\n\t\tfor (let key in dynamicEngine.expressions._evaluationRequests) {\r\n\t\t\tlet request = dynamicEngine.expressions._evaluationRequests[key];\r\n\t\t\tif (request.context && request._context['__handler__']._usedProperties[options.contextProperty]) {\r\n\t\t\t\tdynamicEngine.expressions._evaluate(request);\r\n\t\t\t}\r\n\t\t}\r\n\t},\r\n\texpressions: {\r\n\t\t_evaluationRequests: {},\r\n\t\t/**\r\n\t\t* Evaluate the received expression\r\n\t\t* @param {Object} options - The needed elements to evaluate the expression\r\n\t\t* @param {string} options.expression - The expression to be evaluated\r\n\t\t* @param {Object} options.extendedContext - Additional context to evaluate the expression against\r\n\t\t* @param {Function} callback - Returns the evaluated expression or error if existed\r\n\t\t* @public\r\n\t\t*/\r\n\t\tevaluate(options, callback) {\r\n\t\t\tconst { id } = options; \r\n\t\t\tconst evaluationRequest = {\r\n\t\t\t\tcallback,\r\n\t\t\t\toptions,\r\n\t\t\t\tid: id || dynamicEngine.expressions._nanoid(),\r\n\t\t\t\tdestroy: function() {\r\n\t\t\t\t\tdynamicEngine.expressions._destroyRequest(this.id);\r\n\t\t\t\t}\r\n\t\t\t};\r\n\t\t\t// if explicit id is sent, destroy if exists\r\n\t\t\tif (id) {\r\n\t\t\t\tdynamicEngine.expressions._destroyRequest(id);\r\n\t\t\t}\r\n\t\t\tdynamicEngine.expressions._evaluate(evaluationRequest);\r\n\t\t\treturn evaluationRequest;\r\n\t\t},\r\n\t\t_evaluate: function(request) {\r\n\t\t\tconst { expressions } = dynamicEngine;\r\n\t\t\tconst { id, callback }  = request;\r\n\t\t\tconst { expression } = request.options;\r\n\r\n\t\t\texpressions._prepareContext(\r\n\t\t\t\trequest.options,\r\n\t\t\t\t(err, context) => {\r\n\t\t\t\t\ttry {\r\n\t\t\t\t\t\tconst handler = {\r\n\t\t\t\t\t\t\t_usedProperties: {},\r\n\t\t\t\t\t\t\tget(target, prop) {\r\n\t\t\t\t\t\t\t\tif (prop === '__handler__') return this;\r\n\t\t\t\t\t\t\t\tif (prop in target) {\r\n\t\t\t\t\t\t\t\t\tthis._usedProperties[prop] = true;\r\n\t\t\t\t\t\t\t\t\treturn target[prop];\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\treturn undefined;\r\n\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\tset() {\r\n\t\t\t\t\t\t\t\tthrow 'not_allowed';\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t};\r\n\t\t\t\t\t\tconst preparedExpression = '`' + expression + '`';\r\n\t\t\t\t\t\trequest._context = new Proxy(context, handler);\r\n\t\t\t\t\t\trequest.context = context;\r\n\t\t\t\t\t\tconst evaluatedExpression =  Function(`\"use strict\"; const context = this;return (${preparedExpression})`).bind(request._context)();\r\n\t\t\t\t\t\texpressions._evaluationRequests[id] = request;\r\n\t\t\t\t\t\trequest.callback(null, evaluatedExpression);\r\n\t\t\t\t\t} catch (err) {\r\n\t\t\t\t\t\tcallback(err);\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t},\r\n\t\t/**\r\n\t\t* Get the base context\r\n\t\t* @param {string} id - The unique id of the request that should be deleted\r\n\t\t* @private\r\n\t\t*/\r\n\t\t_destroyRequest: function(id) {\r\n\t\t\tdelete dynamicEngine.expressions._evaluationRequests[id];\r\n\t\t},\r\n\t\t/**\r\n\t\t* Get the base context\r\n\t\t* @param {Object} options\r\n\t\t* @param {Function} callback - Returns the base context (shared between all platforms)\r\n\t\t* @private\r\n\t\t*/\r\n\t\t_getBaseContext(options, callback) {\r\n\t\t\tlet baseContext = {}; // shared functionality that (app/web/sdk) could use\r\n\t\t\tcallback(null, baseContext);\r\n\t\t},\r\n\t\t/**\r\n\t\t* @desc This function will be overridden in each platform; so it would get correctly the context of the platform\r\n\t\t* @param {Object} options\r\n\t\t* @param {Function} callback - Returns the context of the platform, which requested dynamicEngine.expressions\r\n\t\t* @public\r\n\t\t*/\r\n\t\tgetContext(options, callback) {\r\n\t\t\tcallback(null, {});\r\n\t\t},\r\n\t\t/**\r\n\t\t* @desc This function will merge the different contexts (baseContext, platform's context and the extendedContext) and return them\r\n\t\t* @param {Object} options\r\n\t\t* @param {Function} callback - Returns the final version of the context to be used in the evaluation\r\n\t\t* @private\r\n\t\t*/\r\n\t\t_prepareContext(options, callback) {\r\n\t\t\tdynamicEngine.expressions._getBaseContext(null, (err, baseContext) => {\r\n\t\t\t\tdynamicEngine.expressions.getContext({request: options}, (err, context) => {\r\n\t\t\t\t\tObject.assign(baseContext, context, options.extendedContext);\r\n\t\t\t\t\tcallback(null, baseContext);\r\n\t\t\t\t});\r\n\t\t\t});\r\n\t\t},\r\n\t\t/**\r\n\t\t* @desc This function returns weather this file is loaded from a client or a server side\r\n\t\t* @private\r\n\t\t*/\r\n\t\t_isServer() {\r\n\t\t\treturn !(typeof window !== 'undefined' && window.document);\r\n\t\t},\r\n\t\t/**\r\n\t\t* Get unique id each time\r\n\t\t* @private\r\n\t\t*/\r\n\t\t_nanoid(t=21) {\r\n\t\t\treturn crypto.getRandomValues(new Uint8Array(t)).reduce(((t,e)=>t+=(e&=63)<36?e.toString(36):e<62?(e-26).toString(36).toUpperCase():e>62?'-':'_'),'');\r\n\t\t}\r\n\t}\r\n};\r\n"]}