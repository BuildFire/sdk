const dynamicEngine={triggerContextChange(e){for(var t in dynamicEngine.expressions._evaluationRequests){t=dynamicEngine.expressions._evaluationRequests[t];t.context&&t._context.__handler__._usedProperties[e.contextProperty]&&dynamicEngine.expressions._evaluate(t)}},getGlobalSettings(e,t){t(null,{})},_isServer(){return!("undefined"!=typeof window&&window.document)},_decode({encodedString:e}){return atob(e)},expressions:{_evaluationRequests:{},evaluate(e,t){var n=(e=e||{})["id"],e={callback:t,options:e,id:n||dynamicEngine.expressions._nanoid(),destroy(){dynamicEngine.expressions._destroyRequest(this.id)}};return n&&dynamicEngine.expressions._destroyRequest(n),dynamicEngine.expressions._evaluate(e),e},_evaluate(a){const o=dynamicEngine["expressions"],{id:i,callback:c}=a;let d=a.options.expression||"";o._prepareContext(a.options,(e,n)=>{try{const s={_usedProperties:{},get(e,t){return"__handler__"===t?this:t in e?(this._usedProperties[t]=!0,e[t]):void 0},set(){throw"not_allowed"}},r=()=>{var e="`"+d+"`";a._context=new Proxy(n,s),a.context=n;var t=Function(`"use strict"; const context = this;return (${e})`).bind(a._context)(),e=(o._evaluationRequests[i]=a)._context.datasource.__handler__._usedProperties;dynamicEngine.datasources._fetchNeededDatasources({usedDatasources:e,extendedDatasources:a.options.extendedDatasources},(e,t)=>e?console.error("Error occurred while fetching data: ",e):void dynamicEngine.triggerContextChange({contextProperty:"datasource",data:t})),c(null,{evaluatedExpression:t,evaluationRequest:a})};d.includes("buildfire-repeat")?dynamicEngine.expressions.repeater._replaceRepeaters({expression:d,context:n},(e,t)=>e?c(e):(d=t,void r())):r()}catch(e){c(e)}})},_destroyRequest(e){delete dynamicEngine.expressions._evaluationRequests[e]},_getBaseContext(e,t){t(null,{})},getContext(e,t){t(null,{})},_prepareContext(s,r){dynamicEngine.expressions._getBaseContext(null,(e,n)=>{dynamicEngine.expressions.getContext({request:s},(e,t)=>{Object.assign(n,t,s.extendedContext),dynamicEngine.datasources._addDatasourcesData({context:n}),r(null,n)})})},repeater:{_exposeRepeaterStructure:!1,_replaceRepeaters({expression:t,context:n},s){try{let e=document.createElement("div");e.innerHTML=t,dynamicEngine.expressions.repeater._replaceRepeaterTree({container:e,context:n,scope:{}}),dynamicEngine.expressions.repeater._exposeRepeaterStructure&&console.log("Repeater Structure",e.innerHTML),s(null,e.innerHTML)}catch(e){s(e)}},_replaceRepeaterTree({container:e,context:a,scope:o}){const i=e.querySelector("[buildfire-repeat]");if(i){o=JSON.parse(JSON.stringify(o));const t=i.getAttribute("buildfire-repeat");i.removeAttribute("buildfire-repeat");let[s,r]=t.split(" in ").map(e=>e.trim());r=r.replace(/(^(?! *context\.).*)/,(e,t)=>{var n=r.split(".")[0];return t.replace(n,o[n])});try{const n=Function(`"use strict"; const context = this;return (${r})`).bind(a)();n&&n.forEach((e,t)=>{o[s]=`${r}[${t}]`;const n=i.cloneNode(!0);dynamicEngine.expressions.repeater._replaceRepeaterTree({container:n,context:a,scope:o}),n.innerHTML=n.innerHTML.replace(/\${((?! *context\.)[^{}]*)}/g,(e,t)=>{t=t.replace(s,o[s]);return dynamicEngine.expressions.repeater._exposeRepeaterStructure?"${"+t+'}<span style="display:none">'+t+"</span>":"${"+t+"}"}),i.parentNode.insertBefore(n,i)}),i.remove()}catch(e){if(i.remove(),!e.message||!e.message.includes("undefined")&&!e.message.includes("null"))throw e}}e.querySelector("[buildfire-repeat]")&&dynamicEngine.expressions.repeater._replaceRepeaterTree({container:e,context:a,scope:o})}},_nanoid(e=21){return crypto.getRandomValues(new Uint8Array(e)).reduce((e,t)=>e+=(t&=63)<36?t.toString(36):t<62?(t-26).toString(36).toUpperCase():62<t?"-":"_","")}},datasources:{datasourcesData:{},requestedDatasources:{},_addDatasourcesData({context:e}){e.datasource=new Proxy(this.datasourcesData,{_usedProperties:{},get(e,t){return"__handler__"===t?this:(this._usedProperties[t]=!0,e[t])}})},_fetchNeededDatasources({usedDatasources:r,extendedDatasources:a},o){r&&0<Object.keys(r).length&&dynamicEngine.datasources._getDatasources(null,(e,t)=>{if(e)return console.error("Error occurred while fetching data: ",e);if(t||a){t=t||[];let n=JSON.parse(JSON.stringify(t));if(a){let e=[];t.forEach(t=>{a.find(e=>e.id===t.id)||e.push(t)}),n=[...e,...a]}for(let t in r){var s;this.requestedDatasources[t]&&!(5e3<new Date-this.requestedDatasources[t].lastTimeFetched)||(s=n.find(e=>e.id===t))&&this.fetchDatasource({datasource:s},o)}}})},fetchDatasource({datasource:e},t){e.lastTimeFetched=new Date,"api"===(this.requestedDatasources[e.id]=e).type&&dynamicEngine.datasources._fetchApi({datasource:e},t)},_fetchApi({datasource:o},i){var e=JSON.parse(dynamicEngine._decode({encodedString:o.configuration})),e=dynamicEngine.datasources._evaluateDatasourceConfiguration([e?.url,e?.method,e?.headers,e?.body,e?.params]);Promise.all(e).then(([t,e,n,s,r])=>{const a={};t=new URL(t),e&&(a.method=e),n&&(a.headers=JSON.parse(n)),s&&(a.body=JSON.parse(s)),r&&(r=JSON.parse(r),Object.keys(r).forEach(e=>t.searchParams.append(e,r[e]))),fetch(t,a).then(t=>t.ok?t.json().then(e=>e).catch(()=>{throw new Error("Error Handling",{cause:{message:"response is not JSON"}})}):t.json().then(e=>{throw new Error("Error Handling",{cause:{data:e,status:t.status,statusText:t.statusText}})}).catch(e=>{throw new Error("Error Handling",{cause:{data:e.cause?.data,status:t.status,statusText:t.statusText}})})).then(e=>{dynamicEngine.datasources.datasourcesData[o.id]=e,i(null,e)}).catch(e=>{i({message:"Failed to fetch '"+o.id+"'",details:e.cause},null)})}).catch(e=>{i(e,null)})},_evaluateDatasourceConfiguration(e){const t=[];for(const r of e)r?t.push(new Promise((n,s)=>{dynamicEngine.expressions.evaluate({expression:r},(e,t)=>{e?s(e):(t.evaluationRequest.destroy(),n(t.evaluatedExpression))})})):t.push(Promise.resolve(""));return t},_getDatasources(e,n){dynamicEngine.getGlobalSettings(null,(e,t)=>e?n(e):t?.appDatasources&&0<t.appDatasources.length?n(null,t.appDatasources):void n(null,null))}}};
//# sourceMappingURL=dynamicEngine.min.js.map
