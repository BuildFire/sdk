if("undefined"==typeof buildfire)throw"please add buildfire.js first to use buildfire components";void 0===buildfire.components&&(buildfire.components={}),buildfire.components.reactions=(()=>{class e{constructor(e={}){this.itemId=e.itemId||null,this.userId=e.userId||null,this.reactions=e.reactions||[],this._buildfire=e._buildfire||{}}}class t{static get TAG(){return"$$reactions"}static _insert(t,i){let r=new e({itemId:t.itemId,userId:t.userId,reactions:[{reactionType:t.reactionType}]});r._buildfire.index=this._buildIndex(r),buildfire.appData.insert(r,this.TAG,!1,(e,r)=>{if(e)return i(e);let n=s.itemsReactionsGroupName[t.itemId];return buildfire.analytics.trackAction("react",{groupName:n,itemId:t.itemId,reactionType:t.reactionType}),i(null,r)})}static _update(e,t){let i={"_buildfire.index.string1":e.reaction.itemId+"-"+e.reaction.userId},r={};e.allowMultipleReactions?"add"==e.operation||"toggle"==e.operation?r={$addToSet:{reactions:{reactionType:e.reactionType},"_buildfire.index.array1":{string1:"reactionType-"+e.reaction.itemId+"-"+e.reactionType}}}:"remove"==e.operation&&(r={$pull:{reactions:{reactionType:e.reactionType}}}):"add"==e.operation||"toggle"==e.operation?r={$set:{reactions:[{reactionType:e.reactionType}],"_buildfire.index.array1":[{string1:"reactionType-"+e.reaction.itemId+"-"+e.reactionType}]}}:"remove"==e.operation&&(r={$set:{reactions:[],"_buildfire.index.array1":[]}}),buildfire.appData.searchAndUpdate(i,r,this.TAG,(e,i)=>e?t(e):t(null,i))}static _search(e,t){if(e.reactionId)buildfire.appData.getById(e.reactionId,this.TAG,(e,i)=>e?t(e):t(null,i));else{let i={"_buildfire.index.string1":e.itemId+"-"+e.userId};buildfire.appData.search({filter:i,limit:1},this.TAG,(e,i)=>e?t(e):t(null,i[0]||{}))}}static unReactReact(e,t){return"function"!=typeof t?console.error("callback must be a function!"):e?e.itemId?e.userId?e.reactionType?void this._search(e,(i,r)=>{if(i)return t(i);if(r&&r.data){if(r.data.reactions.find(t=>t.id===e.reactionType))return t(null,{status:"noAction",data:r});{let s=r.data,n=s.reactions.length?s.reactions[0].type:"";s.id=r.id;let a={reaction:s,reactionType:e.reactionType,operation:"toggle",allowMultipleReactions:e.allowMultipleReactions};this._update(a,(e,i)=>e?t(e):t(null,{status:"updated",data:i,oldReactionType:n}))}}else this._insert(e,(e,i)=>e?t(e):t(null,{status:"added",data:i,oldReactionType:""}))}):t("Invalid options, Missing reaction Type!"):t("Invalid options, Missing userId!"):t("Invalid options, Missing itemId!"):t("Invalid options. Options must be set and have at least oldReactionType, newReactionUUID, userId and itemId properties!")}static react(e,t){return"function"!=typeof t?console.error("callback must be a function!"):e?e.itemId?e.reactionType?e.userId?void this._search(e,(i,r)=>{if(i)return t(i);if(r&&r.data){if(r.data.reactions.find(t=>t.reactionType===e.reactionType))return t(null,{status:"noAction",data:r});{let s=r.data;s.id=r.id;let n={reaction:s,reactionType:e.reactionType,operation:"add",allowMultipleReactions:e.allowMultipleReactions};this._update(n,(e,i)=>e?t(e):t(null,{status:"updated",data:i,oldData:r.data}))}}else this._insert(e,(e,i)=>e?t(e):t(null,{status:"added",data:i}))}):t("Invalid options, Missing userId!"):t("Invalid options, Missing reaction Type!"):t("Invalid options, Missing itemId!"):t("Invalid options. Options must be set and have at least reaction ID, userId and itemId properties!")}static unReact(e,t){return"function"!=typeof t?console.error("callback must be a function!"):e?e.itemId?e.userId?e.reactionType?void this._search(e,(i,r)=>{if(i)return t(i);if(!r||!r.data)return t(null,{status:"noAction"});if(!r.data.reactions.find(t=>t.reactionType===e.reactionType))return t(null,{status:"noAction",data:r});{let n=r.data;if(n.id=r.id,1==n.reactions.length)buildfire.appData.delete(n.id,this.TAG,(i,r)=>{if(i&&"NOTFOUND"==i.code)return t(null,{status:"noAction"});if(i)return t(i);let n=s.itemsReactionsGroupName[e.itemId];return buildfire.analytics.trackAction("unReact",{groupName:n,itemId:e.itemId,reactionType:e.reactionType}),t(null,{status:"deleted"})});else{let a={reaction:n,reactionType:e.reactionType,operation:"remove",allowMultipleReactions:e.allowMultipleReactions};this._update(a,(e,i)=>e?t(e):t(null,{status:"deleted",data:i}))}}}):t("Invalid options, Missing reaction Type!"):t("Invalid options, Missing userId!"):t("Invalid options, Missing itemId!"):t("Invalid options. Options must be set and have at least reaction ID, userId and itemId properties!")}static get(e,t){if(!t||"function"!=typeof t)return console.error("callback must be a function!");if(!e)return t("missing get options!");let{itemId:i,groupName:r,pageIndex:a,pageSize:o}=e;if(!i)return t("Invalid get options!");"number"!=typeof a&&(a=0),o||(o=n.userListPageSize),s.getReactionsTypes({groupName:r,itemId:i},(e,r)=>{if(e)return t(e);let s=r.map(e=>`reactionType-${i}-${e.id}`);buildfire.appData.search({filter:{"_buildfire.index.array1.string1":{$in:s}},page:a,pageSize:o,recordCount:!0},this.TAG,(e,i)=>e?t(e):i?t(null,i):t(null,null))})}static getByUserId(e,t,i){if(!i||"function"!=typeof i)return console.error("callback must be a function!");if(!e||"string"!=typeof e||!t||!t.length)return i("Invalid arguments");let r=t.map(t=>t+"-"+e);buildfire.appData.search({filter:{"_buildfire.index.string1":{$in:r}}},this.TAG,(e,t)=>e?i(e):t?i(null,t):i(null,null))}static _buildIndex(e={}){let t={string1:e.itemId+"-"+e.userId,array1:e.reactions.map(t=>({string1:"reactionType-"+e.itemId+"-"+t.reactionType}))};return t}}class i{constructor(e={}){this.itemId=e.itemId||null,this.reactions=e.reactions||[],this._buildfire=e._buildfire||{}}}class r{static get TAG(){return"$$reactionsSummary"}static _search(e,t){buildfire.appData.search({filter:{"_buildfire.index.string1":e},limit:1},this.TAG,(e,i)=>e?t(e):t(null,i))}static _create(e,t){buildfire.appData.insert(e,this.TAG,!1,(e,i)=>e?t(e):t(null,i))}static _update(e,t,i){buildfire.appData.searchAndUpdate(e,t,this.TAG,(e,t)=>{if(e)return i(e);i(null,t)})}static get(e,t){return"function"==typeof t&&t?e&&e.length?void buildfire.appData.search({filter:{"_buildfire.index.string1":{$in:e}}},this.TAG,(e,i)=>e?t(e):i?t(null,i):t(null,null)):t("Missing get itemIds!"):console.error("callback must be a function!")}static increment(e,t){if(!t||"function"!=typeof t)return console.error("callback must be a function!");if(!e)return t("Invalid options!");if(!e.itemId)return t("Invalid options, Missing increment itemId!");if(!e.reactionType)return t("Invalid options, Missing increment reaction Type!");if(!e.userId)return t("Invalid options, Missing increment userId!");let{itemId:r,reactionType:s,userId:n}=e;this._search(r,(e,a)=>{if(e)return t(e);if(a&&a.length){let o=a[0].data.reactions.find(e=>e.reactionType==s),c={},d={};o?(c={"_buildfire.index.string1":r,"reactions.reactionType":s},d={$inc:{"reactions.$.count":1},$set:{"reactions.$.lastReactionBy":n}}):(c={"_buildfire.index.string1":r},d={$addToSet:{reactions:{reactionType:s,count:1,lastReactionBy:n},"_buildfire.index.array1":{string1:"reactionType-"+s}}}),this._update(c,d,(e,i)=>e?t(e):t(null,{status:"done"}))}else{let l=new i({itemId:r,reactions:[{reactionType:s,count:1,lastReactionBy:n}]});l._buildfire.index=this._buildIndex(l),this._create(l,(e,i)=>e?t(e):t(null,{status:"done"}))}})}static decrement(e,t){if(!t||"function"!=typeof t)return console.error("callback must be a function!");if(!e)return t("Invalid options, Missing decrement options!");if(!e.reactionType)return t("Invalid options, Missing decrement reaction Type!");if(!e.itemId)return t("Invalid options, Missing decrement itemId!");let{itemId:r,reactionType:s}=e;this._search(r,(e,n)=>{if(e)return t(e);if(n&&n.length){let a=n[0].data.reactions.find(e=>e.reactionType==s),o={},c={};a?(o={"_buildfire.index.string1":r,"reactions.reactionType":s},c={$inc:{"reactions.$.count":a.count>0?-1:0},$set:{"reactions.$.lastReactionBy":null}}):(o={"_buildfire.index.string1":r},c={$addToSet:{reactions:{reactionType:s,count:0,lastReactionBy:null},"_buildfire.index.array1":{string1:"reactionType-"+s}}}),this._update(o,c,(e,i)=>e?t(e):t(null,{status:"done"}))}else{let d=new i({itemId:r,reactions:[{reactionType:s,count:0,lastReactionBy:null}]});d._buildfire.index=this._buildIndex(d),this._create(d,(e,i)=>e?t(e):t(null,{status:"done"}))}})}static _buildIndex(e={}){let t={string1:e.itemId,array1:e.reactions.map(e=>({string1:"reactionType-"+e.reactionType}))};return t}}class s{static isLoading=!1;static itemsReactionsGroupName={};static groups=null;static getGroupsCallbacksQueue=[];static get TAG(){return"$$reactionsGroups"}static runCallbacksQueue(e,t){this.getGroupsCallbacksQueue.map(i=>e?i(e):t.data&&t.data.groups&&t.data.groups.length?(this.groups=t.data.groups,i(null,this.groups)):(this.groups=[],i(null,[]))),this.getGroupsCallbacksQueue=[]}static getReactionsGroups(e,t){if(!t||"function"!=typeof t)return console.error("callback must be a function!");this.getGroupsCallbacksQueue.push(t),this.isLoading||(this.isLoading=!0,buildfire.appData.get(this.TAG,(e,t)=>{this.isLoading=!1,this.runCallbacksQueue(e,t)}))}static getReactionsTypes(e,t){let{groupName:i,itemId:r}=e;if(!t||"function"!=typeof t)return console.error("callback must be a function!");if(!this.groups||!this.groups.length)return t("No Reactions Group Added yet");if(!r)return t("missing itemId",null);let s=null;if(i){for(let n=0;n<this.groups.length;n++)if(this.groups[n].name.toLowerCase()===i.toLowerCase()){s=this.groups[n];break}if(!s)return t("Invalid group name")}else s=this.groups[0];let a=s.reactions.filter(e=>!0==e.isActive&&e.selectedUrl&&e.unSelectedUrl);return a=a.map(e=>{let t=buildfire.imageLib.resizeImage(e.selectedUrl,{size:"xs",aspect:"1:1"}),i=buildfire.imageLib.resizeImage(e.unSelectedUrl,{size:"xs",aspect:"1:1"});return{...e,selectedUrl:t,unSelectedUrl:i}}),this.itemsReactionsGroupName[r]||(this.itemsReactionsGroupName[r]=i||s.name),t(null,a)}static validateReactionTypes(e,t){let{reactionType:i,itemId:r,groupName:s}=e;return i?r?void this.getReactionsTypes({itemId:r,groupName:s},(e,r)=>{if(e)return t(e);let s=r.find(e=>e.id==i);return s?t(null,s):t("Invalid Reaction ID")}):t("Missing itemId"):t("Missing reaction Type")}}class n{static _itemIds=[];static _timer;static _valid_HTML_Elements=[];static _observerTimer;static _firstReactionsSet=!1;static user=null;static longPressPeriod=500;static userListLimit=250;static userListPageSize=50;static debounce(e){let{itemId:i,getUsersData:s,getSummariesData:a}=e;if(!i)return console.error("Missing itemId");i&&0>n._itemIds.indexOf(i)&&n._itemIds.push(i),clearTimeout(n._timer),n._timer=setTimeout(()=>{let e=[...n._itemIds];n._itemIds=[],a&&r.get(e,(t,i)=>{t&&console.error(t),i&&n._showAllReactionCount(i,e)}),s&&(this.user&&this.user._id?t.getByUserId(this.user._id,e,(e,t)=>{e&&console.error(e),t&&n._showUserReactions(t)}):this._setCurrentUser((i,r)=>{if(i)return console.error(i);r&&r._id&&t.getByUserId(r._id,e,(e,t)=>{e&&console.error(e),t&&n._showUserReactions(t)})}))},300)}static _showAllReactionCount(e,t){e.forEach(e=>{let t=document.querySelectorAll(`[bf-reactions-item-id="${e.data.itemId}"]`),i=[];t.forEach(t=>{if(t){let r=s.itemsReactionsGroupName[e.data.itemId],n=0;e.data.reactions.forEach(t=>{s.validateReactionTypes({reactionType:t.reactionType,itemId:e.data.itemId,groupName:r||""},(e,r)=>{e?console.error(e):t.count>0&&(n+=t.count,i.push({id:r.id,count:t.count}))})});let a=t.querySelectorAll("[bf-reaction-image-id]"),o=t.getAttribute("bf-user_react-type");(a=Array.from(a).filter(e=>{let t=e.getAttribute("bf-reaction-image-id"),r=i.find(e=>e.id==t);return r?e.setAttribute("bf-reaction-image-count",r.count):e.setAttribute("bf-reaction-image-count",0),r&&o!==t})).forEach((e,t)=>{e.classList.remove("reactions-hidden")});let c=t.querySelector("[bf-reactions-total-count]");c&&(c.setAttribute("bf-reactions-total-count",n),c.innerHTML=this.correctCountNumbers(n))}})});document.querySelectorAll("[bf-reactions-total-count]").forEach(e=>{e.style.visibility="visible"})}static _showUserReactions(e){e.forEach(e=>{e&&e.data&&e.data.itemId&&e.data.reactions&&e.data.reactions.length&&s.validateReactionTypes({itemId:e.data.itemId,reactionType:e.data.reactions[0].reactionType,groupName:s.itemsReactionsGroupName[e.data.itemId]||""},(t,i)=>{if(t)return console.error(t);i&&document.querySelectorAll(`[bf-reactions-item-id="${e.data.itemId}"]`).forEach(t=>{let i=t.querySelector("[bf-reactions-btn]"),r=t?t.querySelector(`[bf-reaction-type="${e.data.reactions[0].reactionType}"]`):null;if(t&&r){t.setAttribute("bf-user_react-type",e.data.reactions[0].reactionType),t.setAttribute("bf-user_react-id",e.id),r.classList.add("reacted"),r.style.color=r.getAttribute("bf-reactions-color");let s=t.querySelector(`[bf-reaction-image-id="${e.data.reactions[0].reactionType}"]`);s.classList.contains("reactions-hidden")||s.classList.add("reactions-hidden"),i.src=r.getAttribute("bf-reactions-reacted-url"),i.classList.add("reactions-show-main-icon"),setTimeout(()=>{i.classList.remove("reactions-show-main-icon")},300)}})})})}static correctCountNumbers(e){let t="";return e>=1e9&&(t="b",e/=1e9),e>=1e6&&(t="m",e/=1e6),e>=1e3&&(t="k",e/=1e3),(e=e.toString()).includes(".")&&(e=e.split(".")[0]+"."+e.split(".")[1].substring(0,1)),"0"==e.split(".")[1]&&(e=e.split(".")[0]),e+t}static buildReactionElements(e){let t,i=(t=e?document.querySelector(e):document.body).querySelectorAll("*");this._valid_HTML_Elements=[],this._getValidHTMLElements(i),this._buildComponentByHTML(this._valid_HTML_Elements)}static _getValidHTMLElements(e){e.forEach(e=>{let t={};try{if(e.hasAttribute("bf-reactions-item-id")){let i=e.getAttribute("bf-reactions-on-update"),r=e.getAttribute("bf-reactions-on-error"),s,n;i&&(s=window[i]),r&&(n=window[r]),t={itemId:e.getAttribute("bf-reactions-item-id"),container:e,groupName:e.getAttribute("bf-reactions-group-name"),itemType:e.getAttribute("bf-reactions-item-type"),showCount:JSON.parse(e.getAttribute("bf-reactions-show-count")),showUsersReactions:JSON.parse(e.getAttribute("bf-reactions-show-users-reactions")),onUpdate:s,onError:n},this._valid_HTML_Elements.push(t)}else e.hasAttribute("bf-reactions")&&((t={container:e,...JSON.parse(e.getAttribute("bf-reactions"))}).onUpdate&&(t.onUpdate=window[t.onUpdate]),t.onError&&(t.onError=window[t.onError]),this._valid_HTML_Elements.push(t))}catch(a){return console.error("Error while parsing JSON: "+a)}})}static _buildComponentByHTML(e){(e=(e=Array.from(e)).filter((t,i)=>e.findIndex(e=>e.container==t.container)==i)).forEach(e=>{new buildfire.components.reactions(null,e)})}static _onLoginLogoutHandler(e){document.querySelectorAll("[bf-reactions-item-id]").forEach(t=>{let i=t.querySelector("[bf-reactions-default-src]");i&&!e&&(i.src=i.getAttribute("bf-reactions-default-src"));let r=t.getAttribute("bf-reactions-item-id");r&&e&&n.debounce({itemId:r,getUsersData:!0})})}static _setCurrentUser(e){buildfire.auth.getCurrentUser((t,i)=>(t||!i?this.user={}:i&&i._id&&(this.user=i),buildfire.auth.onLogin(e=>{this._onLoginLogoutHandler(e),this.user=e},!0),buildfire.auth.onLogout(()=>{this._onLoginLogoutHandler(null),this.user={}},!0),e(t,this.user)))}}class a{constructor(e,t={}){if(t.onUpdate&&(this.onUpdate=t.onUpdate),t.onError&&(this.onError=t.onError),this.itemType=t.itemType||"",this._itemId=this.itemType?`${this.itemType}-${t.itemId}`:t.itemId,this.itemId=t.itemId,this.groupName=t.groupName||"",this.selector=e||null,this.container=t.container||null,this.container=this.container||document.querySelector(this.selector),this.showCount="boolean"!=typeof t.showCount||t.showCount,this.showUsersReactions="boolean"!=typeof t.showUsersReactions||t.showUsersReactions,this.allowMultipleReactions=!1,t.dataFromMessage&&(s.groups=t.dataFromMessage,s.itemsReactionsGroupName[this._itemId]=t.groupName||t.dataFromMessage[0].name),!this.itemId&&"control"!==buildfire.context.type)return this.onError({errorCode:"1001",message:"missing required data, invalid itemId"}),console.error("Missing itemId");if(!this.container)return this.onError({itemType:this.itemType,itemId:this.itemId,errorCode:"1001",message:"missing required data, invalid selector/container"}),console.error("Missing selector");buildfire.components.reactions.getReactionGroups((e,t)=>{if(e)return console.error(e);let i={groupName:this.groupName,itemId:this._itemId};this._getReactionTypes(i,(e,t)=>{if(e)return this.onError({itemType:this.itemType,itemId:this.itemId,errorCode:"1002",message:"wrong data, invalid group name"});this.reactionsArr=t,this._init()})})}_init(){if(!this.reactionsArr.length)return this.onError({itemType:this.itemType,itemId:this.itemId,errorCode:"1003",message:"empty record, No Reactions added yet"}),console.error("No Reactions added yet");this._fixGroupName(this.groupName,(e,t)=>{e?this.onError({itemType:this.itemType,itemId:this.itemId,errorCode:"5001",message:"error while getting data, "+e}):t.existGroupName?(this._buildComponent(),n.debounce({itemId:this._itemId,getUsersData:!0,getSummariesData:!0})):this.onError({itemType:this.itemType,itemId:this.itemId,errorCode:"1002",message:"wrong data, invalid group name"})})}_fixGroupName(e,t){let i=()=>{if(e&&s.groups.length){let i;for(let r=0;r<s.groups.length;r++)if(s.groups[r].name.toLowerCase()===e.toLowerCase()){i=s.groups[r];break}return i&&i.name?t(null,{existGroupName:!0}):t(null,{existGroupName:!1})}if(s.groups.length)return t(null,{existGroupName:!0})};s.groups?i():buildfire.components.reactions.getReactionGroups((e,r)=>{if(e)return t(e);i()})}_buildComponent(){this.container.innerHTML=null;let e="";this.reactionsArr.forEach((t,i)=>{e+=` <div reactions-icon-buttons class="reactions-icon-buttons reaction-container-show">
                                        <img style="animation-duration:${i/10+.1}s;" bf-reactions-non-reacted-url="${t.unSelectedUrl}" bf-reactions-reacted-url="${t.selectedUrl}" bf-reactions-url="${t.url}" bf-reaction-type="${t.id}" class="disable-user-select reactions-clickable-image reactions-icon-animation" src="${t.selectedUrl}" />
                                    </div>`}),this.container.setAttribute("bf-reactions-item-id",this._itemId),this.container.setAttribute("bf-user_react-type",""),this.container.setAttribute("bf-user_react-id",""),this.container.classList.add("reactions-main-container");let t="";this.reactionsArr.forEach((e,i)=>{t+=`<img bf-reaction-image-id="${e.id}" style="z-index:${9-i}" bf-reaction-image-count="0" class="disable-user-select reactions-hidden reactions-secondary-icon" src="${e.selectedUrl}" />`}),this.container.innerHTML=`
                <div class="reaction-main-button">
                    <div bf-reactions-image-container class="reactions-main-icon-container" >
                        <img bf-reactions-btn class="disable-user-select reactions-main-icon" bf-reactions-default-src="${this.reactionsArr[0].unSelectedUrl}" src="${this.reactionsArr[0].unSelectedUrl}" />
                        ${t}
                    </div>
                    <span style="visibility:hidden;" class="reactions-total-count reactions-hidden" bf-reactions-total-count="0">0</span>
                </div>
                <div class="reactions-icon-container reactions-hidden" bf-reaction-icon-container>${e}</div>
            `,this.holdTimer=null,this.holdPeriod=0;let i=e=>{e.preventDefault(),this._hideReactionIcons(),this.holdTimer=setInterval(()=>{this.holdPeriod+=n.longPressPeriod/10,this.holdPeriod>=n.longPressPeriod&&this.reactionsArr.length>1&&(this._showReactionIcons(),this.holdPeriod=0,clearInterval(this.holdTimer))},n.longPressPeriod/10)},r=e=>{e.preventDefault();let t=this.container.querySelector("[bf-reaction-icon-container]");if((this.holdPeriod<n.longPressPeriod||1===this.reactionsArr.length)&&t&&t.classList.contains("reactions-hidden")){let i=this.container.querySelectorAll("[bf-reaction-type]"),r=this.container.querySelector(".reacted");r?this._validateUserAndReact(r.getAttribute("bf-reaction-type"),r):this._validateUserAndReact(i[0].getAttribute("bf-reaction-type"),i[0])}this.holdPeriod=0,clearInterval(this.holdTimer)},s=this.container.querySelector("[bf-reactions-btn]"),a=this.container.querySelector("[bf-reactions-total-count]");this.showCount&&(a.classList.remove("reactions-hidden"),this.showUsersReactions&&a.addEventListener("click",e=>{e.preventDefault(),this._showUsersList()})),s.addEventListener("mousedown",i),s.addEventListener("touchstart",i),s.addEventListener("mouseup",r),s.addEventListener("touchend",r);this.container.querySelectorAll("[bf-reaction-type]").forEach(e=>{e.addEventListener("click",t=>{t.preventDefault(),this._validateUserAndReact(e.getAttribute("bf-reaction-type"),e)})})}_showReactionIcons(){let e=this.container.querySelector("[bf-reaction-icon-container]");e&&e.classList.remove("reactions-hidden"),document.body.addEventListener("click",e=>{e.preventDefault(),e&&!this.container.contains(e.target)&&this._hideReactionIcons(this.container)})}_validateUserAndReact(e,t){n.user&&n.user._id?this._reactionHandler(e,t,n.user._id):buildfire.auth.login({},(i,r)=>{r&&r._id&&(n.user=r,this._reactionHandler(e,t,r._id))})}_reactionHandler(e,t,i){let r=this.container.getAttribute("bf-user_react-type"),s={reactionType:e,reactionId:this.container.getAttribute("bf-user_react-id")||null,itemId:this.container.getAttribute("bf-reactions-item-id")};r?r===e?this._deselectReaction({icon:t,userReactUUID:r,userId:i,selectedReaction:s}):this._toggleReaction({icon:t,userReactUUID:r,userId:i,selectedReaction:s}):this._addReaction({icon:t,selectedReaction:s,userId:i})}_addReaction(e){let{icon:i,selectedReaction:n,userId:a,fromQueue:o}=e;this._renderReactionIconsBox({newIcon:i,fromQueue:o});let c={itemId:n.itemId,userId:a,reactionType:n.reactionType,allowMultipleReactions:this.allowMultipleReactions};this.hasPendingRequest?this.nextRequest={type:"add",options:e}:(this.hasPendingRequest=!0,t.react(c,(e,t)=>{if(e)return this._renderReactionIconsBox({oldIcon:i}),this.onError({itemType:this.itemType,itemId:this.itemId,errorCode:"5002",message:"error while updating the data, "+e}),console.error("Error while adding new Reaction: "+e);if(t){if("added"===t.status){this.container.setAttribute("bf-user_react-id",t.data.id);let o={reactionType:n.reactionType,itemId:n.itemId,userId:a};r.increment(o,(e,t)=>{if(this._checkPendingRequest(),e)return this.onError({itemType:this.itemType,itemId:this.itemId,errorCode:"5002",message:"error while updating the data, "+e}),console.error(e);"done"===t.status||t.status})}else if("updated"===t.status){r.decrement({itemId:n.itemId,reactionType:t.oldData.reactions[0].reactionType},(e,t)=>{if(e)return this.onError({itemType:this.itemType,itemId:this.itemId,errorCode:"5002",message:"error while updating the data, "+e}),console.error(e)});let c={reactionType:n.reactionType,itemId:n.itemId,userId:a};r.increment(c,(e,t)=>{if(this._checkPendingRequest(),e)return this.onError({itemType:this.itemType,itemId:this.itemId,errorCode:"5002",message:"error while updating the data, "+e}),console.error(e);"done"===t.status||t.status})}else"noAction"===t.status&&this._checkPendingRequest();let d=s.itemsReactionsGroupName[this._itemId];this.onUpdate({status:"add",reactionType:n.reactionType,itemId:this.itemId,userId:a,itemType:this.itemType,name:d})}}))}_toggleReaction(e){let{icon:i,userReactUUID:n,userId:a,selectedReaction:o,fromQueue:c}=e,d=o.itemId;if(this._renderReactionIconsBox({fromQueue:c,newIcon:i,oldIcon:this.container.querySelector(`[bf-reaction-type="${n}"]`)}),this.hasPendingRequest)this.nextRequest={type:"update",options:e};else{this.hasPendingRequest=!0;let l={itemId:d,userId:a,reactionType:o.reactionType,reactionId:o.reactionId,allowMultipleReactions:this.allowMultipleReactions};t.unReactReact(l,(e,t)=>{if(e)return this._renderReactionIconsBox({oldIcon:i,newIcon:this.container.querySelector(`[bf-reaction-type="${n}"]`)}),this.onError({itemType:this.itemType,itemId:this.itemId,errorCode:"5002",message:"error while updating the data, "+e}),console.error("Error while updated the Reaction: "+e);if(t){"updated"===t.status?(r.decrement({itemId:d,reactionType:n},(e,t)=>{if(this._checkPendingRequest(),e)return this.onError({itemType:this.itemType,itemId:this.itemId,errorCode:"5002",message:"error while updating the data, "+e}),console.error(e)}),r.increment({itemId:d,reactionType:o.reactionType,userId:a},(e,t)=>{if(this._checkPendingRequest(),e)return this.onError({itemType:this.itemType,itemId:this.itemId,errorCode:"5002",message:"error while updating the data, "+e}),console.error(e)})):"added"===t.status?(this.container.setAttribute("bf-user_react-id",t.data.id),r.increment({itemId:d,reactionType:o.reactionType,userId:a},(e,t)=>{if(this._checkPendingRequest(),e)return this.onError({itemType:this.itemType,itemId:this.itemId,errorCode:"5002",message:"error while updating the data, "+e}),console.error(e)})):"noAction"===t.status&&this._checkPendingRequest();let c=s.itemsReactionsGroupName[this._itemId];this.onUpdate({status:"update",reactionType:o.reactionType,itemId:this.itemId,userId:a,itemType:this.itemType,name:c})}})}}_deselectReaction(e){let{icon:i,userReactUUID:n,userId:a,selectedReaction:o,fromQueue:c}=e,d=o.reactionId,l=o.itemId,u=n,h={itemId:l,userId:a,reactionId:d,reactionType:u,allowMultipleReactions:this.allowMultipleReactions};this._renderReactionIconsBox({oldIcon:i,fromQueue:c}),this.hasPendingRequest?this.nextRequest={type:"delete",options:e}:(this.hasPendingRequest=!0,t.unReact(h,(e,t)=>{if(e)return this._renderReactionIconsBox({newIcon:i}),this.onError({itemType:this.itemType,itemId:this.itemId,errorCode:"5003",message:"error while deleting the data, "+e}),console.error("Error while deleting the Reaction: "+e);if(t){"deleted"===t.status?(this.container.setAttribute("bf-user_react-id",""),r.decrement({itemId:l,reactionType:u},(e,t)=>{if(this._checkPendingRequest(),e)return this.onError({itemType:this.itemType,itemId:this.itemId,errorCode:"5002",message:"error while updating the data, "+e}),console.error(e)})):"noAction"===t.status&&this._checkPendingRequest();let n=s.itemsReactionsGroupName[this._itemId];this.onUpdate({status:"delete",reactionType:u,itemId:this.itemId,userId:a,itemType:this.itemType,name:n})}}))}_checkPendingRequest(){if(this.hasPendingRequest=!1,this.nextRequest)switch(this.nextRequest.type){case"add":this._addReaction({...this.nextRequest.options,fromQueue:!0});break;case"update":this._toggleReaction({...this.nextRequest.options,fromQueue:!0});break;case"delete":this._deselectReaction({...this.nextRequest.options,fromQueue:!0})}this.nextRequest={}}_renderReactionIconsBox(e){let{newIcon:t,oldIcon:i,fromQueue:r}=e;if(this._hideReactionIcons(),!r){let s=this.container.querySelector("[bf-reactions-btn]");if(i){i.classList.remove("reacted"),this.container.setAttribute("bf-user_react-type",""),this.container.setAttribute("bf-user_react-id","");let a=this.container.querySelector(`[bf-reaction-image-id="${i.getAttribute("bf-reaction-type")}"]`),o=parseInt(a.getAttribute("bf-reaction-image-count"));a.setAttribute("bf-reaction-image-count",o-1),a.classList.contains("reactions-hidden")&&o>=2&&a.classList.remove("reactions-hidden")}if(t){t.classList.add("reacted"),this.container.setAttribute("bf-user_react-type",t.getAttribute("bf-reaction-type")),s.src=t.getAttribute("bf-reactions-reacted-url"),s.classList.add("reactions-show-main-icon"),setTimeout(()=>{s.classList.remove("reactions-show-main-icon")},300);let c=this.container.querySelector(`[bf-reaction-image-id="${t.getAttribute("bf-reaction-type")}"]`);c.classList.contains("reactions-hidden")||c.classList.add("reactions-hidden");let d=parseInt(c.getAttribute("bf-reaction-image-count"));c.setAttribute("bf-reaction-image-count",d+1)}let l=this.container.querySelector("[bf-reactions-total-count]");if(t&&!i&&l){let u=parseInt(l.getAttribute("bf-reactions-total-count"))+1;u=u>=0?u:0,l.setAttribute("bf-reactions-total-count",u),l.innerHTML=n.correctCountNumbers(u)}if(!t&&i){let h=parseInt(l.getAttribute("bf-reactions-total-count"))-1;h=h>=0?h:0,l.setAttribute("bf-reactions-total-count",h),l.innerHTML=n.correctCountNumbers(h),s.src=this.reactionsArr[0].unSelectedUrl,s.classList.add("reactions-show-main-icon"),setTimeout(()=>{s.classList.remove("reactions-show-main-icon")},300)}}}_hideReactionIcons(e){if(e){let t=e.querySelector("[bf-reaction-icon-container]");t.classList.remove("reaction-container-show"),t.classList.add("reaction-container-hide"),setTimeout(()=>{t.classList.remove("reaction-container-hide"),t.classList.add("reaction-container-show"),t.classList.add("reactions-hidden")},250)}else document.querySelectorAll("[bf-reaction-icon-container]").forEach(e=>{e.classList.remove("reaction-container-show"),e.classList.add("reaction-container-hide"),setTimeout(()=>{e.classList.remove("reaction-container-hide"),e.classList.add("reaction-container-show"),e.classList.add("reactions-hidden")},250)})}_showUsersList(){let e=[],i=[];buildfire.spinner.show();let r=(e,t)=>{buildfire.auth.getUserProfiles({userIds:e.splice(0,50)},(s,n)=>{if(s)return console.error(s);i=i.concat(n),e&&e.length?r(e,t):t()})},s=(t,r,n)=>{let a=t[r],o=this.reactionsArr.find(e=>e.id===a.data.reactions[0].reactionType);if(o){let c=o.selectedUrl,d=i.find(e=>e._id===a.data.userId);d||(d={displayName:"User",imageUrl:"https://app.buildfire.com/app/media/avatar.png"});let l=d.displayName?d.displayName:d.firstName?d.firstName:"User",u=d.imageUrl?d.imageUrl:"https://app.buildfire.com/app/media/avatar.png";u=buildfire.imageLib.resizeImage(u,{size:"xs",aspect:"1:1"});let h=document.createElement("div"),p=document.createElement("div");p.style="display:flex; gap:1rem; align-items:center";let m=document.createElement("img");m.style="border-radius:100%; width:42px; height:42px; -khtml-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; -webkit-touch-callout: none; -webkit-user-select: none;",m.alt="user image",m.src=u,p.appendChild(m);let g=document.createElement("p");g.style="overflow:auto; max-width: 75%; margin:0 !important;",g.textContent=l,p.appendChild(g);let f=document.createElement("span");f.style="position: absolute;bottom: 0;left: 2.6rem;width: 2rem;height: 2rem;display: flex;align-items: center;justify-content: center; margin-left:0 !important;";let y=document.createElement("img");y.style="width: 2rem;height: 2rem; border-radius:100%;",y.src=c,f.appendChild(y),p.appendChild(f),h.appendChild(p),e.push({text:h.innerHTML}),r==t.length-1?this._openDrawer(e):n(t,r+1,s)}else r==t.length-1&&this._openDrawer(e)},a={itemId:this._itemId,groupName:this.groupName,pageIndex:0,pageSize:n.userListPageSize},o=[];t.get(a,(e,i)=>{if(e);else if(i.result.length){o=i.result;let c=[],d=Math.ceil((Math.min(i.totalRecord,n.userListLimit)-n.userListPageSize)/n.userListPageSize);for(let l=0;l<d;l++)c[l]=new Promise((e,i)=>{t.get({...a,pageIndex:l+1},(t,i)=>{i.result.length&&(o=[...o,...i.result]),e(!0)})});if(c.length>=1)Promise.all(c).then(()=>{let e=o.map(e=>e.data.userId);r(e,()=>{s(o,0,s)})});else{let u=o.map(e=>e.data.userId);r(u,()=>{s(o,0,s)})}}else this._openDrawer([])})}_openDrawer(e){buildfire.spinner.hide(),buildfire.components.drawer.open({content:"Reactions",isHTML:!0,triggerCallbackOnUIDismiss:!1,autoUseImageCdn:!0,listItems:e},(e,t)=>{if(e)return console.error(e)})}static getReactionGroups(e){if(s.groups)return e(null,s.groups);s.getReactionsGroups({},(t,i)=>t?e(t):e(null,i))}_getReactionTypes(e,t){let{groupName:i,itemId:r}=e;s.getReactionsTypes({groupName:i,itemId:r},(e,i)=>e?t(e):t(null,i))}onUpdate(e){}onError(e){}static injectReactions(e){n.buildReactionElements(e)}}return s.getReactionsGroups({},(e,t)=>{}),a})();