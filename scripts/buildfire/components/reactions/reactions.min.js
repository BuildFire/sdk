if("undefined"==typeof buildfire)throw"please add buildfire.js first to use buildfire components";void 0===buildfire.components&&(buildfire.components={}),buildfire.components.reactions=(()=>{class e{constructor(e={}){this.itemId=e.itemId||null,this.userId=e.userId||null,this.reactions=e.reactions||[],this._buildfire=e._buildfire||{}}}class t{static get TAG(){return"$$reactions"}static _insert(t,i){let r=new e({itemId:t.itemId,userId:t.userId,reactions:[{reactionType:t.reactionType}]});r._buildfire.index=this._buildIndex(r),buildfire.appData.insert(r,this.TAG,!1,((e,r)=>{if(e)return i(e);let s=n.itemsReactionsGroupName[t.itemId];return buildfire.analytics.trackAction("react",{groupName:s,itemId:t.itemId,reactionType:t.reactionType}),i(null,r)}))}static _update(e,t){let i={"_buildfire.index.string1":e.reaction.itemId+"-"+e.reaction.userId},r={};e.allowMultipleReactions?"add"==e.operation||"toggle"==e.operation?r={$addToSet:{reactions:{reactionType:e.reactionType},"_buildfire.index.array1":{string1:"reactionType-"+e.reaction.itemId+"-"+e.reactionType}}}:"remove"==e.operation&&(r={$pull:{reactions:{reactionType:e.reactionType}}}):"add"==e.operation||"toggle"==e.operation?r={$set:{reactions:[{reactionType:e.reactionType}],"_buildfire.index.array1":[{string1:"reactionType-"+e.reaction.itemId+"-"+e.reactionType}]}}:"remove"==e.operation&&(r={$set:{reactions:[],"_buildfire.index.array1":[]}}),buildfire.appData.searchAndUpdate(i,r,this.TAG,((e,i)=>e?t(e):t(null,i)))}static _search(e,t){if(e.reactionId)buildfire.appData.getById(e.reactionId,this.TAG,((e,i)=>e?t(e):t(null,i)));else{let i={"_buildfire.index.string1":e.itemId+"-"+e.userId};buildfire.appData.search({filter:i,limit:1},this.TAG,((e,i)=>e?t(e):t(null,i[0]||{})))}}static unReactReact(e,t){return"function"!=typeof t?console.error("callback must be a function!"):e?e.itemId?e.userId?e.reactionType?void this._search(e,((i,r)=>{if(i)return t(i);if(r&&r.data){if(r.data.reactions.find((t=>t.id===e.reactionType)))return t(null,{status:"noAction",data:r});{const i=r.data,n=i.reactions.length?i.reactions[0].type:"";i.id=r.id;let s={reaction:i,reactionType:e.reactionType,operation:"toggle",allowMultipleReactions:e.allowMultipleReactions};this._update(s,((e,i)=>e?t(e):t(null,{status:"updated",data:i,oldReactionType:n})))}}else this._insert(e,((e,i)=>e?t(e):t(null,{status:"added",data:i,oldReactionType:""})))})):t("Invalid options, Missing reaction Type!"):t("Invalid options, Missing userId!"):t("Invalid options, Missing itemId!"):t("Invalid options. Options must be set and have at least oldReactionType, newReactionUUID, userId and itemId properties!")}static react(e,t){return"function"!=typeof t?console.error("callback must be a function!"):e?e.itemId?e.reactionType?e.userId?void this._search(e,((i,r)=>{if(i)return t(i);if(r&&r.data){if(r.data.reactions.find((t=>t.reactionType===e.reactionType)))return t(null,{status:"noAction",data:r});{const i=r.data;i.id=r.id;let n={reaction:i,reactionType:e.reactionType,operation:"add",allowMultipleReactions:e.allowMultipleReactions};this._update(n,((e,i)=>e?t(e):t(null,{status:"updated",data:i,oldData:r.data})))}}else this._insert(e,((e,i)=>e?t(e):t(null,{status:"added",data:i})))})):t("Invalid options, Missing userId!"):t("Invalid options, Missing reaction Type!"):t("Invalid options, Missing itemId!"):t("Invalid options. Options must be set and have at least reaction ID, userId and itemId properties!")}static unReact(e,t){return"function"!=typeof t?console.error("callback must be a function!"):e?e.itemId?e.userId?e.reactionType?void this._search(e,((i,r)=>{if(i)return t(i);if(!r||!r.data)return t(null,{status:"noAction"});if(!r.data.reactions.find((t=>t.reactionType===e.reactionType)))return t(null,{status:"noAction",data:r});{const i=r.data;if(i.id=r.id,1==i.reactions.length)buildfire.appData.delete(i.id,this.TAG,((i,r)=>{if(i&&"NOTFOUND"==i.code)return t(null,{status:"noAction"});if(i)return t(i);let s=n.itemsReactionsGroupName[e.itemId];return buildfire.analytics.trackAction("unReact",{groupName:s,itemId:e.itemId,reactionType:e.reactionType}),t(null,{status:"deleted"})}));else{let r={reaction:i,reactionType:e.reactionType,operation:"remove",allowMultipleReactions:e.allowMultipleReactions};this._update(r,((e,i)=>e?t(e):t(null,{status:"deleted",data:i})))}}})):t("Invalid options, Missing reaction Type!"):t("Invalid options, Missing userId!"):t("Invalid options, Missing itemId!"):t("Invalid options. Options must be set and have at least reaction ID, userId and itemId properties!")}static get(e,t){if(!t||"function"!=typeof t)return console.error("callback must be a function!");if(!e)return t("missing get options!");let{itemId:i,groupName:r,pageIndex:o,pageSize:a}=e;if(!i)return t("Invalid get options!");"number"!=typeof o&&(o=0),a||(a=s.userListPageSize),n.getReactionsTypes({groupName:r,itemId:i},((e,r)=>{if(e)return t(e);let n={"_buildfire.index.array1.string1":{$in:r.map((e=>`reactionType-${i}-${e.id}`))}};buildfire.appData.search({filter:n,page:o,pageSize:a,recordCount:!0},this.TAG,((e,i)=>e?t(e):t(null,i||null)))}))}static getByUserId(e,t,i){if(!i||"function"!=typeof i)return console.error("callback must be a function!");if(!e||"string"!=typeof e||!t||!t.length)return i("Invalid arguments");let r={filter:{"_buildfire.index.string1":{$in:t.map((t=>t+"-"+e))}}};buildfire.appData.search(r,this.TAG,((e,t)=>e?i(e):i(null,t||null)))}static _buildIndex(e={}){return{string1:e.itemId+"-"+e.userId,array1:e.reactions.map((t=>({string1:"reactionType-"+e.itemId+"-"+t.reactionType})))}}}class i{constructor(e={}){this.itemId=e.itemId||null,this.reactions=e.reactions||[],this._buildfire=e._buildfire||{}}}class r{static get TAG(){return"$$reactionsSummary"}static _search(e,t){let i={"_buildfire.index.string1":e};buildfire.appData.search({filter:i,limit:1},this.TAG,((e,i)=>e?t(e):t(null,i)))}static _create(e,t){buildfire.appData.insert(e,this.TAG,!1,((e,i)=>e?t(e):t(null,i)))}static _update(e,t,i){buildfire.appData.searchAndUpdate(e,t,this.TAG,((e,t)=>{if(e)return i(e);i(null,t)}))}static get(e,t){return"function"==typeof t&&t?e&&e.length?void buildfire.appData.search({filter:{"_buildfire.index.string1":{$in:e}}},this.TAG,((e,i)=>e?t(e):t(null,i||null))):t("Missing get itemIds!"):console.error("callback must be a function!")}static increment(e,t){if(!t||"function"!=typeof t)return console.error("callback must be a function!");if(!e)return t("Invalid options!");if(!e.itemId)return t("Invalid options, Missing increment itemId!");if(!e.reactionType)return t("Invalid options, Missing increment reaction Type!");if(!e.userId)return t("Invalid options, Missing increment userId!");let{itemId:r,reactionType:n,userId:s}=e;this._search(r,((e,o)=>{if(e)return t(e);if(o&&o.length){let e={},i={};o[0].data.reactions.find((e=>e.reactionType==n))?(e={"_buildfire.index.string1":r,"reactions.reactionType":n},i={$inc:{"reactions.$.count":1},$set:{"reactions.$.lastReactionBy":s}}):(e={"_buildfire.index.string1":r},i={$addToSet:{reactions:{reactionType:n,count:1,lastReactionBy:s},"_buildfire.index.array1":{string1:"reactionType-"+n}}}),this._update(e,i,((e,i)=>e?t(e):t(null,{status:"done"})))}else{let e=new i({itemId:r,reactions:[{reactionType:n,count:1,lastReactionBy:s}]});e._buildfire.index=this._buildIndex(e),this._create(e,((e,i)=>e?t(e):t(null,{status:"done"})))}}))}static decrement(e,t){if(!t||"function"!=typeof t)return console.error("callback must be a function!");if(!e)return t("Invalid options, Missing decrement options!");if(!e.reactionType)return t("Invalid options, Missing decrement reaction Type!");if(!e.itemId)return t("Invalid options, Missing decrement itemId!");let{itemId:r,reactionType:n}=e;this._search(r,((e,s)=>{if(e)return t(e);if(s&&s.length){let e=s[0].data.reactions.find((e=>e.reactionType==n)),i={},o={};e?(i={"_buildfire.index.string1":r,"reactions.reactionType":n},o={$inc:{"reactions.$.count":e.count>0?-1:0},$set:{"reactions.$.lastReactionBy":null}}):(i={"_buildfire.index.string1":r},o={$addToSet:{reactions:{reactionType:n,count:0,lastReactionBy:null},"_buildfire.index.array1":{string1:"reactionType-"+n}}}),this._update(i,o,((e,i)=>e?t(e):t(null,{status:"done"})))}else{let e=new i({itemId:r,reactions:[{reactionType:n,count:0,lastReactionBy:null}]});e._buildfire.index=this._buildIndex(e),this._create(e,((e,i)=>e?t(e):t(null,{status:"done"})))}}))}static _buildIndex(e={}){return{string1:e.itemId,array1:e.reactions.map((e=>({string1:"reactionType-"+e.reactionType})))}}}class n{static itemsReactionsGroupName={};static groups=null;static get TAG(){return"$$reactionsGroups"}static getReactionsGroups(e,t){if(!t||"function"!=typeof t)return console.error("callback must be a function!");buildfire.appData.get(this.TAG,((e,i)=>e?t(e):i.data&&i.data.groups&&i.data.groups.length?(this.groups=i.data.groups,t(null,this.groups)):(this.groups=[],t(null,[]))))}static getReactionsTypes(e,t){const{groupName:i,itemId:r}=e;if(!t||"function"!=typeof t)return console.error("callback must be a function!");if(!this.groups||!this.groups.length)return t("No Reactions Group Added yet");if(!r)return t("missing itemId",null);let n=null;if(i){for(let e=0;e<this.groups.length;e++)if(this.groups[e].name.toLowerCase()===i.toLowerCase()){n=this.groups[e];break}if(!n)return t("Invalid group name")}else n=this.groups[0];let s=n.reactions.filter((e=>1==e.isActive&&e.selectedUrl&&e.unSelectedUrl));return s=s.map((e=>{let t=buildfire.imageLib.resizeImage(e.selectedUrl,{size:"xs",aspect:"1:1"}),i=buildfire.imageLib.resizeImage(e.unSelectedUrl,{size:"xs",aspect:"1:1"});return{...e,selectedUrl:t,unSelectedUrl:i}})),this.itemsReactionsGroupName[r]||(this.itemsReactionsGroupName[r]=i||n.name),t(null,s)}static validateReactionTypes(e,t){const{reactionType:i,itemId:r,groupName:n}=e;return i?r?void this.getReactionsTypes({itemId:r,groupName:n},((e,r)=>{if(e)return t(e);let n=r.find((e=>e.id==i));return n?t(null,n):t("Invalid Reaction ID")})):t("Missing itemId"):t("Missing reaction Type")}}class s{static _itemIds=[];static _timer;static _valid_HTML_Elements=[];static _observerTimer;static _firstReactionsSet=!1;static user=null;static longPressPeriod=500;static userListLimit=250;static userListPageSize=50;static debounce(e){let{itemId:i,getUsersData:n,getSummariesData:o}=e;if(!i)return console.error("Missing itemId");i&&s._itemIds.indexOf(i)<0&&s._itemIds.push(i),clearTimeout(s._timer),s._timer=setTimeout((()=>{let e=[...s._itemIds];s._itemIds=[],o&&r.get(e,((t,i)=>{t&&console.error(t),i&&s._showAllReactionCount(i,e)})),n&&(this.user&&this.user._id?t.getByUserId(this.user._id,e,((e,t)=>{e&&console.error(e),t&&s._showUserReactions(t)})):this._setCurrentUser(((i,r)=>{if(i)return console.error(i);r&&r._id&&t.getByUserId(r._id,e,((e,t)=>{e&&console.error(e),t&&s._showUserReactions(t)}))})))}),300)}static _showAllReactionCount(e,t){e.forEach((e=>{let t=document.querySelectorAll(`[bf-reactions-item-id="${e.data.itemId}"]`),i=[];t.forEach((t=>{if(t){let r=n.itemsReactionsGroupName[e.data.itemId],s=0;e.data.reactions.forEach((t=>{n.validateReactionTypes({reactionType:t.reactionType,itemId:e.data.itemId,groupName:r||""},((e,r)=>{e?console.error(e):t.count>0&&(s+=t.count,i.push({id:r.id,count:t.count}))}))}));let o=t.querySelectorAll("[bf-reaction-image-id]"),a=t.getAttribute("bf-user_react-type");o=Array.from(o).filter((e=>{let t=e.getAttribute("bf-reaction-image-id"),r=i.find((e=>e.id==t));return r?e.setAttribute("bf-reaction-image-count",r.count):e.setAttribute("bf-reaction-image-count",0),r&&a!==t})),o.forEach(((e,t)=>{e.classList.remove("reactions-hidden")}));let c=t.querySelector("[bf-reactions-total-count]");c&&(c.setAttribute("bf-reactions-total-count",s),c.innerHTML=this.correctCountNumbers(s))}}))})),document.querySelectorAll("[bf-reactions-total-count]").forEach((e=>{e.style.visibility="visible"}))}static _showUserReactions(e){e.forEach((e=>{e&&e.data&&e.data.itemId&&e.data.reactions&&e.data.reactions.length&&n.validateReactionTypes({itemId:e.data.itemId,reactionType:e.data.reactions[0].reactionType,groupName:n.itemsReactionsGroupName[e.data.itemId]||""},((t,i)=>{if(t)return console.error(t);if(i){document.querySelectorAll(`[bf-reactions-item-id="${e.data.itemId}"]`).forEach((t=>{let i=t.querySelector("[bf-reactions-btn]"),r=t?t.querySelector(`[bf-reaction-type="${e.data.reactions[0].reactionType}"]`):null;if(t&&r){t.setAttribute("bf-user_react-type",e.data.reactions[0].reactionType),t.setAttribute("bf-user_react-id",e.id),r.classList.add("reacted"),r.style.color=r.getAttribute("bf-reactions-color");let n=t.querySelector(`[bf-reaction-image-id="${e.data.reactions[0].reactionType}"]`);n.classList.contains("reactions-hidden")||n.classList.add("reactions-hidden"),i.src=r.getAttribute("bf-reactions-reacted-url"),i.classList.add("reactions-show-main-icon"),setTimeout((()=>{i.classList.remove("reactions-show-main-icon")}),300)}}))}}))}))}static correctCountNumbers(e){let t="";return e>=1e9&&(t="b",e/=1e9),e>=1e6&&(t="m",e/=1e6),e>=1e3&&(t="k",e/=1e3),(e=e.toString()).includes(".")&&(e=e.split(".")[0]+"."+e.split(".")[1].substring(0,1)),"0"==e.split(".")[1]&&(e=e.split(".")[0]),e+t}static buildReactionElements(e){let t;t=e?document.querySelector(e):document.body;let i=t.querySelectorAll("*");this._valid_HTML_Elements=[],this._getValidHTMLElements(i),this._buildComponentByHTML(this._valid_HTML_Elements)}static _getValidHTMLElements(e){e.forEach((e=>{let t={};try{if(e.hasAttribute("bf-reactions-item-id")){let i,r,n=e.getAttribute("bf-reactions-on-update"),s=e.getAttribute("bf-reactions-on-error");n&&(i=window[n]),s&&(r=window[s]),t={itemId:e.getAttribute("bf-reactions-item-id"),container:e,groupName:e.getAttribute("bf-reactions-group-name"),itemType:e.getAttribute("bf-reactions-item-type"),showCount:JSON.parse(e.getAttribute("bf-reactions-show-count")),showUsersReactions:JSON.parse(e.getAttribute("bf-reactions-show-users-reactions")),onUpdate:i,onError:r},this._valid_HTML_Elements.push(t)}else e.hasAttribute("bf-reactions")&&(t={container:e,...JSON.parse(e.getAttribute("bf-reactions"))},t.onUpdate&&(t.onUpdate=window[t.onUpdate]),t.onError&&(t.onError=window[t.onError]),this._valid_HTML_Elements.push(t))}catch(e){return console.error("Error while parsing JSON: "+e)}}))}static _buildComponentByHTML(e){(e=(e=Array.from(e)).filter(((t,i)=>e.findIndex((e=>e.container==t.container))==i))).forEach((e=>{new buildfire.components.reactions(null,e)}))}static _onLoginLogoutHandler(e){document.querySelectorAll("[bf-reactions-item-id]").forEach((t=>{let i=t.querySelector("[bf-reactions-default-src]");i&&!e&&(i.src=i.getAttribute("bf-reactions-default-src"));let r=t.getAttribute("bf-reactions-item-id");r&&e&&s.debounce({itemId:r,getUsersData:!0})}))}static _setCurrentUser(e){buildfire.auth.getCurrentUser(((t,i)=>(t||!i?this.user={}:i&&i._id&&(this.user=i),buildfire.auth.onLogin((e=>{this._onLoginLogoutHandler(e),this.user=e}),!0),buildfire.auth.onLogout((()=>{this._onLoginLogoutHandler(null),this.user={}}),!0),e(t,this.user))))}}return class{constructor(e,t={}){return t.onUpdate&&(this.onUpdate=t.onUpdate),t.onError&&(this.onError=t.onError),t.dataFromMessage&&(n.groups=t.dataFromMessage,n.itemsReactionsGroupName[t.itemId]=t.groupName||t.dataFromMessage[0].name),this.itemType=t.itemType||"",this.itemId=t.itemId,this.groupName=t.groupName||"",this.selector=e||null,this.container=t.container||null,this.container=this.container||document.querySelector(this.selector),this.showCount="boolean"!=typeof t.showCount||t.showCount,this.showUsersReactions="boolean"!=typeof t.showUsersReactions||t.showUsersReactions,this.allowMultipleReactions=!1,t.itemId?this.container?void buildfire.components.reactions.getReactionGroups(((e,t)=>{if(e)return console.error(e);let i={groupName:this.groupName,itemId:this.itemId};this._getReactionTypes(i,((e,t)=>{if(e)return this.onError({itemType:this.itemType,itemId:this.itemId,errorCode:"1002",message:"wrong data, invalid group name"});this.reactionsArr=t,this._init()}))})):(this.onError({itemType:this.itemType,itemId:this.itemId,errorCode:"1001",message:"missing required data, invalid selector/container"}),console.error("Missing selector")):(this.onError({errorCode:"1001",message:"missing required data, invalid itemId"}),console.error("Missing itemId"))}_init(){if(!this.reactionsArr.length)return this.onError({itemType:this.itemType,itemId:this.itemId,errorCode:"1003",message:"empty record, No Reactions added yet"}),console.error("No Reactions added yet");this._fixGroupName(this.groupName,((e,t)=>{e?this.onError({itemType:this.itemType,itemId:this.itemId,errorCode:"5001",message:"error while getting data, "+e}):t.existGroupName?(this._buildComponent(),s.debounce({itemId:this.itemId,getUsersData:!0,getSummariesData:!0})):this.onError({itemType:this.itemType,itemId:this.itemId,errorCode:"1002",message:"wrong data, invalid group name"})}))}_fixGroupName(e,t){const i=()=>{if(e&&n.groups.length){let i;for(let t=0;t<n.groups.length;t++)if(n.groups[t].name.toLowerCase()===e.toLowerCase()){i=n.groups[t];break}return i&&i.name?t(null,{existGroupName:!0}):t(null,{existGroupName:!1})}if(n.groups.length)return t(null,{existGroupName:!0})};n.groups?i():buildfire.components.reactions.getReactionGroups(((e,r)=>{if(e)return t(e);i()}))}_buildComponent(){this.container.innerHTML=null;let e="";this.reactionsArr.forEach(((t,i)=>{e+=` <div reactions-icon-buttons class="reactions-icon-buttons reaction-container-show">\n                                        <img style="animation-duration:${i/10+.1}s;" bf-reactions-non-reacted-url="${t.unSelectedUrl}" bf-reactions-reacted-url="${t.selectedUrl}" bf-reactions-url="${t.url}" bf-reaction-type="${t.id}" class="disable-user-select reactions-clickable-image reactions-icon-animation" src="${t.selectedUrl}" />\n                                    </div>`})),this.container.setAttribute("bf-reactions-item-id",this.itemId),this.container.setAttribute("bf-user_react-type",""),this.container.setAttribute("bf-user_react-id",""),this.container.classList.add("reactions-main-container");let t="";this.reactionsArr.forEach(((e,i)=>{t+=`<img bf-reaction-image-id="${e.id}" style="z-index:${9-i}" bf-reaction-image-count="0" class="disable-user-select reactions-hidden reactions-secondary-icon" src="${e.selectedUrl}" />`})),this.container.innerHTML=`\n                <div class="reaction-main-button">\n                    <div bf-reactions-image-container class="reactions-main-icon-container" >\n                        <img bf-reactions-btn class="disable-user-select reactions-main-icon" bf-reactions-default-src="${this.reactionsArr[0].unSelectedUrl}" src="${this.reactionsArr[0].unSelectedUrl}" />\n                        ${t}\n                    </div>\n                    <span style="visibility:hidden;" class="reactions-total-count reactions-hidden" bf-reactions-total-count="0">0</span>\n                </div>\n                <div class="reactions-icon-container reactions-hidden" bf-reaction-icon-container>${e}</div>\n            `,this.holdTimer=null,this.holdPeriod=0;let i=e=>{e.preventDefault(),this._hideReactionIcons(),this.holdTimer=setInterval((()=>{this.holdPeriod+=s.longPressPeriod/10,this.holdPeriod>=s.longPressPeriod&&this.reactionsArr.length>1&&(this._showReactionIcons(),this.holdPeriod=0,clearInterval(this.holdTimer))}),s.longPressPeriod/10)},r=e=>{e.preventDefault();let t=this.container.querySelector("[bf-reaction-icon-container]");if((this.holdPeriod<s.longPressPeriod||1===this.reactionsArr.length)&&t&&t.classList.contains("reactions-hidden")){let e=this.container.querySelectorAll("[bf-reaction-type]"),t=this.container.querySelector(".reacted");t?this._validateUserAndReact(t.getAttribute("bf-reaction-type"),t):this._validateUserAndReact(e[0].getAttribute("bf-reaction-type"),e[0])}this.holdPeriod=0,clearInterval(this.holdTimer)},n=this.container.querySelector("[bf-reactions-btn]"),o=this.container.querySelector("[bf-reactions-total-count]");this.showCount&&(o.classList.remove("reactions-hidden"),this.showUsersReactions&&o.addEventListener("click",(e=>{e.preventDefault(),this._showUsersList()}))),n.addEventListener("mousedown",i),n.addEventListener("touchstart",i),n.addEventListener("mouseup",r),n.addEventListener("touchend",r),this.container.querySelectorAll("[bf-reaction-type]").forEach((e=>{e.addEventListener("click",(t=>{t.preventDefault(),this._validateUserAndReact(e.getAttribute("bf-reaction-type"),e)}))}))}_showReactionIcons(){let e=this.container.querySelector("[bf-reaction-icon-container]");e&&e.classList.remove("reactions-hidden"),document.body.addEventListener("click",(e=>{e.preventDefault(),e&&!this.container.contains(e.target)&&this._hideReactionIcons(this.container)}))}_validateUserAndReact(e,t){s.user&&s.user._id?this._reactionHandler(e,t,s.user._id):buildfire.auth.login({},((i,r)=>{r&&r._id&&(s.user=r,this._reactionHandler(e,t,r._id))}))}_reactionHandler(e,t,i){let r=this.container.getAttribute("bf-user_react-type"),n={reactionType:e,reactionId:this.container.getAttribute("bf-user_react-id")||null,itemId:this.container.getAttribute("bf-reactions-item-id")};r?r===e?this._deselectReaction({icon:t,userReactUUID:r,userId:i,selectedReaction:n}):this._toggleReaction({icon:t,userReactUUID:r,userId:i,selectedReaction:n}):this._addReaction({icon:t,selectedReaction:n,userId:i})}_addReaction(e){let{icon:i,selectedReaction:s,userId:o,fromQueue:a}=e;this._renderReactionIconsBox({newIcon:i,fromQueue:a});let c={itemId:s.itemId,userId:o,reactionType:s.reactionType,allowMultipleReactions:this.allowMultipleReactions};this.hasPendingRequest?this.nextRequest={type:"add",options:e}:(this.hasPendingRequest=!0,t.react(c,((t,a)=>{if(t)return this._renderReactionIconsBox({oldIcon:i}),this.onError({itemType:this.itemType,itemId:s.itemId,errorCode:"5002",message:"error while updating the data, "+t}),console.error("Error while adding new Reaction: "+t);if(a){if("added"===a.status){this.container.setAttribute("bf-user_react-id",a.data.id);let e={reactionType:s.reactionType,itemId:s.itemId,userId:o};r.increment(e,((e,t)=>{if(this._checkPendingRequest(),e)return this.onError({itemType:this.itemType,itemId:s.itemId,errorCode:"5002",message:"error while updating the data, "+e}),console.error(e);"done"===t.status||t.status}))}else if("updated"===a.status){r.decrement({itemId:s.itemId,reactionType:a.oldData.reactions[0].reactionType},((e,t)=>{if(e)return this.onError({itemType:this.itemType,itemId:s.itemId,errorCode:"5002",message:"error while updating the data, ",err:e}),console.error(e)}));let e={reactionType:s.reactionType,itemId:s.itemId,userId:o};r.increment(e,((e,t)=>{if(this._checkPendingRequest(),e)return this.onError({itemType:this.itemType,itemId:s.itemId,errorCode:"5002",message:"error while updating the data, ",err:e}),console.error(e);"done"===t.status||t.status}))}else"noAction"===a.status&&this._checkPendingRequest();let t=n.itemsReactionsGroupName[e.itemId];this.onUpdate({status:"add",reactionType:s.reactionType,itemId:s.itemId,userId:o,itemType:this.itemType,name:t})}})))}_toggleReaction(e){let{icon:i,userReactUUID:s,userId:o,selectedReaction:a,fromQueue:c}=e,d=a.itemId;if(this._renderReactionIconsBox({fromQueue:c,newIcon:i,oldIcon:this.container.querySelector(`[bf-reaction-type="${s}"]`)}),this.hasPendingRequest)this.nextRequest={type:"update",options:e};else{this.hasPendingRequest=!0;let c={itemId:d,userId:o,reactionType:a.reactionType,reactionId:a.reactionId,allowMultipleReactions:this.allowMultipleReactions};t.unReactReact(c,((t,c)=>{if(t)return this._renderReactionIconsBox({oldIcon:i,newIcon:this.container.querySelector(`[bf-reaction-type="${s}"]`)}),this.onError({itemType:this.itemType,itemId:d,errorCode:"5002",message:"error while updating the data, ",error:t}),console.error("Error while updated the Reaction: "+t);if(c){"updated"===c.status?(r.decrement({itemId:d,reactionType:s},((e,t)=>{if(this._checkPendingRequest(),e)return this.onError({itemType:this.itemType,itemId:d,errorCode:"5002",message:"error while updating the data, ",err:e}),console.error(e)})),r.increment({itemId:d,reactionType:a.reactionType,userId:o},((e,t)=>{if(this._checkPendingRequest(),e)return this.onError({itemType:this.itemType,itemId:d,errorCode:"5002",message:"error while updating the data, ",err:e}),console.error(e)}))):"added"===c.status?(this.container.setAttribute("bf-user_react-id",c.data.id),r.increment({itemId:d,reactionType:a.reactionType,userId:o},((e,t)=>{if(this._checkPendingRequest(),e)return this.onError({itemType:this.itemType,itemId:d,errorCode:"5002",message:"error while updating the data, ",err:e}),console.error(e)}))):"noAction"===c.status&&this._checkPendingRequest();let t=n.itemsReactionsGroupName[e.itemId];this.onUpdate({status:"update",reactionType:a.reactionType,itemId:d,userId:o,itemType:this.itemType,name:t})}}))}}_deselectReaction(e){let{icon:i,userReactUUID:s,userId:o,selectedReaction:a,fromQueue:c}=e,d=a.reactionId,l=a.itemId,u=s,m={itemId:l,userId:o,reactionId:d,reactionType:u,allowMultipleReactions:this.allowMultipleReactions};this._renderReactionIconsBox({oldIcon:i,fromQueue:c}),this.hasPendingRequest?this.nextRequest={type:"delete",options:e}:(this.hasPendingRequest=!0,t.unReact(m,((t,s)=>{if(t)return this._renderReactionIconsBox({newIcon:i}),this.onError({itemType:this.itemType,itemId:l,errorCode:"5003",message:"error while deleting the data, "+t}),console.error("Error while deleting the Reaction: "+t);if(s){"deleted"===s.status?(this.container.setAttribute("bf-user_react-id",""),r.decrement({itemId:l,reactionType:u},((e,t)=>{if(this._checkPendingRequest(),e)return this.onError({itemType:this.itemType,itemId:l,errorCode:"5002",message:"error while updating the data, "+e}),console.error(e)}))):"noAction"===s.status&&this._checkPendingRequest();let t=n.itemsReactionsGroupName[e.itemId];this.onUpdate({status:"delete",reactionType:u,itemId:l,userId:o,itemType:this.itemType,name:t})}})))}_checkPendingRequest(){if(this.hasPendingRequest=!1,this.nextRequest)switch(this.nextRequest.type){case"add":this._addReaction({...this.nextRequest.options,fromQueue:!0});break;case"update":this._toggleReaction({...this.nextRequest.options,fromQueue:!0});break;case"delete":this._deselectReaction({...this.nextRequest.options,fromQueue:!0})}this.nextRequest={}}_renderReactionIconsBox(e){let{newIcon:t,oldIcon:i,fromQueue:r}=e;if(this._hideReactionIcons(),!r){let e=this.container.querySelector("[bf-reactions-btn]");if(i){i.classList.remove("reacted"),this.container.setAttribute("bf-user_react-type",""),this.container.setAttribute("bf-user_react-id","");let e=this.container.querySelector(`[bf-reaction-image-id="${i.getAttribute("bf-reaction-type")}"]`),t=parseInt(e.getAttribute("bf-reaction-image-count"));e.setAttribute("bf-reaction-image-count",t-1),e.classList.contains("reactions-hidden")&&t>=2&&e.classList.remove("reactions-hidden")}if(t){t.classList.add("reacted"),this.container.setAttribute("bf-user_react-type",t.getAttribute("bf-reaction-type")),e.src=t.getAttribute("bf-reactions-reacted-url"),e.classList.add("reactions-show-main-icon"),setTimeout((()=>{e.classList.remove("reactions-show-main-icon")}),300);let i=this.container.querySelector(`[bf-reaction-image-id="${t.getAttribute("bf-reaction-type")}"]`);i.classList.contains("reactions-hidden")||i.classList.add("reactions-hidden");let r=parseInt(i.getAttribute("bf-reaction-image-count"));i.setAttribute("bf-reaction-image-count",r+1)}let r=this.container.querySelector("[bf-reactions-total-count]");if(t&&!i&&r){let e=r.getAttribute("bf-reactions-total-count"),t=parseInt(e)+1;t=t>=0?t:0,r.setAttribute("bf-reactions-total-count",t),r.innerHTML=s.correctCountNumbers(t)}if(!t&&i){let t=r.getAttribute("bf-reactions-total-count"),i=parseInt(t)-1;i=i>=0?i:0,r.setAttribute("bf-reactions-total-count",i),r.innerHTML=s.correctCountNumbers(i),e.src=this.reactionsArr[0].unSelectedUrl,e.classList.add("reactions-show-main-icon"),setTimeout((()=>{e.classList.remove("reactions-show-main-icon")}),300)}}}_hideReactionIcons(e){if(e){let t=e.querySelector("[bf-reaction-icon-container]");t.classList.remove("reaction-container-show"),t.classList.add("reaction-container-hide"),setTimeout((()=>{t.classList.remove("reaction-container-hide"),t.classList.add("reaction-container-show"),t.classList.add("reactions-hidden")}),250)}else document.querySelectorAll("[bf-reaction-icon-container]").forEach((e=>{e.classList.remove("reaction-container-show"),e.classList.add("reaction-container-hide"),setTimeout((()=>{e.classList.remove("reaction-container-hide"),e.classList.add("reaction-container-show"),e.classList.add("reactions-hidden")}),250)}))}_showUsersList(){let e=[];buildfire.spinner.show();let i=(t,r,n)=>{let s=t[r],o=this.reactionsArr.find((e=>e.id===s.data.reactions[0].reactionType));if(o){let a=o.selectedUrl;buildfire.auth.getUserProfile({userId:s.data.userId},((s,o)=>{if(s)return console.error(s);o||(o={displayName:"User",imageUrl:"https://app.buildfire.com/app/media/avatar.png"});let c=o.displayName?o.displayName:o.firstName?o.firstName:"User",d=o.imageUrl?o.imageUrl:"https://app.buildfire.com/app/media/avatar.png";d=buildfire.imageLib.resizeImage(d,{size:"xs",aspect:"1:1"});const l=document.createElement("div"),u=document.createElement("div");u.style="display:flex; gap:1rem; align-items:center";const m=document.createElement("img");m.style="border-radius:100%; width:42px; height:42px; -khtml-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; -webkit-touch-callout: none; -webkit-user-select: none;",m.alt="user image",m.src=d,u.appendChild(m);const p=document.createElement("p");p.style="overflow:auto; max-width: 75%; margin:0 !important;",p.textContent=c,u.appendChild(p);const h=document.createElement("span");h.style="position: absolute;bottom: 0;left: 2.6rem;width: 2rem;height: 2rem;display: flex;align-items: center;justify-content: center; margin-left:0 !important;";const f=document.createElement("img");f.style="width: 2rem;height: 2rem; border-radius:100%;",f.src=a,h.appendChild(f),u.appendChild(h),l.appendChild(u),e.push({text:l.innerHTML}),r==t.length-1?this._openDrawer(e):n(t,r+1,i)}))}else r==t.length-1&&this._openDrawer(e)},r={itemId:this.itemId,groupName:this.groupName,pageIndex:0,pageSize:s.userListPageSize},n=[];t.get(r,((e,o)=>{if(e);else if(o.result.length){n=o.result;let e=[],a=o.totalRecord,c=Math.ceil((Math.min(a,s.userListLimit)-s.userListPageSize)/s.userListPageSize);for(let i=0;i<c;i++)e[i]=new Promise(((e,s)=>{t.get({...r,pageIndex:i+1},((t,i)=>{i.result.length&&(n=[...n,...i.result]),e(!0)}))}));e.length>=1?Promise.all(e).then((()=>{i(n,0,i)})):i(n,0,i)}else this._openDrawer([])}))}_openDrawer(e){buildfire.spinner.hide(),buildfire.components.drawer.open({content:"Reactions",isHTML:!0,triggerCallbackOnUIDismiss:!1,autoUseImageCdn:!0,listItems:e},((e,t)=>{if(e)return console.error(e)}))}static getReactionGroups(e){if(n.groups)return e(null,n.groups);n.getReactionsGroups({},((t,i)=>t?e(t):e(null,i)))}_getReactionTypes(e,t){let{groupName:i,itemId:r}=e;n.getReactionsTypes({groupName:i,itemId:r},((e,i)=>e?t(e):t(null,i)))}onUpdate(e){}onError(e){}static injectReactions(e){s.buildReactionElements(e)}}})();