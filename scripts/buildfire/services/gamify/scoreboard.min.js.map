{"version":3,"sources":["../sdk/scripts/buildfire/services/gamify/scoreboard.js"],"names":["buildfire","gamify","Scoreboard","tagName","size","autoSubscribeToPushNotification","this","pushGroupName","prototype","getScoreboard","callback","publicData","get","err","result","data","topScores","undefined","gamesPlayed","reset","save","_PNEnabled","notifications","pushNotification","subscribe","cb","groupName","console","error","unsubscribe","logScore","user","score","warn","t","ts","Date","logError","newRec","createdOn","bumpedOff","rankedAt","length","push","sort","a","b","pop","update","id","i","obj","email","schedule","title","text","displayName","users"],"mappings":"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","file":"scoreboard.min.js","sourcesContent":["/**\n * Created by danielhindi on 1/18/18.\n */\n\nif (typeof (buildfire) == \"undefined\") throw (\"please add buildfire.js first to use BuildFire services\");\nif (!buildfire.gamify) buildfire.gamify = {};\n\n\nbuildfire.gamify.Scoreboard = function(tagName,size,autoSubscribeToPushNotification){\n    this.size=size || 10;\n    this.autoSubscribeToPushNotification=autoSubscribeToPushNotification;\n    if(this.size < 1)this.size=10;\n    this.tagName = tagName || \"scoreboard\";\n    this.pushGroupName = \"scoreboard_\" + this.tagName;\n};\n\nbuildfire.gamify.Scoreboard.prototype = {\n    size:10\n    ,getScoreboard:function(callback){\n        buildfire.publicData.get(this.tagName, function (err, result) {\n\n            if(err)\n                callback(err);\n            else {\n                if (result.data.topScores)\n                    callback(undefined,result.data);\n                else\n                    callback(undefined,{\n                        gamesPlayed:0\n                        ,topScores: []\n                    });\n            }\n        });\n    }\n    ,reset:function(){\n        var data = {\n            gamesPlayed:0\n            ,topScores: []\n        };\n        buildfire.publicData.save(data,this.tagName, function(){});\n    }\n    , _PNEnabled:function(){\n        return buildfire.notifications && buildfire.notifications.pushNotification;\n    }\n    ,subscribe:function(cb){\n        /// if PushNotifications are available then subscribe to the group\n        if(this._PNEnabled()) {\n            buildfire.notifications.pushNotification.subscribe({groupName: this.pushGroupName}, function (err) {\n                if (err) console.error(err);\n                if(cb)cb(err);\n            });\n            return true;\n        }else\n            return false;\n    }\n    ,unsubscribe:function(cb){\n        /// if PushNotifications are available then unsubscribe from the group\n        if(this._PNEnabled()) {\n            buildfire.notifications.pushNotification.unsubscribe({groupName: this.pushGroupName}, function (err) {\n                if (err) console.error(err);\n                if(cb)cb(err);\n            });\n            return true;\n        }else\n            return false;\n    }\n    ,logScore: function (user, score,callback) {\n\n        if(this.autoSubscribeToPushNotification){\n            if(!this.subscribe()){\n                console.warn(\"Cannot subscribe to scoreboard push notifications because buildfire push notification services is not attached\");\n            }\n        }\n\n        var t= this;\n        var ts = new Date();\n        buildfire.publicData.get(this.tagName, function (err, result) {\n            function logError(err){\n                if(err){\n                    debugger;\n                    callback(err);\n                }\n            }\n\n            var newRec={user: user, score: score, createdOn:ts};\n\n            var data = {\n                gamesPlayed:0\n                ,topScores: [newRec]\n            };\n            if (err)\n                callback(err);\n            else if (result) {\n\n                if(!result.data.topScores){\n                    data.gamesPlayed++;\n                    buildfire.publicData.save(data, t.tagName,logError );\n                }\n                else{\n\n\n                    /// check if your score is greater than the lowest one\n                    if(result.data.topScores.length > t.size){\n                        if(result.data.topScores[t.size -1].score > score) /// nothing to do here you didnt make the list\n                            callback();\n                    }\n\n                    data = result.data;\n                    data.topScores.push(newRec);\n                    data.topScores= data.topScores.sort(function (a, b) {\n                        return b.score - a.score ;\n                    });\n\n                    var bumpedOff;\n                    if(data.topScores.length > t.size)\n                        bumpedOff = data.topScores.pop();\n\n                    data.gamesPlayed++;\n                    buildfire.publicData.update(result.id, data, t.tagName, logError);\n\n                    var rankedAt;\n                    for(var i = 0; i < data.topScores.length ;i++){\n                        if(data.topScores[i].createdOn == ts){\n                            rankedAt = i;\n                            break;\n                        }\n                    }\n                    var obj={bumpedOff:bumpedOff, rankedAt:rankedAt};\n\n                    if(t._PNEnabled()) {\n\n                        if( obj.bumpedOff && obj.bumpedOff.user.email != user.email){\n\n                            //send notification\n                            buildfire.notifications.pushNotification.schedule({\n                                title: \"You got kicked off !!!\"\n                                ,text: \"Your old score is no longer on the top 10. \" + user.displayName + \" has taken your spot. Honestly, I dont know how you sleep at night.\"\n                                //,at: new Date()\n                                ,users:[obj.bumpedOff.user.id]\n                            },logError);\n                        }\n\n                        if(rankedAt == 0) {\n                            buildfire.notifications.pushNotification.schedule({\n                                title: \"There is a new champion!\"\n                                ,text: user.displayName + \" has taken the lead at the new undisputed champion with a score of \" + score\n                                ,groupName: t.pushGroupName\n                            }, logError);\n                        }\n\n                        if(rankedAt == 1) {\n                            buildfire.notifications.pushNotification.schedule({\n                                title: \"There is a challenger to the champion\"\n                                , text: user.displayName + \" has taken 2nd place with a score of \" + score + \". Watch out \" + data.topScores[0].user.displayName\n                                , groupName: t.pushGroupName\n                            }, logError);\n                        }\n\n                        if(rankedAt == 2) {\n                            buildfire.notifications.pushNotification.schedule({\n                                title: \"There is a kid in town!\"\n                                , text: user.displayName + \" has taken 3rd place. Keep an eye on this one\"\n                                , groupName: t.pushGroupName\n                            }, logError);\n                        }\n\n                    }\n\n                    callback(null,obj);\n                }\n\n            }\n            else {\n                data.gamesPlayed++;\n                buildfire.publicData.save(data,t.tagName, logError);\n                callback(null,{rankedAt:0});\n            }\n\n        });\n    }\n};"]}