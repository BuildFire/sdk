tinymce.PluginManager.add('bf_videolib', function (editor, url) {
  let dialogHeight = window.innerHeight > 470 ? 470 : window.innerHeight - 20;
  editor.ui.registry.addButton('bf_videolib', {
    icon: 'embed',
    tooltip: 'Insert/edit video',
    onAction: function () {
      showVideoDialog();
    }
  });
  editor.ui.registry.addButton('bf_edit_video', {
    icon: 'edit-block',
    tooltip: 'Edit video',
    onAction: function () {
      showVideoDialog();
    }
  });
  editor.ui.registry.addMenuItem('bf_videolib', {
    icon: 'embed',
    text: 'Insert/edit video',
    onAction: function () {
      showVideoDialog();
    }
  });
  editor.ui.registry.addMenuItem('bf_editVideo', {
    text: 'Edit video',
    icon: 'edit-block',
    onAction: function() {
      showVideoDialog();
    }
  });
  editor.ui.registry.addContextToolbar('editBfVideo', {
    predicate: function (node) {
      if (node.tagName === 'VIDEO' || node.dataset.bfVideo) return true;
      if (node.tagName === 'IFRAME') return true;
      if (node.getAttribute && node.getAttribute('data-mce-object') === 'video') return true;
      var video = node.querySelector && node.querySelector('video');
      if (video) return true;
      return false;
    },
    items: 'bf_edit_video',
    position: 'node',
    scope: 'node'
  });
  editor.ui.registry.addContextMenu('bf_videoContextMenu', {
    update: function (element) {
      var node = element;
      while (node && node !== editor.getBody()) {
        if (node.tagName === 'VIDEO' || node.dataset.bfVideo) return 'bf_editVideo';
        if (node.tagName === 'IFRAME') return 'bf_editVideo';
        if (node.tagName === 'SPAN' && node.getAttribute && node.getAttribute('data-mce-object')) return 'bf_editVideo';
        node = node.parentNode;
      }
      return '';
    }
  });

  var activeXhr = null;
  var isProcessing = false;
  
  function showVideoDialog() {
    var selectedNode = editor.selection.getNode();
    var isEditing = selectedNode && (selectedNode.getAttribute('data-mce-object') || selectedNode.tagName === 'IFRAME' || selectedNode.tagName === 'VIDEO');
    
    var initialData = {
      source: '',
      width: '',
      height: '',
      embed: '',
      altSource: '',
      poster: '',
      quality: '',
      atSecond: '',
      useCdn: false
    };
    
    if (isEditing) {
      var videoNode = selectedNode;
      var bfVideoData = null;
      
      // Check if it's a TinyMCE wrapper span
      if (selectedNode.tagName === 'SPAN' && selectedNode.getAttribute('data-mce-object')) {
        // Try to get data-bf-video from TinyMCE's data-mce-p-data-bf-video attribute
        var mceBfVideo = selectedNode.getAttribute('data-mce-p-data-bf-video');
        if (mceBfVideo) {
          bfVideoData = decodeURIComponent(mceBfVideo);
        }
        videoNode = selectedNode.querySelector('video') || selectedNode.querySelector('iframe') || selectedNode;
      }
      
      // If not found on span, try the video element itself
      if (!bfVideoData && videoNode.dataset && videoNode.dataset.bfVideo) {
        bfVideoData = videoNode.dataset.bfVideo;
      }
      
      if (bfVideoData) {
        var videoProperties = JSON.parse(unescape(bfVideoData));
        initialData.source = videoProperties.originalSrc || '';
        initialData.altSource = videoProperties.altSource || '';
        initialData.poster = videoProperties.poster || '';
        initialData.quality = videoProperties.quality || '';
        initialData.atSecond = videoProperties.atSecond || '';
        initialData.width = videoProperties.width || '';
        initialData.height = videoProperties.height || '';
        initialData.useCdn = videoProperties.useCdn || false;
      }
      
      // Get clean HTML content
      editor.selection.select(selectedNode);
      var htmlContent = editor.selection.getContent();
      if (htmlContent) {
        initialData.embed = btoa(encodeURIComponent(htmlContent));
      }
    }
    
    var queryString = encodeURIComponent(JSON.stringify(initialData));
    editor.windowManager.openUrl({
      title: 'Insert/Edit Video',
      url: url + '/dialog.html?data=' + queryString,
      width: 500,
      height: dialogHeight,
      buttons: [
        {
          type: 'cancel',
          name: 'cancel',
          text: 'Cancel'
        },
        {
          type: 'custom',
          name: 'save',
          text: 'Save',
          primary: true
        }
      ],
      onAction: function (dialogApi, details) {
        if (details.name === 'save' && !isProcessing) {
          dialogApi.sendMessage({ action: 'getVideoData' });
        }
      },
      onMessage: function (dialogApi, message) {
        if (message.mceAction === 'insertVideo' && message.data) {
          validateAndInsertVideo(message.data, dialogApi);
        }
      },
      onClose: function () {
        if (activeXhr) {
          activeXhr.abort();
          activeXhr = null;
        }
        editor.focus();
      }
    });
    
  }
  
  function validateAndInsertVideo(data, dialogApi) {
    var source = data.source;
    
    // For direct video files with CDN enabled, validate CDN URL first
    if (data.useCdn && source && source.match(/\.(mp4|webm|ogg)(\?.*)?$/i)) {
      if (typeof buildfire !== 'undefined' && buildfire.videoLib && buildfire.videoLib.toCdnUrl) {
        try {
          var cdnParams = { videoUrl: source };
          if (data.quality) {
            cdnParams.quality = data.quality;
          }
          var cdnUrl = buildfire.videoLib.toCdnUrl(cdnParams);
          
          // Show loader in dialog and set processing flag
          isProcessing = true;
          dialogApi.sendMessage({ action: 'showLoader' });

          // Test if CDN URL is accessible
          activeXhr = new XMLHttpRequest();
          activeXhr.open('HEAD', cdnUrl, true);
          activeXhr.onreadystatechange = function() {
            if (activeXhr.readyState === 4) {
              var status = activeXhr.status;
              var responseText = activeXhr.responseText;
              
              // Hide loader in dialog and clear processing flag
              isProcessing = false;
              dialogApi.sendMessage({ action: 'hideLoader' });
              activeXhr = null;
              
              // If status is 0, request was aborted (user clicked Cancel), don't show error
              if (status === 0) {
                return;
              }
              
              if (status === 200) {
                // CDN URL works, proceed with video insertion
                var videoHtml = data.embed || '';
                if (videoHtml) {
                  editor.insertContent(videoHtml);
                }
                dialogApi.close();
              } else if (status === 413) {
                // CDN failed with 413 (file too large)
                editor.windowManager.open({
                  title: 'Video Too Large',
                  body: {
                    type: 'panel',
                    items: [{ type: 'htmlpanel', html: '<p>Video exceeds CDN processing limits. Please disable CDN or use a smaller video file.</p>' }]
                  },
                  buttons: [{ type: 'cancel', text: 'OK', primary: true }],
                  initialData: {}
                });
              } else {
                // Other CDN error with details
                var errorMsg = 'Error processing video via CDN. Try again later or disable CDN.';
                if (responseText) {
                  errorMsg += ': ' + responseText;
                }
                editor.windowManager.open({
                  title: 'CDN Error',
                  body: {
                    type: 'panel',
                    items: [{ type: 'htmlpanel', html: '<p>' + errorMsg + '</p>' }]
                  },
                  buttons: [{ type: 'cancel', text: 'OK', primary: true }],
                  initialData: {}
                });
              }
            }
          };
          activeXhr.send();
          return;
        } catch (e) {
          console.error('CDN validation error:', e);
          isProcessing = false;
          dialogApi.sendMessage({ action: 'hideLoader' });
        }
      }
    }
    
    // For non-video files or if CDN validation not needed, insert directly
    var videoHtml = data.embed || '';
    if (videoHtml) {
      editor.insertContent(videoHtml);
    }
    dialogApi.close();
  }
  
  return {
    getMetadata: function () {
      return {
        name: 'BuildFire Video Library plugin',
        url: 'https://github.com/BuildFire/sdk'
      };
    }
  };
});