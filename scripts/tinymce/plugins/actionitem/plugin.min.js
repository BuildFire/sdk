tinymce.PluginManager.add("actionitem", function (editor, url) {
  editor.addButton("actionitem", {
    text: "Action Item",
    icon: false,
    onclick: function () {
      let selection = editor.selection.getContent({ format: "html" });

      let selectedNode = editor.selection.getNode();
      let actionItem = null;
      let isEditing = false;

      if (
        selectedNode &&
        selectedNode.dataset &&
        selectedNode.dataset.actionItem
      ) {
        try {
          actionItem = JSON.parse(
            selectedNode.dataset.actionItem.split("'").join('"')
          );
          isEditing = true;
        } catch (error) {
          actionItem = null;
          isEditing = false;
        }
      }

      buildfire.actionItems.showDialog(
        actionItem,
        { allowNoAction: false, showIcon: false, showTitle: false },
        (err, actionItem) => {
          if (err) return console.error(err);
          if (!actionItem) return;

          let stringifiedActionItem = JSON.stringify(actionItem)
            .split('"')
            .join("'");
          if (isEditing) {
            let anchor = `<a href="#" data-action-item="${stringifiedActionItem}" onclick="buildfire.actionItems.execute(${stringifiedActionItem}, ()=>{})">${selectedNode.innerHTML}</a>`;
            selectedNode.parentNode.innerHTML = anchor;
          } else {
            let anchor = `<a href="#" data-action-item="${stringifiedActionItem}" onclick="buildfire.actionItems.execute(${stringifiedActionItem}, ()=>{})">${selection}</a>`;
            editor.selection.setContent(anchor);
          }
          editor.fire("change")
        }
      );
    },
  });

  return {
    getMetadata: function () {
      return {
        name: "Action Item Plugin",
        url: "https://github.com/BuildFire/sdk/wiki/How-to-use-action-Items",
      };
    },
  };
});
